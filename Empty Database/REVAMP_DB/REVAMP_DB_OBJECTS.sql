-------------------------------------------------------
-- Export file for user REVAMPV2                     --
-- Created by david.santana on 3/12/2014, 6:21:11 PM --
-------------------------------------------------------

set define off
spool REVAMP_DB_OBJECTS.log

prompt
prompt Creating table CMS_MENU_ITEMS
prompt =============================
prompt
create table CMS_MENU_ITEMS
(
  menu_id          NUMBER,
  menu_title       VARCHAR2(255),
  parent_id        NUMBER default 0,
  page_id          NUMBER,
  active           NUMBER default 1,
  status           NUMBER default 1,
  user_rights      NUMBER default 0,
  target_portal_id NUMBER default 1,
  sort_order       NUMBER,
  is_education     NUMBER default 0
)
;
comment on column CMS_MENU_ITEMS.status
  is '0: Un-Published; 1: Published';
comment on column CMS_MENU_ITEMS.target_portal_id
  is '1: Patient; 2: VA_Facing; 3: Both';

prompt
prompt Creating table CMS_PAGES
prompt ========================
prompt
create table CMS_PAGES
(
  page_id          NUMBER,
  title            VARCHAR2(4000),
  author_id        NUMBER,
  contents         CLOB,
  status           NUMBER(2),
  active           NUMBER(1),
  created          DATE,
  created_by       NUMBER,
  last_modified    DATE,
  last_modified_by NUMBER,
  is_template      NUMBER default 0
)
;
comment on column CMS_PAGES.status
  is '0:un-published; 1: published';

prompt
prompt Creating table CPAP_DATA_PHILLIPS
prompt =================================
prompt
create table CPAP_DATA_PHILLIPS
(
  arm                   NUMBER,
  study                 NUMBER,
  participant           NUMBER,
  dob                   DATE,
  city                  VARCHAR2(48),
  state                 VARCHAR2(2),
  zip                   VARCHAR2(16),
  notifications         VARCHAR2(255),
  timestamp             DATE,
  start_date            DATE,
  encounter             NUMBER,
  encounter_rank        NUMBER,
  encounter_type        VARCHAR2(255),
  total_connected_time  NUMBER,
  total_blower_time     NUMBER,
  apnea_hypopnea_index  NUMBER,
  hypopnea_index        NUMBER,
  oa_apnea_index        NUMBER,
  ca_apnea_index        NUMBER,
  flow_limitation_index NUMBER,
  vibratory_snore_index NUMBER,
  rera_index            NUMBER,
  pp_breathing          NUMBER,
  average_leak          NUMBER,
  maximum_leak          NUMBER,
  leak_90_percent       NUMBER,
  total_large_leak      NUMBER,
  total_apnea_duration  NUMBER,
  avg_cpap_pressure     NUMBER,
  max_cpap_pressure     NUMBER,
  min_cpap_pressure     NUMBER,
  cpap_90_pressure      NUMBER
)
;

prompt
prompt Creating table CPAP_DEVICE
prompt ==========================
prompt
create table CPAP_DEVICE
(
  device_id      NUMBER,
  device_type_id NUMBER,
  device_name    VARCHAR2(255),
  serial_number  VARCHAR2(255),
  patient_id     VARCHAR2(50),
  low_pressure   VARCHAR2(4),
  high_pressure  VARCHAR2(4),
  mask_type      VARCHAR2(50),
  mask_details   VARCHAR2(4000),
  pap_type       NUMBER default 0,
  date_updated   DATE default sysdate,
  active         NUMBER default 1
)
;
comment on column CPAP_DEVICE.device_id
  is 'sequence';
comment on column CPAP_DEVICE.device_type_id
  is '1=philips 2=resmed';
comment on column CPAP_DEVICE.device_name
  is 'name';
comment on column CPAP_DEVICE.serial_number
  is 'sn';
comment on column CPAP_DEVICE.active
  is 'Indicate if the machine is in use by the patient';
alter table CPAP_DEVICE
  add constraint PK_CPAP_DEVICE unique (SERIAL_NUMBER, PATIENT_ID);

prompt
prompt Creating table CPAP_DEVICE_TYPE
prompt ===============================
prompt
create table CPAP_DEVICE_TYPE
(
  device_type_id          NUMBER,
  device_type_description VARCHAR2(255)
)
;

prompt
prompt Creating table CPAP_LEAK_TYPE
prompt =============================
prompt
create table CPAP_LEAK_TYPE
(
  leak_type_id    NUMBER,
  leak_type_descr VARCHAR2(1000)
)
;

prompt
prompt Creating table DATA_CPAP_PHILIPS
prompt ================================
prompt
create table DATA_CPAP_PHILIPS
(
  patientid                      VARCHAR2(255),
  facilitypatientid              VARCHAR2(255),
  patientname                    VARCHAR2(255),
  therapydate                    VARCHAR2(255),
  activeday                      VARCHAR2(255),
  minutesofuse                   VARCHAR2(255),
  ahi                            VARCHAR2(255),
  averageleak                    VARCHAR2(255),
  minutesoflargeleak             VARCHAR2(255),
  connectedminutes               VARCHAR2(255),
  apneaindex                     VARCHAR2(255),
  hypopneaindex                  VARCHAR2(255),
  patientreference               VARCHAR2(255),
  patientoffice                  VARCHAR2(255),
  usagehumidifier                VARCHAR2(255),
  indexapneaobstructedairway     VARCHAR2(255),
  indexapneaclearairway          VARCHAR2(255),
  indexnrah                      VARCHAR2(255),
  indexflowlimitation            VARCHAR2(255),
  indexvibratorysnore            VARCHAR2(255),
  pressurecpap                   VARCHAR2(255),
  pressurecpapmax                VARCHAR2(255),
  pressurecpap90pct              VARCHAR2(255),
  pressureipap                   VARCHAR2(255),
  pressureipapmax                VARCHAR2(255),
  pressureipap90pct              VARCHAR2(255),
  pressureipapavgpeak            VARCHAR2(255),
  pressureepap                   VARCHAR2(255),
  pressureepapmax                VARCHAR2(255),
  pressureepap90pct              VARCHAR2(255),
  apneaminutes                   VARCHAR2(255),
  countpatientdisconnect         VARCHAR2(255),
  countpressurehighout           VARCHAR2(255),
  countpressurelowout            VARCHAR2(255),
  countpressuresupportlow        VARCHAR2(255),
  counttidalvolumelow            VARCHAR2(255),
  countminuteventlow             VARCHAR2(255),
  countapnea                     VARCHAR2(255),
  countapneaalarm                VARCHAR2(255),
  csrpct                         VARCHAR2(255),
  pbpct                          VARCHAR2(255),
  leakmax                        VARCHAR2(255),
  leak90pct                      VARCHAR2(255),
  breathrate                     VARCHAR2(255),
  exhaledtidalvolume             VARCHAR2(255),
  triggeredbreathspct            VARCHAR2(255),
  peakflow                       VARCHAR2(255),
  minuteventilation              VARCHAR2(255),
  pressuresupport                VARCHAR2(255),
  indexrera                      VARCHAR2(255),
  cpapmin                        VARCHAR2(255),
  indexvariablebreathing         VARCHAR2(255),
  inhaledtidalvolume             VARCHAR2(255),
  titrationtotal                 VARCHAR2(255),
  settinghumidifier              VARCHAR2(255),
  settingflex                    VARCHAR2(255),
  settingcpap                    VARCHAR2(255),
  settingcpapmin                 VARCHAR2(255),
  settingcpapmax                 VARCHAR2(255),
  settingipap                    VARCHAR2(255),
  settingipapmin                 VARCHAR2(255),
  settingipapmax                 VARCHAR2(255),
  settingepap                    VARCHAR2(255),
  settingepapmin                 VARCHAR2(255),
  settingepapmax                 VARCHAR2(255),
  settingbreathrate              VARCHAR2(255),
  settingpressuresupportmin      VARCHAR2(255),
  settingpressuresupportmax      VARCHAR2(255),
  settingpressuremax             VARCHAR2(255),
  pcpupin                        VARCHAR2(255),
  sleepdrupin                    VARCHAR2(255),
  device                         VARCHAR2(255),
  therapymode                    VARCHAR2(255),
  modemrx                        VARCHAR2(255),
  clinicianname                  VARCHAR2(255),
  patientactive                  VARCHAR2(255),
  patientcompany                 VARCHAR2(255),
  patientfirstname               VARCHAR2(255),
  patientmiddlename              VARCHAR2(255),
  patientlastname                VARCHAR2(255),
  patientdateofbirth             VARCHAR2(255),
  usageminutes                   VARCHAR2(255),
  deviceserial                   VARCHAR2(255),
  primaryinsuranceprovidername   VARCHAR2(255),
  primaryinsuranceplanname       VARCHAR2(255),
  primaryinsurancegroupnumber    VARCHAR2(255),
  primaryinsurancepolicynumber   VARCHAR2(255),
  primaryinspolicyholdername     VARCHAR2(255),
  primaryinspolicyholderrelship  VARCHAR2(255),
  primaryinsproviderexternid     VARCHAR2(255),
  secondaryinsprovidername       VARCHAR2(255),
  secondaryinsuranceplanname     VARCHAR2(255),
  secondaryinsurancegroupnumber  VARCHAR2(255),
  secondaryinsurancepolicynumber VARCHAR2(255),
  secondaryinspolicyholdername   VARCHAR2(255),
  secondaryinspolicyholderrelshp VARCHAR2(255),
  secondaryinsproviderexternalid VARCHAR2(255),
  settingdominanthumidifimethod  VARCHAR2(255),
  classichumidificationminutes   VARCHAR2(255),
  systemonehumidificationminutes VARCHAR2(255),
  heatedtubehumidificationmins   VARCHAR2(255),
  passoverhumidificationminutes  VARCHAR2(255),
  disconnectedhumidiminutes      VARCHAR2(255),
  errorhumidificationminutes     VARCHAR2(255),
  heatedtubesettingavg           VARCHAR2(255),
  humiditylevelsettingavg        VARCHAR2(255),
  humidifiersettingavg           VARCHAR2(255),
  ambienttemperatureavg          VARCHAR2(255),
  ambienthumidityavg             VARCHAR2(255),
  import_status                  NUMBER default 0,
  date_imported                  DATE default sysdate,
  date_processed                 DATE,
  import_status_cmnt             VARCHAR2(255),
  import_patient_id              VARCHAR2(255),
  import_device_id               NUMBER,
  import_timestamp               TIMESTAMP(6) default systimestamp
)
;
comment on column DATA_CPAP_PHILIPS.patientid
  is 'The database primary key for the patient';
comment on column DATA_CPAP_PHILIPS.facilitypatientid
  is 'The patient’s facility ID';
comment on column DATA_CPAP_PHILIPS.patientname
  is 'The patient’s full name (family, given middle)';
comment on column DATA_CPAP_PHILIPS.therapydate
  is 'The date when the therapy data was recorded';
comment on column DATA_CPAP_PHILIPS.activeday
  is 'Set if the day has not been excluded from compliance calculations';
comment on column DATA_CPAP_PHILIPS.minutesofuse
  is 'Total blower time';
comment on column DATA_CPAP_PHILIPS.ahi
  is 'Apnea-hypopnea index';
comment on column DATA_CPAP_PHILIPS.averageleak
  is 'Average leak';
comment on column DATA_CPAP_PHILIPS.minutesoflargeleak
  is 'Total time in large leak';
comment on column DATA_CPAP_PHILIPS.connectedminutes
  is 'Total connected patient time';
comment on column DATA_CPAP_PHILIPS.apneaindex
  is 'Apnea index';
comment on column DATA_CPAP_PHILIPS.hypopneaindex
  is 'Hypopnea index';
comment on column DATA_CPAP_PHILIPS.patientreference
  is 'The patient’s reference ID (Social Security Number)';
comment on column DATA_CPAP_PHILIPS.patientoffice
  is 'The name of the patient’s DME office';
comment on column DATA_CPAP_PHILIPS.usagehumidifier
  is 'Total humidifier usage time';
comment on column DATA_CPAP_PHILIPS.indexapneaobstructedairway
  is 'Obstructed airway apnea index';
comment on column DATA_CPAP_PHILIPS.indexapneaclearairway
  is 'Clear airway apnea index';
comment on column DATA_CPAP_PHILIPS.indexnrah
  is 'Non-responsive apnea/hypopnea index';
comment on column DATA_CPAP_PHILIPS.indexflowlimitation
  is 'Flow limitation index';
comment on column DATA_CPAP_PHILIPS.indexvibratorysnore
  is 'Vibratory snore index';
comment on column DATA_CPAP_PHILIPS.pressurecpap
  is 'Average CPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressurecpapmax
  is 'Maximum CPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressurecpap90pct
  is '90th percentile CPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureipap
  is 'Average IPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureipapmax
  is 'Maximum IPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureipap90pct
  is '90th percentile IPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureipapavgpeak
  is 'Average peak IPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureepap
  is 'Average EPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureepapmax
  is 'Maximum EPAP pressure';
comment on column DATA_CPAP_PHILIPS.pressureepap90pct
  is '90th percentile EPAP pressure';
comment on column DATA_CPAP_PHILIPS.apneaminutes
  is 'Total time in apnea';
comment on column DATA_CPAP_PHILIPS.countpatientdisconnect
  is 'Total patient disconnect alarms';
comment on column DATA_CPAP_PHILIPS.countpressurehighout
  is 'Total low pressure alarms';
comment on column DATA_CPAP_PHILIPS.countpressurelowout
  is 'Total high pressure alarms';
comment on column DATA_CPAP_PHILIPS.countpressuresupportlow
  is 'Total low pressure support alarms';
comment on column DATA_CPAP_PHILIPS.counttidalvolumelow
  is 'Total low tidal volume alarms';
comment on column DATA_CPAP_PHILIPS.countminuteventlow
  is 'Total low minute ventilation alarms';
comment on column DATA_CPAP_PHILIPS.countapnea
  is 'Total apnea count';
comment on column DATA_CPAP_PHILIPS.countapneaalarm
  is 'Total apnea alarms';
comment on column DATA_CPAP_PHILIPS.csrpct
  is 'Percentage of time spent in Cheyne-Stokes Respiration';
comment on column DATA_CPAP_PHILIPS.pbpct
  is 'Percentage of time spend in Periodic Breathing';
comment on column DATA_CPAP_PHILIPS.leakmax
  is 'Maximum leak';
comment on column DATA_CPAP_PHILIPS.leak90pct
  is '90th percentile leak';
comment on column DATA_CPAP_PHILIPS.breathrate
  is 'Average breath rate';
comment on column DATA_CPAP_PHILIPS.exhaledtidalvolume
  is 'Average exhaled tidal volume';
comment on column DATA_CPAP_PHILIPS.triggeredbreathspct
  is 'Average percentage patient triggered breaths';
comment on column DATA_CPAP_PHILIPS.peakflow
  is 'Average peak flow';
comment on column DATA_CPAP_PHILIPS.minuteventilation
  is 'Average respiratory minute volume';
comment on column DATA_CPAP_PHILIPS.pressuresupport
  is 'Average pressure support';
comment on column DATA_CPAP_PHILIPS.indexrera
  is 'Respiratory event related arousal index';
comment on column DATA_CPAP_PHILIPS.cpapmin
  is 'Minimum CPAP pressure';
comment on column DATA_CPAP_PHILIPS.indexvariablebreathing
  is 'Variable breathing index';
comment on column DATA_CPAP_PHILIPS.inhaledtidalvolume
  is 'Average inhaled tidal volume';
comment on column DATA_CPAP_PHILIPS.titrationtotal
  is 'Percentage time of all breaths spent in inspiration';
comment on column DATA_CPAP_PHILIPS.settinghumidifier
  is 'The prescribed humidifier setting';
comment on column DATA_CPAP_PHILIPS.settingflex
  is 'The prescribed flex setting';
comment on column DATA_CPAP_PHILIPS.settingcpap
  is 'The prescribed CPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingcpapmin
  is 'The prescribed minimum CPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingcpapmax
  is 'The prescribed maximum CPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingipap
  is 'The prescribed IPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingipapmin
  is 'The prescribed minimum IPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingipapmax
  is 'The prescribed maximum IPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingepap
  is 'The prescribed EPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingepapmin
  is 'The prescribed minimum EPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingepapmax
  is 'The prescribed maximum EPAP pressure';
comment on column DATA_CPAP_PHILIPS.settingbreathrate
  is 'The prescribed breath rate setting';
comment on column DATA_CPAP_PHILIPS.settingpressuresupportmin
  is 'The prescribed minimum pressure support setting';
comment on column DATA_CPAP_PHILIPS.settingpressuresupportmax
  is 'The prescribed maximum pressure support setting';
comment on column DATA_CPAP_PHILIPS.settingpressuremax
  is 'The prescribed maximum pressure';
comment on column DATA_CPAP_PHILIPS.pcpupin
  is 'The UPIN/NPI of the primary care physician assigned to the patient';
comment on column DATA_CPAP_PHILIPS.sleepdrupin
  is 'The UPIN/NPI of the sleep doctor assigned to the patient';
comment on column DATA_CPAP_PHILIPS.device
  is 'The model name of the prescribed device';
comment on column DATA_CPAP_PHILIPS.therapymode
  is 'The prescribed therapy mode';
comment on column DATA_CPAP_PHILIPS.modemrx
  is 'True if a modem is prescribed to the patient';
comment on column DATA_CPAP_PHILIPS.clinicianname
  is 'The full name of the clinician assigned to the patient (family, given middle)';
comment on column DATA_CPAP_PHILIPS.patientactive
  is 'True if the patient is active, false otherwise';
comment on column DATA_CPAP_PHILIPS.patientcompany
  is 'The name of the company managing this patient';
comment on column DATA_CPAP_PHILIPS.patientfirstname
  is 'The first name of the patient';
comment on column DATA_CPAP_PHILIPS.patientmiddlename
  is 'The middle name of the patient';
comment on column DATA_CPAP_PHILIPS.patientlastname
  is 'The last name of the patient';
comment on column DATA_CPAP_PHILIPS.patientdateofbirth
  is 'The date of birth for the patient';
comment on column DATA_CPAP_PHILIPS.usageminutes
  is 'The blower or connect time, depending on the patient settings in EA/EP2';
comment on column DATA_CPAP_PHILIPS.deviceserial
  is 'The serial number of the prescribed device';
comment on column DATA_CPAP_PHILIPS.primaryinsuranceprovidername
  is 'The name of the primary insurance provider';
comment on column DATA_CPAP_PHILIPS.primaryinsuranceplanname
  is 'The name of the plan for the primary insurance policy';
comment on column DATA_CPAP_PHILIPS.primaryinsurancegroupnumber
  is 'The group number of the primary insurance policy';
comment on column DATA_CPAP_PHILIPS.primaryinsurancepolicynumber
  is 'The policy number of the primary insurance policy';
comment on column DATA_CPAP_PHILIPS.primaryinspolicyholdername
  is 'The name of the policyholder of the primary insurance policy';
comment on column DATA_CPAP_PHILIPS.primaryinspolicyholderrelship
  is 'The patient’s relationship to the policyholder of the primary insurance policy';
comment on column DATA_CPAP_PHILIPS.primaryinsproviderexternid
  is 'The external ID of primary insurance provider';
comment on column DATA_CPAP_PHILIPS.secondaryinsprovidername
  is 'The name of the secondary insurance provider';
comment on column DATA_CPAP_PHILIPS.secondaryinsuranceplanname
  is 'The name of the plan for the secondary insurance policy';
comment on column DATA_CPAP_PHILIPS.secondaryinsurancegroupnumber
  is 'The group number of the secondary insurance policy';
comment on column DATA_CPAP_PHILIPS.secondaryinsurancepolicynumber
  is 'The policy number of the secondary insurance policy';
comment on column DATA_CPAP_PHILIPS.secondaryinspolicyholdername
  is 'The name of the policyholder of the secondary insurance policy';
comment on column DATA_CPAP_PHILIPS.secondaryinspolicyholderrelshp
  is 'The patient’s relationship to the policyholder of the secondary insurance policy';
comment on column DATA_CPAP_PHILIPS.secondaryinsproviderexternalid
  is 'The external ID of secondary insurance provider';
comment on column DATA_CPAP_PHILIPS.settingdominanthumidifimethod
  is 'The humidification method used the majority of the time';
comment on column DATA_CPAP_PHILIPS.classichumidificationminutes
  is 'Total time in classic humidification mode';
comment on column DATA_CPAP_PHILIPS.systemonehumidificationminutes
  is 'Total time in System One humidification mode';
comment on column DATA_CPAP_PHILIPS.heatedtubehumidificationmins
  is 'Total time in heated tube humidification mode';
comment on column DATA_CPAP_PHILIPS.passoverhumidificationminutes
  is 'Total time in pass over humidification mode';
comment on column DATA_CPAP_PHILIPS.disconnectedhumidiminutes
  is 'Total time in disconnected humidification mode';
comment on column DATA_CPAP_PHILIPS.errorhumidificationminutes
  is 'Total time in humidification mode with error';
comment on column DATA_CPAP_PHILIPS.heatedtubesettingavg
  is 'Average heated tube setting';
comment on column DATA_CPAP_PHILIPS.humiditylevelsettingavg
  is 'Average humidity level setting';
comment on column DATA_CPAP_PHILIPS.humidifiersettingavg
  is 'Average humidifier setting';
comment on column DATA_CPAP_PHILIPS.ambienttemperatureavg
  is 'Average ambient temperature';
comment on column DATA_CPAP_PHILIPS.ambienthumidityavg
  is 'Average ambient humidity';
comment on column DATA_CPAP_PHILIPS.import_status
  is '0 = waiting to process, 1=processed, 2=error';
comment on column DATA_CPAP_PHILIPS.date_imported
  is 'date the record was added to this table';
comment on column DATA_CPAP_PHILIPS.date_processed
  is 'date this record was processed';
comment on column DATA_CPAP_PHILIPS.import_status_cmnt
  is 'comment on import status';
comment on column DATA_CPAP_PHILIPS.import_patient_id
  is 'patient_id the data was imported to';
comment on column DATA_CPAP_PHILIPS.import_device_id
  is 'device id the data was imported to';

prompt
prompt Creating table DATA_CPAP_RESMED
prompt ===============================
prompt
create table DATA_CPAP_RESMED
(
  organizationname      VARCHAR2(255),
  extract_date_tm       VARCHAR2(255),
  sessiondate           VARCHAR2(255),
  status                VARCHAR2(255),
  effectivedate         VARCHAR2(255),
  ecoid                 VARCHAR2(255),
  patientid             VARCHAR2(255),
  lastname              VARCHAR2(255),
  firstname             VARCHAR2(255),
  dob                   VARCHAR2(255),
  gender                VARCHAR2(255),
  location              VARCHAR2(255),
  clinicaluser          VARCHAR2(255),
  provider1             VARCHAR2(255),
  masktype              VARCHAR2(255),
  masksize              VARCHAR2(255),
  commmoduletype        VARCHAR2(255),
  commmodulesn          VARCHAR2(255),
  devicesn              VARCHAR2(255),
  devicetype            VARCHAR2(255),
  devicemode            VARCHAR2(255),
  usagehours            VARCHAR2(255),
  usagethreshold        VARCHAR2(255),
  leakthreshold         VARCHAR2(255),
  cpappresssett         VARCHAR2(255),
  minautosetpresssett   VARCHAR2(255),
  maxautosetpresssett   VARCHAR2(255),
  ipapsetting           VARCHAR2(255),
  epapsetting           VARCHAR2(255),
  ai                    VARCHAR2(255),
  hi                    VARCHAR2(255),
  ahi                   VARCHAR2(255),
  cai                   VARCHAR2(255),
  oai                   VARCHAR2(255),
  uai                   VARCHAR2(255),
  apneapercentage       VARCHAR2(255),
  leakmedian            VARCHAR2(255),
  leak95thpct           VARCHAR2(255),
  leakmax               VARCHAR2(255),
  pressuremedian        VARCHAR2(255),
  pressure95thpct       VARCHAR2(255),
  pressuremax           VARCHAR2(255),
  eprlevel              VARCHAR2(255),
  eprmode               VARCHAR2(255),
  exppresmedian         VARCHAR2(255),
  exppressure95thpct    VARCHAR2(255),
  exppressuremax        VARCHAR2(255),
  insppressuremedian    VARCHAR2(255),
  insppressure95thpct   VARCHAR2(255),
  insppressuremax       VARCHAR2(255),
  ieratiomedian         VARCHAR2(255),
  ieratio95thpct        VARCHAR2(255),
  ieratiomax            VARCHAR2(255),
  minventmedian         VARCHAR2(255),
  minvent95thpct        VARCHAR2(255),
  minventmax            VARCHAR2(255),
  respratemedian        VARCHAR2(255),
  resprate95thpct       VARCHAR2(255),
  respratemax           VARCHAR2(255),
  tidalvolumemedian     VARCHAR2(255),
  tidalvolume95thpct    VARCHAR2(255),
  tidalvolumemax        VARCHAR2(255),
  pctsponttriggbreaths  VARCHAR2(255),
  pctspontcycledbreaths VARCHAR2(255),
  addressline1          VARCHAR2(255),
  addressline2          VARCHAR2(255),
  city                  VARCHAR2(255),
  country               VARCHAR2(255),
  state                 VARCHAR2(255),
  zip                   VARCHAR2(255),
  dayphone1             VARCHAR2(255),
  dayphone2             VARCHAR2(255),
  nightphone1           VARCHAR2(255),
  email                 VARCHAR2(255),
  prov1pin#             VARCHAR2(255),
  prov1license          VARCHAR2(255),
  prov2                 VARCHAR2(255),
  prov2pin#             VARCHAR2(255),
  prov2license          VARCHAR2(255),
  devicemanufacturer    VARCHAR2(255),
  import_status         NUMBER default 0,
  date_imported         DATE default sysdate,
  date_processed        DATE,
  import_status_cmnt    VARCHAR2(255),
  import_patient_id     VARCHAR2(255),
  import_device_id      NUMBER,
  import_timestamp      TIMESTAMP(6) default systimestamp
)
;
comment on column DATA_CPAP_RESMED.organizationname
  is 'Organization Name';
comment on column DATA_CPAP_RESMED.extract_date_tm
  is 'MMM DD YYYY hh:MM AM/PM The date and time when the report is generated. NOTE Format change from ResTraxx';
comment on column DATA_CPAP_RESMED.sessiondate
  is 'MM/DD/YY The date the session was recorded. Session is a treatment session';
comment on column DATA_CPAP_RESMED.status
  is 'Will always be active. Legacy field from ResTraxx';
comment on column DATA_CPAP_RESMED.effectivedate
  is 'MM/DD/YY The patient setup date';
comment on column DATA_CPAP_RESMED.ecoid
  is 'GUID Patient unique id: 36 characters comprised of 32 alphanumeric characters + 4 hyphens';
comment on column DATA_CPAP_RESMED.patientid
  is 'Patient Identification entered by the user. Optional field';
comment on column DATA_CPAP_RESMED.lastname
  is 'Patient Last Name';
comment on column DATA_CPAP_RESMED.firstname
  is 'Patient First Name';
comment on column DATA_CPAP_RESMED.dob
  is 'MM/DD/YYYY Date of birth';
comment on column DATA_CPAP_RESMED.gender
  is 'Patient''s gender';
comment on column DATA_CPAP_RESMED.location
  is 'Patient location';
comment on column DATA_CPAP_RESMED.clinicaluser
  is 'Clinical User';
comment on column DATA_CPAP_RESMED.provider1
  is 'The first Physician or Physician organization that is associated with this patient';
comment on column DATA_CPAP_RESMED.masktype
  is 'The patient''s mask type';
comment on column DATA_CPAP_RESMED.masksize
  is 'The patient''s mask size';
comment on column DATA_CPAP_RESMED.commmoduletype
  is 'This field shall be "S9 Wireless" for patients that are monitored wirelessly. This field shall be empty if only card
monitoring is in use for this patient';
comment on column DATA_CPAP_RESMED.commmodulesn
  is 'This field shall be the serial number of the wireless monitoring device if wirelessly monitored otherwise this field
shall be empty if only card monitoring is in use for this patient';
comment on column DATA_CPAP_RESMED.devicesn
  is 'The flow generator serial number';
comment on column DATA_CPAP_RESMED.devicetype
  is 'The actual flow generator type configured for the patient, i.e. S9 Escape, S9 AutoSet, S8 AutoSet, etc';
comment on column DATA_CPAP_RESMED.devicemode
  is 'The actual flow generator mode configured for the patient';
comment on column DATA_CPAP_RESMED.usagehours
  is 'HH:MM';
comment on column DATA_CPAP_RESMED.usagethreshold
  is 'Hard coded to 4';
comment on column DATA_CPAP_RESMED.leakthreshold
  is 'Leak Threshold (L/sec)';
comment on column DATA_CPAP_RESMED.cpappresssett
  is 'CPAP Pressure Setting (cmH2O)';
comment on column DATA_CPAP_RESMED.minautosetpresssett
  is 'Min AutoSet Pressure Setting (cmH2O)';
comment on column DATA_CPAP_RESMED.maxautosetpresssett
  is 'Max AutoSet Pressure Setting (cmH2O)';
comment on column DATA_CPAP_RESMED.ipapsetting
  is 'IPAP Setting (cmH2O)';
comment on column DATA_CPAP_RESMED.epapsetting
  is 'EPAP Setting (cmH2O)';
comment on column DATA_CPAP_RESMED.ai
  is 'Al (e/hr)';
comment on column DATA_CPAP_RESMED.hi
  is 'HI (e/hr)';
comment on column DATA_CPAP_RESMED.ahi
  is 'AHI (e/hr)';
comment on column DATA_CPAP_RESMED.cai
  is 'CAI (e/hr)';
comment on column DATA_CPAP_RESMED.oai
  is 'OAI (e/hr)';
comment on column DATA_CPAP_RESMED.uai
  is 'UAI (e/hr)';
comment on column DATA_CPAP_RESMED.apneapercentage
  is 'Will always be empty. Legacy field from ResTraxx';
comment on column DATA_CPAP_RESMED.leakmedian
  is 'Leak Median (L/sec)';
comment on column DATA_CPAP_RESMED.leak95thpct
  is 'Leak 95th Percentile (L/sec)';
comment on column DATA_CPAP_RESMED.leakmax
  is 'Leak Max (L/sec)';
comment on column DATA_CPAP_RESMED.pressuremedian
  is 'Pressure Median (cmH2O)';
comment on column DATA_CPAP_RESMED.pressure95thpct
  is 'Pressure 95th Percentile (cmH2O)';
comment on column DATA_CPAP_RESMED.pressuremax
  is 'Pressure Max (cmH2O)';
comment on column DATA_CPAP_RESMED.eprlevel
  is 'Display the numeric EPR Level e.g. "3"';
comment on column DATA_CPAP_RESMED.eprmode
  is 'Display the EPR Mode e.g. "Fulltime"';
comment on column DATA_CPAP_RESMED.exppresmedian
  is 'Expiratory Pressure (EPAP) Median (cmH2O)';
comment on column DATA_CPAP_RESMED.exppressure95thpct
  is 'Expiratory Pressure (EPAP) 95th Percentile (cmH2O)';
comment on column DATA_CPAP_RESMED.exppressuremax
  is 'Expiratory Pressure (EPAP) Max (cmH2O)';
comment on column DATA_CPAP_RESMED.insppressuremedian
  is 'Inspiratory Pressure (IPAP) Median (cmH2O)';
comment on column DATA_CPAP_RESMED.insppressure95thpct
  is 'Inspiratory Pressure (IPAP) 95th Percentile (cmH2O)';
comment on column DATA_CPAP_RESMED.insppressuremax
  is 'Inspiratory Pressure (IPAP) Max (cmH2O)';
comment on column DATA_CPAP_RESMED.ieratiomedian
  is 'I:E Ratio Median';
comment on column DATA_CPAP_RESMED.ieratio95thpct
  is 'I:E Ratio 95th Percentile';
comment on column DATA_CPAP_RESMED.ieratiomax
  is 'I:E Ratio Max';
comment on column DATA_CPAP_RESMED.minventmedian
  is 'Minute Ventilation Median (L/min)';
comment on column DATA_CPAP_RESMED.minvent95thpct
  is 'Minute Ventilation 95th Percentile (L/min)';
comment on column DATA_CPAP_RESMED.minventmax
  is 'Minute Ventilation Max (L/min)';
comment on column DATA_CPAP_RESMED.respratemedian
  is 'Respiratory Rate Median (bpm)';
comment on column DATA_CPAP_RESMED.resprate95thpct
  is 'Respiratory Rate 95th Percentile (bpm)';
comment on column DATA_CPAP_RESMED.respratemax
  is 'Respiratory Rate Max (bpm)';
comment on column DATA_CPAP_RESMED.tidalvolumemedian
  is 'Tidal Volume Median (ml)';
comment on column DATA_CPAP_RESMED.tidalvolume95thpct
  is 'Tidal Volume 95th Percentile (ml)';
comment on column DATA_CPAP_RESMED.tidalvolumemax
  is 'Tidal Volume Max (ml)';
comment on column DATA_CPAP_RESMED.pctsponttriggbreaths
  is '% Spontaneous triggered breaths';
comment on column DATA_CPAP_RESMED.pctspontcycledbreaths
  is '% Spontaneous cycled breaths';
comment on column DATA_CPAP_RESMED.addressline1
  is 'Address (line1)';
comment on column DATA_CPAP_RESMED.addressline2
  is 'Address (line 2)';
comment on column DATA_CPAP_RESMED.city
  is 'City';
comment on column DATA_CPAP_RESMED.country
  is 'Country';
comment on column DATA_CPAP_RESMED.state
  is 'State / Province';
comment on column DATA_CPAP_RESMED.zip
  is 'Zip / Post Code';
comment on column DATA_CPAP_RESMED.dayphone1
  is 'Work phone number';
comment on column DATA_CPAP_RESMED.dayphone2
  is 'Mobile phone number';
comment on column DATA_CPAP_RESMED.nightphone1
  is 'Home phone number';
comment on column DATA_CPAP_RESMED.email
  is 'Email';
comment on column DATA_CPAP_RESMED.prov1pin#
  is 'ID number from UI';
comment on column DATA_CPAP_RESMED.prov1license
  is 'NPI number from UI';
comment on column DATA_CPAP_RESMED.prov2
  is 'Provider Name';
comment on column DATA_CPAP_RESMED.prov2pin#
  is 'ID number from UI';
comment on column DATA_CPAP_RESMED.prov2license
  is 'NPI number from UI';
comment on column DATA_CPAP_RESMED.devicemanufacturer
  is 'Static text field with value: ''ResMed''. Legacy field from Restraxx';
comment on column DATA_CPAP_RESMED.import_status
  is '0 = waiting to process, 1=processed, 2=error';
comment on column DATA_CPAP_RESMED.date_imported
  is 'date the record was added to this table';
comment on column DATA_CPAP_RESMED.date_processed
  is 'date this record was processed';
comment on column DATA_CPAP_RESMED.import_status_cmnt
  is 'comment about import';
comment on column DATA_CPAP_RESMED.import_patient_id
  is 'patient id data imported to';
comment on column DATA_CPAP_RESMED.import_device_id
  is 'device id imported to';

prompt
prompt Creating table TREATMENT
prompt ========================
prompt
create table TREATMENT
(
  treatment_id                NUMBER(11) default 0 not null,
  patient_id                  VARCHAR2(50) not null,
  referal_id                  NUMBER(5) default 0,
  initial_visit_date          DATE,
  education_start_date        DATE,
  active_completion_date      DATE,
  aftercare_completion_date   DATE,
  suspense_date               DATE,
  completed_date              DATE,
  treatment_status_id         NUMBER(11),
  supervisor_performance_id   NUMBER(11),
  owner_location_id           NUMBER(11),
  reason_treatment_terminated VARCHAR2(4000),
  case_closed                 NUMBER(1) default 0,
  referal_source              VARCHAR2(150),
  level_of_care_id            NUMBER(5) default 0,
  disposition_id              NUMBER(5) default 0,
  refused_treatment           NUMBER(11) default 0,
  failed_treatment            NUMBER default 0,
  last_updated                DATE,
  last_updated_by             NUMBER,
  sleep_study_date            DATE,
  baseline_ahi                NUMBER
)
;
create index DISPOSITION_ID on TREATMENT (DISPOSITION_ID);
create index LEVEL_OF_CARE_ID on TREATMENT (LEVEL_OF_CARE_ID);
create index PATIENT_ID_11 on TREATMENT (PATIENT_ID);
create index REFERAL_ID on TREATMENT (REFERAL_ID);
create index TREATMENT_ID_6 on TREATMENT (TREATMENT_ID);
alter table TREATMENT
  add constraint PK_TREATMENT primary key (TREATMENT_ID, PATIENT_ID);

prompt
prompt Creating table ENCOUNTER
prompt ========================
prompt
create table ENCOUNTER
(
  encounter_id             VARCHAR2(50) not null,
  encounter_date           DATE,
  treatment_id             NUMBER(11) default 0 not null,
  patient_id               VARCHAR2(50) not null,
  encounter_type_id        NUMBER(5) default 0,
  followup_date            DATE,
  patient_height           FLOAT default 0 not null,
  patient_weight           FLOAT default 0 not null,
  encounter_diagnosis      VARCHAR2(4000),
  provider_signature_id    VARCHAR2(50),
  date_signed              DATE,
  mh_subjective            VARCHAR2(4000),
  mh_objective             VARCHAR2(4000),
  mh_assessment            VARCHAR2(4000),
  mh_plan                  VARCHAR2(4000),
  mh_provider_signature_id VARCHAR2(50),
  mh_date_signed           DATE,
  pt_appearance            VARCHAR2(80),
  pt_eye_contact           VARCHAR2(80),
  pt_attitude              VARCHAR2(80),
  pt_mood                  VARCHAR2(80),
  pt_affect                VARCHAR2(80),
  pt_attention             VARCHAR2(80),
  pt_thought_process       VARCHAR2(80),
  pt_thought_content       VARCHAR2(80),
  pt_judgment              VARCHAR2(80),
  pt_insight               VARCHAR2(80),
  pt_memory                VARCHAR2(80),
  hallucination_evidence   VARCHAR2(80),
  suicidal_evidence        VARCHAR2(80),
  mh_addendum              VARCHAR2(4000),
  fit_for_duty             VARCHAR2(80),
  suicide_risk             VARCHAR2(80),
  records_maintained_at    VARCHAR2(255) default '',
  mh_records_maintained_at VARCHAR2(255) default '',
  mh_plan_prevention       VARCHAR2(4000) default '',
  session_time             VARCHAR2(50),
  mh_session_time          VARCHAR2(50),
  tech_signature_id        VARCHAR2(50),
  tech_date_signed         DATE,
  adc_signature_id         VARCHAR2(50),
  adc_date_signed          DATE,
  closed                   NUMBER default 0,
  dlc_id                   NUMBER(5) default 0,
  ad_provider_signature_id VARCHAR2(50),
  ad_provider_date_signed  DATE,
  ad_adc_signature_id      VARCHAR2(50),
  ad_adc_date_signed       DATE,
  ad_tech_signature_id     VARCHAR2(50),
  ad_tech_date_signed      DATE,
  dlc_justification        VARCHAR2(4000),
  treatment_plan           CLOB,
  last_updated             DATE,
  last_updated_by          NUMBER,
  addendum_save            CLOB,
  subjective               CLOB,
  objective                CLOB,
  assessment               CLOB,
  plan                     CLOB,
  plan_prevention          CLOB,
  addendum                 CLOB,
  belongs_to               VARCHAR2(50)
)
;
comment on column ENCOUNTER.last_updated
  is 'date last updated/inserted';
comment on column ENCOUNTER.last_updated_by
  is 'fx_user_id ';
comment on column ENCOUNTER.addendum_save
  is 'Hold Addendum Until Signed';
create index ENCOUNTER_NDX_PID on ENCOUNTER (PATIENT_ID);
create index ENCOUNTER_TYPE_ID on ENCOUNTER (ENCOUNTER_TYPE_ID);
create index MH_PROVIDER_SIGNATURE_ID on ENCOUNTER (MH_PROVIDER_SIGNATURE_ID);
alter table ENCOUNTER
  add constraint PK_ENCOUNTER primary key (ENCOUNTER_ID);
alter table ENCOUNTER
  add constraint TREATMENTENCOUNTER foreign key (TREATMENT_ID, PATIENT_ID)
  references TREATMENT (TREATMENT_ID, PATIENT_ID) on delete cascade
  disable;

prompt
prompt Creating table ENCOUNTER_INTAKE
prompt ===============================
prompt
create table ENCOUNTER_INTAKE
(
  encounter_id        VARCHAR2(50) not null,
  encounter_intake_id NUMBER(5) not null,
  mid                 NUMBER(5) default 0 not null,
  intake_type         NUMBER(5) default 0,
  score               NUMBER(11) default 0,
  read_only           NUMBER(3) default 0 not null,
  complete            NUMBER(11),
  alternate_language  NUMBER default 0,
  review_encounter_id VARCHAR2(50),
  review_provider_id  VARCHAR2(50),
  review_date         DATE,
  stat_modality_id    NUMBER,
  intake_group_id     NUMBER
)
;
comment on column ENCOUNTER_INTAKE.complete
  is 'added to support patient portal';
comment on column ENCOUNTER_INTAKE.alternate_language
  is 'added to support patient portal 0=english, 1 = spanish';
comment on column ENCOUNTER_INTAKE.review_encounter_id
  is 'enc id that reviewed the intake';
create index ENCOUNTER_ID00001 on ENCOUNTER_INTAKE (ENCOUNTER_ID);
create index ENCOUNTER_INTAKE_ID00000 on ENCOUNTER_INTAKE (ENCOUNTER_INTAKE_ID);
create index MID00000 on ENCOUNTER_INTAKE (MID);
alter table ENCOUNTER_INTAKE
  add constraint ENCOUNTER_INTAKE_PK primary key (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID);

prompt
prompt Creating table ENCOUNTER_INTAKE_FLAG
prompt ====================================
prompt
create table ENCOUNTER_INTAKE_FLAG
(
  encounter_id          VARCHAR2(50) not null,
  encounter_intake_id   NUMBER(5) not null,
  flag_id               NUMBER(11) default 0 not null,
  mid                   NUMBER(5) default 0 not null,
  session_flag_tx       VARCHAR2(4000) not null,
  visible               NUMBER(3),
  severity_code         NUMBER(11) default 0,
  problemtoflag_id      NUMBER(11),
  rid                   NUMBER,
  flag_type             NUMBER,
  patient_approved      NUMBER(2) default 1,
  priority              NUMBER(2),
  tid                   NUMBER(2),
  report_type_id        NUMBER(2),
  flag_group            NUMBER(2),
  qid                   NUMBER(3),
  status                NUMBER(2) default 0,
  problem_status        NUMBER(2) default 0,
  ignore_intake_problem NUMBER(1) default 0
)
;
comment on column ENCOUNTER_INTAKE_FLAG.rid
  is 'added to support patient portal';
comment on column ENCOUNTER_INTAKE_FLAG.flag_type
  is 'added to support patient portal';
comment on column ENCOUNTER_INTAKE_FLAG.patient_approved
  is 'added to support patient portal';
comment on column ENCOUNTER_INTAKE_FLAG.priority
  is 'added to support patient portal priority within a flag group';
comment on column ENCOUNTER_INTAKE_FLAG.tid
  is 'added to support patient portal ';
comment on column ENCOUNTER_INTAKE_FLAG.report_type_id
  is 'added to support patient portal 1 = patient, 2 = provider bullet, 3 = provider full';
comment on column ENCOUNTER_INTAKE_FLAG.flag_group
  is 'added to support patient portal Associates related flags';
comment on column ENCOUNTER_INTAKE_FLAG.status
  is '// 0 - NOT DONE; 1 - DONE';
comment on column ENCOUNTER_INTAKE_FLAG.problem_status
  is '// 0 - Potential; 1 - Actual';
comment on column ENCOUNTER_INTAKE_FLAG.ignore_intake_problem
  is '//1 - Stop suggesting this problem in the Possible Problems List';
create index ENCOUNTER_ID00002 on ENCOUNTER_INTAKE_FLAG (ENCOUNTER_ID);
create index ENCOUNTER_INTAKEENCOUNTER_INT on ENCOUNTER_INTAKE_FLAG (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID);
create index ENCOUNTER_INTAKE_ID00001 on ENCOUNTER_INTAKE_FLAG (ENCOUNTER_INTAKE_ID);
create index FLAG_ID00000 on ENCOUNTER_INTAKE_FLAG (FLAG_ID);
create index MID00002 on ENCOUNTER_INTAKE_FLAG (MID);
alter table ENCOUNTER_INTAKE_FLAG
  add constraint ENCOUNTER_INTAKE_FLAG_PK primary key (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID, FLAG_ID);
alter table ENCOUNTER_INTAKE_FLAG
  add constraint ENCOUNTER_INTAKE_FLAG_FK01 foreign key (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID)
  references ENCOUNTER_INTAKE (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID)
  disable;

prompt
prompt Creating table ENCOUNTER_INTAKE_RESPONSES
prompt =========================================
prompt
create table ENCOUNTER_INTAKE_RESPONSES
(
  encounter_id        VARCHAR2(50) not null,
  encounter_intake_id NUMBER(5) not null,
  rid                 NUMBER(5) not null,
  mid                 NUMBER(5) not null,
  tid                 NUMBER(5) not null,
  qid                 NUMBER(5) not null,
  response_type       NUMBER(5) default 0,
  response_value      VARCHAR2(4000),
  score_value         NUMBER(11) default 0,
  response_datetime   DATE,
  response_time       NUMBER,
  intake_group_id     NUMBER
)
;
comment on column ENCOUNTER_INTAKE_RESPONSES.response_datetime
  is 'added to support patient portal';
comment on column ENCOUNTER_INTAKE_RESPONSES.response_time
  is 'added to support patient portal';
create index ENCOUNTER_ID00003 on ENCOUNTER_INTAKE_RESPONSES (ENCOUNTER_ID);
create index ENCOUNTER_INTAKEENCOUNTE00000 on ENCOUNTER_INTAKE_RESPONSES (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID);
create index ENCOUNTER_INTAKE_RESPONS00000 on ENCOUNTER_INTAKE_RESPONSES (RID);
alter table ENCOUNTER_INTAKE_RESPONSES
  add constraint PRIMARYKEY00014 primary key (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID, RID, MID, TID, QID);

prompt
prompt Creating table ENCOUNTER_INTAKE_SCORE
prompt =====================================
prompt
create table ENCOUNTER_INTAKE_SCORE
(
  encounter_id        VARCHAR2(50) not null,
  encounter_intake_id NUMBER(5) not null,
  intake_score_id     NUMBER(11) default 0 not null,
  mid                 NUMBER(5) default 0,
  score_type          NUMBER(11) default 0,
  score               NUMBER default 0,
  pcent               NUMBER(11),
  interpret           VARCHAR2(255),
  series              NUMBER default 1,
  intake_group_id     NUMBER
)
;
create index ENCOUNTER_ID00004 on ENCOUNTER_INTAKE_SCORE (ENCOUNTER_ID);
create index ENCOUNTER_INTAKEENCOUNTE00001 on ENCOUNTER_INTAKE_SCORE (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID);
create index ENCOUNTER_INTAKE_ID00002 on ENCOUNTER_INTAKE_SCORE (ENCOUNTER_INTAKE_ID);
create index INTAKE_SCORE_ID00000 on ENCOUNTER_INTAKE_SCORE (INTAKE_SCORE_ID);
create index MID00003 on ENCOUNTER_INTAKE_SCORE (MID);
create index STAT_INTAKE_SCORE_ITEMENCOUNT on ENCOUNTER_INTAKE_SCORE (SCORE_TYPE);
alter table ENCOUNTER_INTAKE_SCORE
  add constraint PRIMARYKEY00015 primary key (ENCOUNTER_ID, ENCOUNTER_INTAKE_ID, INTAKE_SCORE_ID);

prompt
prompt Creating table ENCOUNTER_TIU_NOTE
prompt =================================
prompt
create table ENCOUNTER_TIU_NOTE
(
  patient_id        VARCHAR2(50),
  mdws_patient_id   NUMBER,
  mdws_user_id      VARCHAR2(200),
  clinic_id         NUMBER,
  note_title_ien    VARCHAR2(200),
  treatment_id      NUMBER,
  encounter_id      VARCHAR2(50),
  mdws_encounter_id VARCHAR2(200),
  note_result_id    VARCHAR2(200),
  visit_timestamp   VARCHAR2(20),
  note_date         DATE,
  mdws_region_id    NUMBER,
  mdws_site_id      NUMBER
)
;

prompt
prompt Creating table FX_AUDIT
prompt =======================
prompt
create table FX_AUDIT
(
  db_session_id VARCHAR2(500),
  client_ip     VARCHAR2(500),
  fx_user_id    NUMBER,
  audit_date    DATE,
  audit_name    VARCHAR2(500),
  audit_data    CLOB
)
;

prompt
prompt Creating table FX_IPLOGIN_ATTEMPTS
prompt ==================================
prompt
create table FX_IPLOGIN_ATTEMPTS
(
  client_ip         VARCHAR2(500),
  login_attempts    NUMBER,
  date_last_attempt DATE,
  is_locked         NUMBER,
  lock_period       NUMBER
)
;
comment on column FX_IPLOGIN_ATTEMPTS.client_ip
  is 'ip of the user trying to login';
comment on column FX_IPLOGIN_ATTEMPTS.login_attempts
  is 'number of attempts';
comment on column FX_IPLOGIN_ATTEMPTS.date_last_attempt
  is 'date of last attempt';
comment on column FX_IPLOGIN_ATTEMPTS.is_locked
  is 'ip is locked';
comment on column FX_IPLOGIN_ATTEMPTS.lock_period
  is 'time in minutes to lock ip';

prompt
prompt Creating table FX_JOB_STATUS
prompt ============================
prompt
create table FX_JOB_STATUS
(
  job_date    DATE default sysdate,
  status_code NUMBER,
  job_status  CLOB,
  job_name    VARCHAR2(500)
)
;

prompt
prompt Creating table FX_PAGE_ACCESS
prompt =============================
prompt
create table FX_PAGE_ACCESS
(
  page_name    VARCHAR2(255),
  user_type    NUMBER,
  user_rights  NUMBER,
  active       NUMBER default 1,
  comments     VARCHAR2(255),
  is_logged_in NUMBER(2) default 1
)
;

prompt
prompt Creating table FX_RESTRICTED_NAME
prompt =================================
prompt
create table FX_RESTRICTED_NAME
(
  restricted_name VARCHAR2(50) not null
)
;
create index RESTRICTED_NAME_NDX01 on FX_RESTRICTED_NAME (RESTRICTED_NAME);

prompt
prompt Creating table FX_RIGHTS_TEMPLATE
prompt =================================
prompt
create table FX_RIGHTS_TEMPLATE
(
  user_rights NUMBER,
  read_only   NUMBER,
  user_type   NUMBER
)
;

prompt
prompt Creating table FX_SEC_QUESTIONS
prompt ===============================
prompt
create table FX_SEC_QUESTIONS
(
  fx_user_id      NUMBER,
  question_id_1   NUMBER,
  answer_1        VARCHAR2(255),
  question_id_2   NUMBER,
  answer_2        VARCHAR2(255),
  question_id_3   NUMBER,
  answer_3        VARCHAR2(255),
  answer_attempts NUMBER default 0,
  last_updated    DATE
)
;

prompt
prompt Creating table FX_SESSION
prompt =========================
prompt
create table FX_SESSION
(
  web_session_id   VARCHAR2(500),
  db_session_id    VARCHAR2(500),
  date_created     VARCHAR2(500),
  date_last_action VARCHAR2(500),
  fx_user_id       NUMBER,
  expired          NUMBER,
  client_ip        VARCHAR2(500)
)
;

prompt
prompt Creating table FX_SESSION_VALUE
prompt ===============================
prompt
create table FX_SESSION_VALUE
(
  db_session_id    VARCHAR2(1500),
  db_session_key   VARCHAR2(500),
  db_session_value VARCHAR2(4000),
  client_ip        VARCHAR2(500)
)
;

prompt
prompt Creating table FX_SETTINGS
prompt ==========================
prompt
create table FX_SETTINGS
(
  mail_smtp_host               VARCHAR2(4000),
  mail_smtp_sender             VARCHAR2(4000),
  mail_smtp_port               NUMBER,
  site_url                     VARCHAR2(4000),
  notify_email                 VARCHAR2(4000),
  has_military_detail          NUMBER(1) default 0,
  has_patient_supervisor_input NUMBER(1) default 0,
  has_patient_insurance        NUMBER(1) default 0,
  branch_of_service            NUMBER(1) default 0,
  texting_host                 VARCHAR2(4000),
  texting_port                 NUMBER,
  texting_user                 VARCHAR2(4000),
  texting_pswd                 VARCHAR2(4000),
  ora_win_dir                  VARCHAR2(4000)
)
;
comment on column FX_SETTINGS.mail_smtp_host
  is 'SMTP Mail Server IP Address';
comment on column FX_SETTINGS.mail_smtp_sender
  is 'Sender Email Address To Be Used In the Email To Field on Notification Emails';
comment on column FX_SETTINGS.mail_smtp_port
  is 'SMTP Mail Server Port ID';
comment on column FX_SETTINGS.site_url
  is 'Website URL';
comment on column FX_SETTINGS.notify_email
  is 'Email Address of Sys Admin Receiving Email Notifications';
comment on column FX_SETTINGS.has_military_detail
  is 'Flag Indicating Whether The Military Detail Tab Should be Shown';
comment on column FX_SETTINGS.has_patient_supervisor_input
  is 'Flag Indicating Whether The Supervisor Input Tab should be Shown';
comment on column FX_SETTINGS.has_patient_insurance
  is 'Flag Indicating Whether Patient Insurance Tab should be Shown';
comment on column FX_SETTINGS.branch_of_service
  is 'Field Identifying Patient''s Branch of Service - AirForce  = 1,
  Army = 2,
  Marines = 3,
  Navy = 4,
  Commercial = 5';
comment on column FX_SETTINGS.texting_host
  is 'Text Message Server IP Address';
comment on column FX_SETTINGS.texting_port
  is 'Text Message Server Port ID';
comment on column FX_SETTINGS.texting_user
  is 'Text Message Username';
comment on column FX_SETTINGS.texting_pswd
  is 'Text Message Password';

prompt
prompt Creating table FX_USER
prompt ======================
prompt
create table FX_USER
(
  fx_user_id            NUMBER not null,
  user_name             VARCHAR2(500),
  certificate           VARCHAR2(4000),
  is_locked             NUMBER,
  is_inactive           NUMBER,
  date_created          DATE,
  date_modified         DATE,
  updated_by            NUMBER,
  reset_password        NUMBER,
  date_password_changed DATE,
  date_last_login       DATE,
  session_timeout       NUMBER,
  login_attempts        NUMBER,
  password              VARCHAR2(1500),
  last_updated          DATE,
  last_updated_by       NUMBER,
  iv                    VARCHAR2(255),
  iv_pre                VARCHAR2(255),
  prev_pwd1             VARCHAR2(1500),
  prev_pwd2             VARCHAR2(1500),
  prev_pwd3             VARCHAR2(1500),
  prev_pwd4             VARCHAR2(1500),
  prev_pwd5             VARCHAR2(1500),
  prev_pwd6             VARCHAR2(1500),
  prev_pwd7             VARCHAR2(1500),
  prev_pwd8             VARCHAR2(1500),
  prev_pwd9             VARCHAR2(1500),
  prev_pwd10            VARCHAR2(1500),
  last_flogin_date      DATE,
  last_flogin_ip        VARCHAR2(25),
  last_login_ip         VARCHAR2(25),
  flogin_attempts       NUMBER,
  mdws_user_name        VARCHAR2(255),
  mdws_pwd              VARCHAR2(255),
  mdws_region_id        NUMBER,
  mdws_site_id          NUMBER,
  mdws_user_id          NUMBER,
  mdws_note_title_label VARCHAR2(200),
  mdws_note_clinic_id   NUMBER
)
;
comment on column FX_USER.fx_user_id
  is 'Unique User ID Tied To SUAT_USER Table';
comment on column FX_USER.user_name
  is 'User Name - Encrypted';
comment on column FX_USER.certificate
  is 'CAC Certificate - Encrypted';
comment on column FX_USER.is_locked
  is 'Flag Indicating Whether Account Is Locked';
comment on column FX_USER.is_inactive
  is 'Flag Indicating Whether Account Is Inactive';
comment on column FX_USER.date_created
  is 'Account Creation Date';
comment on column FX_USER.date_modified
  is 'Last Modified Date';
comment on column FX_USER.updated_by
  is 'FX User ID Of Last User To Modify Record ';
comment on column FX_USER.reset_password
  is 'Flag Indicating Whether User Needs To Reset Password';
comment on column FX_USER.date_password_changed
  is 'Date Of Last Password Change';
comment on column FX_USER.date_last_login
  is 'Date The Last Time The User Logged In';
comment on column FX_USER.session_timeout
  is 'Session Timeout IN Minutes';
comment on column FX_USER.login_attempts
  is 'Number of Unsuccessful Login Attempts';
comment on column FX_USER.password
  is 'Password - Encrypted';
comment on column FX_USER.last_updated
  is 'Date Last Updated';
comment on column FX_USER.last_updated_by
  is 'FX User ID Of Last User To Update';
comment on column FX_USER.prev_pwd1
  is 'Previous Password 1 of Last 10 Passwords';
comment on column FX_USER.prev_pwd2
  is 'Previous Password 2 of Last 10 Passwords';
comment on column FX_USER.prev_pwd3
  is 'Previous Password 3 of Last 10 Passwords';
comment on column FX_USER.prev_pwd4
  is 'Previous Password 4 of Last 10 Passwords';
comment on column FX_USER.prev_pwd5
  is 'Previous Password 5 of Last 10 Passwords';
comment on column FX_USER.prev_pwd6
  is 'Previous Password 5 of Last 10 Passwords';
comment on column FX_USER.prev_pwd7
  is 'Previous Password 6 of Last 10 Passwords';
comment on column FX_USER.prev_pwd8
  is 'Previous Password 8 of Last 10 Passwords';
comment on column FX_USER.prev_pwd9
  is 'Previous Password 9 of Last 10 Passwords';
comment on column FX_USER.prev_pwd10
  is 'Previous Password 10 of Last 10 Passwords';
comment on column FX_USER.last_flogin_date
  is 'Last Failed Login Date';
comment on column FX_USER.last_flogin_ip
  is 'Last Failed Login IP Address';
comment on column FX_USER.last_login_ip
  is 'Last Successful Login IP Address';
comment on column FX_USER.flogin_attempts
  is 'Number Of Failed Login Attempts';
alter table FX_USER
  add constraint FX_USER_KEY_PK primary key (FX_USER_ID);

prompt
prompt Creating table FX_USER_RIGHTS
prompt =============================
prompt
create table FX_USER_RIGHTS
(
  fx_user_id  NUMBER(11),
  user_rights NUMBER(32),
  read_only   NUMBER(32),
  user_type   NUMBER(32)
)
;

prompt
prompt Creating table INTAKE_FLAGS
prompt ===========================
prompt
create table INTAKE_FLAGS
(
  flag_id            NUMBER(11) default 0 not null,
  mid                NUMBER(5) default 0 not null,
  session_flag_tx    VARCHAR2(4000) not null,
  visible            NUMBER(3),
  session_flag_ed    VARCHAR2(4000),
  calc_type          VARCHAR2(10),
  calc_var           VARCHAR2(4000),
  calculated         NUMBER(11) default 0,
  severity_code      NUMBER(11) default 0,
  flag_type_id       NUMBER default 0 not null,
  identifier         VARCHAR2(50),
  session_flag_list  VARCHAR2(4000),
  priority           NUMBER(2),
  flag_target_id     NUMBER(3),
  risk_factor_id     NUMBER(4),
  tid                NUMBER(2),
  report_type_id     NUMBER(2),
  flag_group         NUMBER(2),
  alternate_language VARCHAR2(4000),
  flag_series        NUMBER(10),
  alt_lang_calc_var  VARCHAR2(4000)
)
;
comment on column INTAKE_FLAGS.flag_type_id
  is '99 is assessment completed';
comment on column INTAKE_FLAGS.identifier
  is 'added to support patient portal';
comment on column INTAKE_FLAGS.session_flag_list
  is 'added to support patient portal';
comment on column INTAKE_FLAGS.priority
  is 'added to support patient portal priority within a flag group';
comment on column INTAKE_FLAGS.flag_target_id
  is 'added to support patient portal ';
comment on column INTAKE_FLAGS.risk_factor_id
  is 'added to support patient portal NOT USED - mental health, behavioral health, chronic disease, family hist, etc, ';
comment on column INTAKE_FLAGS.tid
  is 'added to support patient portal ';
comment on column INTAKE_FLAGS.report_type_id
  is 'added to support patient portal 1 = patient, 2 = provider bullet, 3 = provider full';
comment on column INTAKE_FLAGS.flag_group
  is 'added to support patient portal Associates related flags';
comment on column INTAKE_FLAGS.alternate_language
  is 'added to support patient portal not used right now';
comment on column INTAKE_FLAGS.flag_series
  is 'added to support patient portal';
comment on column INTAKE_FLAGS.alt_lang_calc_var
  is 'added to support patient portal';
create index MID00005 on INTAKE_FLAGS (MID);
alter table INTAKE_FLAGS
  add constraint PRIMARYKEY00018 primary key (FLAG_ID);

prompt
prompt Creating table INTAKE_MODULE
prompt ============================
prompt
create table INTAKE_MODULE
(
  mid          NUMBER(5) default 0 not null,
  module       VARCHAR2(80) not null,
  active       NUMBER(5) not null,
  description  VARCHAR2(4000),
  sort_order   NUMBER(6) default 0 not null,
  render_graph NUMBER(2) default 0
)
;
comment on column INTAKE_MODULE.render_graph
  is '0: do not render this module scores in the graphic hub';
alter table INTAKE_MODULE
  add constraint PRIMARYKEY00022 primary key (MID);

prompt
prompt Creating table INTAKE_MODULE_GROUP
prompt ==================================
prompt
create table INTAKE_MODULE_GROUP
(
  module_group_id    NUMBER,
  module_group_descr VARCHAR2(255),
  sort_order         NUMBER,
  description        VARCHAR2(4000),
  event_id           NUMBER(4),
  active             NUMBER(2) default 1,
  stat_modality_id   NUMBER(4)
)
;

prompt
prompt Creating table INTAKE_MODULE_GROUP_MID
prompt ======================================
prompt
create table INTAKE_MODULE_GROUP_MID
(
  module_group_id NUMBER,
  mid             NUMBER,
  sort_order      NUMBER
)
;

prompt
prompt Creating table INTAKE_PROBLEM_CRITERIA
prompt ======================================
prompt
create table INTAKE_PROBLEM_CRITERIA
(
  intake_problem_id NUMBER(11) default 0,
  criteria_id       NUMBER(11) default 0,
  criteria          VARCHAR2(255) default 0,
  active            NUMBER,
  rid               VARCHAR2(255),
  mid               NUMBER
)
;

prompt
prompt Creating table INTAKE_PROBLEM_CRITERIA_DEF
prompt ==========================================
prompt
create table INTAKE_PROBLEM_CRITERIA_DEF
(
  intake_problem_id NUMBER(11) default 0,
  criteria_id       NUMBER(11) default 0,
  definition_id     NUMBER(11) default 0,
  definition        VARCHAR2(255),
  active            NUMBER,
  rid               VARCHAR2(64),
  mid               NUMBER
)
;

prompt
prompt Creating table INTAKE_PROBLEM_LIST
prompt ==================================
prompt
create table INTAKE_PROBLEM_LIST
(
  intake_problem_id NUMBER(11) default 0,
  flag_id           NUMBER(11) default 0,
  mid               NUMBER(11) default 0,
  problem           VARCHAR2(80),
  active            NUMBER(11) default 0,
  diagnosis_id      NUMBER(11),
  mh_axis           NUMBER
)
;
comment on column INTAKE_PROBLEM_LIST.diagnosis_id
  is 'diagnosis id';

prompt
prompt Creating table INTAKE_TOPIC
prompt ===========================
prompt
create table INTAKE_TOPIC
(
  mid                    NUMBER(5) default 0 not null,
  tid                    NUMBER(5) not null,
  topic                  VARCHAR2(1024) not null,
  del_taction            VARCHAR2(10),
  active                 NUMBER(5) not null,
  del_alternate_language VARCHAR2(1024),
  del_topic_image        VARCHAR2(255)
)
;
comment on column INTAKE_TOPIC.del_topic_image
  is 'added to support patient portal';
create index INTAKE_MODULEINTAKE_TOPIC00000 on INTAKE_TOPIC (MID);
alter table INTAKE_TOPIC
  add constraint PRIMARYKEY00106 primary key (MID, TID);
alter table INTAKE_TOPIC
  add foreign key (MID)
  references INTAKE_MODULE (MID)
  disable;

prompt
prompt Creating table INTAKE_QUESTION
prompt ==============================
prompt
create table INTAKE_QUESTION
(
  mid      NUMBER(5) default 0 not null,
  tid      NUMBER(5) not null,
  qid      NUMBER(5) default 0 not null,
  question VARCHAR2(4000),
  active   NUMBER
)
;
comment on column INTAKE_QUESTION.mid
  is 'Module identifier';
comment on column INTAKE_QUESTION.tid
  is 'Topic Identifier';
comment on column INTAKE_QUESTION.qid
  is 'Question Identifier';
comment on column INTAKE_QUESTION.question
  is 'Question Text in english';
comment on column INTAKE_QUESTION.active
  is '0 to decomission a question';
create index INTAKE_TOPICINTAKE_QUEST00000 on INTAKE_QUESTION (MID, TID);
alter table INTAKE_QUESTION
  add constraint PRIMARYKEY00104 primary key (MID, TID, QID);
alter table INTAKE_QUESTION
  add foreign key (MID, TID)
  references INTAKE_TOPIC (MID, TID)
  disable;

prompt
prompt Creating table INTAKE_RESPONSE
prompt ==============================
prompt
create table INTAKE_RESPONSE
(
  rid           NUMBER(5) not null,
  mid           NUMBER(5) default 0 not null,
  tid           NUMBER(5) not null,
  qid           NUMBER(5) not null,
  response      VARCHAR2(255) not null,
  display_type  NUMBER(5) default 0,
  response_type NUMBER(5) default 0,
  active        NUMBER,
  unit          VARCHAR2(80)
)
;
comment on column INTAKE_RESPONSE.rid
  is 'Response Identifier. Unique by Module';
comment on column INTAKE_RESPONSE.mid
  is 'Module Identifier';
comment on column INTAKE_RESPONSE.tid
  is 'Topic Identifier';
comment on column INTAKE_RESPONSE.qid
  is 'Question Identifier';
comment on column INTAKE_RESPONSE.response
  is 'Response text';
comment on column INTAKE_RESPONSE.display_type
  is 'Type of object that will be displayed for the response: RADIO		= 1;
CHECK		= 2;
TEXT		= 3;
COMBO BOX	= 4;
DATE		= 5;
HEIGHT		= 6;
WEIGHT		= 7;
LIST		= 8;
DATETIME	= 9;
BMI		= 10;
TITLE		= 11;
MONTHYEAR	= 12;
DUALCHOICE	= 13;
TRICHOICE	= 14;
TRICHOICETITLE = 15;
MEDBAR		= 16;
PROVENTRYBAR	= 17;
ALLERGYBAR	= 18;
FAMILYHXBAR	= 19;
COMBOHEIGHT	= 20;
DATEPICKER   	= 21;
NONEOFABOVE	= 99;';
comment on column INTAKE_RESPONSE.response_type
  is 'BOOL	= 1;
INTEGER = 2;
TEXT	= 3;
DATE	= 4;
PARSED	= 5;';
comment on column INTAKE_RESPONSE.unit
  is 'describes the unit of the response e.g. Pounds, inches, etc.';
create index INTAKE_QUESTIONINTAKE_RE00000 on INTAKE_RESPONSE (MID, TID, QID);
create index MID00012 on INTAKE_RESPONSE (MID);
create index QID00002 on INTAKE_RESPONSE (QID);
create index TID00002 on INTAKE_RESPONSE (TID);
alter table INTAKE_RESPONSE
  add constraint INTAKE_RESPONSE_KEY_PK primary key (RID, MID);
alter table INTAKE_RESPONSE
  add constraint INTAKE_RESPONSE_KEY_FK01 foreign key (MID, TID, QID)
  references INTAKE_QUESTION (MID, TID, QID)
  disable;

prompt
prompt Creating table MESSAGE_CONTENTS
prompt ===============================
prompt
create table MESSAGE_CONTENTS
(
  message_id  NUMBER not null,
  from_usr_id NUMBER,
  subject     VARCHAR2(255),
  body        CLOB,
  date_sent   DATE,
  sender_name VARCHAR2(255)
)
;
alter table MESSAGE_CONTENTS
  add constraint PK_MSG_ID primary key (MESSAGE_ID);

prompt
prompt Creating table MESSAGE_RECIPIENT
prompt ================================
prompt
create table MESSAGE_RECIPIENT
(
  message_id   NUMBER,
  recipient_id NUMBER,
  is_to        NUMBER,
  is_cc        NUMBER,
  is_bcc       NUMBER,
  unread       NUMBER,
  deleted      NUMBER,
  is_sender    NUMBER default 0
)
;
alter table MESSAGE_RECIPIENT
  add constraint FK_MSG_ID foreign key (MESSAGE_ID)
  references MESSAGE_CONTENTS (MESSAGE_ID) on delete cascade;

prompt
prompt Creating table PATIENT_DEMOGRAPHICS
prompt ===================================
prompt
create table PATIENT_DEMOGRAPHICS
(
  patient_id         VARCHAR2(50) not null,
  first_name         VARCHAR2(128) not null,
  mi                 VARCHAR2(128),
  last_name          VARCHAR2(128) not null,
  fmp                VARCHAR2(128),
  sponsor_ssn        VARCHAR2(128),
  ssn                VARCHAR2(128),
  gender             VARCHAR2(128),
  marital_status_id  NUMBER(5) default 0,
  dob                VARCHAR2(128),
  has_firarm         NUMBER(1) default 0,
  education_level_id NUMBER(5) default 0,
  provider_id        VARCHAR2(50),
  address1           VARCHAR2(80),
  address2           VARCHAR2(80),
  city               VARCHAR2(50),
  postal_code        VARCHAR2(50),
  homephone          VARCHAR2(20),
  workphone          VARCHAR2(20),
  email              VARCHAR2(128),
  state_id           NUMBER(11) default 0,
  has_referal        NUMBER(5) default 0,
  awaiting_transfer  NUMBER,
  transfer_dmis_id   VARCHAR2(255),
  edipn              VARCHAR2(12),
  fx_user_id         NUMBER,
  last_updated       DATE,
  last_updated_by    NUMBER,
  is_high_interest   NUMBER(1),
  portal_user_id     NUMBER(11),
  current_weight     NUMBER,
  current_height     NUMBER,
  wrk_phone_call     NUMBER default 0,
  home_phone_call    NUMBER default 0,
  home_phone_msg     NUMBER default 0,
  email_msg          NUMBER default 0,
  device_id          NUMBER,
  cellphone          VARCHAR2(20),
  cell_phone_call    NUMBER default 0,
  mdws_patient_id    VARCHAR2(255),
  mdws_region_id     NUMBER,
  mdws_site_id       NUMBER
)
;
comment on column PATIENT_DEMOGRAPHICS.device_id
  is 'the device id of the cpap device this patient has';
create index EDUCATIONAL_LEVEL_ID on PATIENT_DEMOGRAPHICS (EDUCATION_LEVEL_ID);
create index MARITAL_STATUS_ID on PATIENT_DEMOGRAPHICS (MARITAL_STATUS_ID);
create index POSTAL_CODE_1 on PATIENT_DEMOGRAPHICS (POSTAL_CODE);
alter table PATIENT_DEMOGRAPHICS
  add constraint PK_PATIENT primary key (PATIENT_ID);

prompt
prompt Creating table PATIENT_CPAP
prompt ===========================
prompt
create table PATIENT_CPAP
(
  patient_id     VARCHAR2(50) not null,
  device_id      NUMBER,
  therapy_date   DATE,
  minutes_of_use NUMBER,
  ahi            NUMBER,
  leak           NUMBER,
  leak_type_id   NUMBER
)
;
comment on column PATIENT_CPAP.patient_id
  is 'patient id';
comment on column PATIENT_CPAP.device_id
  is 'device id of the cpap machine';
comment on column PATIENT_CPAP.therapy_date
  is 'date of therapy';
comment on column PATIENT_CPAP.minutes_of_use
  is 'minutes of use';
comment on column PATIENT_CPAP.ahi
  is 'ahi';
comment on column PATIENT_CPAP.leak
  is 'leak value';
alter table PATIENT_CPAP
  add constraint PK_PATIENT_ID unique (PATIENT_ID, DEVICE_ID, THERAPY_DATE)
  disable;
alter table PATIENT_CPAP
  add constraint FK_PATIENT_ID foreign key (PATIENT_ID)
  references PATIENT_DEMOGRAPHICS (PATIENT_ID) on delete cascade;

prompt
prompt Creating table PATIENT_EMERGENCY_CONTACT
prompt ========================================
prompt
create table PATIENT_EMERGENCY_CONTACT
(
  patient_id      VARCHAR2(50) not null,
  name            VARCHAR2(80),
  relationship_id NUMBER(11) default 0,
  address1        VARCHAR2(80),
  address2        VARCHAR2(80),
  city            VARCHAR2(50),
  postal_code     VARCHAR2(50),
  homephone       VARCHAR2(20),
  workphone       VARCHAR2(20),
  email           VARCHAR2(60),
  state_id        NUMBER(11) default 0,
  last_updated    DATE,
  last_updated_by NUMBER
)
;
create index POSTAL_CODE_2 on PATIENT_EMERGENCY_CONTACT (POSTAL_CODE);
create index RELATIONSHIP_ID on PATIENT_EMERGENCY_CONTACT (RELATIONSHIP_ID);
alter table PATIENT_EMERGENCY_CONTACT
  add constraint PK_PATIENT_EMERGENCY_CONTACT primary key (PATIENT_ID);

prompt
prompt Creating table STAT_ETHNICITY
prompt =============================
prompt
create table STAT_ETHNICITY
(
  ethnicity_id   NUMBER(2) not null,
  ethnicity_name VARCHAR2(128) not null,
  sort_order     NUMBER(2) not null
)
;
comment on column STAT_ETHNICITY.ethnicity_id
  is 'unique numeric identifier for an ethnicity';
comment on column STAT_ETHNICITY.ethnicity_name
  is 'unique text identifier for an ethnicity';
comment on column STAT_ETHNICITY.sort_order
  is 'used to sort the ethnicity when displayed';
alter table STAT_ETHNICITY
  add constraint STAT_ETHNICITY_KEY_PK primary key (ETHNICITY_ID);
alter table STAT_ETHNICITY
  add constraint STAT_ETHNICITY_KEY_UK unique (ETHNICITY_NAME);
alter table STAT_ETHNICITY
  add constraint STAT_ETHNICITY_CHK
  check (ethnicity_id > 0);

prompt
prompt Creating table PATIENT_ETHNICITY
prompt ================================
prompt
create table PATIENT_ETHNICITY
(
  patient_id   VARCHAR2(50) not null,
  ethnicity_id NUMBER(2) not null
)
;
comment on column PATIENT_ETHNICITY.patient_id
  is 'FK to patient demographics table';
comment on column PATIENT_ETHNICITY.ethnicity_id
  is 'FK to stat ethnicity table';
alter table PATIENT_ETHNICITY
  add constraint PATIENT_ETHNICITY_KEY_PK primary key (PATIENT_ID);
alter table PATIENT_ETHNICITY
  add constraint PATIENT_ETHNICITY_KEY_FK01 foreign key (PATIENT_ID)
  references PATIENT_DEMOGRAPHICS (PATIENT_ID);
alter table PATIENT_ETHNICITY
  add constraint PATIENT_ETHNICITY_KEY_FK02 foreign key (ETHNICITY_ID)
  references STAT_ETHNICITY (ETHNICITY_ID);

prompt
prompt Creating table PATIENT_EVENT
prompt ============================
prompt
create table PATIENT_EVENT
(
  patient_id        VARCHAR2(50) not null,
  pat_event_id      NUMBER(5) not null,
  event_id          NUMBER(5) not null,
  event_date        DATE,
  status            NUMBER(2) default 0,
  status_date       DATE,
  notification_sent NUMBER default 0,
  comments          VARCHAR2(4000),
  reminder_sent     NUMBER default 0
)
;
alter table PATIENT_EVENT
  add constraint PK_PAT_EVENT primary key (PATIENT_ID, PAT_EVENT_ID);

prompt
prompt Creating table PATIENT_LOCK
prompt ===========================
prompt
create table PATIENT_LOCK
(
  patient_id    VARCHAR2(50),
  provider_id   VARCHAR2(50),
  provider_name VARCHAR2(128),
  session_id    VARCHAR2(500),
  lock_time     DATE,
  fx_user_id    NUMBER(11),
  email         VARCHAR2(255)
)
;

prompt
prompt Creating table PATIENT_MILITARY_DETAIL
prompt ======================================
prompt
create table PATIENT_MILITARY_DETAIL
(
  patient_id                     VARCHAR2(50) not null,
  current_title                  VARCHAR2(50),
  rank_id                        NUMBER(5) default 0,
  military_service_id            NUMBER(5) default 0,
  military_status_id             NUMBER(5) default 0,
  training_type_id               NUMBER(5) default 0,
  special_status_id              NUMBER(5) default 0,
  location_id                    NUMBER(5) default 0,
  majcom_id                      NUMBER(5) default 0,
  squadron                       VARCHAR2(50),
  unit                           VARCHAR2(50),
  duty_specialty_id              NUMBER(11) default 0,
  is_sensitive_duty_program      NUMBER(1) default 0,
  is_personnel_reliability_prog  NUMBER(1) default 0,
  is_sensitive_compartmented_inf NUMBER(1) default 0,
  is_flying_status               NUMBER(1) default 0,
  is_mobility                    NUMBER(1) default 0,
  is_handle_weapons              NUMBER(1) default 0,
  prp_data_id                    NUMBER(11) default 0,
  duty_phone                     VARCHAR2(20),
  tafmsd                         DATE,
  das                            DATE,
  deros                          DATE,
  dos                            DATE,
  dos_indefinite                 NUMBER(1) default 0,
  assigment_pending              NUMBER(1) default 0,
  assigment_pending_location     VARCHAR2(50),
  assigment_pending_nolaterthan  DATE,
  days_tdy_id                    NUMBER(5) default 0,
  tdy_on_event                   NUMBER(1) default 0,
  on_mobility_status             NUMBER(1) default 0,
  days_deployed_id               NUMBER(11) default 0,
  incident_while_deployed        NUMBER(1) default 0,
  upcoming_deployment            NUMBER(1) default 0,
  permanent_duty_station_id      NUMBER(5) default 0,
  other_permanent_duty_station   VARCHAR2(50),
  supervisor_name                VARCHAR2(50),
  supervisor_phone               VARCHAR2(50),
  carer_plan_id                  NUMBER(5) default 0,
  is_vml                         NUMBER(1) default 0,
  is_vml_donot_know              NUMBER(1) default 0,
  upcoming_deployment_donot_know NUMBER(1) default 0,
  is_presidential_support        NUMBER(1) default 0,
  squadron_id                    NUMBER,
  is_duty_limited                NUMBER(1) default 0,
  last_updated                   DATE,
  last_updated_by                NUMBER,
  gt_score                       NUMBER,
  months_in_combat               NUMBER
)
;
create index PATIENT_MILITARY_DETAILDUTY_SP on PATIENT_MILITARY_DETAIL (DUTY_SPECIALTY_ID);
alter table PATIENT_MILITARY_DETAIL
  add constraint PK_PATIENT_MILITARY_DETAIL primary key (PATIENT_ID);

prompt
prompt Creating table PATIENT_MODULE
prompt =============================
prompt
create table PATIENT_MODULE
(
  patient_id         VARCHAR2(50),
  assign_provider_id VARCHAR2(50),
  date_assigned      DATE,
  date_completed     DATE,
  mid                NUMBER(5),
  status             VARCHAR2(50) default 0,
  last_updated       DATE,
  last_updated_by    NUMBER,
  read_date          DATE,
  read_provider_id   VARCHAR2(50),
  module_group_id    NUMBER,
  language_used      NUMBER default 0,
  scheduled_date     DATE
)
;
comment on column PATIENT_MODULE.status
  is '0 = not done, 1 = completed, 2 = skipped';
comment on column PATIENT_MODULE.read_date
  is 'date provider viewed';
comment on column PATIENT_MODULE.read_provider_id
  is 'provider id who read';
comment on column PATIENT_MODULE.language_used
  is '0=english, i=alternate';

prompt
prompt Creating table STAT_RACE
prompt ========================
prompt
create table STAT_RACE
(
  race_id    NUMBER(2) not null,
  race_title VARCHAR2(128) not null,
  sort_order NUMBER(2) not null
)
;
comment on column STAT_RACE.race_id
  is 'unique numeric identifier for a race';
comment on column STAT_RACE.race_title
  is 'unique text identifier for a race';
comment on column STAT_RACE.sort_order
  is 'used to sort the race when displayed';
alter table STAT_RACE
  add constraint STAT_RACE_KEY_PK primary key (RACE_ID);
alter table STAT_RACE
  add constraint STAT_RACE_KEY_UK unique (RACE_TITLE);
alter table STAT_RACE
  add constraint STAT_RACE_CHK
  check (race_id > 0);

prompt
prompt Creating table PATIENT_RACE
prompt ===========================
prompt
create table PATIENT_RACE
(
  patient_id VARCHAR2(50) not null,
  race_id    NUMBER(2) not null
)
;
comment on column PATIENT_RACE.patient_id
  is 'FK to patient demographics table';
comment on column PATIENT_RACE.race_id
  is 'FK to stat race table';
alter table PATIENT_RACE
  add constraint PATIENT_RACE_KEY_PK primary key (PATIENT_ID, RACE_ID);
alter table PATIENT_RACE
  add constraint PATIENT_RACE_KEY_FK01 foreign key (PATIENT_ID)
  references PATIENT_DEMOGRAPHICS (PATIENT_ID);
alter table PATIENT_RACE
  add constraint PATIENT_RACE_KEY_FK02 foreign key (RACE_ID)
  references STAT_RACE (RACE_ID);

prompt
prompt Creating table PATIENT_SPONSOR
prompt ==============================
prompt
create table PATIENT_SPONSOR
(
  patient_id      VARCHAR2(50) not null,
  name            VARCHAR2(25),
  relationship_id NUMBER(11) default 0,
  address1        VARCHAR2(80),
  address2        VARCHAR2(80),
  city            VARCHAR2(50),
  postal_code     VARCHAR2(50),
  homephone       VARCHAR2(20),
  workphone       VARCHAR2(20),
  email           VARCHAR2(50),
  state_id        NUMBER(11) default 0,
  last_updated    DATE,
  last_updated_by NUMBER
)
;
create index PERSON_ID_2 on PATIENT_SPONSOR (PATIENT_ID);
create index POSTAL_CODE_3 on PATIENT_SPONSOR (POSTAL_CODE);
create index RELATIONSHIP_ID_1 on PATIENT_SPONSOR (RELATIONSHIP_ID);

prompt
prompt Creating table PATIENT_TREATMENT_STEP
prompt =====================================
prompt
create table PATIENT_TREATMENT_STEP
(
  patient_id        VARCHAR2(50) not null,
  treatment_step    NUMBER(12) default 0 not null,
  notification_step NUMBER(12) default 0 not null
)
;
alter table PATIENT_TREATMENT_STEP
  add constraint PK_TX_STEP_PATID unique (PATIENT_ID);
alter table PATIENT_TREATMENT_STEP
  add constraint FK_TX_STEP_PATID foreign key (PATIENT_ID)
  references PATIENT_DEMOGRAPHICS (PATIENT_ID) on delete cascade;

prompt
prompt Creating table STAT_ETH_RACE_SOURCE
prompt ===================================
prompt
create table STAT_ETH_RACE_SOURCE
(
  eth_race_source_id   NUMBER(2) not null,
  eth_race_source_name VARCHAR2(50) not null
)
;
comment on column STAT_ETH_RACE_SOURCE.eth_race_source_id
  is 'unique numeric identifier for a ethnicity race source';
comment on column STAT_ETH_RACE_SOURCE.eth_race_source_name
  is 'unique text identifier for a ethnicity race source';
alter table STAT_ETH_RACE_SOURCE
  add constraint STAT_ETH_RACE_SOURCE_KEY_PK primary key (ETH_RACE_SOURCE_ID);
alter table STAT_ETH_RACE_SOURCE
  add constraint STAT_ETH_RACE_SOURCE_KEY_UK unique (ETH_RACE_SOURCE_NAME);
alter table STAT_ETH_RACE_SOURCE
  add constraint STAT_ETH_RACE_SOURCE_CHK
  check (ETH_RACE_SOURCE_ID > 0);

prompt
prompt Creating table PAT_ETH_RACE_SOURCE
prompt ==================================
prompt
create table PAT_ETH_RACE_SOURCE
(
  patient_id         VARCHAR2(50) not null,
  eth_race_source_id NUMBER(2) not null
)
;
comment on column PAT_ETH_RACE_SOURCE.patient_id
  is 'FK to patient demographics table';
comment on column PAT_ETH_RACE_SOURCE.eth_race_source_id
  is 'FK to ethnicity race source table';
alter table PAT_ETH_RACE_SOURCE
  add constraint PAT_ETH_RACE_SOURCE_KEY_PK primary key (PATIENT_ID);
alter table PAT_ETH_RACE_SOURCE
  add constraint PAT_ETH_RACE_SOURCE_KEY_FK foreign key (ETH_RACE_SOURCE_ID)
  references STAT_ETH_RACE_SOURCE (ETH_RACE_SOURCE_ID);

prompt
prompt Creating table SITE
prompt ===================
prompt
create table SITE
(
  site_id          VARCHAR2(50),
  site_name        VARCHAR2(50),
  site_address_1   VARCHAR2(50),
  site_address_2   VARCHAR2(50),
  site_city        VARCHAR2(50),
  site_state       VARCHAR2(50),
  site_postal_code VARCHAR2(50)
)
;
create index SITE_ID on SITE (SITE_ID);
create index SITE_POSTAL_CODE on SITE (SITE_POSTAL_CODE);

prompt
prompt Creating table STAT_DIAGNOSIS
prompt =============================
prompt
create table STAT_DIAGNOSIS
(
  diagnosis_id      NUMBER(11) not null,
  diagnosis_title   VARCHAR2(4000),
  active            NUMBER(5) default 0 not null,
  menu_parent_id    NUMBER(11) default 0,
  menu_has_parent   NUMBER(5) default 0,
  menu_has_child    NUMBER(5) default 0,
  diagnosis_group   NUMBER(11) default 0,
  diagnosis_axis    NUMBER(11) default 0,
  diagnosis_details VARCHAR2(4000),
  selective_filter  NUMBER(11) default 0,
  fitforduty        NUMBER(5) default 0,
  substance         VARCHAR2(80),
  abudepn           INTEGER,
  sort_order        NUMBER(5),
  diag_code         VARCHAR2(10),
  mid               NUMBER(11),
  registry          NUMBER(1),
  description       VARCHAR2(4000)
)
;
create index MENU_PARENT_ID on STAT_DIAGNOSIS (MENU_PARENT_ID);
alter table STAT_DIAGNOSIS
  add constraint PK_STAT_DIAGNOSIS primary key (DIAGNOSIS_ID);

prompt
prompt Creating table STAT_DIAGNOSIS_SPECIFIER
prompt =======================================
prompt
create table STAT_DIAGNOSIS_SPECIFIER
(
  stat_diagnosis_id NUMBER,
  stat_specifier_id NUMBER
)
;

prompt
prompt Creating table STAT_DIAGNOSIS_SYMPTOMS
prompt ======================================
prompt
create table STAT_DIAGNOSIS_SYMPTOMS
(
  diagnosis_id NUMBER(11) not null,
  symptom_id   NUMBER(11) not null,
  active       NUMBER(5) default 0,
  symptom      VARCHAR2(4000)
)
;
alter table STAT_DIAGNOSIS_SYMPTOMS
  add constraint PK_STAT_DIAGNOSIS_SYMPTOMS primary key (SYMPTOM_ID);

prompt
prompt Creating table STAT_DIMS_BASE
prompt =============================
prompt
create table STAT_DIMS_BASE
(
  dims_id          VARCHAR2(5) not null,
  short_name       VARCHAR2(4),
  base             VARCHAR2(80),
  active           NUMBER(5) default 0,
  suat_key         VARCHAR2(128),
  suat_request_key VARCHAR2(128),
  majcom_id        NUMBER(5) default 0,
  sort_order       NUMBER(3)
)
;
create index MAJCOM_ID on STAT_DIMS_BASE (MAJCOM_ID);
create index SUAT_KEY on STAT_DIMS_BASE (SUAT_KEY);
create index SUAT_REQUEST_KET on STAT_DIMS_BASE (SUAT_REQUEST_KEY);
alter table STAT_DIMS_BASE
  add constraint PK_STAT_DIMS_BASE primary key (DIMS_ID);

prompt
prompt Creating table STAT_ENCOUNTER_TYPE
prompt ==================================
prompt
create table STAT_ENCOUNTER_TYPE
(
  encounter_type_id NUMBER(5) default 0 not null,
  enc_type_desc     VARCHAR2(80),
  active            NUMBER(5) default 0
)
;
alter table STAT_ENCOUNTER_TYPE
  add constraint PK_STAT_ENCOUNTER_TYPE primary key (ENCOUNTER_TYPE_ID);

prompt
prompt Creating table STAT_EVENT
prompt =========================
prompt
create table STAT_EVENT
(
  event_id         NUMBER(5) not null,
  event_group      NUMBER(5),
  event            VARCHAR2(80),
  active           NUMBER(1),
  internal_message VARCHAR2(4000),
  external_message VARCHAR2(255),
  triggered_by     NUMBER default 0,
  trigger_event_id NUMBER,
  reminder_message VARCHAR2(4000),
  header_label     VARCHAR2(80)
)
;
comment on column STAT_EVENT.triggered_by
  is '0 - Manually, 1 - Previous Event, 2 - nurse/provider, 3 - Date Calculation';
alter table STAT_EVENT
  add constraint PK_EVENT_ID primary key (EVENT_ID);

prompt
prompt Creating table STAT_GENDER
prompt ==========================
prompt
create table STAT_GENDER
(
  gender_id   NUMBER(5) default 0 not null,
  gender_desc VARCHAR2(100) not null,
  active      NUMBER(5) default 0 not null
)
;
alter table STAT_GENDER
  add constraint PK_STAT_GENDER primary key (GENDER_ID);

prompt
prompt Creating table STAT_MEASURE_UNIT
prompt ================================
prompt
create table STAT_MEASURE_UNIT
(
  unit_id          NUMBER(11) default 0 not null,
  unit_description VARCHAR2(50),
  measure_id       NUMBER(11) default 0,
  active           NUMBER(11) default 0
)
;
create index MEASURE_ID on STAT_MEASURE_UNIT (MEASURE_ID);
alter table STAT_MEASURE_UNIT
  add constraint PK_STAT_MEASURE_UNIT primary key (UNIT_ID);

prompt
prompt Creating table STAT_MENU_ITEMS
prompt ==============================
prompt
create table STAT_MENU_ITEMS
(
  menu_item_id        NUMBER(11),
  menu_item           VARCHAR2(255),
  has_children        NUMBER(2) default 0,
  has_parent          NUMBER(2) default 0,
  parent_id           NUMBER(11) default 0,
  href                VARCHAR2(255),
  html_property       VARCHAR2(255),
  js_property         VARCHAR2(255),
  user_type           NUMBER(12),
  user_right          NUMBER(12) default 0,
  is_logged_in        NUMBER(2) default 1,
  selected_patient    NUMBER(2) default 0,
  selected_encounter  NUMBER(2) default 0,
  active              NUMBER(2) default 1,
  item_type           NUMBER(2) default 1,
  title               VARCHAR2(255),
  width               NUMBER default 32,
  height              NUMBER default 32,
  img_src             VARCHAR2(255),
  has_open_case       NUMBER(2) default 0,
  toolbar_sort_order  NUMBER,
  icon_property       VARCHAR2(255),
  req_readwrite_right NUMBER(12) default 0,
  check_pat_lock      NUMBER(1) default 0,
  menu_sort_order     NUMBER,
  closes_patient      NUMBER default 0,
  ignore_on_tiu       NUMBER default 0
)
;
comment on column STAT_MENU_ITEMS.check_pat_lock
  is '0 do not check for patient record lock status, 1 check...';

prompt
prompt Creating table STAT_MILITARY_SERVICE
prompt ====================================
prompt
create table STAT_MILITARY_SERVICE
(
  military_service_id    NUMBER(5) default 0 not null,
  military_service_title VARCHAR2(50),
  active                 NUMBER(5) default 0
)
;
alter table STAT_MILITARY_SERVICE
  add constraint PK_STAT_MILITARY_SERVICE primary key (MILITARY_SERVICE_ID);

prompt
prompt Creating table STAT_MODALITY
prompt ============================
prompt
create table STAT_MODALITY
(
  stat_modality_id  NUMBER(11) not null,
  modality_group_id NUMBER(11) not null,
  modality          VARCHAR2(256) not null,
  cpt               VARCHAR2(10),
  duration          VARCHAR2(20) not null,
  is_active         NUMBER(1) not null,
  is_medical_check  NUMBER(1) not null,
  stat_mod_type_id  NUMBER(4) not null,
  diagnosis_id      NUMBER(11) not null
)
;
comment on column STAT_MODALITY.modality_group_id
  is 'FK to stat_modality_group';
comment on column STAT_MODALITY.is_active
  is '0 = inactive; 1 = active';
comment on column STAT_MODALITY.is_medical_check
  is '0 = no; 1 = yes';
comment on column STAT_MODALITY.stat_mod_type_id
  is 'FK to stat_modality_type table';
comment on column STAT_MODALITY.diagnosis_id
  is 'FK to stat_diagnosis table';
alter table STAT_MODALITY
  add constraint PK_MODALITY_ID primary key (STAT_MODALITY_ID);
alter table STAT_MODALITY
  add constraint STAT_MODALITY_UK1 unique (MODALITY);
alter table STAT_MODALITY
  add constraint STAT_MODALITY_STAT_DIAGNO_FK1 foreign key (DIAGNOSIS_ID)
  references STAT_DIAGNOSIS (DIAGNOSIS_ID)
  disable;
alter table STAT_MODALITY
  add constraint STAT_MODALITY_CHK1
  check (IS_ACTIVE IN (0, 1));
alter table STAT_MODALITY
  add constraint STAT_MODALITY_CHK2
  check (IS_MEDICAL_CHECK IN (0, 1));

prompt
prompt Creating table STAT_OUTCOME_MEASURE
prompt ===================================
prompt
create table STAT_OUTCOME_MEASURE
(
  stat_outcome_id      NUMBER(11) default 0 not null,
  stat_outcome_desc    VARCHAR2(255),
  stat_outcome_comment VARCHAR2(255)
)
;

prompt
prompt Creating table STAT_PROBLEM
prompt ===========================
prompt
create table STAT_PROBLEM
(
  stat_problem_id   NUMBER,
  stat_problem_desc VARCHAR2(4000),
  stat_problem_text VARCHAR2(4000),
  sort_order        NUMBER,
  active            NUMBER
)
;

prompt
prompt Creating table STAT_REFERRAL
prompt ============================
prompt
create table STAT_REFERRAL
(
  stat_referral_id   NUMBER(11) default 0 not null,
  stat_referral_desc VARCHAR2(4000),
  stat_referral_text VARCHAR2(4000),
  person_contacted   VARCHAR2(255),
  provider_name      VARCHAR2(255),
  street_address     VARCHAR2(500),
  city               VARCHAR2(255),
  state              VARCHAR2(100),
  postal_code        VARCHAR2(20),
  phone              VARCHAR2(50),
  fax                VARCHAR2(20),
  release_signed     NUMBER,
  active             NUMBER default 1
)
;
comment on column STAT_REFERRAL.active
  is '// 0: inactive, 1: active';
alter table STAT_REFERRAL
  add constraint STAT_REFERRAL_KEY_PK primary key (STAT_REFERRAL_ID);

prompt
prompt Creating table STAT_RELATIONSHIP
prompt ================================
prompt
create table STAT_RELATIONSHIP
(
  relationship_id NUMBER(11) default 0 not null,
  description     VARCHAR2(50) not null,
  active          NUMBER(5) default 0 not null
)
;
alter table STAT_RELATIONSHIP
  add constraint PK_STAT_RELATIONSHIP primary key (RELATIONSHIP_ID);

prompt
prompt Creating table STAT_REVAMP_REPORT_QUERY
prompt =======================================
prompt
create table STAT_REVAMP_REPORT_QUERY
(
  var_id           NUMBER,
  full_description VARCHAR2(4000),
  query            VARCHAR2(4000),
  status           VARCHAR2(128) default 1,
  is_distribution  NUMBER default 0,
  s1               NUMBER,
  s2               NUMBER,
  s3               NUMBER,
  active           NUMBER default 1,
  visible          NUMBER default 1,
  data_entry       VARCHAR2(64)
)
;

prompt
prompt Creating table STAT_SEC_QUESTIONS
prompt =================================
prompt
create table STAT_SEC_QUESTIONS
(
  question_id    NUMBER,
  question       VARCHAR2(255),
  question_group NUMBER,
  active         NUMBER default 1
)
;

prompt
prompt Creating table STAT_SPECIFIER
prompt =============================
prompt
create table STAT_SPECIFIER
(
  stat_specifier_id   NUMBER,
  stat_specifier_text VARCHAR2(1000),
  sort_order          NUMBER
)
;

prompt
prompt Creating table STAT_STATES
prompt ==========================
prompt
create table STAT_STATES
(
  state_id     NUMBER(11) default 0 not null,
  state_title  VARCHAR2(50),
  abbrebiation VARCHAR2(4),
  active       NUMBER(11) default 0
)
;
alter table STAT_STATES
  add constraint PK_STAT_STATES primary key (STATE_ID);

prompt
prompt Creating table STAT_USER_RIGHTS
prompt ===============================
prompt
create table STAT_USER_RIGHTS
(
  stat_right_id NUMBER(5) default 0 not null,
  right_desc    VARCHAR2(255),
  right_bin     VARCHAR2(32),
  right_hex     VARCHAR2(32),
  right_dec     NUMBER(12),
  active        NUMBER(2) default 1,
  visible       NUMBER(2) default 1,
  comments      VARCHAR2(255),
  sort_order    NUMBER,
  has_mode      NUMBER(2) default 1
)
;
comment on column STAT_USER_RIGHTS.has_mode
  is '1: If the rights use Read Only modes; 0: Modes does not apply to this right';
alter table STAT_USER_RIGHTS
  add constraint PK_STAT_USER_RIGHTS primary key (STAT_RIGHT_ID);

prompt
prompt Creating table STAT_USER_TYPES
prompt ==============================
prompt
create table STAT_USER_TYPES
(
  stat_usertype_id NUMBER(11) not null,
  usertype_desc    VARCHAR2(255) not null,
  active           NUMBER(2) default 1,
  visible          NUMBER(2) default 1,
  comments         VARCHAR2(255)
)
;

prompt
prompt Creating table SUAT_USER
prompt ========================
prompt
create table SUAT_USER
(
  email                VARCHAR2(50) not null,
  uidpwd               VARCHAR2(200) not null,
  rank                 VARCHAR2(10) not null,
  name                 VARCHAR2(50) not null,
  provider_id          VARCHAR2(50) not null,
  military_service_id  NUMBER(5) default 0 not null,
  corps                VARCHAR2(50),
  title                VARCHAR2(50),
  unit                 VARCHAR2(50),
  squadron             VARCHAR2(50),
  phone                VARCHAR2(50),
  dims_id              VARCHAR2(5) not null,
  entry_date           DATE,
  locked               NUMBER(1) default 0,
  must_change_password NUMBER(1) default 0,
  fx_user_id           NUMBER,
  supervisor_id        VARCHAR2(50),
  graph_pref           NUMBER default 0
)
;
comment on column SUAT_USER.email
  is 'User Email Address';
comment on column SUAT_USER.uidpwd
  is 'User ID and Password';
comment on column SUAT_USER.rank
  is 'User Rank';
comment on column SUAT_USER.name
  is 'User First and Last Name';
comment on column SUAT_USER.provider_id
  is 'Provider Id';
comment on column SUAT_USER.military_service_id
  is 'Military Service ID';
comment on column SUAT_USER.corps
  is 'Corps';
comment on column SUAT_USER.title
  is 'Job Title';
comment on column SUAT_USER.unit
  is 'User Unit';
comment on column SUAT_USER.squadron
  is 'User Squadron';
comment on column SUAT_USER.phone
  is 'User Contact Phone Number';
comment on column SUAT_USER.dims_id
  is 'DMIS/Base ID';
comment on column SUAT_USER.entry_date
  is 'Record Entry Date';
comment on column SUAT_USER.locked
  is 'Flag Indicating Whether Or Not Account Is Locked';
comment on column SUAT_USER.must_change_password
  is 'Flag Indicating That The User Must Change Password On Next Login';
comment on column SUAT_USER.fx_user_id
  is 'User ID Linked To The FX_USER_TABLE';
comment on column SUAT_USER.supervisor_id
  is 'Provider ID of the Intern''s Supervisor';
comment on column SUAT_USER.graph_pref
  is '0: single graph, 1: multiple graphs';
create index DIMS_ID_1 on SUAT_USER (DIMS_ID);
create unique index PROVIDER_ID on SUAT_USER (PROVIDER_ID);
alter table SUAT_USER
  add constraint PK_SUAT_USER primary key (PROVIDER_ID, DIMS_ID);

prompt
prompt Creating table TEMPLATE
prompt =======================
prompt
create table TEMPLATE
(
  template_id       INTEGER not null,
  type_id           INTEGER,
  description       VARCHAR2(80),
  creator_id        VARCHAR2(50),
  created_date      DATE,
  active            INTEGER,
  template_group_id NUMBER,
  template          CLOB,
  read_only         NUMBER default 0
)
;
alter table TEMPLATE
  add constraint PK_TEMPLATE_ID primary key (TEMPLATE_ID);

prompt
prompt Creating table TEMPLATE_GROUP
prompt =============================
prompt
create table TEMPLATE_GROUP
(
  template_group_id NUMBER,
  group_name        VARCHAR2(255),
  comments          VARCHAR2(255),
  active            NUMBER default 1,
  created_by        NUMBER,
  last_updated      DATE,
  last_updated_by   NUMBER,
  read_only         NUMBER default 0
)
;

prompt
prompt Creating table TEMPLATE_ITEM
prompt ============================
prompt
create table TEMPLATE_ITEM
(
  description       VARCHAR2(50) not null,
  item_group_id     INTEGER,
  item_sql          VARCHAR2(4000),
  help_text         VARCHAR2(4000),
  active            INTEGER default 1,
  item_id           NUMBER,
  template_group_id NUMBER
)
;
alter table TEMPLATE_ITEM
  add constraint PK_DESCRIPTION primary key (DESCRIPTION);

prompt
prompt Creating table TEMPLATE_ITEM_GROUP
prompt ==================================
prompt
create table TEMPLATE_ITEM_GROUP
(
  group_id    INTEGER not null,
  description VARCHAR2(50),
  active      INTEGER
)
;
alter table TEMPLATE_ITEM_GROUP
  add constraint PK_GROUP_ID primary key (GROUP_ID);

prompt
prompt Creating table TEMPLATE_TYPE
prompt ============================
prompt
create table TEMPLATE_TYPE
(
  type_id     INTEGER not null,
  description VARCHAR2(80),
  active      INTEGER
)
;
alter table TEMPLATE_TYPE
  add constraint PK_TYPE_ID primary key (TYPE_ID);

prompt
prompt Creating table TIU_STAT_SEX
prompt ===========================
prompt
create table TIU_STAT_SEX
(
  sex_id           NUMBER(1),
  sex_label        VARCHAR2(255),
  sex_abbreviation VARCHAR2(1)
)
;
comment on column TIU_STAT_SEX.sex_id
  is 'numeric value uniquely identifying a sex';
comment on column TIU_STAT_SEX.sex_label
  is 'text value uniquely identifying a sex';
comment on column TIU_STAT_SEX.sex_abbreviation
  is 'text value stating the abbreviation of a sex';

prompt
prompt Creating table TIU_UTL_CLINIC
prompt =============================
prompt
create table TIU_UTL_CLINIC
(
  clinic_id      NUMBER,
  clinic_label   VARCHAR2(4000),
  xfer_system_id NUMBER,
  xfer_date      DATE,
  region_id      NUMBER,
  site_id        NUMBER
)
;
comment on column TIU_UTL_CLINIC.clinic_id
  is 'unique id for the clinic';
comment on column TIU_UTL_CLINIC.clinic_label
  is 'clinic label';
comment on column TIU_UTL_CLINIC.xfer_system_id
  is 'transfer system id';
comment on column TIU_UTL_CLINIC.xfer_date
  is 'date transferred';

prompt
prompt Creating table TIU_UTL_NOTE_TITLE
prompt =================================
prompt
create table TIU_UTL_NOTE_TITLE
(
  note_title_tag     NUMBER,
  note_title_label   VARCHAR2(4000),
  note_title_details VARCHAR2(4000),
  xfer_system_id     NUMBER,
  xfer_date          DATE,
  region_id          NUMBER,
  site_id            NUMBER
)
;
comment on column TIU_UTL_NOTE_TITLE.note_title_tag
  is 'note title tag';
comment on column TIU_UTL_NOTE_TITLE.note_title_label
  is 'note title label';
comment on column TIU_UTL_NOTE_TITLE.note_title_details
  is 'note title details';
comment on column TIU_UTL_NOTE_TITLE.xfer_system_id
  is 'transfer system id';
comment on column TIU_UTL_NOTE_TITLE.xfer_date
  is 'date of transfer';

prompt
prompt Creating table TIU_UTL_REGION
prompt =============================
prompt
create table TIU_UTL_REGION
(
  region_id      NUMBER,
  region_name    VARCHAR2(500),
  xfer_system_id NUMBER,
  xfer_date      DATE
)
;

prompt
prompt Creating table TIU_UTL_SITE
prompt ===========================
prompt
create table TIU_UTL_SITE
(
  region_id      NUMBER,
  site_id        NUMBER,
  site_name      VARCHAR2(500),
  xfer_system_id NUMBER,
  xfer_date      DATE
)
;

prompt
prompt Creating table TREATMENT_PROBLEM_LIST
prompt =====================================
prompt
create table TREATMENT_PROBLEM_LIST
(
  problem_id             NUMBER(10),
  treatment_id           NUMBER(10),
  patient_id             VARCHAR2(50),
  encounter_id           VARCHAR2(50),
  diagnostic_id          NUMBER(11),
  last_updated           DATE,
  last_updated_by        NUMBER(16),
  inactive               NUMBER(16) default 0,
  inactive_comment       VARCHAR2(4000),
  inactive_date          DATE,
  symptom_duration       VARCHAR2(255),
  diagnostic_comment     VARCHAR2(4000),
  diagnostic_axis_type   NUMBER(2),
  diagnostic_text        VARCHAR2(4000),
  stat_specifier_id      NUMBER(8),
  stat_specifier_text    VARCHAR2(4000),
  diag_code              VARCHAR2(255),
  see_medical_record     NUMBER(2),
  contributory           NUMBER(2),
  problem_disposition_id NUMBER,
  problem                VARCHAR2(500),
  problemtoflag_id       NUMBER,
  diagnosis_id           NUMBER,
  status                 NUMBER(5),
  entry_provider         VARCHAR2(80),
  entry_date             DATE,
  flag_id                NUMBER(11) default 0,
  mid                    NUMBER(11) default 0,
  sort_order             NUMBER(2)
)
;
comment on column TREATMENT_PROBLEM_LIST.see_medical_record
  is '0 : NO / 1 : YES';
comment on column TREATMENT_PROBLEM_LIST.contributory
  is '0 : NO / 1 : YES';
comment on column TREATMENT_PROBLEM_LIST.problem_disposition_id
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.problem
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.problemtoflag_id
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.diagnosis_id
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.status
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.entry_provider
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.entry_date
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.flag_id
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.mid
  is 'added for portal support';
comment on column TREATMENT_PROBLEM_LIST.sort_order
  is 'set the problem as primary, secondary, tertiary, etc...';
create index INDEX_ENCOUNTER_ID on TREATMENT_PROBLEM_LIST (ENCOUNTER_ID);
alter table TREATMENT_PROBLEM_LIST
  add constraint TX_PROBLEM_LIST_KEY_PK unique (PROBLEM_ID);
alter table TREATMENT_PROBLEM_LIST
  add constraint TX_PROBLEM_LIST_KEY_FK foreign key (TREATMENT_ID, PATIENT_ID)
  references TREATMENT (TREATMENT_ID, PATIENT_ID) on delete cascade
  disable;

prompt
prompt Creating table TREATMENT_PROB_CRITERIA
prompt ======================================
prompt
create table TREATMENT_PROB_CRITERIA
(
  problem_id        NUMBER(10) not null,
  treatment_id      NUMBER(10) not null,
  patient_id        VARCHAR2(50) not null,
  encounter_id      VARCHAR2(50) not null,
  criteria_id       NUMBER(10) not null,
  criteria          VARCHAR2(255),
  status            NUMBER,
  active            NUMBER,
  intake_problem_id NUMBER(11),
  mid               VARCHAR2(255),
  rid               VARCHAR2(255)
)
;
alter table TREATMENT_PROB_CRITERIA
  add constraint TXPROBCRITERIA_PK_01 primary key (PROBLEM_ID, TREATMENT_ID, PATIENT_ID, ENCOUNTER_ID, CRITERIA_ID);
alter table TREATMENT_PROB_CRITERIA
  add constraint TXPROBCRITERIA_FK_01 foreign key (PROBLEM_ID)
  references TREATMENT_PROBLEM_LIST (PROBLEM_ID) on delete cascade;

prompt
prompt Creating table TREATMENT_PROB_CRITERIA_DEF
prompt ==========================================
prompt
create table TREATMENT_PROB_CRITERIA_DEF
(
  problem_id        NUMBER(10) not null,
  treatment_id      NUMBER(10) not null,
  patient_id        VARCHAR2(50) not null,
  encounter_id      VARCHAR2(50) not null,
  criteria_id       NUMBER(10) not null,
  definition        VARCHAR2(255),
  status            NUMBER,
  active            NUMBER,
  definition_id     NUMBER(10) not null,
  intake_problem_id NUMBER(11)
)
;
create unique index TXPROBCRITERIADEF_PK_01 on TREATMENT_PROB_CRITERIA_DEF (PROBLEM_ID, TREATMENT_ID, PATIENT_ID, ENCOUNTER_ID, CRITERIA_ID, DEFINITION_ID);
alter table TREATMENT_PROB_CRITERIA_DEF
  add constraint TXPROBCRITERIADEF_FK_01 foreign key (PROBLEM_ID)
  references TREATMENT_PROBLEM_LIST (PROBLEM_ID) on delete cascade
  disable;

prompt
prompt Creating table UTL_PARAMETER
prompt ============================
prompt
create table UTL_PARAMETER
(
  parameter_name  VARCHAR2(128) not null,
  parameter_value VARCHAR2(4000) not null
)
;
comment on table UTL_PARAMETER
  is 'to store parameter values for database application';
comment on column UTL_PARAMETER.parameter_name
  is 'name of the parameter';
comment on column UTL_PARAMETER.parameter_value
  is 'value of the parameter';
alter table UTL_PARAMETER
  add constraint UTL_PARAMETER_KEY_PK primary key (PARAMETER_NAME);

prompt
prompt Creating sequence SEQCMSMENUID
prompt ==============================
prompt
create sequence SEQCMSMENUID
minvalue 1
maxvalue 999999
start with 231
increment by 1
cache 20;

prompt
prompt Creating sequence SEQCPAPDEVICE
prompt ===============================
prompt
create sequence SEQCPAPDEVICE
minvalue 1
maxvalue 999999999
start with 330
increment by 1
cache 20;

prompt
prompt Creating sequence SEQFXUSERID
prompt =============================
prompt
create sequence SEQFXUSERID
minvalue 1
maxvalue 999999999
start with 1312
increment by 1
cache 20;

prompt
prompt Creating sequence SEQINACTIVEPAP
prompt ================================
prompt
create sequence SEQINACTIVEPAP
minvalue 1
maxvalue 9999999999
start with 1
increment by 1
cache 10;

prompt
prompt Creating sequence SEQMSGID
prompt ==========================
prompt
create sequence SEQMSGID
minvalue 1
maxvalue 9999999
start with 569
increment by 1
cache 20;

prompt
prompt Creating sequence SEQPATEVENTID
prompt ===============================
prompt
create sequence SEQPATEVENTID
minvalue 1
maxvalue 999999999999999999
start with 4758
increment by 1
cache 20;

prompt
prompt Creating sequence SEQPROBLEMID
prompt ==============================
prompt
create sequence SEQPROBLEMID
minvalue 1
maxvalue 9999999999
start with 500
increment by 1
cache 20;

prompt
prompt Creating sequence SEQREFERRALID
prompt ===============================
prompt
create sequence SEQREFERRALID
minvalue 1
maxvalue 9999999999
start with 305
increment by 1
cache 20;

prompt
prompt Creating sequence SEQSTATICPAGEID
prompt =================================
prompt
create sequence SEQSTATICPAGEID
minvalue 1
maxvalue 999999
start with 271
increment by 1
cache 20;

prompt
prompt Creating sequence SEQTEMPLATEGRPID
prompt ==================================
prompt
create sequence SEQTEMPLATEGRPID
minvalue 1
maxvalue 999999
start with 121
increment by 1
cache 20;

prompt
prompt Creating sequence SEQTEMPLATEID
prompt ===============================
prompt
create sequence SEQTEMPLATEID
minvalue 1
maxvalue 999999999
start with 320
increment by 1
cache 20;

prompt
prompt Creating sequence SEQTXDIAGNOSISID
prompt ==================================
prompt
create sequence SEQTXDIAGNOSISID
minvalue 1
maxvalue 999999999
start with 10540
increment by 1
cache 20;

prompt
prompt Creating sequence SEQTXPROBCRITERIA
prompt ===================================
prompt
create sequence SEQTXPROBCRITERIA
minvalue 1
maxvalue 9999999999
start with 1041
increment by 1
cache 20;

prompt
prompt Creating sequence SEQTXPROBCRITERIADEF
prompt ======================================
prompt
create sequence SEQTXPROBCRITERIADEF
minvalue 1
maxvalue 9999999999
start with 903
increment by 1
cache 20;

prompt
prompt Creating sequence SEQTXPROBLEMID
prompt ================================
prompt
create sequence SEQTXPROBLEMID
minvalue 1
maxvalue 9999999999
start with 859
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_APP_USER_ID
prompt =================================
prompt
create sequence SEQ_APP_USER_ID
minvalue 1
maxvalue 9999999999999
start with 10861
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_ENCOUNTERID
prompt =================================
prompt
create sequence SEQ_ENCOUNTERID
minvalue 1
maxvalue 999999999999999999999999999
start with 11286
increment by 1
cache 20;

prompt
prompt Creating function GETPATIENTBMI
prompt ===============================
prompt
create or replace function GetPatientBMI(pi_vPatientID in varchar2) return varchar2 is
  type RetRefCursor is ref cursor;
  
  curEncounter RetRefCursor;
  rs RetRefCursor;
  
  recEncounter encounter%rowtype;
  --v_vPatientID varchar2(50) := '0125AIBDFA1127201212045';
  
  v_nHeight number := -1;
  v_nWeight number := -1;
  
  v_nBMI number := -1;
  v_vBMI varchar2(50) := '';
  
begin
  open curEncounter for
     select *
       from encounter e
      where e.patient_id = pi_vPatientID
      order by e.encounter_date desc;
  
    loop
      fetch curEncounter 
       into recEncounter;
       exit when curEncounter%notfound;
       
       if recEncounter.patient_height is not null then
         if v_nHeight <= 0 then
           v_nHeight := recEncounter.patient_height;
         end if;
       end if;
       
       if recEncounter.patient_weight  is not null then
         if v_nWeight <= 0 then
           v_nWeight := recEncounter.patient_weight;
         end if;
       end if; 
       
       if v_nBMI = -1 then
         if v_nWeight > 0 and v_nHeight > 0 then
           v_nBMI := (v_nWeight/(v_nHeight * v_nHeight)) * 703;
           v_vBMI := to_char(v_nBMI, '999.99');
         end if;
       end if;
       
    end loop;
  close curEncounter;
  
  return(v_vBMI);
end GetPatientBMI;
/

prompt
prompt Creating function GETPATIENTCOLUMNVALUE
prompt =======================================
prompt
create or replace function getPatientColumnValue (
   pi_vValue                         in varchar2,
   pi_vPatientID                     in varchar2
   ) return                             varchar2
is
   v_rKey                               raw(32) := sys.ic_utl_sec.c_rKey;
begin
   return sys.ic_utl_sec.decryptData(pi_vValue, v_rKey, pi_vPatientID);
exception
   when others
   then
      return null;
end;
/

prompt
prompt Creating function MID
prompt =====================
prompt
CREATE OR REPLACE FUNCTION MID(srcStr IN VARCHAR2, strt IN INTEGER, len IN NUMBER DEFAULT 32767)
  RETURN VARCHAR2 IS dStr VARCHAR2(32767);
  BEGIN
    If ( strt > Length(srcStr) ) Then
      RETURN( NULL );
    END IF;
    dStr := SUBSTR( srcStr, strt, len );
    RETURN ( dStr );
  END;
/

prompt
prompt Creating view DEL_PATIENT
prompt =========================
prompt
create or replace force view del_patient as
select t.patient_id,
         getPatientColumnValue(t.first_name,t.patient_id) as first_name,
         getPatientColumnValue(t.mi,t.patient_id) as mi,
         getPatientColumnValue(t.last_name,t.patient_id) as last_name,
         getPatientColumnValue(t.fmp,t.patient_id) as fmp,
         getPatientColumnValue(t.sponsor_ssn,t.patient_id) as sponsor_ssn,
         getPatientColumnValue(t.ssn,t.patient_id) as ssn,
         mid(getPatientColumnValue(t.last_name,t.patient_id), 1, 1) || mid(getPatientColumnValue(t.ssn,t.patient_id), 6, 9) as lnssnlast4,
         getPatientColumnValue(t.gender,t.patient_id) as gender,
         t.marital_status_id,
         to_date(getPatientColumnValue(t.dob,t.patient_id), 'MM/DD/YYYY') as dob,
         has_firarm,
         education_level_id,
         provider_id,
         address1,
         address2,
         city,
         postal_code,
         homephone,
         cellphone,
         workphone,
         getPatientColumnValue(t.email,t.patient_id) as email,
         state_id,
         has_referal,
         awaiting_transfer,
         transfer_dmis_id,
         edipn,
         fx_user_id,
         last_updated,
         last_updated_by,
         is_high_interest,
         portal_user_id,
         current_weight,
         current_height,
         t.wrk_phone_call,
         t.home_phone_call,
         t.home_phone_msg,
         t.cell_phone_call,
         t.email_msg,
         t.device_id,
         GetPatientBMI(t.patient_id) as BMI
    from patient_demographics t;

prompt
prompt Creating view VW_PATIENT_CPAP_FREPORT
prompt =====================================
prompt
create or replace force view vw_patient_cpap_freport as
select pc."PATIENT_ID",
       pc."DEVICE_ID",
       pc."THERAPY_DATE",
       pc."MINUTES_OF_USE",
       pc."AHI",
       pc."LEAK",
       pc."LEAK_TYPE_ID",
       pe.status_date,
       t.initial_visit_date
  from patient_cpap pc, patient_event pe, treatment t
 where pc.patient_id = t.patient_id
   and pc.patient_id = pe.patient_id
   and pe.event_id = 10
   and pe.status = 1
   and pc.therapy_date < to_date('20140315','yyyymmdd')
   and t.initial_visit_date < to_date('20140315','yyyymmdd')
   and pe.status_date < to_date('20140315','yyyymmdd');

prompt
prompt Creating view VW_1WK_AHI_BASELINE_AHI
prompt =====================================
prompt
create or replace force view vw_1wk_ahi_baseline_ahi as
select distinct r.PATIENT_ID,
                (select nvl(baseline_ahi, 0)
                   from treatment
                  where patient_id = r.PATIENT_ID) as BASELINE_AHI,
                (select sum(t.AHI) / 7
                   from VW_PATIENT_CPAP_FREPORT t
                  where t.PATIENT_ID = r.PATIENT_ID
                    and (t.THERAPY_DATE >= t.status_date and
                        t.THERAPY_DATE <= (t.status_date + 7))) as AHI_1WK,
                ((select sum(t.AHI) / 7
                    from VW_PATIENT_CPAP_FREPORT t
                   where t.PATIENT_ID = r.PATIENT_ID
                     and (t.THERAPY_DATE >= t.status_date and
                         t.THERAPY_DATE <= (t.status_date + 7))) -
                (select nvl(baseline_ahi, 0)
                    from treatment
                   where patient_id = r.PATIENT_ID)) as AHI_1WK_MINUS_BASELINE_AHI,
                   (((select sum(t.AHI) / 7
                    from VW_PATIENT_CPAP_FREPORT t
                   where t.PATIENT_ID = r.PATIENT_ID
                     and (t.THERAPY_DATE >= t.status_date and
                         t.THERAPY_DATE <= (t.status_date + 7))) /
                (select nvl(baseline_ahi, 0)
                    from treatment
                   where patient_id = r.PATIENT_ID)) * 100 ) as AHI_1WK_BASELINE_AHI_PERCENT
  from VW_PATIENT_CPAP_FREPORT r;

prompt
prompt Creating view VW_AGE_DISTRIB
prompt ============================
prompt
create or replace force view vw_age_distrib as
select '18-29' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 18 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 29)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 18 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 29)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 18 and
               trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 29)) as COUNT
  from dual
union
select '30-39' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 30 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 39)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 30 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 39)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 30 and
               trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 39)) as COUNT
  from dual
union
select '40-49' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 40 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 49)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 40 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 49)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 40 and
               trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 49)) as COUNT
  from dual
union
select '50-59' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 50 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 59)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 50 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 59)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 50 and
               trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 59)) as COUNT
  from dual
union
select '60-69' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 60 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 69)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 60 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 69)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 60 and
               trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 69)) as COUNT
  from dual
union
select '70-79' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 70 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 79)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 70 and
                trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 79)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 70 and
               trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) <= 79)) as COUNT
  from dual
union
select '80 +' as AGE_GROUP,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'F'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 80)) as FEMALE,

       (select count(*)
          from patient_demographics
         where getpatientcolumnvalue(gender, patient_id) = 'M'
           and (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 80)) as MALE,
       (select count(*)
          from patient_demographics
         where (trunc(months_between(SYSDATE,
                                     to_date(getPatientColumnValue(dob,
                                                                   PATIENT_ID),
                                             'MM/DD/YYYY')) / 12) >= 80)) as COUNT
  from dual;

prompt
prompt Creating view VW_INTAKE
prompt =======================
prompt
create or replace force view vw_intake as
select (select t1.module
         from (select t1.module, t4.mid, t4.tid, t4.qid, t4.rid
                from intake_module t1,
                     (select t2.mid, min(t2.tid) tid from intake_topic t2 group by t2.mid) t2,
                     (select t3.mid, t3.tid, min(t3.qid) qid from intake_question t3 group by t3.mid, t3.tid) t3,
                     (select t4.mid, t4.tid, t4.qid, min(t4.rid) rid from intake_response t4 group by  t4.mid, t4.tid, t4.qid) t4
                where t1.mid = t2.mid
                  and t2.mid = t3.mid
                  and t2.tid = t3.tid
                  and t3.mid = t4.mid
                  and t3.tid = t4.tid
                  and t3.qid = t4.qid
                ) t1
       where t1.mid = t4.mid
        and t1.tid = t4.tid
        and t1.qid = t4.qid
        and t1.rid = t4.rid
       ) as module,

       (select t1.topic
         from (select t1.topic, t4.mid, t4.tid, t4.qid, t4.rid
                from intake_topic t1,
                     (select t3.mid, t3.tid, min(t3.qid) qid from intake_question t3 group by t3.mid, t3.tid) t3,
                     (select t4.mid, t4.tid, t4.qid, min(t4.rid) rid from intake_response t4 group by  t4.mid, t4.tid, t4.qid) t4
                where t1.mid = t3.mid
                  and t1.tid = t3.tid
                  and t3.mid = t4.mid
                  and t3.tid = t4.tid
                  and t3.qid = t4.qid
                ) t1
       where t1.mid = t4.mid
        and t1.tid = t4.tid
        and t1.qid = t4.qid
        and t1.rid = t4.rid
       ) as topic,
       (select t1.question
         from (select t1.question, t4.mid, t4.tid, t4.qid, t4.rid
                from intake_question t1,
                     (select t4.mid, t4.tid, t4.qid, min(t4.rid) rid from intake_response t4 group by  t4.mid, t4.tid, t4.qid) t4
                where t1.mid = t4.mid
                  and t1.tid = t4.tid
                  and t1.qid = t4.qid
                ) t1
       where t1.mid = t4.mid
        and t1.tid = t4.tid
        and t1.qid = t4.qid
        and t1.rid = t4.rid
       ) as question,
       t4.response
 from intake_response t4
order by t4.mid, t4.tid, t4.qid, t4.rid;

prompt
prompt Creating view VW_INTAKE_PROBLEM_LIST
prompt ====================================
prompt
create or replace force view vw_intake_problem_list as
select t."INTAKE_PROBLEM_ID",t."FLAG_ID",t."MID",t."PROBLEM",t."ACTIVE",t."DIAGNOSIS_ID",t."MH_AXIS", t.diagnosis_id || ',' || t.intake_problem_id as DIAGID_PROBID
from intake_problem_list t;

prompt
prompt Creating view VW_PATIENT_FREPORT
prompt ================================
prompt
create or replace force view vw_patient_freport as
select su.name, t.initial_visit_date, pd."PATIENT_ID",pd."FIRST_NAME",pd."MI",
       pd."LAST_NAME",pd."FMP",pd."SPONSOR_SSN",pd."SSN",
       pd."GENDER",pd."MARITAL_STATUS_ID",pd."DOB",pd."HAS_FIRARM",
       pd."EDUCATION_LEVEL_ID",pd."PROVIDER_ID",pd."ADDRESS1",
       pd."ADDRESS2",pd."CITY",pd."POSTAL_CODE",pd."HOMEPHONE",
       pd."WORKPHONE",pd."EMAIL",pd."STATE_ID",pd."HAS_REFERAL",
       pd."AWAITING_TRANSFER",pd."TRANSFER_DMIS_ID",pd."EDIPN",
       pd."FX_USER_ID",pd."LAST_UPDATED",pd."LAST_UPDATED_BY",
       pd."IS_HIGH_INTEREST",pd."PORTAL_USER_ID",pd."CURRENT_WEIGHT",
       pd."CURRENT_HEIGHT",pd."WRK_PHONE_CALL",pd."HOME_PHONE_CALL",
       pd."HOME_PHONE_MSG",pd."EMAIL_MSG",pd."DEVICE_ID",pd."CELLPHONE",
       pd."CELL_PHONE_CALL",pd."MDWS_PATIENT_ID",pd."MDWS_REGION_ID",pd."MDWS_SITE_ID"
    from suat_user su, patient_demographics pd, treatment t
   where su.provider_id=pd.provider_id and pd.patient_id= t.patient_id;

prompt
prompt Creating view VW_PATIENT_FX_AUDIT_FREPORT
prompt =========================================
prompt
create or replace force view vw_patient_fx_audit_freport as
select fx."DB_SESSION_ID",fx."CLIENT_IP",fx."FX_USER_ID",fx."AUDIT_DATE",fx."AUDIT_NAME",fx."AUDIT_DATA", p.patient_id
    from fx_audit fx, patient_demographics p
   where fx.fx_user_id=p.fx_user_id;

prompt
prompt Creating view VW_PATIENT_LOCK
prompt =============================
prompt
create or replace force view vw_patient_lock as
select t."PATIENT_ID",t."PROVIDER_ID",t."PROVIDER_NAME", t."EMAIL", t."SESSION_ID",t."LOCK_TIME",t."FX_USER_ID",
  round((sysdate - nvl(t.lock_time, sysdate)) * 24 * 60 , 2) as elapsed_time
    from patient_lock t;

prompt
prompt Creating view VW_ZIPCODE_DISTRIB
prompt ================================
prompt
create or replace force view vw_zipcode_distrib as
select "POSTAL_CODE","FEMALE","MALE","TOTAL"
  from (select t.postal_code,
               (select count(*)
                  from patient_demographics t2
                 where t2.postal_code = t.postal_code
                   and getPatientColumnValue(t2.gender, t2.patient_id) = 'F') as FEMALE,
               (select count(*)
                  from patient_demographics t2
                 where t2.postal_code = t.postal_code
                   and getPatientColumnValue(t2.gender, t2.patient_id) = 'M') as MALE,
               count(*) as TOTAL
          from PATIENT_DEMOGRAPHICS t
         where t.postal_code is not null
         group by t.postal_code
         order by t.postal_code) s1
union
select "POSTAL_CODE","FEMALE","MALE","TOTAL"
  from (select 'N/A' as postal_code,
               (select count(*)
                  from patient_demographics
                 where postal_code is null
                   and getPatientColumnValue(gender, patient_id) = 'F') as FEMALE,
               (select count(*)
                  from patient_demographics
                 where postal_code is null
                   and getPatientColumnValue(gender, patient_id) = 'M') as MALE,
               (select count(*)
                  from patient_demographics
                 where postal_code is null) as TOTAL
          from dual) s2;

prompt
prompt Creating package IC_UTL_SEC_TEMP
prompt ================================
prompt
create or replace package IC_UTL_SEC_TEMP is

   function encryptData_str (
      pi_vData                          in varchar2
      )
      return                               varchar2;

   function decryptData_str (
        pi_vData                          in varchar2

      )
      return                               varchar2;

   function VarcharToAscii (
     strData            in    varchar2
     ) return varchar2;

   function AsciiToVarchar (
     strData            in    varchar2
     ) return varchar2;

   function UnPad (
     strData            in    varchar2
     ) return varchar2;

   function Pad (
     strData            in    varchar2
     ) return varchar2;

end;
/

prompt
prompt Creating package PCK_APP_MENU
prompt =============================
prompt
create or replace package PCK_APP_MENU is

  --return recordsets
  type RetRefCursor is ref cursor;

  procedure GetMenuRootLevelRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetMenuItemsRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetToolbarItemsRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetMenuItemsRights(po_vItemsRights out varchar2);
  procedure GetPageAccessRights(po_vItemsRights out varchar2);
  procedure GetUserRightsTemplates(po_vItemsRights out varchar2);

end PCK_APP_MENU;
/

prompt
prompt Creating package PCK_AP_USERADMIN
prompt =================================
prompt
create or replace package PCK_AP_USERADMIN is

  --return recordsets
  type RetRefCursor is ref cursor;

  procedure InsertSuatUser(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vProviderID      in varchar2,
                           pi_nlocked          in number,
                           pi_vName            in varchar2,
                           pi_vRank            in varchar2,
                           pi_nServiceID       in number,
                           pi_vTitle           in varchar2,
                           pi_vCorps           in varchar2,
                           pi_vSquadron        in varchar2,
                           pi_vOfficeSymbol    in varchar2,
                           pi_vPhone           in varchar2,
                           pi_vEmail           in varchar2,
                           pi_vDimsID          in varchar2,
                           pi_vUIDPWD          in varchar2,
                           pi_nMustChgPwd      in number,
                           pi_vSupervisorID    in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure UpdateSuatUser(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vProviderID      in varchar2,
                           pi_vCurrentDimsID   in varchar2,
                           pi_nlocked          in number,
                           pi_vName            in varchar2,
                           pi_vRank            in varchar2,
                           pi_nServiceID       in number,
                           pi_vTitle           in varchar2,
                           pi_vCorps           in varchar2,
                           pi_vSquadron        in varchar2,
                           pi_vOfficeSymbol    in varchar2,
                           pi_vPhone           in varchar2,
                           pi_vEmail           in varchar2,
                           pi_vDimsID          in varchar2,
                           pi_vUIDPWD          in varchar2,
                           pi_nMustChgPwd      in number,
                           pi_vSupervisorID    in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure GetUserRightsRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor);

  procedure GetUserTypesRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetSUATUsersRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetUserPermissionsRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nRights          in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetInternSupervisorsRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);

  procedure InsertRightsTemplate(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nUserType        in number,
                                 pi_nUserRights      in number,
                                 pi_nRightsMode      in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  procedure UpdateRightsTemplate(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nUserType        in number,
                                 pi_nUserRights      in number,
                                 pi_nRightsMode      in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  procedure GetRightsTemplateRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

end PCK_AP_USERADMIN;
/

prompt
prompt Creating package PCK_CMS
prompt ========================
prompt
create or replace package PCK_CMS is

  --return recordsets
  type RetRefCursor is ref cursor;

  procedure GetAuthorRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out RetRefCursor);

  procedure GetPagesListRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetPageContentsRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nPageID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure InsertPage(pi_vSessionID       in varchar2,
                       pi_vSessionClientIP in varchar2,
                       pi_nUserID          in number,
                       pi_nAuthorID        in number,
                       pi_vTitle           in varchar2,
                       pi_cContents        in clob,
                       pi_nStatus          in number,
                       po_nPageID          out number,
                       po_nStatusCode      out number,
                       po_vStatusComment   out varchar2);

  procedure EditPage(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     pi_nPageID          in number,
                     pi_nAuthorID        in number,
                     pi_vTitle           in varchar2,
                     pi_cContents        in clob,
                     pi_nStatus          in number,
                     po_nStatusCode      out number,
                     po_vStatusComment   out varchar2);

  procedure GetALLMenusTop(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetALLMenuChildren(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetALLMenuItems(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor);

  function GetPageStatus(pi_nPageID in number) return number; 
  
  procedure GetTemplatesListRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure InsertMenuItem(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_vMenuTitle      in varchar2,
                           pi_nParentID       in number,
                           pi_nPageID         in number,
                           pi_nUserRights     in number,
                           pi_nTargetPortalID in number,
                           pi_nSortOrder      in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2);

  procedure UpdateMenuItem(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_nMenuID         in number,
                           pi_vMenuTitle      in varchar2,
                           pi_nParentID       in number,
                           pi_nPageID         in number,
                           pi_nUserRights     in number,
                           pi_nTargetPortalID in number,
                           pi_nSortOrder      in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2);

  procedure DeleteMenuItem(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_nMenuID in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2);

  procedure DeleteCMSPage(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          
                          pi_nPageID in number,
                          
                          po_nStatusCode    out number,
                          po_vStatusComment out varchar2);

  procedure GetMenuRootLevelRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_nPortalID        in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetEduTopItemRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor);

  procedure GetMenuItemsRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nPortalID        in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure SearchContentsRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vSearch          in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

end PCK_CMS;
/

prompt
prompt Creating package PCK_COMMON
prompt ===========================
prompt
create or replace package PCK_COMMON is

  -- Public type declarations
  type refCursor is ref cursor;
  --todo: update righs using entries in STAT_USER_RIGHTS
  c_nNoneUR                          constant binary_integer := 0;   -- 0000000000000000
  c_nDataManagementUR                constant binary_integer := 1;   -- 0000000000000001
  c_nCaseManagementUR                constant binary_integer := 2;   -- 0000000000000010
  c_nPopulationReportingUR           constant binary_integer := 4;   -- 0000000000000100
  c_nTxAssessmentPlanningUR          constant binary_integer := 8;   -- 0000000000001000
  c_nSignNoteUR                      constant binary_integer := 16;  -- 0000000000010000
  c_nCloseNoteUR                     constant binary_integer := 32;  -- 0000000000100000
  c_nProcessNewPatientsUR            constant binary_integer := 64;  -- 0000000001000000
  c_nAdministratorUR                 constant binary_integer := 131072; -- 0000000010000000
  
  c_nMAJCOMUR    constant binary_integer := 32768; --1000000000000000;
  c_nHQUR        constant binary_integer := 32768; --1000000000000000;

  c_nResultStatus_Error   constant binary_integer := 1;
  c_nResultStatus_Success constant binary_integer := 0;

  /*****
  Description:
  helper function used to get data by using dynamic sql 
  "into" statement. value is returned as a vachar2
  and can be casted as needed. We use dynamic sql for 
  security reasons.
  
  Input Params:
  pi_vSQL       The sql to execute with 1 and only 1 field in the select statement
  
  Returns:
  The 1 seleted value as a string
  *****/
  function GetDynamicSQLValue(pi_vSql in varchar2) return varchar2;

  /*****
  Description:
  helper function used to get the next value from a sequence
  
  Input Params:
  pi_vSQL        The name of the sequence to get the nexval from
  
  Returns:
  The next value from the sequence
  *****/
  function GetNextSequenceValue(pi_vSequenceName in varchar2) return number;

  --status codes
  c_nStatus_Success constant number(1) := 1;
  c_nStatus_Error   constant number(1) := 2;
  c_nStatus_Unknown constant number(1) := 3;

  --status texts
  c_vStatus_Default   constant varchar2(255) := '';
  c_vStatus_undefined constant varchar2(255) := 'An undefined error occurred, please contact your system administrator!';

  --are we in debug mode? 1 = yes, 0 = no
  c_nDebug_Mode constant number(1) := 1;

  --used for Enquote Literal
  c_nDoubleTic constant varchar2(2) := '''';

  -- STAT_ACTIVE
  c_nActive   constant number(1) := 1;
  c_nInactive constant number(1) := 2;

  --Active Filter
  c_nFilterActive   constant number(1) := 1;
  c_nFilterInactive constant number(1) := 2;
  c_nShowActiveAll  constant number(1) := 3;

  /*****
  Description:
  helper function used to generate comment text
  
  Input Params:
  pi_vProcedureName        package:procedure that called this function
  pi_vSessionClientIP      user friendly status
  
  Returns:
  returns the formatted status comment 
  ******/
  function GetStatusComment(pi_vPCKStatusLabel in varchar2,
                            pi_vDetails        in varchar2) return varchar2;

  /*****
  Description:
  helper function used to get age given date of birth
  *****/
  function GetAge(pi_dtDOB in date) return number;

  /*****
  Description:
  helper function used to get a piece of data
  *****/
  function GetPiece(strData      in varchar2,
                    strDelimiter in varchar2,
                    nPosition    in NUMBER) return varchar2;

   /*****
  Description:
  helper function used to get a comma separated value list from a cursor
  *****/
  function join(p_cursor sys_refcursor, p_del varchar2 := ',')
    return varchar2;

end;
/

prompt
prompt Creating package PCK_CPAP_DEVICE
prompt ================================
prompt
create or replace package PCK_CPAP_DEVICE is

  type RetRefCursor is ref cursor;

  procedure AddUpdateDevice(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            
                            pi_vKey          in varchar2,
                            pi_vPatientID    in varchar2,
                            pi_vDeviceName   in varchar2,
                            pi_nDeviceTypeID in number,
                            pi_vSerialNumber in varchar2,
                            pi_vLowPressure  in varchar2,
                            pi_vHighPressure in varchar2,
                            pi_vMaskType     in varchar2,
                            pi_vMaskDetails  in varchar2,
                            pi_nPAPType      in number,
                            
                            pi_vStudyDate   in varchar2,
                            pi_nBaselineAHI in number,
                            
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2);

  procedure GetPatientDeviceRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_vPatientID in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2,
                               rs                out RetRefCursor);

  procedure GetOtherDevicesRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              
                              pi_vKey       in varchar2,
                              pi_vPatientID in varchar2,
                              
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2,
                              rs                out RetRefCursor);

  procedure DeactivatePAPDevice(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                
                                pi_vPatientID    in varchar2,
                                pi_vSerialNumber in varchar2,
                                
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2);

end PCK_CPAP_DEVICE;
/

prompt
prompt Creating package PCK_CPAP_IMPORT
prompt ================================
prompt
create or replace package PCK_CPAP_IMPORT is

 type RetRefCursor is ref cursor;
 
 --moves data from data_cpap_philips to appropriate tables
 procedure ImportPhilipsData(
   pi_vKey in varchar2,
   po_nStatusCode out number,
   po_vStatusComment out varchar2);
                               
 --moves data from data_cpap_resmed to appropriate tables
 procedure ImportRESMEDData(
   pi_vKey in varchar2,
   po_nStatusCode out number,
   po_vStatusComment   out varchar2);
                               
  --helper to import patient cpap data
  procedure ImportPatCPAP(
    pi_vKey in varchar2,
    pi_vPatientID in varchar2,
    pi_nDeviceID in number,
    pi_dtTherapy in date,
    pi_nMinsUse in number,
    pi_nAHI in number,
    pi_nLeak in number,
    pi_nLeakTypeID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);                                
                                
end PCK_CPAP_IMPORT;
/

prompt
prompt Creating package PCK_CPAP_RESULTS
prompt =================================
prompt
create or replace package PCK_CPAP_RESULTS is

  --custom to return recordsets
  type RetRefCursor is ref cursor;

  procedure GetCPAPResultsRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

  procedure GetAHIBaselineRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

  procedure GetQuestionnaireListRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);

end PCK_CPAP_RESULTS;
/

prompt
prompt Creating package PCK_DEMOGRAPHICS
prompt =================================
prompt
create or replace package PCK_DEMOGRAPHICS is

  --recordsets
  type RetRefCursor is ref cursor;

  procedure GetRelationshipSelfRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      );

  procedure GetStateRS(
                       pi_vSessionID       in varchar2,
                       pi_vSessionClientIP in varchar2,
                       pi_nUserID          in number,
                       po_nStatusCode      out number,
                       po_vStatusComment   out varchar2,
                       rs                  out RetRefCursor
                       );

  procedure GetGenderRS(
                        pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out RetRefCursor
                        );

  procedure GetGenderDescByIdRS (
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vGenderID               in varchar2,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2,
      rs                         out RetRefCursor
      );

end PCK_DEMOGRAPHICS;
/

prompt
prompt Creating package PCK_DEVICES
prompt ============================
prompt
create or replace package PCK_DEVICES is

  --recordsets
  type RetRefCursor is ref cursor;

  procedure GetDevicesRS(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2,
                         rs                  out RetRefCursor);

  procedure GetDevicePatientRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vKey in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

end PCK_DEVICES;
/

prompt
prompt Creating package PCK_DIAGNOSIS
prompt ==============================
prompt
create or replace package PCK_DIAGNOSIS is
  type RetRefCursor is ref cursor;

  function getAxis(diagid in number) return number;
  function getDiagnosisTitle(diagnosisId in number) return varchar2;
  function getDiagnosisDetails(diagnosisId in number) return varchar2;
  function getDiagnosisCode(diagnosisId in number) return varchar2;
  function getSpecifierText(specifierId in number) return varchar2;

  procedure GetAxisItems(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_nAxis            in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2,
                         rs                  out RetRefCursor);

  procedure GetAxisChildItems(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nAxis            in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure LoadSpecifiers(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nDiagId          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure AddDiagnosis(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_vPatientID       in varchar2,
                         pi_vEncounterID     in varchar2,
                         pi_nTreatmentID     in number,
                         pi_nTreatDiagID     in number,
                         pi_nDiagnosisID     in number,
                         pi_nSpecifierID     in number,
                         pi_vDiagnosisText   in varchar2,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2);

  procedure DeleteDiagnosis(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPatientID       in varchar2,
                            pi_vEncounterID     in varchar2,
                            pi_nTreatmentID     in number,
                            pi_nTreatDiagID     in number,
                            pi_nDiagnosisID     in number,
                            pi_nSpecifierID     in number,
                            pi_vDiagnosisText   in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);

  procedure UpdateRemissionStage(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vEncounterID     in varchar2,
                                 pi_nTreatmentID     in number,
                                 pi_nTreatDiagID     in number,
                                 pi_nDiagnosisID     in number,
                                 pi_nSpecifierID     in number,
                                 pi_vDiagnosisText   in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  --Insert diagnosis
  procedure InsertDiagnosis(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            --
                            pi_vPatientID   in varchar2,
                            pi_vEncounterID in varchar2,
                            pi_nTreatmentID in number,
                            pi_nDiagnosisID in number,
                            pi_nSpecifierID in number,
                            pi_vAxis3Text   in varchar2,
                            --
                            po_nProblemID     out number,
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2);

  --Update diagnosis
  procedure UpdateDiagnosis(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            --
                            pi_vPatientID   in varchar2,
                            pi_vEncounterID in varchar2,
                            pi_nTreatmentID in number,
                            pi_nProblemID   in number,
                            pi_nDiagnosisID in number,
                            pi_nSpecifierID in number,
                            pi_vAxis3Text   in varchar2,
                            pi_vComment     in varchar2,
                            pi_nSortOrder   in number,
                            --
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2);

  procedure GetDiagnosisByIdRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_nDiagnosisID     in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetStatSpecifiersRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure GetAllSpecifiersRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure UpdateDiagnosisA3(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nProblemID       in number,
                              pi_vPatientID       in varchar2,
                              pi_vDiagText        in varchar2,
                              pi_nSeeMedRec       in number,
                              pi_nContributory    in number,
                              pi_vDiagComment     in varchar2,
                              pi_nSortOrder       in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2);

  procedure GetPotentialProblemsRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   pi_vEncounterID     in varchar2,
                                   pi_nTreatmentID     in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);

  procedure GetProblemCriteriaRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vEncounterID     in varchar2,
                                 pi_nIntkProblemID   in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetCriteriaDefinitionsRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vEncounterID     in varchar2,
                                     pi_nIntkProblemID   in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor);

  procedure InsertCriteriaDefinition(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_vEncounterID     in varchar2,
                                     pi_nTreatmentID     in number,
                                     pi_nDiagnosisID     in number,
                                     pi_nProblemID       in number,
                                     --pi_nIntakeProblemID in number,
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2);

  procedure GetTxProblemCriteriaRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   pi_vEncounterID     in varchar2,
                                   pi_nTreatmentId     in number,
                                   pi_nProblemID       in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);

  procedure GetTxProblemCriteriaDefRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vPatientID       in varchar2,
                                      pi_vEncounterID     in varchar2,
                                      pi_nTreatmentId     in number,
                                      pi_nProblemID       in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor);

  procedure UpdateCriteria(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nProblemID       in number,
                           pi_nCriteriaID      in number,
                           pi_nStatus          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure UpdateCriteriaDefinition(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     
                                     pi_nProblemID    in number,
                                     pi_nCriteriaID   in number,
                                     pi_nDefinitionID in number,
                                     pi_nStatus       in number,
                                     
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2);

  procedure DiscontinueDiagnosis(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_nProblemID       in number,
                                 pi_vInactiveComment in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  procedure GetQuestionResponseRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vEncounterID     in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

  procedure DiscardPossibleProblem(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vEncounterID     in varchar2,
                                   pi_nIntakeProblemID in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2);

  function fUpdateEncDiagnosis(pi_vPatientID   varchar2,
                               pi_vEncounterID varchar2) return varchar2;

  function fGetDiagnosisString(pi_vPatientID   varchar2,
                               pi_vEncounterID varchar2) return varchar2;

  procedure UpdateDiagnosisProb(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nProblemID       in number,
                                pi_nDiagnosisID     in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2);

  procedure GetAllChildItemsRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetAxesTitlesRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor);

  function fGetAssessmentPlanString(pi_vPatientID   varchar2,
                                    pi_vEncounterID varchar2) return varchar2;

end PCK_DIAGNOSIS;
/

prompt
prompt Creating package PCK_ENCOUNTER
prompt ==============================
prompt
create or replace package PCK_ENCOUNTER is

  --custom to return recordsets
  type RetRefCursor is ref cursor;
  type refCursor is ref cursor;

  procedure GetEncounterRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           pi_nTreatmentID     in number,
                           pi_vEncounterID     in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetCurrentTreatmentRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

  procedure CreateEncounter(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPatientID       in varchar2,
                            pi_vTreatmentID     in varchar2,
                            pi_vNewEncID        in varchar2,
                            pi_nEncounterType   in number, --0=initial, 6=other, 7 = admin note, 8 = group note
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);

  procedure GetTreatmentEncountersRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor);
  
  procedure GetAllEncounterListRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

  procedure GetAllEncounterIntakeRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor);

  procedure GetEncounterDates(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nSelectedCases   in number,
                              pi_nTreatmentID     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);
    
  procedure GetInitialVisitRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nTreatmentID     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);


  procedure GetEncounterIntakeFlagsRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      
                                      pi_vEncounterID   in varchar2,
                                      pi_nMID           in number,
                                      po_nStatusCode    out number,
                                      po_vStatusComment out varchar2,
                                      rs                out RetRefCursor);

  procedure UpdateEncounterDiagnosis(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_vEncounterID     in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2);

  function fUpdateEncDiagnosis(pi_vPatientID   varchar2,
                               pi_vEncounterID varchar2) return varchar2;

  procedure GetEducationFlagsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vPatientID       in varchar2,
                                pi_vEncounterID     in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  --ReVamp Added New
  procedure GetAllEncounterTypesRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);

  -- toggle note's lock state
  procedure LockNote(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     --
                     pi_vPatientID   in varchar2,
                     pi_vEncounterID in varchar2,
                     pi_nTreatmentID in number,
                     --
                     po_nStatusCode    out number,
                     po_vStatusComment out varchar2);

  procedure CreateSelfMgntEncounter(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    
                                    pi_vPatientID in varchar2,
                                    pi_vNewEncID  in varchar2,
                                    
                                    po_nStatusCode    out number,
                                    po_vStatusComment out varchar2);

  procedure GetSelfMgntEncounterRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2,
                                   rs                out RetRefCursor);

  procedure GetModuleGroupStatusRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2,
                                   rs                out RetRefCursor);

  procedure CloseSelfMgntEncounter(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID   in varchar2,
                                   pi_vEncounterID in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2);

  -- GET ENCOUNTER INTAKE ID
  procedure GetEncIntakeIdRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vEncounterID in varchar2,
                             pi_nMID         in number,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor);

  procedure IsModuleAssigned(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vPatientID in varchar2,
                             pi_nMID       in number,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor);

  procedure UpdatePatientDetials(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vEncounterID in varchar2,
                                 pi_nWeight      in number,
                                 pi_nHeight      in number,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure GetPatientDetialsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                
                                pi_vEncounterID in varchar2,
                                
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2,
                                rs                out RetRefCursor);

end PCK_ENCOUNTER;
/

prompt
prompt Creating package PCK_UTL_COMMON
prompt ===============================
prompt
create or replace package PCK_UTL_COMMON is

   -- Public type declarations
   type refCursor is ref cursor;

   -- Public constant declarations
   c_nResultStatus_Error       constant number := 1;
   c_nResultStatus_Success     constant number := 0;

end;
/

prompt
prompt Creating package PCK_ENCOUNTER_INTAKE
prompt =====================================
prompt
create or replace package PCK_ENCOUNTER_INTAKE is

  --custom to return recordsets
  type RetRefCursor is ref cursor;

  function GetPiece(strData      in varchar2,
                    strDelimiter in varchar2,
                    nPosition    in NUMBER) return varchar2;

  procedure GetEncounterFlags(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vEncounterID     in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out Pck_Utl_Common.refCursor);

  procedure GetEncounterIntakeFlags(pi_vSessionID         in varchar2,
                                    pi_vSessionClientIP   in varchar2,
                                    pi_nUserID            in number,
                                    pi_vEncounterID       in varchar2,
                                    pi_vEncounterIntakeID in number,
                                    po_nStatusCode        out number,
                                    po_vStatusComment     out varchar2,
                                    rs                    out Pck_Utl_Common.refCursor);

  procedure getIntakeAltLang(pi_vSessionID         in varchar2,
                             pi_vSessionClientIP   in varchar2,
                             pi_nUserID            in number,
                             pi_vEncounterID       in varchar2,
                             pi_nEncounterIntakeID in number,
                             po_nOutAltLang        out number,
                             po_nStatusCode        out number,
                             po_vStatusComment     out varchar2);

  procedure getIntakePatientID(pi_vSessionID         in varchar2,
                               pi_vSessionClientIP   in varchar2,
                               pi_nUserID            in number,
                               pi_vEncounterID       in varchar2,
                               pi_nEncounterIntakeID in number,
                               po_vPatientID         out varchar2,
                               po_nStatusCode        out number,
                               po_vStatusComment     out varchar2);

  -----------------------------------------------------------
  -- Tries to retrieve the encounter ID for the passed MID.
  -- If there is no encounter, it inserts a new encounter
  -- of type 7 (patient intake session)
  -----------------------------------------------------------
  procedure GetEncounterIDFromModule(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_nModuleID        in number,
                                     pi_vPatientID       in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_vEncounterID     out varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2);

  -- Checks to see if there is an encounter_intake for the module
  -- if not, it inserts new one
  procedure NewEncounterIntake(pi_vSessionID         in varchar2,
                               pi_vSessionClientIP   in varchar2,
                               pi_nUserID            in number,
                               pi_nModuleID          in number,
                               pi_vEncounterID       in varchar2,
                               pi_nAltLang           in number,
                               po_nEncounterIntakeID out number,
                               po_nStatusCode        out number,
                               po_vStatusComment     out varchar2);

  --get all Encounter Intake Responses
  procedure GetResponsesCountRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vEncounterID     in varchar2,
                                pi_vMIDs            in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure GetIntakesForEducationRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor);

  procedure GetIntakesForReviewRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  pi_vEncounterID      in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

end PCK_ENCOUNTER_INTAKE;
/

prompt
prompt Creating package PCK_FX_SEC
prompt ===========================
prompt
create or replace package PCK_FX_SEC is

  --custom to return recordsets
  type RetRefCursor is ref cursor;
  
  --session values
  procedure DeleteSessionValue(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vKey             in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2);
  procedure GetSessionValue(pi_vDBSessionID     in varchar2,
                            pi_vWebSessionID    in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vKey             in varchar2,
                            po_vKeyValue        out varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);
  procedure SetSessionValue(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vKey             in varchar2,
                            pi_vKeyValue        in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);

  procedure DeleteAllSessionValues(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2);

  --auditing
  procedure AuditPageAccess(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPageName        in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);

  --login and return a databsae session id
  procedure CertLogin(pi_vSessionID       in varchar2,
                      pi_vSessionClientIP in varchar2,
                      pi_nUserID          in number, --not used but passed in to maintain consistant default param list
                      pi_vCert            in varchar2,
                      po_nUserID          out number,
                      po_vDBSessionID     out varchar2,
                      po_nTimeout         out number,
                      po_nStatusCode      out number,
                      po_vStatusComment   out varchar2);

  --login and return a databsae session id
  procedure Login(pi_vSessionID       in varchar2,
                  pi_vSessionClientIP in varchar2,
                  pi_nUserID          in number, --not used but passed in to maintain consistant default param list
                  pi_vUserName        in varchar2,
                  pi_vPassword        in varchar2,
                  pi_vCert            in varchar2,
                  po_nUserID          out number,
                  po_vDBSessionID     out varchar2,
                  po_nTimeout         out number,
                  po_nStatusCode      out number,
                  po_vStatusComment   out varchar2);

  --login and return a databsae session id
  procedure Sign(pi_vSessionID       in varchar2,
                 pi_vSessionClientIP in varchar2,
                 pi_nUserID          in number,
                 pi_vUserName        in varchar2,
                 pi_vPassword        in varchar2,
                 po_vProviderID      out varchar2,
                 po_nUserType        out number,
                 po_nStatusCode      out number,
                 po_vStatusComment   out varchar2);

  procedure ValidatePassword(pi_vKey in varchar2,
                             pi_nUserID        in number,
                             pi_vUserName      in varchar2,
                             pi_vOldPassword   in varchar2,
                             pi_vPassword      in varchar2,
                             pi_vCOldPassword  in varchar2,
                             pi_vCPassword     in varchar2,
                             pi_vCUserName     in varchar2,
                             pi_nResetPassword in number,
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2);

  --user change password and login
  procedure ChangePassword(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number, --not used but passed in to maintain consistant default param list
                           pi_vKey in varchar2,
                           pi_vUserName        in varchar2,
                           pi_vOldPassword     in varchar2,
                           pi_vPassword        in varchar2,
                           pi_vCert            in varchar2,
                           pi_vCOldPassword    in varchar2,
                           pi_vCPassword       in varchar2,
                           pi_vCUserName       in varchar2,
                           po_nUserID          out number,
                           po_vDBSessionID     out varchar2,
                           po_nTimeout         out number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  --logoff
  procedure LogOff(pi_vSessionID       in varchar2,
                   pi_vSessionClientIP in varchar2,
                   pi_nUserID          in number,
                   po_nStatusCode      out number,
                   po_vStatusComment   out varchar2);

  --get fx_user record by encrypted uid
  procedure GetFXUserRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        pi_vEncUID          in varchar2,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out RetRefCursor);

  --audit a transaction
  procedure AuditTransaction(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vSPName          in varchar2,
                             pi_clAuditXML       in clob,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2);

  --insert a new fx_user
  procedure InsertFXUser(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_vKey in varchar2,
                         pi_vProviderID      in varchar2,
                         pi_vUserName        in varchar2,
                         pi_vPassword        in varchar2,
                         pi_nAccountLocked   in number,
                         pi_nAccountInactive in number,
                         
                         pi_vCOldPassword in varchar2,
                         pi_vCPassword    in varchar2,
                         pi_vCUserName    in varchar2,
                         
                         po_nFXUserID      out number,
                         po_nStatusCode    out number,
                         po_vStatusComment out varchar2);

  --update an fx_user record
  procedure UpdateFXUser(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_nFXUserID        in number,
                         pi_vProviderID      in varchar2,
                         pi_vUserName        in varchar2,
                         pi_vPassword        in varchar2,
                         pi_nAccountLocked   in number,
                         pi_nAccountInactive in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2);

  procedure UpdateFXUserRights(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_nFxUserID        in number,
                               pi_nUserType        in number,
                               pi_nUserRights      in number,
                               pi_nUserReadOnly    in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2);

  --update an fx_user record
  procedure UpdateFXUserPWD(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vKey in varchar2,
                            pi_nFXUserID        in number,
                            pi_vUserName        in varchar2,
                            pi_vPassword        in varchar2,
                            pi_nAccountLocked   in number,
                            pi_nAccountInactive in number,
                            
                            pi_vCPassword in varchar2,
                            pi_vCUserName in varchar2,
                            
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2);

  --update an fx_user record
  procedure UpdateFXUserOptions(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nFXUserID        in number,
                                pi_nAccountLocked   in number,
                                pi_nAccountInactive in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2);

  procedure GetFXUsernamePasswordRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vProviderID      in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor);

  procedure GetFXUserIdRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vProviderID      in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor);

  procedure CheckFXUserRecRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vProviderID      in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

  procedure GetSecurityQuestions(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nQuestionGrp     in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetUserQuestions(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             --
                             pi_vUsername in varchar2,
                             --                                 
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor);

  procedure UpdateSecQuestions(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_nQuestionID_1 in number,
                               pi_vAnswer_1     in varchar2,
                               
                               pi_nQuestionID_2 in number,
                               pi_vAnswer_2     in varchar2,
                               
                               pi_nQuestionID_3 in number,
                               pi_vAnswer_3     in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2);

  procedure CheckSecurityQuestions(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   --pi_nQuestionID_1 in number,
                                   pi_vAnswer_1 in varchar2,
                                   
                                   --pi_nQuestionID_2 in number,
                                   pi_vAnswer_2 in varchar2,
                                   
                                   --pi_nQuestionID_3 in number,
                                   pi_vAnswer_3 in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2);

  procedure ResetPassword(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vKey in varchar2,
                          pi_nFXUserID        in number,
                          pi_vUserName        in varchar2,
                          pi_vPassword        in varchar2,
                          pi_vCPassword       in varchar2,
                          pi_vCUserName       in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2);
  
end PCK_FX_SEC;
/

prompt
prompt Creating package PCK_FX_SEC_PATIENT
prompt ===================================
prompt
create or replace package PCK_FX_SEC_PATIENT is

 --custom to return recordsets
  type RetRefCursor is ref cursor;

 --insert a new fx_user
  procedure InsertPatientFXUser (
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vKey in varchar2,
      pi_vPatientID              in varchar2,
      pi_vUserName               in varchar2,
      pi_vPassword               in varchar2,
      pi_nAccountLocked          in number,
      pi_nAccountInactive        in number,
      
      pi_vCOldPassword           in varchar2,
      pi_vCPassword              in varchar2,
      pi_vCUserName              in varchar2,        
      po_nFXUserID               out number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     );

  --update an fx_user record
   procedure UpdatePatientFXUserPWD(
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vKey in varchar2,
      pi_nFXUserID               in number,
      pi_vUserName               in varchar2,
      pi_vPassword               in varchar2,
      pi_nAccountLocked          in number,
      pi_nAccountInactive        in number,
      
      pi_vCPassword              in varchar2,
      pi_vCUserName              in varchar2,
      
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     );

   --update an fx_user record
   procedure UpdatePatientFXUserOptions(
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_nFXUserID               in number,
      pi_nAccountLocked          in number,
      pi_nAccountInactive        in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     );

  procedure GetPatientFXUsernamePasswordRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      pi_vKey in varchar2,
      pi_vPatientID       in varchar2,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      );

   procedure GetPatientFXUserIdRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      pi_vKey in varchar2,
      pi_vPatientID       in varchar2,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      );

   procedure CheckPatientFXUserRecRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      pi_vKey in varchar2,
      pi_vPatientID       in varchar2,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      );


end PCK_FX_SEC_PATIENT;
/

prompt
prompt Creating package PCK_INTAKE
prompt ===========================
prompt
create or replace package PCK_INTAKE is

  --custom to return recordsets
  type RetRefCursor is ref cursor;

  procedure InsertTreatmentProblems(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    pi_nTreatmentID     in number,
                                    pi_vEncounterID     in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2);

  procedure GetResponseLoadRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vLoadTable       in varchar2,
                              pi_vLoadField       in varchar2,
                              pi_vLoadFilter      in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetIntakeModulesRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetPatientModulesRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vPatientID       in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure InsertPatientModules(pi_vSessionID        in varchar2,
                                 pi_vSessionClientIP  in varchar2,
                                 pi_nUserID           in number,
                                 pi_vPatientID        in varchar2,
                                 pi_vAssignProviderID in varchar2,
                                 pi_dDateAssigned     in date,
                                 pi_nMID              in number,
                                 pi_nModuleGroup      in number,
                                 pi_vStatus           in varchar2,
                                 po_nStatusCode       out number,
                                 po_vStatusComment    out varchar2);

  procedure DeletePatientModules(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vStatus          in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  procedure UpdatePatientModules(pi_vSessionID        in varchar2,
                                 pi_vSessionClientIP  in varchar2,
                                 pi_nUserID           in number,
                                 pi_vPatientID        in varchar2,
                                 pi_vAssignProviderID in varchar2,
                                 pi_dDateAssigned     in date,
                                 pi_dDateCompleted    in date,
                                 pi_nMID              in number,
                                 pi_vStatus           in varchar2,
                                 po_nStatusCode       out number,
                                 po_vStatusComment    out varchar2);

  procedure GetModuleGroupRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

  procedure GetModulesListRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

  procedure AssignPatientModules(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vPatientID  in varchar2,
                                 pi_vProviderID in varchar2,
                                 pi_vModules    in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure GetPatIntakeAssignedRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);

  procedure WriteIntakeResponses(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vEncounterID in varchar2,
                                 pi_nEncIntakeID in number,
                                 pi_nMID         in number,
                                 pi_nIntakeGrpID in number,
                                 pi_vResponses   in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  -- *****************************************************
  -- MARK MODULE COMPLETE
  procedure CompleteModule(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_vPatientID in varchar2,
                           pi_nMID       in number,
                           pi_nGroupID   in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2);

  -- *****************************************************
  -- INSERT ENCOUNTER INTAKE 
  procedure InsertEncounterIntake(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  
                                  pi_vEncounterID in varchar2,
                                  pi_nMID         in number,
                                  pi_nEncIntakeID in number,
                                  pi_nModality    in number,
                                  pi_nIntakeGroup    in number,
                                  
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2);

  -- *****************************************************
  -- Assign initial Assessments

  procedure AssignInitialAssessments(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     
                                     pi_vPatientID in varchar2,
                                     
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2);

  -- *****************************************************
  -- Insert Encounter Intake Score

  procedure InsertEncIntakeScore(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vEncounterID in varchar2,
                                 pi_nEncIntakeID in number,
                                 pi_nMID         in number,
                                 pi_nScoreType   in number,
                                 pi_nScore       in number,
                                 pi_nPCent       in number,
                                 pi_vInterpret   in varchar2,
                                 pi_nSeries      in number,
                                 pi_nIntakeGroup      in number,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure GetPatIntakeScoresRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vPatientID in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2,
                                 rs                out RetRefCursor);

  procedure GetIntakeReport(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            
                            pi_vEncounterID in varchar2,
                            pi_nEncIntakeID in number,
                            
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2,
                            rs                out RetRefCursor);

  procedure GetIntakeReportCSVRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vEncounterID     in varchar2,
                                 pi_nEncIntakeID     in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetSymptomsFUResponsesRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor);

  PROCEDURE GetScoreDataStringRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

end;
/

prompt
prompt Creating package PCK_JOBS
prompt =========================
prompt
create or replace package PCK_JOBS is

  procedure ImportRESMEDData;
  procedure ImportPhillipsData;
  procedure SendPatEventReminder;

end;
/

prompt
prompt Creating package PCK_MESSAGES
prompt =============================
prompt
create or replace package PCK_MESSAGES is

  --return recordsets
  type RetRefCursor is ref cursor;

  procedure GetUserMessagesRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vKey             in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetDeletedMessagesRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetUnreadMessagesRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure GetSentMessagesRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vKey             in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetRecipientsListRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nMessageID       in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure SendMessage(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        
                        pi_vKey        in varchar2,
                        pi_vRecipients in varchar2,
                        pi_vSubject    in varchar2,
                        pi_clobBody    in clob,
                        po_nMessageID  out number,
                        
                        po_nStatusCode    out number,
                        po_vStatusComment out varchar2);

  procedure MarkAsRead(pi_vSessionID       in varchar2,
                       pi_vSessionClientIP in varchar2,
                       pi_nUserID          in number,
                       pi_nMessageID       in number,
                       po_nStatusCode      out number,
                       po_vStatusComment   out varchar2);

  procedure MarkAsDeleted(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_nMessageID       in number,
                          pi_nIsSentMsg       in number,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2);

  procedure GetProviderPatientsRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vKey             in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

  procedure GetAllProviderRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor);

  function fGetRecipientsList(pi_vKey in varchar2, pi_nMessageID varchar2)
    return varchar2;

  procedure BulkSendMessages(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_nMessageID in number,
                             pi_vRecipient in varchar2,
                             pi_vSubject   in varchar2,
                             pi_clobBody   in clob,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2);

  -- **************************************************************
  --  SEND EXTERNAL MESSAGE NOTIFICATION
  procedure SendExternalNotification(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vKey             in varchar2,
                                     pi_nMessageID       in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2);

end PCK_MESSAGES;
/

prompt
prompt Creating package PCK_MILITARY
prompt =============================
prompt
create or replace package PCK_MILITARY is

  --return recordsets
  type RetRefCursor is ref cursor;

  --get a record set back
  procedure GetMilitaryServiceRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);


  procedure GetMilitaryDutyStationRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor);

end PCK_MILITARY;
/

prompt
prompt Creating package PCK_NOTE_PREFILL
prompt =================================
prompt
create or replace package PCK_NOTE_PREFILL is

  -- Public type declarations
  type RetRefCursor is ref cursor;

  function fnGetQuestionResponse(pi_vPatientID in varchar2,
                                 pi_nMID       in number,
                                 pi_nTID       in number,
                                 pi_nQID       in number,
                                 pi_nModGroup  in number) return varchar2;

  function fnGetQuestionScore(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nTID       in number,
                              pi_nQID       in number,
                              pi_nModGroup  in number) return varchar2;

  function fnGetQuestionResponseList(pi_vPatientID in varchar2,
                                     pi_nMID       in number,
                                     pi_nTID       in number,
                                     pi_nQID       in number,
                                     pi_nModGroup  in number) return varchar2;

  function fnGetResponseByID(pi_vPatientID in varchar2,
                             pi_nMID       in number,
                             pi_nTID       in number,
                             pi_nQID       in number,
                             pi_nRID       in number,
                             pi_nModGroup  in number) return varchar2;

  function fnHasResponse(pi_vPatientID in varchar2,
                         pi_nMID       in number,
                         pi_nTID       in number,
                         pi_nQID       in number,
                         pi_nModGroup  in number) return number;

  function fnHasResponseByID(pi_vPatientID in varchar2,
                             pi_nMID       in number,
                             pi_nTID       in number,
                             pi_nQID       in number,
                             pi_nRID       in number,
                             pi_nModGroup  in number) return number;

  function fnGetScore(pi_vPatientID in varchar2,
                      pi_nMID       in number,
                      pi_nModGroup  in number,
                      pi_nInterpret in number) return varchar2;

  function fnGetScoreData(pi_vPatientID in varchar2,
                          pi_nMID       in number,
                          pi_nModGroup  in number,
                          pi_nInterpret in number) return varchar2;

  function fnGet1MOTxSymptoms(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nGroup1    in number,
                              pi_nGroup2    in number) return varchar2;

  function fnGet1MOOSASymptoms(pi_vPatientID in varchar2,
                               pi_nMID       in number,
                               pi_nGroup1    in number,
                               pi_nGroup2    in number) return varchar2;

  function fnGet3MOTxSymptoms(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nGroup1    in number,
                              pi_nGroup2    in number) return varchar2;

  function fnGet3MOOSASymptoms(pi_vPatientID in varchar2,
                               pi_nMID       in number,
                               pi_nGroup1    in number,
                               pi_nGroup2    in number) return varchar2;

  function fnGet1WKTxSymptoms(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nGroup1    in number,
                              pi_nGroup2    in number) return varchar2;

  function fnGet1WKOSASymptoms(pi_vPatientID in varchar2,
                               pi_nMID       in number,
                               pi_nGroup1    in number,
                               pi_nGroup2    in number) return varchar2;

  function fnPAPUsage(pi_vPatientID in varchar2) return varchar2;

  function fnGetTimeDescription(minutes in number) return varchar2;  
  
   function fnGetPatientBMI(pi_vPatientID in varchar2, pi_nGroupID in number) return varchar2;

end PCK_NOTE_PREFILL;
/

prompt
prompt Creating package PCK_PATIENT
prompt ============================
prompt
create or replace package PCK_PATIENT is

  type RetRefCursor is ref cursor;
  
  procedure InitialEncounter(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             po_nInitialEnc      out number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2);

  --get a record set of patients back that match criteria
  procedure GetPatientLookupRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vKey in varchar2,
                               pi_nSelectedCases   in number,
                               pi_nSearchType      in number,
                               pi_vSearchValue     in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  --gets basic patient demographic data given the patients fx_user_id
  procedure GetPatientIDRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vKey in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor);

  procedure GetPatientDemographicsRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vKey in varchar2,
                                     pi_vPatientID       in varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor);

  procedure InsertPatientDemographics(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      --Patient Table
                                      pi_vKey in varchar2,
                                      pi_vPatientID      in varchar2,
                                      pi_vEncounterID    in varchar2,
                                      pi_vFirstName      in varchar2,
                                      pi_vMI             in varchar2,
                                      pi_vLastName       in varchar2,
                                      pi_vSponsorSSN     in varchar2,
                                      pi_vSSN            in varchar2,
                                      pi_vGender         in varchar2,
                                      pi_vDateOfBirth    in varchar2,
                                      pi_vProviderID     in varchar2,
                                      pi_vAddress1       in varchar2,
                                      pi_vAddress2       in varchar2,
                                      pi_vCity           in varchar2,
                                      pi_vPostal_Code    in varchar2,
                                      pi_vHomePhone      in varchar2,
                                      pi_vCellPhone      in varchar2,
                                      pi_vWorkPhone      in varchar2,
                                      pi_vEmail          in varchar2,
                                      pi_vStateID        in varchar2,
                                      pi_nCellPhoneMsg   in number,
                                      pi_nEmailMsg       in number,
                                      pi_nCallPreference in number,
                                      po_nStatusCode     out number,
                                      po_vStatusComment  out varchar2);

  procedure UpdatePatientDemographics(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vKey in varchar2,
                                      pi_vPatientID       in varchar2,
                                      pi_vFirstName       in varchar2,
                                      pi_vMI              in varchar2,
                                      pi_vLastName        in varchar2,
                                      pi_vSponsorSSN      in varchar2,
                                      pi_vSSN             in varchar2,
                                      pi_vGender          in varchar2,
                                      pi_vDateOfBirth     in varchar2,
                                      pi_vProviderID      in varchar2,
                                      pi_vAddress1        in varchar2,
                                      pi_vAddress2        in varchar2,
                                      pi_vCity            in varchar2,
                                      pi_vPostal_Code     in varchar2,
                                      pi_vHomePhone       in varchar2,
                                      pi_vCellPhone       in varchar2,
                                      pi_vWorkPhone       in varchar2,
                                      pi_vEmail           in varchar2,
                                      pi_vStateID         in varchar2,
                                      pi_nCellPhoneMsg    in number,
                                      pi_nEmailMsg        in number,
                                      pi_nCallPreference  in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2);

  procedure GetPatientTreatmentIdRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor);

  procedure GetPatientSponsorRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vPatientID       in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure InsertPatientSponsor(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vName            in varchar2,
                                 pi_nRelationshipID  in number,
                                 pi_vAddress1        in varchar2,
                                 pi_vCity            in varchar2,
                                 pi_vPostalCode      in varchar2,
                                 pi_vHomePhone       in varchar2,
                                 pi_vWorkPhone       in varchar2,
                                 pi_vEmail           in varchar2,
                                 pi_nStateID         in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  procedure UpdatePatientSponsor(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vName            in varchar2,
                                 pi_nRelationshipID  in number,
                                 pi_vAddress1        in varchar2,
                                 pi_vCity            in varchar2,
                                 pi_vPostalCode      in varchar2,
                                 pi_vHomePhone       in varchar2,
                                 pi_vWorkPhone       in varchar2,
                                 pi_vEmail           in varchar2,
                                 pi_nStateID         in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2);

  procedure GetPatientEmergencyContactRS(pi_vSessionID       in varchar2,
                                         pi_vSessionClientIP in varchar2,
                                         pi_nUserID          in number,
                                         pi_vPatientID       in varchar2,
                                         po_nStatusCode      out number,
                                         po_vStatusComment   out varchar2,
                                         rs                  out RetRefCursor);

  procedure InsertPatientEmergencyContact(pi_vSessionID       in varchar2,
                                          pi_vSessionClientIP in varchar2,
                                          pi_nUserID          in number,
                                          pi_vPatientID       in varchar2,
                                          pi_vName            in varchar2,
                                          pi_nRelationshipID  in number,
                                          pi_vAddress1        in varchar2,
                                          pi_vCity            in varchar2,
                                          pi_vPostal_Code     in varchar2,
                                          pi_vHomePhone       in varchar2,
                                          pi_vWorkPhone       in varchar2,
                                          pi_vEmail           in varchar2,
                                          pi_nStateID         in number,
                                          po_nStatusCode      out number,
                                          po_vStatusComment   out varchar2);

  procedure UpdatePatientEmergencyContact(pi_vSessionID       in varchar2,
                                          pi_vSessionClientIP in varchar2,
                                          pi_nUserID          in number,
                                          pi_vPatientID       in varchar2,
                                          pi_vName            in varchar2,
                                          pi_nRelationshipID  in number,
                                          pi_vAddress1        in varchar2,
                                          pi_vCity            in varchar2,
                                          pi_vPostal_Code     in varchar2,
                                          pi_vHomePhone       in varchar2,
                                          pi_vWorkPhone       in varchar2,
                                          pi_vEmail           in varchar2,
                                          pi_nStateID         in number,
                                          po_nStatusCode      out number,
                                          po_vStatusComment   out varchar2);

  
  procedure GetPatientMilDetailByIdRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vPatientID       in varchar2,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor);

  procedure DelIncPatIntakeAssessments(pi_vSessionID       in varchar2,
                                       pi_vSessionClientIP in varchar2,
                                       pi_nUserID          in number,
                                       pi_vPatientID       in varchar2,
                                       po_nStatusCode      out number,
                                       po_vStatusComment   out varchar2);

  procedure IncPatIntakeAssessments(pi_vSessionID            in varchar2,
                                    pi_vSessionClientIP      in varchar2,
                                    pi_nUserID               in number,
                                    pi_vPatientID            in varchar2,
                                    po_nHasIncPatAssessments out number,
                                    po_nStatusCode           out number,
                                    po_vStatusComment        out varchar2);

  procedure GetMilitaryDetailsRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey in varchar2,
                                 pi_vPatientID       in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);
  
  procedure UpdateMilitaryDetails(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  --Patient Table
                                  pi_vFMP        in varchar2,
                                  pi_vEDIPN      in varchar2,
                                  pi_vSponsorSSN in varchar2,
                                  --Patient Military Detail Table
                                  pi_vService       in varchar2,
                                  pi_vPayGrade      in varchar2,
                                  pi_vDutyStation   in varchar2,
                                  pi_vStatus        in varchar2,
                                  pi_nSquadron      in number,
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2);

  procedure UpdateMilitaryDetails2(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   pi_vFMP             in varchar2,
                                   pi_vEDIPN           in varchar2,
                                   pi_vSponsorSSN      in varchar2,
                                   pi_vService         in varchar2,
                                   pi_vPayGrade        in varchar2,
                                   pi_vDutyStation     in varchar2,
                                   pi_vStatus          in varchar2,
                                   pi_nSquadron        in number,
                                   pi_vUnit            in varchar2,
                                   pi_nGTScore         in number,
                                   pi_nMonthInCombat   in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2);

  procedure DeletePatientAssignedModule(pi_vPatientID     in varchar2,
                                        nMID              in number,
                                        po_nStatusCode    out number,
                                        po_vStatusComment out varchar2);

  procedure UpdatePatientModuleStatus(pi_vPATIENT_ID    in VARCHAR2,
                                      pi_vMID           in NUMBER,
                                      pi_vSTATUS        in NUMBER,
                                      po_nStatusCode    out number,
                                      po_vStatusComment out varchar2);

  --get the list of modules (assessments) 
  --assigned to the patient
  procedure getPatientModuleRS(pi_vSessionID        in varchar2,
                               pi_vSessionClientIP  in varchar2,
                               pi_nUserID           in number,
                               pi_vPatientID        in varchar2, -- JRL added
                               pi_nSelectedLanguage in number,
                               po_nStatusCode       out number,
                               po_vStatusComment    out varchar2,
                               rs                   out Pck_Utl_Common.refCursor);

  --count the modules that are not complete for the patient     
  procedure getPatientModuleCount(pi_vPatientID     in varchar2,
                                  po_nMIDCount      out number,
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2);

  procedure UpdateCPAPDevice(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vKey in varchar2,
                             pi_vPatientID in varchar2,
                             pi_nDeviceID  in number,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2);

  --gets dataset to populate Patient Portal Lookup List
  procedure GetPatientPortalListRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vKey in varchar2,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out Pck_Utl_Common.refCursor);

  procedure updatePatFxUserRights;

end PCK_PATIENT;
/

prompt
prompt Creating package PCK_PATIENT_EVENTS
prompt ===================================
prompt
create or replace package PCK_PATIENT_EVENTS is

  --return recordsets
  type RetRefCursor is ref cursor;

  procedure GetPatientEventsRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vPatientID       in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  procedure GetAllPatientEventsRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

  procedure CheckPatMessagesPrefs(pi_vKey       in varchar2,
                                  pi_vPatientID in varchar2,
                                  po_nTextMsg   out number,
                                  po_nEmail     out number);

  procedure SendInternalNotification(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     
                                     pi_vKey       in varchar2,
                                     pi_vPatientID in varchar2,
                                     pi_nEventID   in number,
                                     
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2);

  procedure CompletedEvent(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_vKey       in varchar2,
                           pi_vPatientID in varchar2,
                           pi_nEventID   in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2);

  procedure AddAllEvents(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         
                         pi_vPatientID in varchar2,
                         
                         po_nStatusCode    out number,
                         po_vStatusComment out varchar2);

  procedure UpdatePatientEvent(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_vKey       in varchar2,
                               pi_vPatientID in varchar2,
                               pi_nEventID   in number,
                               pi_vEventDate in varchar2,
                               pi_nStatus    in number,
                               pi_vComments  in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2);

  procedure SendEventNotification(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  
                                  pi_vKey       in varchar2,
                                  pi_vPatientID in varchar2,
                                  pi_nEventID   in number,
                                  
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2);

  procedure GetStatEventsRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor);

  procedure AddSpecificEvent(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             pi_nEventID         in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2);

  procedure CompletedSpecificEvent(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vKey             in varchar2,
                                   pi_vPatientID       in varchar2,
                                   pi_nEventID         in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2);

  procedure AssignModuleGroupEvent(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID  in varchar2,
                                   pi_nEventID    in number,
                                   pi_dtEventDate in date,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2);

  procedure SendPatEventReminder(pi_vKey           in varchar2,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure SendInternalReminder(pi_vKey           in varchar2,
                                 pi_vPatientID     in varchar2,
                                 pi_nEventID       in number,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure SendEventReminder(pi_vKey           in varchar2,
                              pi_vPatientID     in varchar2,
                              pi_nEventID       in number,
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2);

  procedure GetPatByEvtDueDateRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vKey   in varchar2,
                                 pi_vDate1 in varchar2,
                                 pi_vDate2 in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2,
                                 rs                out RetRefCursor);

  procedure GetPatByOverdueEvtRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetAllPatientsListRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out Pck_Utl_Common.refCursor);

  function IsEventDateReadOnly(pi_vPatientID in varchar2,
                               pi_nEventID   in number) return number;

  procedure CheckPAPEventALL(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vKey in varchar2,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2);

  procedure CheckPAPEvent(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          
                          pi_vKey       in varchar2,
                          pi_vPatientID in varchar2,
                          
                          po_nStatusCode    out number,
                          po_vStatusComment out varchar2);

  function UpdateStatusDate(pi_vPatientID in varchar2,
                            pi_nEventID   in number,
                            pi_nStatus    in number,
                            pi_vEventDate in varchar2) return number;

  -- Get JSON string of patient events
  procedure GetAllPatEventsJSONRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vKey             in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor);

end PCK_PATIENT_EVENTS;
/

prompt
prompt Creating package PCK_PATIENT_LOCK
prompt =================================
prompt
create or replace package PCK_PATIENT_LOCK is

  --custom to return recordsets
  type RetRefCursor is ref cursor;

  procedure GetPatientLock(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           rs                  out RetRefCursor,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure InsertPatientLock(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2);

  procedure DeletePatientLock(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2);

  procedure RefreshPatientLock(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vPatientID       in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2);

end PCK_PATIENT_LOCK;
/

prompt
prompt Creating package PCK_PATIENT_TX_STEP
prompt ====================================
prompt
create or replace package PCK_PATIENT_TX_STEP is

  type RetRefCursor is ref cursor;

  procedure InsertPatientStep(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              
                              pi_vPatientID in varchar2,
                              pi_nStep      in number,
                              
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2);

  procedure UpdatePatientSteps(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_vPatientID in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2);

  procedure DeletePatientStep(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              
                              pi_vPatientID in varchar2,
                              pi_nStep      in number,
                              
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2);

  procedure GetPatientStepRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vPatientID in varchar2,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor);

  procedure UpdateNotificationStep(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID        in varchar2,
                                   pi_nNotificationStep in number,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2);

end PCK_PATIENT_TX_STEP;
/

prompt
prompt Creating package PCK_PAT_ETHNICITY_RACE
prompt =======================================
prompt
create or replace package PCK_PAT_ETHNICITY_RACE is

  -- Author  : SAEL.LUGO
  -- Created : 8/20/2012 9:09:24 AM
  -- Purpose : stores all the stored procedures needed to insert, select,
  --           update and delete patient ethnicity and race data
  
  -- custom to return recordsets
  type RetRefCursor is ref cursor;
  
  procedure InsertPatientEthnicity(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    pi_nEthnicityID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);
  
  procedure InsertPatientRace(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    pi_nRaceID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);
    
  procedure InsertPatEthRaceSource(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    pi_nSourceID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);
  
  procedure GetEthnicityRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor);
  
  procedure GetRaceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor);
  
  procedure GetEthRaceSourceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor);
  
  procedure GetPatientEthnicityRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor);
  
  procedure GetPatientRaceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor);
    
  function GetPatientRaceListString(
    pi_vPatientID in varchar2)
  return varchar2;
    
  procedure GetPatEthRaceSourceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor);
    
  procedure DeletePatientEthnicity(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);
    
  procedure DeletePatientRace(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);
    
  procedure DeletePatEthRaceSource(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2);

end PCK_PAT_ETHNICITY_RACE;
/

prompt
prompt Creating package PCK_PROVIDER
prompt =============================
prompt
create or replace package PCK_PROVIDER is

  --recordsets
  type RetRefCursor is ref cursor;

  procedure GetProviderRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vDIMSID          in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor);

end PCK_PROVIDER;
/

prompt
prompt Creating package PCK_REFERRAL_CLINIC
prompt ====================================
prompt
create or replace package PCK_REFERRAL_CLINIC is

  type RetRefCursor is ref cursor;

  procedure GetReferralClinicRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nStatReferralID  in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure GetReferralClinicLookUpRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor);

  procedure InsertReferralClinic(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vReferralDesc    in varchar2,
                                 pi_vReferralText    in varchar2,
                                 pi_vProviderName in varchar2,
                                 pi_vAddress      in varchar2,
                                 pi_vCity         in varchar2,
                                 pi_nStateID      in number,
                                 pi_vPostalCode   in varchar2,
                                 pi_vPhone        in varchar2,
                                 pi_vFax          in varchar2,
                                 po_nReferralID    out number,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure UpdateReferralClinic(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nReferralID      in number,
                                 pi_vReferralDesc    in varchar2,
                                 pi_vReferralText    in varchar2,
                                 pi_vProviderName in varchar2,
                                 pi_vAddress      in varchar2,
                                 pi_vCity         in varchar2,
                                 pi_nStateID      in number,
                                 pi_vPostalCode   in varchar2,
                                 pi_vPhone        in varchar2,
                                 pi_vFax          in varchar2,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2);

  procedure DiscontinueReferralClinic(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_nReferralID      in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2);

end PCK_REFERRAL_CLINIC;
/

prompt
prompt Creating package PCK_REVAMP_REPORT
prompt ==================================
prompt
create or replace package PCK_REVAMP_REPORT is

  procedure GetReportRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out PCK_COMMON.refCursor);

  function fnGetPatSelectString return varchar2;

  -- Get Score changes
  function fnGetScoreChange(pi_vPatientID in varchar2,
                            pi_nMID       in number,
                            pi_nGrpID1    in number,
                            pi_nGrpID2    in number) return number;

end PCK_REVAMP_REPORT;
/

prompt
prompt Creating package PCK_REVAMP_TIU_COMMON
prompt ======================================
prompt
CREATE OR REPLACE PACKAGE "PCK_REVAMP_TIU_COMMON" is

-- Public constant declarations
--

--cursor
type refCursor is ref cursor;

-- default ids for temporal, outcome and decision states
c_nDefaultUnknownID constant number(1) := 1;
c_nDefaultGoodID constant number(1) := 2;
c_nDefaultBadID constant number(1) := 3;

--status codes
c_nStatus_Success     constant number(1) := 1;
c_nStatus_Error       constant number(1) := 2;
c_nStatus_Unknown     constant number(1) := 3;

--state codes
c_nState_NotSelected  constant number(1) := 1;
c_nState_Good         constant number(1) := 2;
c_nState_Unknown      constant number(1) := 3;
c_nState_Bad          constant number(1) := 4;

--status texts
c_vStatus_Default     constant varchar2(255) := '';
c_vStatus_undefined   constant varchar2(255) := 'An undefined error occurred, please contact your system administrator!';

--are we in debug mode? 1 = yes, 0 = no
c_nDebug_Mode         constant number(1) := 0;

--should we transfer from mdws? 1=yes, 0=no
c_nMDWS               constant number(1) := 1;

--used for Enquote Literal
c_nDoubleTic          constant varchar2(2) := '''';

-- STAT_ACTIVE
c_nActive constant number(1) := 1;
c_nInactive constant number(1) := 2;

--Active Filter
c_nFilterActive constant number(1) := 1;
c_nFilterInactive constant number(1) := 2;
c_nShowActiveAll constant number(1) := 3;

--item types
c_nLaboratory constant number(1) := 1;
c_nQuestionSelection constant number(1) := 2;
c_nQuestionFreeText constant number(1) := 3;
c_nCollection constant number(1) := 4;
c_nNoteTitle constant number(1) := 5;

-- checklist states
c_nOpen constant number(1) := 1;
c_nClosed constant number(1) := 2;
c_nCancelled constant number(1) := 3;

-- stat true false
c_nTrue constant number(1) := 1;
c_nFalse constant number(1) := 2;

/*****
Description:
helper function used to get data by using dynamic sql
"into" statement. value is returned as a vachar2
and can be casted as needed. We use dynamic sql for
security reasons.

Input Params:
pi_vSQL       The sql to execute with 1 and only 1 field in the select statement

Returns:
The 1 seleted value as a string
*****/
function GetDynamicSQLValue (
      pi_vSql in varchar2
      ) return varchar2;

/*
checks for a valid entry in the fx_session table
*/
function CheckFXSession (
      pi_vSessionID in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID in number
      ) return boolean;

/*****
Description:
helper function used to get the next value from a sequence

Input Params:
pi_vSQL        The name of the sequence to get the nexval from

Returns:
The next value from the sequence
*****/
function GetNextSequenceValue (
      pi_vSequenceName in varchar2
      ) return number;

/*****
Description:
helper function used to generate comment text

Input Params:
pi_vProcedureName        package:procedure that called this function
pi_vSessionClientIP      user friendly status

Returns:
returns the formatted status comment
******/
function GetStatusComment (
    pi_vPCKStatusLabel in varchar2,
    pi_vDetails in varchar2
    ) return varchar2;

/*****
Description:
helper function used to get age given date of birth
*****/
function GetAge(pi_dtDOB in date)
return number;

/*****
Description:
helper function used to get a piece of data
*****/
function GetPiece( strData      in varchar2,
                   strDelimiter in varchar2,
                   nPosition    in NUMBER) return varchar2;


end PCK_REVAMP_TIU_COMMON;
/

prompt
prompt Creating package PCK_REVAMP_TIU
prompt ===============================
prompt
CREATE OR REPLACE PACKAGE "PCK_REVAMP_TIU" AS

/* gets diagnosis rs for use in building tiu note */
procedure GetEncTIUNoteDiagRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_vPatientID             in varchar2,
      pi_nTreatmentID           in number,
      pi_vEncounterID           in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

/*gets note details that were written to MDWS*/
procedure GetEncounterTIUNote (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_vPatientID             in varchar2,
      pi_nTreatmentID           in number,
      pi_vEncounterID           in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

/*save tiu note details*/
procedure SaveEncounterTIUNote(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_vPatientID             in varchar2,
      pi_nMDWSPatientID         in number,
      pi_vMDWSUserID            in varchar2,
      pi_nClinicID              in number,
      pi_VNoteTitleIEN          in varchar2,
      pi_nTreatmentID           in number,
      pi_vEncounterID           in varchar2,
      pi_vMDWSEncounterID       in varchar2,
      pi_vNoteResultID          in varchar2,
      pi_vVisitTimeStamp        in varchar2,
      pi_dtNoteDate             in date,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2);

  procedure GetMDWSPatientIDRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_vPatientID             in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

procedure UpdateMDWSAccount (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                 in number,
      pi_vKey                    in varchar2,
      pi_nFXUserID               in number,
      pi_vUserName               in varchar2,
      pi_vPassword               in varchar2,
      pi_nRegionID               in number,
      pi_nSiteID                 in number,
      pi_nMDWSUserID             in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     );

procedure UpdateMDWSAccount (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                 in number,
      pi_vNoteTitleLabel          in varchar2,
      pi_nNoteClinicID           in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     );

procedure GetMDWSAccountRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                 in number,
      pi_vKey                    in varchar2,
      pi_nFXUserID              in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

procedure AuditTransaction (
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vSPName                 in varchar2,
      pi_clAuditXML              in clob,
      pi_nStatus                 in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     );

/*
saves a clinic to the database
*/
procedure SaveClinic(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_nClinicID                in number,
      pi_vClinicLabel             in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2);

/*
Description: Gets all clinics
*/
procedure GetClinicRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

 /*
saves a region to the database
*/
procedure SaveRegion(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_vRegionName            in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2);


/*
saves a site to the database
*/
procedure SaveSite(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_vSiteName            in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2);


procedure GetRegionRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

procedure GetSiteRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nRegionID              in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

/**************************************************************************/

/*****
  Description:
  Inserts or updates a patient in utl_patient.
  ******/
  procedure SavePatient (
    pi_vSessionID        in varchar2,
    pi_vSessionClientIP  in varchar2,
    pi_nUserID           in number,
    pi_nXferSystemID     in number,
    pi_vNewPatientID     in varchar2,
    pi_vNewEncounterID   in varchar2,
    pi_vKey              in varchar2,
    pi_nRegionID         in number,
    pi_nSiteID           in number,
    pi_vMDWSPatientID    in varchar2,
    pi_vSSN              in varchar2,
    pi_dtDOB             in date,
    pi_vFirstName        in varchar2,
    pi_vFullName         in varchar2,
    pi_vLastName         in varchar2,
    pi_vMI               in varchar2,
    pi_nSex              in number,
    pi_vHomeAddr1        in varchar2,
    pi_vHomeAddr2        in varchar2,
    pi_vHomeCity         in varchar2,
    pi_vHomeState        in varchar2,
    pi_vHomeZip          in varchar2,
    pi_vHomePhone        in varchar2,
    po_nStatusCode       out number,
    po_vStatusComment    out varchar2);

/**************************************************************************/
/*
saves a note title to the database
*/
procedure SaveNoteTitle(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_nNoteTitleTag           in number,
      pi_vNoteTitleLabel        in varchar2,
      pi_vNoteTitleDetails      in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2);

/*****
Description: Gets all note tiles
******/
procedure GetNoteTitleRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      );

END PCK_REVAMP_TIU;
/

prompt
prompt Creating package PCK_SOAPP_REPORT
prompt =================================
prompt
create or replace package PCK_SOAPP_REPORT is
  type RetRefCursor is ref cursor;

  procedure Sign(pi_vSessionID        in varchar2,
                 pi_vSessionClientIP  in varchar2,
                 pi_nUserID           in number,
                 pi_vPatientID        in varchar2,
                 pi_nTreatmentID      in number,
                 pi_vEncounterID      in varchar2,
                 pi_vSignedProviderID in varchar2,
                 pi_nSignedUserType   in number,
                 pi_nCloseEncounter   in number,
                 po_nStatusCode       out number,
                 po_vStatusComment    out varchar2);

  procedure updtSubjective(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           pi_vEncounterID     in varchar2,
                           pi_nTreatmentID     in number,
                           pi_vSubjective      in clob,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure updtObjective(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vPatientID       in varchar2,
                          pi_vEncounterID     in varchar2,
                          pi_nTreatmentID     in number,
                          pi_vObjective       in clob,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2);

  procedure updtAssessment(pi_vSessionID        in varchar2,
                           pi_vSessionClientIP  in varchar2,
                           pi_nUserID           in number,
                           pi_vKey in varchar2,
                           pi_vPatientID        in varchar2,
                           pi_vEncounterID      in varchar2,
                           pi_nTreatmentID      in number,
                           pi_vAssessment       in clob,
                           pi_nDLCID            in number,
                           pi_vDLCJustification in varchar2,
                           pi_nIsHighInterest   in number,
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2);

  procedure updtPlan(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     pi_vPatientID       in varchar2,
                     pi_vEncounterID     in varchar2,
                     pi_nTreatmentID     in number,
                     pi_vPlan            in clob,
                     po_nStatusCode      out number,
                     po_vStatusComment   out varchar2);

  procedure updtTreatmentPlan(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_vEncounterID     in varchar2,
                              pi_nTreatmentID     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2);

  procedure updtPrevention(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           pi_vEncounterID     in varchar2,
                           pi_nTreatmentID     in number,
                           pi_vPrevention      in clob,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure updtAddendum(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_vPatientID       in varchar2,
                         pi_vEncounterID     in varchar2,
                         pi_nTreatmentID     in number,
                         pi_vAddendum        in clob,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2);

  procedure updtAddendumSave(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             pi_vEncounterID     in varchar2,
                             pi_nTreatmentID     in number,
                             pi_vAddendumSave    in clob,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2);

  procedure updtSessionTime(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPatientID       in varchar2,
                            pi_vEncounterID     in varchar2,
                            pi_nTreatmentID     in number,
                            pi_vMaintained      in varchar2,
                            pi_vSessionTime     in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);

  procedure updtRecordsMaintainedAt(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    pi_vEncounterID     in varchar2,
                                    pi_nTreatmentID     in number,
                                    pi_vMaintained      in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2);

  procedure refreshTreatmentPlanText(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_vEncounterID     in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2);
 
 procedure UpdtSOAP(pi_vSessionID       in varchar2,
                    pi_vSessionClientIP in varchar2,
                    pi_nUserID          in number,
                    pi_vPatientID       in varchar2,
                    pi_vEncounterID     in varchar2,
                    pi_nTreatmentID     in number,
                    pi_vSubjective      in varchar2,
                    pi_vObjective       in varchar2,
                    pi_vAssessment      in varchar2,
                    pi_vPlan            in varchar2,
                    po_nStatusCode      out number,
                    po_vStatusComment   out varchar2);

end PCK_SOAPP_REPORT;
/

prompt
prompt Creating package PCK_SYSTEM_SETTINGS
prompt ====================================
prompt
create or replace package PCK_SYSTEM_SETTINGS is

  type RetRefCursor is ref cursor;

  procedure GetSystemSettingsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure UpdateSystemSettings(pi_vSessionID                 in varchar2,
                                 pi_vSessionClientIP           in varchar2,
                                 pi_nUserID                    in number,
                                 pi_vMailSMTPHost              in varchar2,
                                 pi_vSenderEmailAddress        in varchar2,
                                 pi_nMailSMTPPort              in number,
                                 pi_vSiteURL                   in varchar2,
                                 pi_vNotifyEmailAddress        in varchar2,
                                 pi_vTextingHost               in varchar2,
                                 pi_nTextingPort               in number,
                                 pi_vTextingUser               in varchar2,
                                 pi_vTextingPswd               in varchar2,
                                 pi_vOraWinDir                 in varchar2,
                                 po_nStatusCode                out number,
                                 po_vStatusComment             out varchar2);

  procedure GetSiteRS(pi_vSessionID       in varchar2,
                      pi_vSessionClientIP in varchar2,
                      pi_nUserID          in number,
                      po_nStatusCode      out number,
                      po_vStatusComment   out varchar2,
                      rs                  out RetRefCursor);                        

end PCK_SYSTEM_SETTINGS;
/

prompt
prompt Creating package PCK_TEMPLATE
prompt =============================
prompt
create or replace package PCK_TEMPLATE is

  --custom to return recordsets
  type RetRefCursor is ref cursor;
  type refCursor is ref cursor;

  procedure InsertTemplate(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nSOAPsectID      in number,
                           pi_vTemplateName    in varchar2,
                           pi_vTemplateText    in clob,
                           pi_nTempGroupID     in number,
                           po_nTemplateID      out number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure UpdateTemplate(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nTemplateID      in number,
                           pi_nGroupID         in number,
                           pi_vTemplateName    in varchar2,
                           pi_vTemplateText    in clob,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2);

  procedure GetParsedTemplate2RS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vEncounterID     in varchar2,
                                 pi_nTemplateID      in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetTemplateDataTagRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor);

  procedure GetTemplateDataTagGroupRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor);

  procedure GetTemplateTypeRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetTemplateRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor);

  procedure DiscontinueTemplate(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nTemplateID      in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2);

  procedure InsertTemplateGroup(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vTemplateGrpName in varchar2,
                                pi_vComments        in varchar2,
                                po_nTemplateGrpID   out number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2);

  procedure UpdateTemplateGroup(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nTemplateGrpID   in number,
                                pi_vTemplateGrpName in varchar2,
                                pi_vComments        in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2);

  procedure DiscontinueTemplateGroup(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_nTemplateGrpID   in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2);

  procedure GetTemplateGroupsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  procedure GetGroupTemplatesRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nGroupID         in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor);

  function fnGetParsedTemplateText(pi_vPatientID    in varchar2,
                                   pi_vKey          in varchar2,
                                   pi_vTemplateText in varchar2) return clob;

end PCK_TEMPLATE;
/

prompt
prompt Creating package PCK_TREATMENT
prompt ==============================
prompt
create or replace package PCK_TREATMENT is

  --custom to return recordsets
  type RetRefCursor is ref cursor;

  procedure GetCurrentTreatmentID(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  po_nTreatmentID     out number,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2);

 
  procedure GetTreatmentListRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vPatientID       in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor);

  
  procedure GetTreatmentsList(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nSelectCases     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);
                                                    
  procedure GetStatModalityByModalityIDRS(pi_vSessionID       in varchar2,
                                          pi_vSessionClientIP in varchar2,
                                          pi_nUserID          in number,
                                          pi_nModalityID      in number,
                                          po_nStatusCode      out number,
                                          po_vStatusComment   out varchar2,
                                          rs                  out RetRefCursor);
                                          

  procedure GetAllStatModalityTypesRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor);
                                 
  
  procedure GetDiagnosticIDRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nTreatmentID     in number,
                              pi_vEncounterID     in varchar2,
                              pi_nProblemID       in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetDiagnosisSymptomsRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_nDiagnosisID     in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor);


end PCK_TREATMENT;
/

prompt
prompt Creating package PCK_TREATMENT_PLAN
prompt ===================================
prompt
create or replace package PCK_TREATMENT_PLAN is

  --custom to return recordsets
  type RetRefCursor is ref cursor;

  -- PROBLEM LIST --
  procedure GetProblemListRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             pi_nTreatmentID     in number,
                             --
                             
                             --
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor);                         
 
end PCK_TREATMENT_PLAN;
/

prompt
prompt Creating package PCK_USER
prompt =========================
prompt
create or replace package PCK_USER is

  --return recordsets
  type RetRefCursor is ref cursor;

  --get a record set
  procedure GetLoginUserRS (
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vKey in varchar2,
      pi_nFXUserID               in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2,
      rs                         out RetRefCursor
      );

end PCK_USER;
/

prompt
prompt Creating package PCK_USER_ADMIN
prompt ===============================
prompt
create or replace package PCK_USER_ADMIN is

  --return recordsets
  type RetRefCursor is ref cursor;

  procedure GetUserLookupRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vDMISID          in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor);

  procedure GetUserLookupBySearchRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vSearchValue     in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor);

  procedure GetSuatUserRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vProviderID      in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor);

  procedure GetSuatUserNameRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nFXUserID        in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure GetFacilityInfoRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor);

  procedure InsertFacilityInfo(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vSiteID          in varchar2,
                               pi_vSiteName        in varchar2,
                               pi_vSiteAddress1    in varchar2,
                               pi_vSiteCity        in varchar2,
                               pi_vSiteState       in varchar2,
                               pi_vSitePostalCode  in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2);

  procedure UpdateFacilityInfo(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vSiteID          in varchar2,
                               pi_vSiteName        in varchar2,
                               pi_vSiteAddress1    in varchar2,
                               pi_vSiteCity        in varchar2,
                               pi_vSiteState       in varchar2,
                               pi_vSitePostalCode  in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2);

  procedure UpdateGraphPref(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_nGraphOpt        in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2);

  procedure GetGraphPref(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2,
                         rs                  out RetRefCursor);

end;
/

prompt
prompt Creating type TYP_OBJ_PATIENT_ENCOUNTER
prompt =======================================
prompt
CREATE OR REPLACE TYPE "TYP_OBJ_PATIENT_ENCOUNTER"                                                                                                                                                                                                                             as object
(
   patient_id     varchar2(50),
   encounter_date date,
   gender         varchar2(1),
   race_list      varchar2(255),
   ethnicity_list varchar2(255)
)
/

prompt
prompt Creating type TYP_TBL_PATIENT_ENCOUNTER
prompt =======================================
prompt
CREATE OR REPLACE TYPE "TYP_TBL_PATIENT_ENCOUNTER"                                                                          as table of TYP_OBJ_PATIENT_ENCOUNTER
/

prompt
prompt Creating function ANDN
prompt ======================
prompt
CREATE OR REPLACE FUNCTION andn( a NUMBER, b NUMBER) RETURN NUMBER AS
  BEGIN
     IF a <>0 AND b <>0 THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function CCUR
prompt ======================
prompt
CREATE OR REPLACE FUNCTION CCUR(expn IN NUMBER) RETURN NUMBER IS
   BEGIN
    RETURN ( round( expn, 2 ) );
  END;
/

prompt
prompt Creating function CDBL
prompt ======================
prompt
CREATE OR REPLACE FUNCTION CDBL(expn IN NUMBER) RETURN NUMBER IS convNum NUMBER;
  BEGIN
      convNum := expn;
      RETURN ( convNum );
  END;
/

prompt
prompt Creating function CINT
prompt ======================
prompt
CREATE OR REPLACE FUNCTION CINT(expn IN NUMBER) RETURN NUMBER IS
  BEGIN
     RETURN ( expn );
  END;
/

prompt
prompt Creating function CLNG
prompt ======================
prompt
CREATE OR REPLACE FUNCTION CLNG(expn IN NUMBER) RETURN NUMBER IS
  BEGIN
     RETURN ( expn );
  END;
/

prompt
prompt Creating function DATEADD
prompt =========================
prompt
CREATE OR REPLACE FUNCTION DATEADD(Intvl IN VARCHAR2,NIntvl IN NUMBER,Dexpr IN DATE)
  RETURN DATE IS convDate DATE;
  BEGIN
    IF LOWER(RTRIM(Intvl))='y' or LOWER(RTRIM(Intvl))='w' or LOWER(RTRIM(Intvl))='d' Then
       convDate := Dexpr+NIntvl;
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 'm' then
       convDate := ADD_MONTHS(Dexpr,NIntvl);
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 'q' then
       convDate := ADD_MONTHS(Dexpr,3*NIntvl);
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 'ww' then
       convDate := Dexpr + 7*NIntvl;
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 'h' then
       convDate := Dexpr + NIntvl/24;
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 'n' then
       convDate := Dexpr + NIntvl/1440;
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 's' then
       convDate := Dexpr + NIntvl/86400;
       return(convDate);
    ELSIF LOWER(RTRIM(Intvl)) = 'yyyy' then
       If TRUNC(NIntvl) = NIntvl Then
          convDate := ADD_MONTHS(Dexpr,NIntvl*12);
          return(convDate);
       Else
          convDate := Dexpr + NIntvl*365;
          return(convDate);
       END IF;
    END IF;
  END;
/

prompt
prompt Creating function EQN
prompt =====================
prompt
CREATE OR REPLACE FUNCTION eqn( a NUMBER, b NUMBER ) RETURN NUMBER AS
  BEGIN
     IF a = b THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function FNC_UTL_DECSTR
prompt ================================
prompt
create or replace function FNC_UTL_DECSTR (
   pi_vParameter0                  in varchar2,
   pi_vParameter1                  in varchar2,
   pi_vParameter2                  in varchar2
   )
   return                             varchar2
is
   type refCursor is ref cursor;
   rc                                   refCursor;
   v_vSql                               varchar2(4000);
   v_vReturnValue                       varchar2(4000);
begin
   v_vSql := 'select sys.ic_utl_sec.decryptData(:P0, :P1, :P2) from dual';
   open rc for v_vSql using pi_vParameter0, pi_vParameter1, pi_vParameter2;
   fetch rc into v_vReturnValue;
   close rc;

   return v_vReturnValue;
exception
   when others
   then
      return null;
end;
/

prompt
prompt Creating function FNC_UTL_DIGEST
prompt ================================
prompt
create or replace function FNC_UTL_DIGEST (
   pi_vParameter0                    in varchar2,
   pi_vParameter1                    in varchar2
   ) return                             varchar2
is
   v_vHashed                           varchar2(4000);
   v_vSql                              varchar2(4000);
begin
   v_vSql := 'select sys.ic_utl_sec.digest(:P0, :P1) from dual ';
   execute immediate v_vSql into v_vHashed using pi_vParameter0, trim(pi_vParameter1);
   return v_vHashed;
exception
   when others
   then
      return null;
end;
/

prompt
prompt Creating function FNC_UTL_ENCSTR
prompt ================================
prompt
create or replace function FNC_UTL_ENCSTR (
   pi_vParameter0                  in varchar2,
   pi_vParameter1                  in varchar2,
   pi_vParameter2                  in varchar2
   )
   return                             varchar2
is
   type refCursor is ref cursor;
   rc                                   refCursor;
   v_vSql                               varchar2(4000);
   v_vReturnValue                       varchar2(4000);
begin
   v_vSql := 'select sys.ic_utl_sec.encryptData(:P0, :P1, :P2) from dual';
   open rc for v_vSql using pi_vParameter0, pi_vParameter1, pi_vParameter2;
   fetch rc into v_vReturnValue;
   close rc;

   return v_vReturnValue;
exception
   when others
   then
      return null;
end;
/

prompt
prompt Creating function FNGETKEY
prompt ==========================
prompt
create or replace function fnGetKey return varchar2 is
  Result varchar2(4000);
begin
  --get the key
    sys.ic_utl_gk('DRDB', Result);
  return(Result);
end fnGetKey;
/

prompt
prompt Creating function GETCOLUMNVALUE
prompt ================================
prompt
create or replace function getColumnValue (
   pi_vColumnName                    in varchar2
   ) return                             varchar2
is
   type refCursor                      is ref cursor;
   rc                                  refCursor;
   v_vData                             varchar2(4000);
   v_vSql                              varchar2(4000);
begin
   v_vSql := 'select trim(' || pi_vColumnName || ') from fx_settings ';
   open rc for v_vSql;
   fetch rc into v_vData;
   close rc;

   return v_vData;
exception
   when others
   then
      return null;
end;
/

prompt
prompt Creating function GETENCOUNTERAGE
prompt =================================
prompt
create or replace function getEncounterAge (
   pi_dEncounterDate                 in date, 
   pi_dDob                           in date
   ) return                             number
is
begin
   return trunc(months_between(pi_dEncounterDate, pi_dDob) / 12);
exception
   when others
   then
      return null;
end;
/

prompt
prompt Creating function GETEVENTDAYS
prompt ==============================
prompt
create or replace function GetEventDays(pi_vPatientID in varchar2, pi_nEvent1 in number, pi_nEvent2 in number) return number is
  Result number := null;
  dtEvent1 date := null;
  dtEvent2 date := null;
begin
  
  --get event date 1
  begin
    select t.status_date
      into dtEvent1
      from patient_event t
     where t.patient_id = pi_vPatientID
       and t.event_id = pi_nEvent1
       and t.status = 1;
  exception
    when others then
      dtEvent1 := null;
  end;
  
    --get event date 2
  begin
    select t.status_date
      into dtEvent2
      from patient_event t
     where t.patient_id = pi_vPatientID
       and t.event_id = pi_nEvent2
       and t.status = 1;
  exception
    when others then
      dtEvent2 := null;
  end;
  
  if (dtEvent2 is not null) and (dtEvent1 is not null) then
    Result := ROUND(Abs(to_date(trunc(dtEvent2)) - to_date(trunc(dtEvent1))), 1);
  end if;
  
  return(Result);
end GetEventDays;
/

prompt
prompt Creating function GETPARAMETERVALUE
prompt ===================================
prompt
create or replace function getParameterValue(pi_vParameterName in varchar2)
  return varchar2 is

  type refCursor is ref cursor;
  rc      refCursor;
  v_vData varchar2(4000);

begin

  open rc for
    select t.parameter_value
      from utl_parameter t
     where t.parameter_name = upper(pi_vParameterName);

  fetch rc
    into v_vData;
  close rc;
  return v_vData;

exception
  when others then
    return null;
  
end getParameterValue;
/

prompt
prompt Creating function GETPATIENTETHNICITYLIST
prompt =========================================
prompt
create or replace function getPatientEthnicityList(pi_vPatientID in varchar2) return varchar2
  is
    v_vList varchar(255) := ',';
  begin
    for rec in (select t.ethnicity_id
      from patient_ethnicity t
      where t.patient_id = pi_vPatientID)
    loop
      v_vList := v_vList || rec.ethnicity_id || ',';
    end loop;
    
    return v_vList;
  exception
    when others then
      return '';
  end;
/

prompt
prompt Creating function GETPATIENTRACELIST
prompt ====================================
prompt
create or replace function getPatientRaceList(pi_vPatientID in varchar2) return varchar2
  is
    v_vList varchar(255) := ',';
  begin
    for rec in (select t.race_id
      from patient_race t
      where t.patient_id = pi_vPatientID)
    loop
      v_vList := v_vList || rec.race_id || ',';
    end loop;
    
    return v_vList;
  exception
    when others then
      return '';
  end;
/

prompt
prompt Creating function GETRACE
prompt =========================
prompt
create or replace function getRace(
          pi_vRaceList in varchar2
     ) return varchar2
     is
          v_vRace varchar2(4000) := '';
     begin
          for rec in (select t.*
                      from stat_race t
                      where t.race_id in (pi_vRaceList))
          loop
               v_vRace := v_vRace || rec.race_title || ', ';
          end loop;
          
          return rtrim(v_vRace, ', ');
     end;
/

prompt
prompt Creating function GETRIDRESPONSEVALUE
prompt =====================================
prompt
create or replace function getRIDResponseValue (
   pi_nEncounterID       in number,
   pi_nRID               in number
   ) return                 varchar2
is
   v_vResponseValue         varchar2(4000);
begin
   select t.response_value
     into v_vResponseValue
     from encounter_intake_responses t
    where t.encounter_id = pi_nEncounterID
      and t.rid = pi_nRID;

   return v_vResponseValue;

exception
   when others then
      return null;
end;
/

prompt
prompt Creating function GETSELECTEDRADIOVALUE
prompt =======================================
prompt
create or replace function getSelectedRadioValue (
   pi_nEncounterID       in number,
   pi_nTID               in number,
   pi_nQID               in number
   ) return                 number
is
   v_nResponseValue         number;
begin
   select t.rid
     into v_nResponseValue
     from encounter_intake_responses t
    where t.encounter_id = pi_nEncounterID
      and t.tid = pi_nTID
      and t.qid = pi_nQID;

   return v_nResponseValue;

exception
   when others then
      return -1;
end;
/

prompt
prompt Creating function GTEN
prompt ======================
prompt
CREATE OR REPLACE FUNCTION gten( a NUMBER, b NUMBER) RETURN NUMBER AS
  BEGIN
     IF a >= b THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function GTN
prompt =====================
prompt
CREATE OR REPLACE FUNCTION gtn( a NUMBER, b NUMBER) RETURN NUMBER AS
  BEGIN
     IF a > b THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function HASUSERRIGHT
prompt ==============================
prompt
create or replace function HasUserRight(pi_nUserID in number, pi_nUserRight in binary_integer) return boolean is

  Result boolean;

  v_nUserRights binary_integer;
  v_nHasRight binary_integer;

begin

  v_nUserRights := 0;
  v_nHasRight := 0;

  begin
  
  select nvl(user_rights, 0) into v_nUserRights 
         from fx_user_rights t
         where t.fx_user_id = pi_nUserID;
  
  exception
    when
    others
    then
      return false;
  end;
  
  v_nHasRight := bitand(v_nUserRights, pi_nUserRight);
  
  if  v_nHasRight > 0 then
  
    Result := true;
  
  else
  
    Result := false;
  
  end if;
    
  return(Result);
end HasUserRight;
/

prompt
prompt Creating function INTDIV
prompt ========================
prompt
CREATE OR REPLACE FUNCTION intdiv( a NUMBER, b NUMBER) RETURN NUMBER IS OUT NUMBER;
  BEGIN
     IF (a IS NULL) OR (b IS NULL) THEN
        RETURN NULL;
     ELSE
        out := trunc( round(a) / round(b) );
        RETURN out;
     END IF;
  END;
/

prompt
prompt Creating function INTN
prompt ======================
prompt
CREATE OR REPLACE FUNCTION INTN(expn IN NUMBER) RETURN NUMBER IS convNum NUMBER;
  BEGIN
      If expn >= 0 THEN
         convNum := TRUNC( expn );
      ELSE
         convNum := FLOOR( expn );
      END IF;
      RETURN( convNum );
  END;
/

prompt
prompt Creating function ISN
prompt =====================
prompt
CREATE OR REPLACE FUNCTION isn( a IN NUMBER, b IN VARCHAR2 ) RETURN NUMBER AS out NUMBER;
  BEGIN
     IF ( LOWER(b) = LOWER('NULL') ) THEN
        IF ( a IS NULL ) THEN
           RETURN -1;
        ELSE
           RETURN 0;
        END IF;
     ELSE
        IF ( a IS NOT NULL ) THEN
           RETURN -1;
        ELSE
           RETURN 0;
        END IF;
     END IF;
  END;
/

prompt
prompt Creating function IS_IN_48HR
prompt ============================
prompt
create or replace function IS_IN_48HR (
   pi_vDate                          in varchar2
   ) return                             number 
is
   v_nIsIn24Hr                          number := 0;
begin
   if (to_date(pi_vDate, 'MM/DD') > (sysdate - 2))
   then
      v_nIsIn24Hr := 1;
   end if;
   return v_nIsIn24Hr;
   
exception
   when others
   then
      return 0;
end;
/

prompt
prompt Creating function LEFT
prompt ======================
prompt
CREATE OR REPLACE FUNCTION LEFT(srcStr IN VARCHAR2, len IN INTEGER)
  RETURN VARCHAR2 IS dStr VARCHAR2(32767);
  BEGIN
      dStr := SUBSTR( srcStr, 1, len );
      RETURN ( dStr );
  END;
/

prompt
prompt Creating function LTEN
prompt ======================
prompt
CREATE OR REPLACE FUNCTION lten( a NUMBER, b NUMBER) RETURN NUMBER AS
  BEGIN
     IF a <= b THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function LTN
prompt =====================
prompt
CREATE OR REPLACE FUNCTION ltn( a NUMBER, b NUMBER) RETURN NUMBER AS
  BEGIN
     IF a < b THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function NOTEQN
prompt ========================
prompt
CREATE OR REPLACE FUNCTION noteqn( a NUMBER, b NUMBER ) RETURN NUMBER AS
  BEGIN
     IF a <> b THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function NOTN
prompt ======================
prompt
CREATE OR REPLACE FUNCTION notn( a NUMBER ) RETURN NUMBER AS
  BEGIN
     IF a = 0 THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function ORN
prompt =====================
prompt
CREATE OR REPLACE FUNCTION orn( a NUMBER, b NUMBER) RETURN NUMBER AS
  BEGIN
     IF a <>0 OR b <>0 THEN
        RETURN -1;
     ELSE
        RETURN 0;
     END IF;
  END;
/

prompt
prompt Creating function RIGHT
prompt =======================
prompt
CREATE OR REPLACE FUNCTION RIGHT(srcStr IN VARCHAR2, len IN INTEGER)
   RETURN VARCHAR2 IS dStr VARCHAR2(32767);
  BEGIN
    IF ( len >= LENGTH(srcStr) ) THEN
      RETURN( srcStr );
    END IF;
    dStr := SUBSTR(srcStr, LENGTH(srcStr) - len+1, len);
    RETURN ( dStr );
  END;
/

prompt
prompt Creating function RND
prompt =====================
prompt
CREATE OR REPLACE FUNCTION rnd
   RETURN NUMBER AS
     m  CONSTANT NUMBER:=100000000;
     m1 CONSTANT NUMBER:=10000;
     b  CONSTANT NUMBER:=31415821;
     a           NUMBER;
     the_date    DATE;
     days        NUMBER;
     secs        NUMBER;
     iMul        NUMBER;
     p1          NUMBER;
     p0          NUMBER;
     q1          NUMBER;
     q0          NUMBER;
  BEGIN
     the_date := SYSDATE;
     days     := TO_NUMBER( to_char( the_date, 'J'    ) );
     secs     := TO_NUMBER( to_char( the_date, 'SSSSS') );
     a        := days * 24 * 3600 + secs;
     p1       := TRUNC( a / m1 );
     p0       := MOD  ( a,  m1 );
     q1       := TRUNC( b / m1 );
     q0       := MOD  ( b,  m1 );
     iMul     :=( MOD( ( MOD( p0*q1+p1*q0,m1 ) *m1+p0*q0 ), m ) );
     a        :=MOD( iMul+1, m );
     RETURN( a/m );
  END;
/

prompt
prompt Creating function SPACE_
prompt ========================
prompt
CREATE OR REPLACE FUNCTION SPACE_(len IN NUMBER) RETURN VARCHAR2 IS dStr VARCHAR2(32767);
  BEGIN
    dStr := LPAD(' ', len , ' ');
    RETURN ( dStr );
  END;
/

prompt
prompt Creating function TIME_1
prompt ========================
prompt
CREATE OR REPLACE FUNCTION time_1(Dexpr IN DATE) RETURN CHAR IS convDate CHAR(8);
  BEGIN
    convDate := to_char(Dexpr,'hh24:mi:ss');
    RETURN( convDate );
  END;
/

prompt
prompt Creating function TIME_2
prompt ========================
prompt
CREATE OR REPLACE FUNCTION time_2 RETURN CHAR IS convDate CHAR(8);
  BEGIN
     convDate := to_char( SYSDATE, 'hh24:mi:ss');
     RETURN ( convDate );
  END;
/

prompt
prompt Creating function TRIM
prompt ======================
prompt
CREATE OR REPLACE FUNCTION trim ( Dexpr IN VARCHAR2 ) RETURN VARCHAR2 IS
  BEGIN
     RETURN LTRIM( RTRIM ( Dexpr ) );
  END;
/

prompt
prompt Creating procedure FIXPAPDATA
prompt =============================
prompt
create or replace procedure FixPAPData(pi_vSerialNumber in varchar2, pi_vStartDate in varchar2) is

  v_vPatientID varchar2(60);
  v_nDeviceID  number := -1;
  v_nDeviceTypeID number;
  v_dtStartDate date := to_date(to_char(sysdate, 'MM/DD/YYYY'), 'MM/DD/YYYY');

begin
  
 -- get device data from serial
 begin
   select t.patient_id, 
          t.device_id, 
          t.device_type_id
   into v_vPatientID,
        v_nDeviceID,
        v_nDeviceTypeID
   from cpap_device t
   where t.serial_number = pi_vSerialNumber;
   exception
     when others 
       then v_nDeviceID := -1;
 end;
  
 if v_nDeviceID > 0 then
   
   v_dtStartDate := to_date(pi_vStartDate, 'YYYYMMDD');
   
   -- delete patient pap data
   delete from patient_cpap t
   where t.patient_id = v_vPatientID
   and t.device_id = v_nDeviceID
   and t.therapy_date < v_dtStartDate;
   commit;
   
   -- modify pap import data
   if v_nDeviceTypeID = 1 then
     
     update data_cpap_philips t
     set t.deviceserial = t.deviceserial || '_notREVAMP',
         t.import_status = 0,
         t.import_status_cmnt = null,
         t.import_patient_id = null,
         t.import_device_id = null,
         t.import_timestamp = null
         where t.deviceserial = pi_vSerialNumber
         and t.import_status > 0
         and t.therapydate is not null
         and to_date(t.therapydate, 'YYYY-MM-DD') < v_dtStartDate;
         
         commit;
         
   elsif v_nDeviceTypeID = 2 then
     
     update data_cpap_resmed t
     set t.devicesn = t.devicesn || '_notREVAMP',
         t.import_status = 0,
         t.import_status_cmnt = null,
         t.import_patient_id = null,
         t.import_device_id = null,
         t.import_timestamp = null
     where t.devicesn = pi_vSerialNumber
     and t.import_status > 0
     and t.sessiondate is not null
     and to_date(t.sessiondate, 'MM/DD/YYYY') < v_dtStartDate;
     
     commit;
     
   end if;
   
 end if;
 
end FixPAPData;
/

prompt
prompt Creating procedure GETAGE3
prompt ==========================
prompt
create or replace procedure getAge3 (
   pi_dtDob                           in date,
   po_nAge                          out number
   )
is
   v_dDob                               date;
begin
   po_nAge := trunc((sysdate - pi_dtDob)/365);
end;
/

prompt
prompt Creating procedure PRC_UTL_EXECUTE_SQL
prompt ======================================
prompt
create or replace procedure PRC_UTL_EXECUTE_SQL (
   pi_vSql                           in varchar2
   )
is
   v_vSql                               varchar2(4000) := upper(trim(pi_vSql));
begin
   if (v_vSql like '%;%UPDATE%' and v_vSql not like '%;%''%UPDATE%''%') or
      (v_vSql like '%;%DELETE%' and v_vSql not like '%;%''%DELETE%''%') or
      (v_vSql like '%;%INSERT%' and v_vSql not like '%;%''%INSERT%''%')
   then
      return;
   end if;

   execute immediate pi_vSql;
   commit;

exception
   when others
   then
      null;
end;
/

prompt
prompt Creating procedure PRC_UTL_SEND_EMAIL_TEXT_MSG
prompt ==============================================
prompt
create or replace procedure PRC_UTL_SEND_EMAIL_TEXT_MSG(pi_vEmailSender      in varchar2,
                                                        pi_vEmailRecipients  in varchar2,
                                                        pi_vEmailSubject     in varchar2,
                                                        pi_vEmailMessage     in varchar2,
                                                        pi_vTextingRecipient in varchar2,
                                                        pi_vTextingMessage   in varchar2) is

  /*
  grant execute on ic_utl_sec to revampv2;
  grant execute on utl_smtp to revampv2;
  grant execute on utl_file to revampv2;
  grant execute on utl_http to revampv2;
  grant execute on dbms_network_acl_admin to revampv2;
  */

  -- create/recreate and grant acl
  procedure createAcl is
  begin
    begin
      dbms_network_acl_admin.create_acl(acl         => 'ic_utl.xml',
                                        description => 'ACL_IC_UTL',
                                        principal   => user,
                                        is_grant    => TRUE,
                                        privilege   => 'connect');
      commit;
    exception
      when others then
        null;
    end;
    dbms_network_acl_admin.add_privilege(acl       => 'ic_utl.xml',
                                         principal => user,
                                         is_grant  => TRUE,
                                         privilege => 'resolve');
    commit;
  
    dbms_network_acl_admin.assign_acl(acl  => 'ic_utl.xml',
                                      host => getColumnValue('MAIL_SMTP_HOST'));
    commit;
  
    dbms_network_acl_admin.assign_acl(acl  => 'ic_utl.xml',
                                      host => getColumnValue('TEXTING_HOST'));
    commit;
  end;

  -- send email
  procedure sendEmail(pi_vSender     in varchar2,
                      pi_vRecipients in varchar2,
                      pi_vSubject    in varchar2,
                      pi_vMessage    in varchar2) is
    v_Mail_Conn utl_smtp.Connection;
    crlf        varchar2(2) := chr(13) || chr(10);
    v_vSmtpHost varchar2(256);
    v_vSmtpPort varchar2(256);
  
    -- addRecipient
    procedure addRecipient(pi_vRecipients in varchar2) is
      v_vRecipients   varchar2(4000) := replace(pi_vRecipients, ' ') || ';';
      v_vEmailAddress varchar2(4000);
      v_nPos          number;
    begin
      while (v_vRecipients is not null) loop
        v_nPos          := instr(v_vRecipients, ';');
        v_vEmailAddress := trim(substr(v_vRecipients, 1, v_nPos - 1));
        v_vRecipients   := trim(substr(v_vRecipients, v_nPos + 1));
        utl_smtp.rcpt(v_Mail_Conn, v_vEmailAddress);
      end loop;
    end;
  begin
  
    v_vSmtpHost := getColumnValue('MAIL_SMTP_HOST');
    V_VSmtpPort := getColumnValue('MAIL_SMTP_PORT');
  
    v_Mail_Conn := utl_smtp.Open_Connection(v_vSmtpHost, v_vSmtpPort);
  
    utl_smtp.Helo(v_Mail_Conn, v_vSmtpHost);
    utl_smtp.Mail(v_Mail_Conn, pi_vSender);
    addRecipient(pi_vRecipients);
    utl_smtp.Data(v_Mail_Conn,
                  'Date: ' ||
                  to_char(sysdate, 'Dy, DD Mon YYYY hh24:mi:ss') || crlf ||
                  'From: ' || pi_vSender || crlf || 'Subject: ' ||
                  pi_vSubject || crlf || 'To: ' || pi_vRecipients || crlf || crlf ||
                  pi_vMessage);
    utl_smtp.Quit(v_mail_conn);
  end;

  -- send text msg
  procedure sendTextMsg(pi_vRecipient in varchar2, pi_vMessage in varchar2) is
    v_vResult   varchar2(4000);
    v_vUrl      varchar2(4000);
    v_vMessage  varchar2(4000);
    v_vUserName varchar2(128);
    v_vPassword varchar2(128);
  begin
  
    v_vUserName := sys.ic_utl_sec.decryptdata(getColumnValue('TEXTING_USER'),
                                              sys.ic_utl_sec.c_rKey);
    v_vPassword := sys.ic_utl_sec.decryptdata(getColumnValue('TEXTING_PSWD'),
                                              sys.ic_utl_sec.c_rKey);
  
    v_vMessage := replace(pi_vMessage, ' ', '%20');
    v_vUrl     := 'http://' || getColumnValue('TEXTING_HOST') || ':' ||
                  getColumnValue('TEXTING_PORT') || '/' || 'sendmsg?' ||
                  'user=' || v_vUserName || '&passwd=' || v_vPassword ||
                  '&cat=1' || '&to=' || pi_vRecipient || '&text=' ||
                  v_vMessage;
    v_vResult  := sys.utl_http.request(url => v_vUrl);
  end;
begin
  -- create/recreate and grant acl
  --createAcl ();

  -- send email
  sendEmail(pi_vEmailSender,
            pi_vEmailRecipients,
            pi_vEmailSubject,
            pi_vEmailMessage);

  -- send text msg
  sendTextMsg(pi_vTextingRecipient, pi_vTextingMessage);

exception
  when others then
    null;
end;
/

prompt
prompt Creating procedure PRC_UTL_TRUNCATE_PATIENT_DATA
prompt ================================================
prompt
create or replace procedure PRC_UTL_TRUNCATE_PATIENT_DATA
is
   procedure executeSql (
      pi_vSql                           in varchar2
      )
   is
   begin
      execute immediate pi_vSql;
      commit;
   end;

   procedure updateConstraints (
      pi_vTable                         in varchar2,
      pi_vStatus                        in varchar2
      )
   is
   begin
      for rc in (select t.table_name, t.constraint_name
                   from sys.user_constraints t
                  where t.constraint_type = 'R'
                    and t.r_constraint_name in (select t1.constraint_name
                                                  from sys.user_constraints t1
                                                 where t1.owner like user
                                                   and t1.constraint_type in ('P', 'U')
                                                   and t1.table_name like pi_vTable))
      loop
         executeSql ('alter table '||rc.table_name||' '||pi_vStatus||' constraint '||rc.constraint_name);
      end loop;
   exception
      when others
      then
         null;
   end;

   procedure truncateTable (
      pi_vTableName                     in varchar2
      )
   is
   begin
      for rec in (select t.table_name
                    from user_tables t
                   where t.table_name like trim(upper(pi_vTableName))
                   order by t.table_name)
      loop
         updateConstraints (rec.table_name, 'disable');
         executeSql ('truncate table ' || rec.table_name);
         updateConstraints (rec.table_name, 'enable');
      end loop;
   end;

begin
   truncateTable ('PATIENT%');

   for i in 1..5
   loop
      truncateTable ('ENCOUNTER%');
      truncateTable ('TREATMENT%');
   end loop;   
      
end;
/

prompt
prompt Creating package body IC_UTL_SEC_TEMP
prompt =====================================
prompt
create or replace package body IC_UTL_SEC_TEMP is

   -- Private type declarations

   -- Private constant declarations
   c_nEncType_AES256           constant pls_integer := DBMS_CRYPTO.ENCRYPT_AES256
                                                       + DBMS_CRYPTO.CHAIN_CBC
                                                       + DBMS_CRYPTO.PAD_PKCS5;

   c_nEncType_DES3_2K          constant pls_integer := DBMS_CRYPTO.ENCRYPT_3DES_2KEY
                                                       + DBMS_CRYPTO.CHAIN_CBC
                                                       + DBMS_CRYPTO.PAD_PKCS5;

   c_nEncType_DES3             constant pls_integer := DBMS_CRYPTO.ENCRYPT_3DES
                                                       + DBMS_CRYPTO.CHAIN_CBC
                                                       + DBMS_CRYPTO.PAD_PKCS5;

   c_vKey                      constant varchar2(128) := '0421f86ef07e41619953a052';
   c_vIV                       constant varchar2(128) := '74d02376';


/*  -- Block Cipher Chaining Modifiers
    CHAIN_CBC          CONSTANT PLS_INTEGER            :=   256;  -- 0x0100
    CHAIN_CFB          CONSTANT PLS_INTEGER            :=   512;  -- 0x0200
    CHAIN_ECB          CONSTANT PLS_INTEGER            :=   768;  -- 0x0300
    CHAIN_OFB          CONSTANT PLS_INTEGER            :=  1024;  -- 0x0400

    -- Block Cipher Padding Modifiers
    PAD_PKCS5          CONSTANT PLS_INTEGER            :=  4096;  -- 0x1000
    PAD_NONE           CONSTANT PLS_INTEGER            :=  8192;  -- 0x2000
    PAD_ZERO           CONSTANT PLS_INTEGER            := 12288;  -- 0x3000
    PAD_ORCL           CONSTANT PLS_INTEGER            := 16384;  -- 0x4000*/

  -------------------------------------------------------------
  --translate string to ascii format used by psam
  -------------------------------------------------------------
  function VarcharToAscii (
     strData            in    varchar2
     ) return varchar2
  is
     strChar       varchar2(3);
     strReturn     varchar2(4000);
     i             number;
     nLen          number;
     vErr          varchar2(4000);

  begin

    strReturn := '';
    nLen := length(strData);
    i := 1;

    for i in 1 .. nLen loop

        strChar := substr(strData, i, 1);
        strChar := ascii(strChar);

        while length(strChar) < 3 loop
          strChar := '0' || strChar;
        end loop;

        strReturn := strReturn || strChar;

    end loop;

	  return strReturn;

   exception
     when others then
          vErr := sqlCode || ': ' || sqlErrm;
     return '';
   end VarcharToAscii;

  -------------------------------------------------------------------------
  --translate PSAM ascii to string
  --------------------------------------------------------------------
  function AsciiToVarchar (
     strData            in    varchar2
     ) return varchar2
  is
     strChar       varchar2(3);
     strReturn     varchar2(4000);
     i             number;
     j             number;
     nLen          number;
     vErr          varchar2(4000);

  begin

    strReturn := '';
    nLen := length(strData);
    i := 1;
    j := 1;
    for i in 1 .. nLen/3 loop

        strChar := substr(strData, j, 3);
        strChar := chr(strChar);

        strReturn := strReturn || strChar;
        j := j + 3;

    end loop;

	  return strReturn;

   exception
     when others then
          vErr := sqlCode || ': ' || sqlErrm;
     return '';
   end AsciiToVarchar;

  -------------------------------------------------------------------------
  --unpad a string
  --------------------------------------------------------------------
  function UnPad (
     strData            in    varchar2
     ) return varchar2
  is
     strChar       varchar2(3);
     strReturn     varchar2(4000);
     i             number;
     j             number;
     nLen          number;
     vErr          varchar2(4000);

  begin

    strReturn := '';
    nLen := length(strData);
    i := 1;
    j := 1;
    for i in 1 .. nLen/4 loop

        strChar := substr(strData, j, 2);

        strReturn := strReturn || strChar;
        j := j + 2;
        j := j + 2;--skip next 2 ie remove the pad

    end loop;

	  return ltrim(rtrim(strReturn));

   exception
     when others then
          vErr := sqlCode || ': ' || sqlErrm;
     return '';
   end UnPad;

  -------------------------------------------------------------------------
  --unpad a string
  -------------------------------------------------------------------------
  function Pad (
     strData            in    varchar2
     ) return varchar2
  is
     strChar       varchar2(3);
     strReturn     varchar2(4000);
     i             number;
     j             number;
     nLen          number;
     vErr          varchar2(4000);

  begin

    strReturn := '';
    nLen := length(strData);
    i := 1;
    j := 1;
    for i in 1 .. nLen/2 loop

        strChar := substr(strData, j, 2);

        strReturn := strReturn || strChar || '00';

        j := j + 2;

    end loop;

	  return ltrim(rtrim(strReturn));

   exception
     when others then
          vErr := sqlCode || ': ' || sqlErrm;
     return '';

   end Pad;

   ----------------------------------------------------------------------------------
   --encrypts a string passed in and returns it
   --as ascii 3 digits per char ex: 004053057056222117114158006140184167173100146135
   ----------------------------------------------------------------------------------
   function encryptData_str (
      pi_vData                          in varchar2
      )
      return                               varchar2
   is
      v_rEncryptedData                     raw(4000);
      v_vEncryptedData                     varchar2(4000);
      v_rKey                               raw(128);
      v_rIV                                raw(128);
      v_rClearData                         raw(4000);
      v_vClearData                         varchar2(4000);

      v_test varchar2(4000);
      vErr varchar2(4000);
   begin

      v_rKey := UTL_I18N.STRING_TO_RAW (c_vKey);
      v_rIV := UTL_I18N.STRING_TO_RAW (c_vIV);

      --
      v_rClearData := UTL_I18N.STRING_TO_RAW (pi_vData);--this is missing paddding
      v_rClearData := Pad(v_rClearData);--'4a004f0045005900590059005900';--this works...

      v_rEncryptedData := DBMS_CRYPTO.ENCRYPT (
                             src => v_rClearData,
                             typ => c_nEncType_DES3,
                             key => v_rKey,
                             iv => v_rIV
                             );

      v_vEncryptedData := VarcharToAscii(UTL_I18N.raw_to_char(v_rEncryptedData));

      v_test := AsciiToVarchar(v_vEncryptedData);

      return v_vEncryptedData;

   end;

   --------------------------------------------------------------------------------------------------------------
   --decrypts a sctring passed in ascii 3 digits per char, ex: 004053057056222117114158006140184167173100146135
   --------------------------------------------------------------------------------------------------------------
   function decryptData_str (
      pi_vData                          in varchar2
      )
      return                               varchar2
   is
      v_vDecryptedData                     varchar2(4000);
      v_rDecryptedData                     raw(4000);
      v_rKey                               raw(128);
      v_rIV                                raw(128);

      v_rEncryptedData                     raw(4000);
      v_vEncryptedData                     varchar2(4000);
      vErr varchar2(4000);

   begin

     v_rKey := UTL_I18N.STRING_TO_RAW (c_vKey);
     v_rIV := UTL_I18N.STRING_TO_RAW (c_vIV);

     v_vEncryptedData := AsciiToVarchar(pi_vData);
     v_rEncryptedData := UTL_I18N.STRING_TO_RAW(v_vEncryptedData);

     v_rDecryptedData := '';

     v_rDecryptedData := DBMS_CRYPTO.DECRYPT (
                             src => v_rEncryptedData,
                             typ => c_nEncType_DES3,
                             key => v_rKey,
                             iv =>  v_rIV
                             );

     v_rDecryptedData := unpad(v_rDecryptedData);

     v_vDecryptedData := UTL_I18N.RAW_TO_CHAR (v_rDecryptedData, 'AL32UTF8');

     return v_vDecryptedData;

   exception
      when others
      then
          vErr := sqlCode || ': ' || sqlErrm;
      return null;
   end;

end;
/

prompt
prompt Creating package body PCK_APP_MENU
prompt ==================================
prompt
create or replace package body PCK_APP_MENU is

  procedure GetMenuRootLevelRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  
    v_nUserRights number(12) := 0;
    v_nUserType   number(12) := 0;
    v_nReadOnly   number(12) := 0;
    v_bIsLoggedIn boolean := false;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_bIsLoggedIn := (nvl(pi_nUserID, 0)) > 0;
  
    if v_bIsLoggedIn then
    
      select r.user_rights, r.user_type, r.read_only
        into v_nUserRights, v_nUserType, v_nReadOnly
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || 'from stat_menu_items t ';
      v_vSQL := v_vSQL || 'where t.active = 1 ';
      v_vSQL := v_vSQL || 'and t.has_parent = 0 ';
      v_vSQL := v_vSQL || 'and t.is_logged_in <> 0 ';
      v_vSQL := v_vSQL || 'and (((bitand(t.user_right, :USER_RIGHTS) > 0) ';
      v_vSQL := v_vSQL || 'or t.user_right = 0) ';
      v_vSQL := v_vSQL || 'and ((bitand(t.user_type, :USER_TYPE) > 0) ';
      v_vSQL := v_vSQL || 'or (t.user_type = 0))) ';
      v_vSQL := v_vSQL || 'and ((t.req_readwrite_right = 0) or (bitand(t.req_readwrite_right, :READ_ONLY) != t.req_readwrite_right)) ';
      v_vSQL := v_vSQL || 'order by t.parent_id, t.menu_sort_order, t.menu_item_id ';
    
    else
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || 'from stat_menu_items t ';
      v_vSQL := v_vSQL || 'where t.active = 1 ';
      v_vSQL := v_vSQL || 'and t.has_parent = 0 ';
      v_vSQL := v_vSQL || 'and t.is_logged_in = 0 ';
      v_vSQL := v_vSQL || 'and ((t.user_right = :USER_RIGHTS) or (t.user_type = :USER_TYPE)) ';
      v_vSQL := v_vSQL || 'and ((t.req_readwrite_right = 0) or (bitand(t.req_readwrite_right, :READ_ONLY) != t.req_readwrite_right)) ';
      v_vSQL := v_vSQL || 'order by t.parent_id, t.menu_sort_order, t.menu_item_id ';
    end if;
  
    open rs for v_vSQL
      using v_nUserRights, v_nUserType, v_nReadOnly;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_APP_MENU.GetMenuRootLevelRS(): ' || sqlErrm;
  end;

  --Get Menu Child Items
  procedure GetMenuItemsRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
    v_nUserRights number(12) := 0;
    v_nUserType   number(12) := 0;
    v_nReadOnly   number(12) := 0;
    v_bIsLoggedIn boolean := false;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_bIsLoggedIn := (nvl(pi_nUserID, 0)) > 0;
  
    if v_bIsLoggedIn then
    
      select r.user_rights, r.user_type, r.read_only
        into v_nUserRights, v_nUserType, v_nReadOnly
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || 'from stat_menu_items t ';
      v_vSQL := v_vSQL || 'where t.active = 1 ';
      v_vSQL := v_vSQL || 'and t.has_parent = 1 ';
      v_vSQL := v_vSQL || 'and (((bitand(t.user_right, :USER_RIGHTS) > 0) ';
      v_vSQL := v_vSQL || 'or t.user_right = 0) ';
      v_vSQL := v_vSQL || 'and ((bitand(t.user_type, :USER_TYPE) > 0) ';
      v_vSQL := v_vSQL || 'or (t.user_type = 0))) ';
      v_vSQL := v_vSQL || 'and (bitand(1, t.item_type) > 0) ';
      v_vSQL := v_vSQL || 'and ((t.req_readwrite_right = 0) or (bitand(t.req_readwrite_right, :READ_ONLY) != t.req_readwrite_right)) ';
      v_vSQL := v_vSQL || 'order by t.parent_id, t.menu_sort_order, t.menu_item_id ';
    
    else
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || 'from stat_menu_items t ';
      v_vSQL := v_vSQL || 'where t.active = 1 ';
      v_vSQL := v_vSQL || 'and t.has_parent = 1 ';
      v_vSQL := v_vSQL || 'and t.is_logged_in = 0 ';
      v_vSQL := v_vSQL ||
                'and ((t.user_right = :USER_RIGHTS) or (t.user_type = :USER_TYPE)) ';
      v_vSQL := v_vSQL || 'and (bitand(1, t.item_type) > 0) ';
      v_vSQL := v_vSQL || 'and ((t.req_readwrite_right = 0) or (bitand(t.req_readwrite_right, :READ_ONLY) != t.req_readwrite_right)) ';
      v_vSQL := v_vSQL || 'order by t.parent_id, t.menu_sort_order, t.menu_item_id ';
    
    end if;
  
    open rs for v_vSQL
      using v_nUserRights, v_nUserType, v_nReadOnly;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_APP_MENU.GetMenuItemsRS(): ' || sqlErrm;
  end;

  procedure GetToolbarItemsRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
    v_nUserRights number(12) := 0;
    v_nUserType   number(12) := 0;
    v_bIsLoggedIn boolean := false;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_bIsLoggedIn := (nvl(pi_nUserID, 0)) > 0;
  
    if v_bIsLoggedIn then
    
      select r.user_rights, r.user_type
        into v_nUserRights, v_nUserType
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || 'from stat_menu_items t ';
      v_vSQL := v_vSQL || 'where t.active = 1 ';
      --v_vSQL := v_vSQL || 'and t.has_parent = 1 ';
      v_vSQL := v_vSQL || 'and (((bitand(t.user_right, :USER_RIGHTS) > 0) ';
      v_vSQL := v_vSQL || 'or t.user_right = 0) ';
      v_vSQL := v_vSQL || 'and ((bitand(t.user_type, :USER_TYPE) > 0) ';
      v_vSQL := v_vSQL || 'or (t.user_type = 0))) ';
      v_vSQL := v_vSQL || 'and (bitand(2, t.item_type) > 0) ';
      v_vSQL := v_vSQL || 'order by t.toolbar_sort_order, t.menu_item_id ';
    
    else
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || 'from stat_menu_items t ';
      v_vSQL := v_vSQL || 'where t.active = 1 ';
      --v_vSQL := v_vSQL || 'and t.has_parent = 1 ';
      v_vSQL := v_vSQL || 'and t.is_logged_in = 0 ';
      v_vSQL := v_vSQL ||
                'and ((t.user_right = :USER_RIGHTS) or (t.user_type = :USER_TYPE)) ';
      v_vSQL := v_vSQL || 'and (bitand(2, t.item_type) > 0) ';
      v_vSQL := v_vSQL || 'order by t.toolbar_sort_order, t.menu_item_id ';
    
    end if;
  
    open rs for v_vSQL
      using v_nUserRights, v_nUserType;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_APP_MENU.GetToolbarItemsRS(): ' || sqlErrm;
  end;
  
  procedure GetMenuItemsRights(po_vItemsRights out varchar2)
  is
    curItems RetRefCursor;
    recItems stat_menu_items%rowtype;
    curRights RetRefCursor;
    recRights stat_user_rights%rowtype;
    v_vSTR varchar2(32767) := '';
    v_nRight number := 0;
    
  begin
 
  open curItems for
       select * from stat_menu_items t
        where t.active = 1
          and t.user_right > 0
     order by t.parent_id, t.menu_sort_order, t.menu_item_id ;
     
     loop
      fetch curItems
        into recItems;
      exit when curItems%notfound;
      
      v_vSTR := v_vSTR || chr(10) || '* ' || recItems.Menu_Item || ' [' || to_char(recItems.User_Right) || ']' ||chr(10);
      
      open curRights for
       select * from stat_user_rights t
        where t.active = 1
          and t.visible = 1
     order by t.stat_right_id; 
     
      loop
      fetch curRights
        into recRights;
      exit when curRights%notfound;
           if bitand(recRights.Right_Dec, recItems.User_Right) = recRights.Right_Dec then
             v_vSTR := v_vSTR || chr(9) || '- ' || recRights.Right_Desc || chr(10);
           end if;
      end loop;
      
      close curRights;
      
     end loop;
  
  close curItems;
  
  po_vItemsRights := v_vSTR;
  
  end;
  
  procedure GetPageAccessRights(po_vItemsRights out varchar2)
  is
    curItems RetRefCursor;
    recItems fx_page_access%rowtype;
    curRights RetRefCursor;
    recRights stat_user_rights%rowtype;
    v_vSTR varchar2(32767) := '';
    v_nRight number := 0;
    
  begin
 
  open curItems for
       select * from fx_page_access t
       where t.active = 1
       and t.user_rights > 0
       order by t.page_name;
     
     loop
      fetch curItems
        into recItems;
      exit when curItems%notfound;
      
      v_vSTR := v_vSTR || chr(10) || '* ' || recItems.Page_Name || chr(10);
      
      open curRights for
       select * from stat_user_rights t
        where t.active = 1
          and t.visible = 1
     order by t.stat_right_id; 
     
      loop
      fetch curRights
        into recRights;
      exit when curRights%notfound;
           if bitand(recRights.Right_Dec, recItems.User_Rights) = recRights.Right_Dec then
             v_vSTR := v_vSTR || chr(9) || '- ' || recRights.Right_Desc || chr(10);
           end if;
      end loop;
      
      close curRights;
      
     end loop;
  
  close curItems;
  
  po_vItemsRights := v_vSTR;
  
  end;
  
  procedure GetUserRightsTemplates(po_vItemsRights out varchar2)
  is
    curItems RetRefCursor;
    recItems fx_rights_template%rowtype;
    curRights RetRefCursor;
    recRights stat_user_rights%rowtype;
    v_vSTR varchar2(32767) := '';
    v_nRight number := 0;
    v_vTypeDesc varchar2(32767) := '';
    
  begin
 
  open curItems for
       select * from fx_rights_template t
       order by t.user_type;
     
     loop
      fetch curItems
        into recItems;
      exit when curItems%notfound;
      
      select usertype_desc
      into  v_vTypeDesc
      from stat_user_types 
      where stat_usertype_id = recItems.User_Type;
      
      v_vSTR := v_vSTR || chr(10) || chr(10) || '* ' || v_vTypeDesc;
      
      open curRights for
       select * from stat_user_rights t
        where t.active = 1
          and t.visible = 1
     order by t.stat_right_id; 
     
      loop
      fetch curRights
        into recRights;
      exit when curRights%notfound;
           if bitand(recRights.Right_Dec, recItems.User_Rights) = recRights.Right_Dec then
             v_vSTR := v_vSTR || chr(10) || chr(9) || '- ' || recRights.Right_Desc;
           end if;
           
           if bitand(recRights.Right_Dec, recItems.Read_Only) = recRights.Right_Dec then
             v_vSTR := v_vSTR || ' [Read-Only]';
           end if;
      end loop;
      
      close curRights;
      
     end loop;
  
  close curItems;
  
  po_vItemsRights := v_vSTR;
  
  end;

end PCK_APP_MENU;
/

prompt
prompt Creating package body PCK_AP_USERADMIN
prompt ======================================
prompt
create or replace package body PCK_AP_USERADMIN is

  procedure InsertSuatUser(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vProviderID      in varchar2,
                           pi_nlocked          in number,
                           pi_vName            in varchar2,
                           pi_vRank            in varchar2,
                           pi_nServiceID       in number,
                           pi_vTitle           in varchar2,
                           pi_vCorps           in varchar2,
                           pi_vSquadron        in varchar2,
                           pi_vOfficeSymbol    in varchar2,
                           pi_vPhone           in varchar2,
                           pi_vEmail           in varchar2,
                           pi_vDimsID          in varchar2,
                           pi_vUIDPWD          in varchar2,
                           pi_nMustChgPwd      in number,
                           pi_vSupervisorID    in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into suat_user
      (provider_id,
       locked,
       name,
       rank,
       military_service_id,
       title,
       corps,
       unit,
       squadron,
       phone,
       email,
       dims_id,
       uidpwd,
       must_change_password,
       entry_date,
       supervisor_id)
    values
      (pi_vProviderID,
       pi_nLocked,
       pi_vName,
       pi_vRank,
       pi_nServiceID,
       pi_vTitle,
       pi_vCorps,
       pi_vSquadron,
       pi_vOfficeSymbol,
       pi_vPhone,
       pi_vEmail,
       pi_vDimsID,
       pi_vUIDPWD,
       pi_nMustChgPwd,
       sysdate,
       pi_vSupervisorID);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.InsertSuatUser(): ' || sqlErrm;
  end;

  procedure UpdateSuatUser(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vProviderID      in varchar2,
                           pi_vCurrentDimsID   in varchar2,
                           pi_nlocked          in number,
                           pi_vName            in varchar2,
                           pi_vRank            in varchar2,
                           pi_nServiceID       in number,
                           pi_vTitle           in varchar2,
                           pi_vCorps           in varchar2,
                           pi_vSquadron        in varchar2,
                           pi_vOfficeSymbol    in varchar2,
                           pi_vPhone           in varchar2,
                           pi_vEmail           in varchar2,
                           pi_vDimsID          in varchar2,
                           pi_vUIDPWD          in varchar2,
                           pi_nMustChgPwd      in number,
                           pi_vSupervisorID    in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update suat_user
       set locked               = pi_nLocked,
           name                 = pi_vName,
           rank                 = pi_vRank,
           military_service_id  = pi_nServiceID,
           title                = pi_vTitle,
           corps                = pi_vCorps,
           unit                 = pi_vSquadron,
           squadron             = pi_vOfficeSymbol,
           phone                = pi_vPhone,
           email                = pi_vEmail,
           dims_id              = pi_vDimsID,
           uidpwd               = pi_vUIDPWD,
           must_change_password = pi_nMustChgPwd,
           supervisor_id        = pi_vSupervisorID
     where provider_id = pi_vProviderID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.UpdateSuatUser(): ' || sqlErrm;
  end;

  --get a record set
  procedure GetUserRightsRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from stat_user_rights t
       where t.active = 1
         and t.visible = 1
       order by t.sort_order, t.stat_right_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.GetUserRightsRS(): ' ||
                           sqlErrm;
  end;

  --get a record set
  procedure GetUserTypesRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from stat_user_types t
       where t.active = 1
         and t.visible = 1
       order by t.stat_usertype_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.GetUserTypesRS(): ' || sqlErrm;
  end;

  --get suat users recordset
  procedure GetSUATUsersRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
    v_vSQL varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_vSQL := v_vSQL ||
              'select t.*, t2.*, t3.user_name, t3.is_locked, t3.is_inactive ';
    v_vSQL := v_vSQL || 'from suat_user t, fx_user_rights t2, fx_user t3 ';
    v_vSQL := v_vSQL || 'where t2.fx_user_id = t.fx_user_id ';
    v_vSQL := v_vSQL || 'and t3.fx_user_id = t.fx_user_id ';
    v_vSQL := v_vSQL || 'and t.dims_id in (select dims_id from suat_user ';
    v_vSQL := v_vSQL || 'where fx_user_id = :USER_ID) ';
    v_vSQL := v_vSQL || 'order by t.name ';
  
    --open recordset
    open rs for v_vSQL
      using pi_nUserID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.GetSUATUsersRS(): ' || sqlErrm;
  end;

  --get user specific permissions
  procedure GetUserPermissionsRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nRights          in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
    v_vSQL         varchar2(32767) := '';
    v_nRightsCount number := 0;
    v_nRights      number := 0;
    v_nReadOnly    number := 0;
    v_nPermissions number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select count(*)
      into v_nRightsCount
      from fx_user_rights t
     where t.fx_user_id = pi_nUserID
       and bitand(t.user_rights, pi_nRights) > 0;
  
    if (v_nRightsCount > 0) then
      select t.user_rights, t.read_only
        into v_nRights, v_nReadOnly
        from fx_user_rights t
       where t.fx_user_id = pi_nUserID
         and bitand(t.user_rights, pi_nRights) > 0;
    
      if (bitand(pi_nRights, v_nReadOnly) > 0) then
        v_nPermissions := 1;
      else
        v_nPermissions := 2;
      end if;
    
    end if;
  
    open rs for
      select v_nPermissions as permissions from dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.GetUserPermissionsRS(): ' ||
                           sqlErrm;
  end;

  --get supervisors recordset
  procedure GetInternSupervisorsRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
      v_vSQL varchar2(32767) := '';
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    v_vSQL := v_vSQL || '   select * ';
    v_vSQL := v_vSQL || '    from fx_user t1, fx_user_rights t2, suat_user t3 ';
    v_vSQL := v_vSQL || '   where t2.fx_user_id = t1.fx_user_id ';
    v_vSQL := v_vSQL || '     and t3.fx_user_id = t1.fx_user_id ';
    v_vSQL := v_vSQL || '     and t2.user_type = 1 ';
    v_vSQL := v_vSQL || '     and t3.dims_id = (select t4.dims_id ';
    v_vSQL := v_vSQL || '                         from suat_user t4 ';
    v_vSQL := v_vSQL || '                        where t4.fx_user_id = :USER_ID) ';
    v_vSQL := v_vSQL || 'order by t3.name ';
  
    --open recordset
    open rs for v_vSQL using pi_nUserID;
   
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.GetInternSupervisorsRS(): ' ||
                           sqlErrm;
  end;

  procedure InsertRightsTemplate(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nUserType        in number,
                                 pi_nUserRights      in number,
                                 pi_nRightsMode      in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
    v_nCount number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select count(*)
      into v_nCount
      from fx_rights_template t
     where t.user_type = pi_nUserType;
  
    if v_nCount > 0 then
      UpdateRightsTemplate(pi_vSessionID => pi_vSessionID,
                           pi_vSessionClientIP => pi_vSessionClientIP, 
                           pi_nUserID => pi_nUserID,
                           pi_nUserType => pi_nUserType,
                           pi_nUserRights => pi_nUserRights,
                           pi_nRightsMode => pi_nRightsMode,
                           po_nStatusCode => po_nStatusCode, 
                           po_vStatusComment => po_vStatusComment);
    else
      insert into fx_rights_template
        (user_type, user_rights, read_only)
      values
        (pi_nUserType, pi_nUserRights, pi_nRightsMode);
    
      commit;
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.InsertRightsTemplate(): ' ||
                           sqlErrm;
  end;

  procedure UpdateRightsTemplate(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nUserType        in number,
                                 pi_nUserRights      in number,
                                 pi_nRightsMode      in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update fx_rights_template t
       set t.user_rights = pi_nUserRights, t.read_only = pi_nRightsMode
     where t.user_type = pi_nUserType;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.UpdateRightsTemplate(): ' ||
                           sqlErrm;
  end;

  procedure GetRightsTemplateRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select * from fx_rights_template t;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_AP_USERADMIN.GetRightsTemplateRS(): ' ||
                           sqlErrm;
  end;

end PCK_AP_USERADMIN;
/

prompt
prompt Creating package body PCK_CMS
prompt =============================
prompt
create or replace package body PCK_CMS is

  procedure GetAuthorRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out RetRefCursor) is
  
    v_nUserRights number := 0;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    select t.user_rights
      into v_nUserRights
      from fx_user_rights t
     where t.fx_user_id = pi_nUserID;
  
    --If user has only "Author" rights get only their own record
    if (bitand(2097152, v_nUserRights) > 0) and (bitand(12582912, v_nUserRights) = 0)  then
      v_vSQL := v_vSQL || 'select t.fx_user_id, t.name ';
      v_vSQL := v_vSQL || '  from suat_user t ';
      v_vSQL := v_vSQL || ' where t.fx_user_id = ''' || pi_nUserID || ''' ';
    elsif bitand(12582912, v_nUserRights) > 0 then
      v_vSQL := v_vSQL || 'select t.fx_user_id, t.name ';
      v_vSQL := v_vSQL || '  from suat_user t, fx_user_rights r ';
      v_vSQL := v_vSQL || ' where r.fx_user_id = t.fx_user_id ';
      v_vSQL := v_vSQL || '   and bitand(14680064, user_rights ) > 0 ';
    end if; 
    v_vSQL := v_vSQL || ' order by t.name';
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetAuthorRS(): ' || sqlErrm;
  end;

  procedure GetPagesListRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
    v_nUserRights number := 0;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    select t.user_rights
      into v_nUserRights
      from fx_user_rights t
     where t.fx_user_id = pi_nUserID;
  
    v_vSQL := v_vSQL || 'select t.*, f.name as author ';
    v_vSQL := v_vSQL || '  from cms_pages t, suat_user f ';
    v_vSQL := v_vSQL || ' where f.fx_user_id = t.author_id ';
    v_vSQL := v_vSQL || '   and t.is_template = 0 ';
  
    --If user has only "Author" rights get only their own pages
    if ((bitand(2097152, v_nUserRights) > 0) and
       (bitand((4194304 + 8388608), v_nUserRights) < 1)) then
      v_vSQL := v_vSQL || ' and t.created_by = ''' || pi_nUserID || ''' ';
    elsif bitand((4194304 + 8388608), v_nUserRights) > 0 then
      v_vSQL := v_vSQL;
    end if;  
    
    v_vSQL := v_vSQL || ' order by t.title ';
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetPagesListRS(): ' || sqlErrm;
  end; 
  
  procedure GetTemplatesListRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
    v_nUserRights number := 0;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    select t.user_rights
      into v_nUserRights
      from fx_user_rights t
     where t.fx_user_id = pi_nUserID;
  
    v_vSQL := v_vSQL || 'select t.* ';
    v_vSQL := v_vSQL || '  from cms_pages t ';
    v_vSQL := v_vSQL || ' where t.is_template = 1 ';
    v_vSQL := v_vSQL || ' order by t.title ';
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetTemplatesListRS(): ' || sqlErrm;
  end;

  procedure GetPageContentsRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nPageID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
    v_vSQL varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_vSQL := v_vSQL || 'select t.* ';
    v_vSQL := v_vSQL || '  from cms_pages t ';
    v_vSQL := v_vSQL || ' where t.page_id = :PAGE_ID ';
  
    open rs for v_vSQL
      using pi_nPageID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetPageContentsRS(): ' || sqlErrm;
  end;

  procedure InsertPage(pi_vSessionID       in varchar2,
                       pi_vSessionClientIP in varchar2,
                       pi_nUserID          in number,
                       
                       pi_nAuthorID in number,
                       pi_vTitle    in varchar2,
                       pi_cContents in clob,
                       pi_nStatus   in number,
                       po_nPageID   out number,
                       
                       po_nStatusCode    out number,
                       po_vStatusComment out varchar2) is
  
    v_nPageID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    po_nPageID        := 0;
  
    select seqstaticpageid.nextval into v_nPageID from dual;
  
    insert into cms_pages
      (page_id,
       title,
       author_id,
       contents,
       status,
       active,
       created,
       created_by)
    values
      (v_nPageID,
       pi_vTitle,
       pi_nAuthorID,
       pi_cContents,
       pi_nStatus,
       1,
       sysdate,
       pi_nUserID);
  
    commit;
  
    po_nPageID := v_nPageID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.InsertPage(): ' || sqlErrm;
  end;

  procedure EditPage(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     
                     pi_nPageID   in number,
                     pi_nAuthorID in number,
                     pi_vTitle    in varchar2,
                     pi_cContents in clob,
                     pi_nStatus   in number,
                     
                     po_nStatusCode    out number,
                     po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update cms_pages t
       set t.title     = pi_vTitle,
           t.author_id = pi_nAuthorID,
           t.contents  = pi_cContents,
           t.status    = pi_nStatus,
           --t.created_by       = pi_nAuthorID,
           t.last_modified    = sysdate,
           t.last_modified_by = pi_nUserID
     where t.page_id = pi_nPageID;
    commit;
    
    update cms_menu_items t
       set t.status = pi_nStatus  
     where t.page_id = pi_nPageID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.EditPage(): ' || sqlErrm;
  end;

  procedure GetALLMenusTop(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from cms_menu_items t
       where t.parent_id = 0
       order by t.sort_order;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetALLMenusTop(): ' || sqlErrm;
  end;

  procedure GetALLMenuChildren(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from cms_menu_items t
       where t.parent_id != 0
       order by t.sort_order;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetALLMenuChildren(): ' || sqlErrm;
  end;

  procedure GetALLMenuItems(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select * from cms_menu_items t order by t.sort_order;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetALLMenuItems(): ' || sqlErrm;
  end;

  function GetPageStatus(pi_nPageID in number) return number is
    Result number := 0;
  begin
  
    if pi_nPageID = 0 then
      Result := 1;
    else
      select status
        into Result
        from cms_pages p
       where p.page_id = pi_nPageID;
    end if;
  
    return(Result);
  end GetPageStatus;

  procedure InsertMenuItem(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_vMenuTitle      in varchar2,
                           pi_nParentID       in number,
                           pi_nPageID         in number,
                           pi_nUserRights     in number,
                           pi_nTargetPortalID in number,
                           pi_nSortOrder      in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2) is
  
    v_nMenuID    number;
    v_nSortOrder number := null;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    if pi_nSortOrder != -1 then
      v_nSortOrder := pi_nSortOrder;
    end if;
  
    select seqcmsmenuid.nextval into v_nMenuID from dual;
    insert into cms_menu_items
      (menu_id,
       menu_title,
       parent_id,
       page_id,
       active,
       status,
       user_rights,
       target_portal_id,
       sort_order)
    values
      (v_nMenuID,
       pi_vMenuTitle,
       pi_nParentID,
       pi_nPageID,
       1,
       GetPageStatus(pi_nPageID),
       pi_nUserRights,
       pi_nTargetPortalID,
       v_nSortOrder);
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.InsertMenuItem(): ' || sqlErrm;
  end;

  procedure UpdateMenuItem(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_nMenuID         in number,
                           pi_vMenuTitle      in varchar2,
                           pi_nParentID       in number,
                           pi_nPageID         in number,
                           pi_nUserRights     in number,
                           pi_nTargetPortalID in number,
                           pi_nSortOrder      in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2) is
  
    v_nSortOrder number := null;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    if pi_nSortOrder != -1 then
      v_nSortOrder := pi_nSortOrder;
    end if;
  
    update cms_menu_items t
       set t.menu_title       = pi_vMenuTitle,
           t.parent_id        = pi_nParentID,
           t.page_id          = pi_nPageID,
           t.status           = GetPageStatus(pi_nPageID),
           t.user_rights      = pi_nUserRights,
           t.target_portal_id = pi_nTargetPortalID,
           t.sort_order       = v_nSortOrder
     where t.menu_id = pi_nMenuID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.UpdateMenuItem(): ' || sqlErrm;
  end;

  procedure DeleteMenuItem(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_nMenuID in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    delete from cms_menu_items t where t.menu_id = pi_nMenuID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.DeleteMenuItem(): ' || sqlErrm;
  end;

  procedure DeleteCMSPage(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          
                          pi_nPageID in number,
                          
                          po_nStatusCode    out number,
                          po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    delete from cms_pages t
          where t.page_id = pi_nPageID;
    commit;
    
    delete from cms_menu_items t
          where t.page_id = pi_nPageID;
    commit;
    
    
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.DeleteCMSPage(): ' || sqlErrm;
  end;

  -- Get menu items to render the HTML code
  procedure GetMenuRootLevelRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_nPortalID        in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  
    v_nUserRights number(12) := 0;
    v_bIsLoggedIn boolean := false;
    v_vSQL        varchar2(32767) := '';
    v_vSQLEdu     varchar2(4000) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_bIsLoggedIn := (nvl(pi_nUserID, 0)) > 0;
  
    if pi_nPortalID = 1 then
      v_vSQLEdu := ' and t.is_education != 1 ';
    end if;
  
    if v_bIsLoggedIn then
    
      select r.user_rights
        into v_nUserRights
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || '  from cms_menu_items t ';
      v_vSQL := v_vSQL || ' where t.parent_id = 0 ';
      v_vSQL := v_vSQL ||
                '   and ((bitand(t.user_rights, :USER_RIGHTS) > 0) or t.user_rights = 0) ';
      v_vSQL := v_vSQL || '   and t.status = 1 ';
      v_vSQL := v_vSQL ||
                '   and (bitand(t.target_portal_id, :TARGET_PORTAL)) > 0 ';
      v_vSQL := v_vSQL || v_vSQLEdu;
      v_vSQL := v_vSQL || ' order by t.sort_order ';
    
      open rs for v_vSQL
        using v_nUserRights, pi_nPortalID;
    
    else
    
      open rs for
        select * from cms_menu_items t where t.menu_id = -1;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetMenuRootLevelRS(): ' || sqlErrm;
  end;

  procedure GetEduTopItemRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor) is
  
    v_nUserRights number(12) := 0;
    v_bIsLoggedIn boolean := false;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_bIsLoggedIn := (nvl(pi_nUserID, 0)) > 0;
  
    if v_bIsLoggedIn then
    
      select r.user_rights
        into v_nUserRights
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || '  from cms_menu_items t ';
      v_vSQL := v_vSQL || ' where t.parent_id = 0 ';
      v_vSQL := v_vSQL ||
                '   and ((bitand(t.user_rights, :USER_RIGHTS) > 0) or t.user_rights = 0) ';
      v_vSQL := v_vSQL || '   and t.status = 1 ';
      v_vSQL := v_vSQL || '   and t.is_education = 1  ';
      v_vSQL := v_vSQL || ' order by t.sort_order ';
    
      open rs for v_vSQL
        using v_nUserRights;
    
    else
    
      open rs for
        select * from cms_menu_items t where t.menu_id = -1;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetEduTopItemRS(): ' || sqlErrm;
  end;

  -- -----------------
  procedure GetMenuItemsRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nPortalID        in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
    v_nUserRights number(12) := 0;
    v_bIsLoggedIn boolean := false;
    v_vSQL        varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_bIsLoggedIn := (nvl(pi_nUserID, 0)) > 0;
  
    if v_bIsLoggedIn then
    
      select r.user_rights
        into v_nUserRights
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      v_vSQL := v_vSQL || 'select * ';
      v_vSQL := v_vSQL || '  from cms_menu_items t ';
      v_vSQL := v_vSQL || ' where t.parent_id > 0 ';
      v_vSQL := v_vSQL ||
                '   and ((bitand(t.user_rights, :USER_RIGHTS) > 0) or t.user_rights = 0) ';
      v_vSQL := v_vSQL || '   and t.status = 1 ';
      v_vSQL := v_vSQL ||
                '   and (bitand(t.target_portal_id, :TARGET_PORTAL)) > 0 ';
      v_vSQL := v_vSQL || ' order by t.sort_order ';
    
      open rs for v_vSQL
        using v_nUserRights, pi_nPortalID;
    
    else
    
      open rs for
        select * from cms_menu_items t where t.menu_id = -1;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.GetMenuItemsRS(): ' || sqlErrm;
  end;

  -- ***************************************************************************
  -- Search Static Pages Contents

  procedure SearchContentsRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vSearch          in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t1.page_id,
             t1.title,
             REGEXP_REPLACE(t1.contents, '<(.*?)>', '') as contents,
             t2.is_education
        from (select *
                from cms_pages t
               where (lower(t.title) like '%' || lower(pi_vSearch) || '%' or
                     lower(REGEXP_REPLACE(t.contents, '<(.*?)>', '')) like
                     '%' || lower(pi_vSearch) || '%')
                 and t.active = 1) t1
      
        left join (select *
                     from cms_menu_items m
                    where m.active = 1
                      and m.status = 1) t2
          on t2.page_id = t1.page_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CMS.SearchContentsRS(): ' || sqlErrm;
  end;

end PCK_CMS;
/

prompt
prompt Creating package body PCK_COMMON
prompt ================================
prompt
create or replace package body PCK_COMMON is

  /*****
  Description:
  helper function used to get data by using dynamic sql 
  "into" statement. all data is returned as a vachar2
  and can be casted as needed. We use dynamic sql for 
  security reasons.
  *****/
  function GetDynamicSQLValue(pi_vSql in varchar2) return varchar2 is
    type refCursor is ref cursor;
    rc      refCursor;
    v_vData varchar2(4000);
  
  begin
    open rc for pi_vSql;
    fetch rc
      into v_vData;
    close rc;
  
    return v_vData;
  
  exception
    when others then
      return null;
  end;

  /*****
  Description:
  helper function used to get the next value from a sequence
  *****/
  function GetNextSequenceValue(pi_vSequenceName in varchar2) return number
  
   is
    v_vSQL     varchar2(4000);
    v_SeqValue varchar2(4000);
  
  begin
  
    v_vSQL := '';
    v_vSQL := v_vSQL || 'SELECT ' || pi_vSequenceName ||
              '.nextval FROM dual';
  
    v_SeqValue := GetDynamicSQLValue(v_vSQL);
  
    return to_number(v_SeqValue);
  
  exception
    when others then
      return null;
    
  end;

  /*****
  Description:
  helper function used to get age given date of birth
  *****/
  function GetAge(pi_dtDOB in date) return number is
    v_nAge number;
  begin
    v_nAge := trunc(months_between(sysdate, pi_dtDOB) / 12);
    return v_nAge;
  end;

  /*****
  Description:
  helper function used to generate comment text
  *****/
  function GetStatusComment(pi_vPCKStatusLabel in varchar2,
                            pi_vDetails        in varchar2) return varchar2
  
   is
    v_vStatusComment varchar2(4000);
    v_vSQL           varchar2(255);
  
  begin
  
    v_vSQL := '';
    v_vSQL := v_vSQL || 'select t.pck_status_comment ';
    v_vSQL := v_vSQL || 'from fx_pck_status t ';
    v_vSQL := v_vSQL || 'where upper(t.pck_status_label) = upper(''' ||
              pi_vPCKStatusLabel || ''')';
  
    v_vStatusComment := GetDynamicSQLValue(v_vSQL);
  
    --if we are in debug mode add the package name and sqlerror
    if PCK_COMMON.c_nDebug_Mode = 1 then
      v_vStatusComment := v_vStatusComment || ' (' || sqlErrm;
      v_vStatusComment := v_vStatusComment || ': ' || pi_vDetails || ')';
    end if;
  
    v_vStatusComment := trim(v_vStatusComment);
  
    if length(v_vStatusComment) > 200 then
      v_vStatusComment := substr(v_vStatusComment, 1, 200);
    end if;
  
    return v_vStatusComment;
  
  exception
    when others then
      v_vStatusComment := c_vStatus_undefined;
      return v_vStatusComment;
    
  end;

  function GetPiece(strData      in varchar2,
                    strDelimiter in varchar2,
                    nPosition    in NUMBER) return varchar2 is
  
    strWorking varchar2(4000);
    strPiece   varchar2(400);
    pos        number;
    nPos2      number;
    nCount     number;
  
  begin
  
    --the piece to return
    strPiece := '';
  
    --set working to data
    strWorking := strData;
  
    --put a delimeter on the front for parsing if needed
    if substr(strWorking, 1, 1) != strDelimiter then
      strWorking := strDelimiter || strWorking;
    end if;
  
    --put a delimeter on the end
    strWorking := strWorking || strDelimiter;
  
    --find the piece between the ~'s ie... "~piece~"
    pos    := -1;
    nCount := -1;
    while (pos != 0) loop
      pos := instr(strWorking, strDelimiter);
      if pos != 0 then
        --increment count
        nCount := nCount + 1;
        --found the piece...
        if nCount = nPosition then
          if (pos + 1 > length(strWorking) - 1) then
            --nothing
            strPiece := '';
          else
            strWorking := substr(strWorking, pos + 1);
            nPos2      := instr(strWorking, strDelimiter);
            if nPos2 = 0 then
              --last piece
              strPiece := strWorking;
              return ltrim(rtrim(strPiece));
            else
              strPiece := substr(strWorking, 0, nPos2 - 1);
              return ltrim(rtrim(strPiece));
            end if;
          end if;
        else
          strWorking := substr(strWorking, pos + 1);
        end if;
      end if;
    end loop;
  
    return ltrim(rtrim(strPiece));
  
  exception
    when others then
      return '';
  end GetPiece;

  function join(p_cursor sys_refcursor, p_del varchar2 := ',')
    return varchar2 is
    l_value  varchar2(32767);
    l_result varchar2(32767);
  begin
    loop
      fetch p_cursor
        into l_value;
      exit when p_cursor%notfound;
      if l_result is not null then
        l_result := l_result || p_del;
      end if;
      l_result := l_result || l_value;
    end loop;
    return l_result;
  end join;

end;
/

prompt
prompt Creating package body PCK_CPAP_DEVICE
prompt =====================================
prompt
create or replace package body PCK_CPAP_DEVICE is

  --converted to use new encryption
  --get other device rs
  procedure GetOtherDevicesRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              
                              pi_vKey       in varchar2,
                              pi_vPatientID in varchar2,
                              
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2,
                              rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    open rs for
      select d.*,
             fnc_utl_decstr(p.LAST_NAME, pi_vKey, p.PATIENT_ID) || ', ' ||
             fnc_utl_decstr(p.FIRST_NAME, pi_vKey, p.PATIENT_ID) as patient_name
        from cpap_device d, patient_demographics p
       where p.patient_id = d.patient_id
         and d.patient_id != pi_vPatientID
         and (d.serial_number is not null and length(d.serial_number) > 0);
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_CPAP_DEVICE.GetOtherDevicesRS(): ' ||
                           sqlCode || ': ' || sqlErrm;
    
  end;

  --add update device
  procedure AddUpdateDevice(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            
                            pi_vKey          in varchar2,
                            pi_vPatientID    in varchar2,
                            pi_vDeviceName   in varchar2,
                            pi_nDeviceTypeID in number,
                            pi_vSerialNumber in varchar2,
                            pi_vLowPressure  in varchar2,
                            pi_vHighPressure in varchar2,
                            pi_vMaskType     in varchar2,
                            pi_vMaskDetails  in varchar2,
                            pi_nPAPType      in number,
                            
                            pi_vStudyDate   in varchar2,
                            pi_nBaselineAHI in number,
                            
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2) is
  
    v_nDeviceCount    number := 0;
    v_nPatDeviceCount number := 0;
  
    v_nStatusCode    number := 0;
    v_vStatusComment varchar2(32767) := '';
  
    v_nDeviceID number := 1;
  
    v_dtStudyDate  date := null;
    v_nBaselineAHI number := null;
  
    v_vCurrentSN varchar2(1000) := '';
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
    v_vCurrentSN      := '';
  
    if pi_nBaselineAHI > -1 then
      v_nBaselineAHI := pi_nBaselineAHI;
    end if;
  
    if LENGTH(pi_vStudyDate) >= 8 then
      v_dtStudyDate := to_date(pi_vStudyDate, 'mm/dd/yyyy');
    end if;
  
    --don't allow assignment of serial number to more than one patient
    select count(*)
      into v_nDeviceCount
      from cpap_device t
     where t.serial_number = pi_vSerialNumber
       and t.patient_id != pi_vPatientID
       and (t.serial_number is not null or length(t.serial_number) > 0);
    if v_nDeviceCount > 0 then
      po_nStatusCode    := 1;
      po_vStatusComment := 'Please enter a different Serial Number. There is another device registered with this number.';
      return;
    end if;
  
    -- update sleep study data
    update treatment t
       set t.sleep_study_date = v_dtStudyDate,
           t.baseline_ahi     = v_nBaselineAHI
     where t.patient_id = pi_vPatientID;
    commit;
  
    --check if there is a record for this patient
    select count(*)
      into v_nPatDeviceCount
      from cpap_device t
     where t.patient_id = pi_vPatientID;
  
    if v_nPatDeviceCount > 0 then
      --patient has a record
    
      --most recent sn added to a patient
      select nvl(serial_number, '')
        into v_vCurrentSN
        from cpap_device
       where patient_id = pi_vPatientID
         and date_updated =
             (select max(date_updated)
                from cpap_device
               where patient_id = pi_vPatientID)
         and active = 1;
    
      --validate the serial number is there
      if pi_vSerialNumber is not null and length(pi_vSerialNumber) > 0 then
      
        --update the patients device
        update cpap_device t
           set t.serial_number  = pi_vSerialNumber,
               t.device_name    = pi_vDeviceName,
               t.device_type_id = pi_nDeviceTypeID,
               t.low_pressure   = pi_vLowPressure,
               t.high_pressure  = pi_vHighPressure,
               t.pap_type       = pi_nPAPType,
               t.mask_type      = pi_vMaskType,
               t.mask_details   = pi_vMaskDetails
         where t.patient_id = pi_vPatientID;
        commit;
      
        --old records tied to current SN stay in tact
      
      else
        --empty serial number, clear data and make a new one
      
        --clear all patient cpap data for the previous device assigned to them
        --this is just in case the device was assigned to a different patient
        delete from patient_cpap
         where device_id in
               (select device_id
                  from cpap_device
                 where upper(serial_number) = upper(v_vCurrentSN));
        commit;
      
        --clear all raw records for this device serial number
        --this is just in case the device was assigned to a different patient
        --all data will be re-imported to the correct patient
        if pi_nDeviceTypeID = 1 then
          --1 = phillips
          update data_cpap_philips
             set import_status      = 0,
                 date_processed     = null,
                 import_status_cmnt = '',
                 import_patient_id  = null,
                 import_device_id   = null
           where upper(deviceserial) = upper(v_vCurrentSN);
          commit;
        end if;
      
        if pi_nDeviceTypeID = 2 then
          --2 = resmed
          update data_cpap_resmed
             set import_status      = 0,
                 date_processed     = null,
                 import_status_cmnt = '',
                 import_patient_id  = null,
                 import_device_id   = null
           where upper(devicesn) = upper(v_vCurrentSN);
          commit;
        end if;
      
        --get a new device id
        select seqcpapdevice.nextval into v_nDeviceID from dual;
      
        update cpap_device t
           set t.serial_number  = pi_vSerialNumber,
               t.device_name    = pi_vDeviceName,
               t.device_type_id = pi_nDeviceTypeID,
               t.low_pressure   = pi_vLowPressure,
               t.high_pressure  = pi_vHighPressure,
               t.pap_type       = pi_nPAPType,
               t.mask_type      = pi_vMaskType,
               t.mask_details   = pi_vMaskDetails,
               t.device_id      = v_nDeviceID
         where t.patient_id = pi_vPatientID;
        commit;
      
        update patient_demographics p
           set p.device_id = v_nDeviceID
         where p.patient_id = pi_vPatientID;
        commit;
      
      end if;
    
    else
      --v_nPatDeviceCount is not greater than zero
    
      --get a new device id
      select seqcpapdevice.nextval into v_nDeviceID from dual;
    
      --insert the device
      insert into cpap_device
        (device_id,
         device_type_id,
         device_name,
         serial_number,
         patient_id,
         low_pressure,
         high_pressure,
         mask_type,
         mask_details,
         pap_type)
      values
        (v_nDeviceID,
         pi_nDeviceTypeID,
         pi_vDeviceName,
         pi_vSerialNumber,
         pi_vPatientID,
         pi_vLowPressure,
         pi_vHighPressure,
         pi_vMaskType,
         pi_vMaskDetails,
         pi_nPAPType);
    
      --update the patients device
      update patient_demographics p
         set p.device_id = v_nDeviceID
       where p.patient_id = pi_vPatientID;
    
      commit;
    
    end if;
  
    --import the raw data to patient_cpap
    pck_cpap_import.ImportPhilipsData(pi_vKey,
                                      v_nStatusCode,
                                      v_vStatusComment);
  
    pck_cpap_import.ImportRESMEDData(pi_vKey,
                                     v_nStatusCode,
                                     v_vStatusComment);
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_CPAP_DEVICE.AddUpdateDevice(): ' || sqlCode || ': ' ||
                           sqlErrm;
    
  end;

  --get patient device rs
  procedure GetPatientDeviceRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_vPatientID in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2,
                               rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    open rs for
      select d.*, t.baseline_ahi, t.sleep_study_date
        from cpap_device d, treatment t
       where t.patient_id = d.patient_id
         and d.patient_id = pi_vPatientID
         and d.active = 1;
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_CPAP_DEVICE.GetPatientDeviceRS(): ' ||
                           sqlCode || ': ' || sqlErrm;
    
  end;

  procedure DeactivatePAPDevice(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                
                                pi_vPatientID    in varchar2,
                                pi_vSerialNumber in varchar2,
                                
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2) is
  
    v_vDeviceType   number := -1;
    v_vNewSerialNum varchar2(64);
    v_nSequence number;
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    -- get the device type
    begin
      select t.device_type_id
        into v_vDeviceType
        from cpap_device t
       where t.patient_id = pi_vPatientID
         and t.serial_number = pi_vSerialNumber
         and t.active = 1;
    exception
      when others then
        v_vDeviceType := -1;
    end;
    
    if v_vDeviceType > 0 then
       -- modify the serial number
       select seqinactivepap.nextval into v_nSequence from dual; 
       v_vNewSerialNum := pi_vSerialNumber || '_' || to_char(v_nSequence);
       
       -- modify the cpap_device record
       update cpap_device t
       set t.serial_number = v_vNewSerialNum,
           t.active = 0
       where t.patient_id = pi_vPatientID
       and t.serial_number = pi_vSerialNumber;
       
       -- prevent existing data from being copied over to next patient that will use this device
       if v_vDeviceType = 1 then
          --1 = phillips
          update data_cpap_philips
             set deviceserial = v_vNewSerialNum
           where upper(deviceserial) = upper(pi_vSerialNumber)
           and import_patient_id = pi_vPatientID
           and import_status = 1;
          commit;
        end if;
      
        if v_vDeviceType = 2 then
          --2 = resmed
          update data_cpap_resmed
             set devicesn = v_vNewSerialNum
           where upper(devicesn) = upper(pi_vSerialNumber)
           and import_patient_id = pi_vPatientID
           and import_status = 1;
          commit;
        end if;
    
    end if;
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_CPAP_DEVICE.DeactivatePAPDevice(): ' ||
                           sqlCode || ': ' || sqlErrm;
    
  end;

end PCK_CPAP_DEVICE;
/

prompt
prompt Creating package body PCK_CPAP_IMPORT
prompt =====================================
prompt
create or replace package body PCK_CPAP_IMPORT is

 --update the phillips data record with status info
 procedure UpdatePhillipsStatus(  vPatientID in varchar2,
                                  nDeviceID in number,
                                  rec data_cpap_philips%rowtype,
                                  nImportStatus in number,
                                  vImportStatusComment in varchar2) 
 is
 begin
     update data_cpap_philips t 
        set t.import_status = nImportStatus, --1= good, 2 = failed
            t.date_processed = sysdate,
            t.import_status_cmnt = vImportStatusComment, 
            t.import_patient_id = vPatientID, 
            t.import_device_id = nDeviceID                                 
      where t.patientid = rec.patientid 
        and t.therapydate = rec.therapydate
        and t.deviceserial = rec.deviceserial 
        and t.device = rec.device 
        and t.import_timestamp = rec.import_timestamp;
        commit;
   exception
    when others then
      null;
 end;    
 
 --update the RESMED data record with status info
 procedure UpdateRESMEDStatus( vPatientID in varchar2,
                               nDeviceID in number,
                               rec data_cpap_resmed%rowtype,
                               nImportStatus in number,
                               vImportStatusComment in varchar2) 
 is
 begin
     update data_cpap_resmed t 
        set t.import_status = nImportStatus, --1=good, 2 = failed
            t.date_processed = sysdate,
            t.import_status_cmnt = vImportStatusComment, 
            t.import_patient_id = vPatientID, 
            t.import_device_id = nDeviceID  
      where t.dob = rec.dob  
        and t.lastname = rec.lastname
        and t.sessiondate = rec.sessiondate
        and t.devicesn = rec.devicesn 
        and t.devicetype = rec.devicetype 
        and t.import_timestamp = rec.import_timestamp;
      commit;
   exception
    when others then
      null;
 end;                      
 
 --
 --moves data from data_cpap_philips to appropriate tables
 --
  procedure ImportPhilipsData(
    pi_vKey in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is                      
    cur RetRefCursor;
    rec data_cpap_philips%rowtype;
    nDeviceID number := 0;
    vPatientID varchar2(500) := '';
    nPatCount number := 0;
    nDeviceCount number := 0;
    nImportStatus number := 0;
    vImportStatus varchar2(4000) := '';
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
        
    open cur for
    
     --only process records that have a serial number
     select * from data_cpap_philips t
      where t.import_status = 0 
        and upper(t.deviceserial) in (select 
                                      upper(serial_number) 
                                      from cpap_device)
     order by t.date_imported asc;
     
     loop
     
         --get one record from the cursor
         fetch cur
          into rec;
         exit when cur%notfound;
                  
         --get the device_id
         nDeviceID := 0;
         select count(*) into nDeviceCount
         from cpap_device t
         where upper(t.serial_number) = upper(rec.deviceserial);
         
         if nDeviceCount > 0 then
            select t.device_id into nDeviceID 
            from cpap_device t
            where upper(t.serial_number) = upper(rec.deviceserial);
         end if;
             
         --found device so try to insert patient record
         if nDeviceID > 0 then
            
             --get the patient id from patient_demographics
             --by device id
             select count(*) into nPatCount
             from patient_demographics t
             where t.device_id = nDeviceID;
             
             --only insert if nPatCount = 1!
             if nPatCount = 1 then
           
                --get the patient id
                select patient_id into vPatientID
                from patient_demographics t
                where t.device_id = nDeviceID;
             
                --import the patient data
                begin
                     
                     nImportStatus := 0;
                     vImportStatus := '';
                
                     --ImportPatCPAP will validate ranges and insert the record
                     ImportPatCPAP(
                       pi_vKey,
                       vPatientID,
                       nDeviceID,
                       to_date(rec.therapydate, 'YYYY-MM-DD'),
                       to_number(rec.minutesofuse),
                       to_number(rec.ahi),
                       to_number(rec.averageleak),
                       1, --leak type is 1 for phillips
                       nImportStatus,
                       vImportStatus);
                 
                      if nImportStatus = 1 then --failed
                      
                          --update the record with status info
                          UpdatePhillipsStatus(vPatientID,
                                               nDeviceID,
                                               rec,
                                               2,
                                               vImportStatus);
                          
                          po_nStatusCode := nImportStatus;
                          po_vStatusComment := vImportStatus;
                      
                       else --success
                      
                          --update the record with status info
                          UpdatePhillipsStatus(vPatientID,
                                               nDeviceID,
                                               rec,
                                               1,
                                               vImportStatus);
                     end if;
                                                 
                 exception
                 when others then
                      po_nStatusCode    := 1;
                      po_vStatusComment := 'PCK_CPAP_IMPORT.ImportPhilipsData(): ' || sqlErrm;  
                      
                      --update the record with status info
                      UpdatePhillipsStatus(vPatientID,
                                           nDeviceID,
                                           rec,
                                           2,
                                           po_vStatusComment); 
                 end;  
           end if;
        end if;
     end loop;
      
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CPAP_IMPORT.ImportPhilipsData(): ' || sqlErrm;  
  end;
 
  --
  --moves data from data_cpap_resmed to appropriate tables
  --
  procedure ImportRESMEDData(
    pi_vKey in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2) is
  
  cur RetRefCursor;
  rec data_cpap_resmed%rowtype;
  nDeviceID number := 0;
  nDeviceCount number := 0;
  vPatientID varchar2(500) := '';
  nPatCount number := 0;
  vUsageHours varchar2(100) := '0';
  nUsageMins number := 0;
  vUHPiece0 varchar2(100) := '0';
  vUHPiece1 varchar2(100) := '0';
  nImportStatus number := 0;
  vImportStatus varchar2(4000) := '';
  
  nLeakMedian number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    open cur for
    
       --only process records that have a serial number
       select * from data_cpap_resmed t
        where t.import_status = 0 
          and upper(t.devicesn) in (select 
                                    upper(serial_number) 
                                    from cpap_device)
       order by t.date_imported asc;
     
     loop
     
         fetch cur
          into rec;
         exit when cur%notfound;
         
         --get the device_id
         nDeviceID := 0;
         select count(*) into nDeviceCount
         from cpap_device t
         where upper(t.serial_number) = upper(rec.devicesn);
         
         if nDeviceCount > 0 then
            select t.device_id into nDeviceID 
            from cpap_device t
            where upper(t.serial_number) = upper(rec.devicesn);
         end if;
               
         --found device so try to insert patient record
         if nDeviceID > 0 then
          
           --get the patient id from patient_demographics
           --by device id
           select count(*) into nPatCount
           from patient_demographics t
           where t.device_id = nDeviceID;
           
            --only insert if nPatCount = 1!
           if nPatCount = 1 then
           
              --get the patient id
              select patient_id into vPatientID
              from patient_demographics t
              where t.device_id = nDeviceID;
           
              --usage hours are formatted HH:MM 0:00 so we
              --need to convert to minutes...
              vUsageHours := nvl(rec.usagehours,'0');
              if vUsageHours = '0' then
                 nUsageMins := 0;
              else
                  --hours
                  vUHPiece0 := pck_common.GetPiece(vUsageHours, ':', 0);
                  --minutes
                  vUHPiece1 := pck_common.GetPiece(vUsageHours, ':', 1);
                  --full usage converted to minutes
                  nUsageMins := (to_number(vUHPiece0)*60) + to_number(vUHPiece1);
              end if;
              
              --convert L/sec to L/min multiply by 60
              nLeakMedian := to_number(nvl(rec.leakmedian,-1));
              if nLeakMedian > 0 then
                 nLeakMedian := nLeakMedian * 60;
              end if;
                    
              --import the patient data
              begin 
              
                  nImportStatus := 0;
                  vImportStatus := '';
                
                  --ImportPatCPAP will validate ranges and insert the record
                  ImportPatCPAP(
                    pi_vKey,
                    vPatientID,
                    nDeviceID,
                    to_date(rec.sessiondate, 'MM/DD/YY'),
                    nUsageMins,--converted to minutes
                    to_number(nvl(rec.ahi,-1)),
                    nLeakMedian,
                    2, --leak type is 2 for resmed
                    nImportStatus,
                    vImportStatus);
                   
                   if nImportStatus = 1 then --failed
                   
                     --update the data record with status info
                     UpdateRESMEDStatus( vPatientID,
                                         nDeviceID,
                                         rec,
                                         2,
                                         vImportStatus); 
                     
                     po_nStatusCode := nImportStatus;
                     po_vStatusComment := vImportStatus;
                                      
                   else
                   
                     --update the data record with status info - success
                     UpdateRESMEDStatus( vPatientID,
                                         nDeviceID,
                                         rec,
                                         1,
                                         vImportStatus); 
                   end if;
                            
               exception
               when others then
                    po_nStatusCode    := 1;
                    po_vStatusComment := 'PCK_CPAP_IMPORT.ImportRESMEDData(): ' || sqlErrm;  
              
                    --update the status record with info     
                    UpdateRESMEDStatus( vPatientID,
                                        nDeviceID,
                                        rec,
                                        2,
                                        po_vStatusComment); 
               end;      
           end if;
        end if;
     end loop;
          
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CPAP_IMPORT.ImportRESMEDData(): ' || sqlErrm;  
  end;
    
  --helper to import patient cpap data
  procedure ImportPatCPAP(
    pi_vKey in varchar2,
    pi_vPatientID in varchar2,
    pi_nDeviceID in number,
    pi_dtTherapy in date,
    pi_nMinsUse in number,
    pi_nAHI in number,
    pi_nLeak in number,
    pi_nLeakTypeID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2) 
  is 
              
    nEventStatusCode number    := 0; --0 = success
    vEventStatusComment varchar2(4000) := '';
   
    nMinsUseCheck number := 0;
    nAHICheck number := 0;
    nLeakcheck number := 0;
    
    nLeak number := 0;
    nAHI number := 0;
    
    v_dtCPAPDate date := null;
                     
  begin
  
    nAHI := pi_nAHI;
    nLeak := pi_nLeak;
    
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
      
    --check the data for valid ranges...
    nMinsUseCheck := 0;
    nAHICheck := 0;
    --
    --0 - 24 hours or 1440 minutes
    if (pi_nMinsUse < 0) or (pi_nMinsUse > 1440) then
       nMinsUseCheck := 1;
    end if;
    
    --0 - 75
    if (pi_nAHI < 0) or (pi_nAHI > 75) then
       nAHICheck := 1;
       nAHI := null;
    end if;
    
    --leak check is different whether we use resmed or philips
    --however ranges are the same for now
    --0 - 120
    --nLeakCheck := 0;
    --if pi_nLeakTypeID = 1 then
    --   if (pi_nLeak < 0) or (pi_nLeak > 120) then
    --      nLeakcheck := 1;
    --      nLeak := null;
    --   end if;
    --end if;
    --if pi_nLeakTypeID = 2 then
    --   if (pi_nLeak < 0) or (pi_nLeak > 120) then
    --      nLeakcheck := 1;
    --      nLeak := null;
    --   end if;
    --end if;
    --after much dicussion leak is saved as long as its above zero
    --left the code above for now commented out....
    nLeakCheck := 0;
    if (pi_nLeak < 0) then
       nLeakcheck := 1;
       nLeak := null;
    end if;
    
    --build error message and return if failed range check
    if (nMinsUseCheck = 1) or 
       (nAHICheck = 1) or 
       (nLeakcheck = 1) then
       
       po_vStatusComment := 'Error: ';
       
       if (nMinsUseCheck = 1) then 
          po_vStatusComment := po_vStatusComment || 'Usage Minutes out of range '; 
       end if;
       
       if (nAHICheck = 1) then
            po_vStatusComment := po_vStatusComment || 'AHI out of range '; 
       end if;
       
       if (nLeakcheck = 1) then
           po_vStatusComment := po_vStatusComment || 'Leak out of range '; 
       end if;
           
    end if;
    
    --if the date or both values are bad then don't import the data!
    if (nMinsUseCheck = 1) or   
       ( (nAHICheck = 1) and
       (nLeakcheck = 1) ) then
       
         po_nStatusCode := 1;
         return;
         
    end if;
    
    --insert the record into patient cpap  
    insert into patient_cpap( patient_id, 
                              device_id, 
                              therapy_date,
                              minutes_of_use,
                              ahi,
                              leak,
                              leak_type_id)
    values(pi_vPatientID,
           pi_nDeviceID,
           pi_dtTherapy,
           pi_nMinsUse,
           nAHI,
           nLeak,
           pi_nLeakTypeID);
    
    commit;
    
    --call sp to fire CPAP Data event, if called more than once its ignored
    begin
    
      PCK_PATIENT_EVENTS.CompletedEvent(
        pi_vKey,
        'internal',
        'localhost',
        0,
        pi_vPatientID,
        10,
        nEventStatusCode,
        vEventStatusComment);
      
      if nEventStatusCode = 0 then 
        
          select min(t.therapy_date)
            into v_dtCPAPDate
            from patient_cpap t 
           where t.patient_id = pi_vPatientID; 
           
          update patient_event t
             set t.status_date = v_dtCPAPDate,
                 t.status      = 1
           where t.patient_id  = pi_vPatientID
             and t.event_id    = 10;
          commit;
          
      end if;                                   
      
      if nEventStatusCode != 0 then
         po_nStatusCode    := 1;
         po_vStatusComment := 'PCK_CPAP_IMPORT.ImportPatCPAP().CompletedEvent: ' || vEventStatusComment;  
      end if;
      
    exception
      when others then
        po_nStatusCode    := 1;
        po_vStatusComment := 'PCK_CPAP_IMPORT.ImportPatCPAP().CompletedEvent: ' || sqlErrm;  
    end;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CPAP_IMPORT.ImportPatCPAP(): ' || sqlErrm;  
  end;
 
  
end PCK_CPAP_IMPORT;
/

prompt
prompt Creating package body PCK_CPAP_RESULTS
prompt ======================================
prompt
create or replace package body PCK_CPAP_RESULTS is

  procedure GetCPAPResultsRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from patient_cpap t
       where t.patient_id = pi_vPatientID
       order by t.therapy_date;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CPAP_RESULTS.GetCPAPResultsRS(): ' ||
                           sqlErrm;
  end;

  procedure GetAHIBaselineRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.patient_id,
             to_char(t.sleep_study_date, 'mm/dd/yyyy') as study_date,
             t.baseline_ahi
        from treatment t
       where t.patient_id = pi_vPatientID
         and t.sleep_study_date is not null
         and t.baseline_ahi is not null;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CPAP_RESULTS.GetAHIBaselineRS(): ' ||
                           sqlErrm;
  end;

  procedure GetQuestionnaireListRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from intake_module t
       where t.render_graph = 1
         and t.active = 1
       order by t.sort_order, t.mid;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_CPAP_RESULTS.GetQuestionnaireListRS(): ' ||
                           sqlErrm;
  end;

end PCK_CPAP_RESULTS;
/

prompt
prompt Creating package body PCK_DEMOGRAPHICS
prompt ======================================
prompt
create or replace package body PCK_DEMOGRAPHICS is

 procedure GetRelationshipSelfRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      )
   is

  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    --open recordset
    open rs for
      select *
      from stat_relationship t
           where active = 1
           or t.relationship_id = 9
           order by active asc;

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DEMOGRAPHICS.GetRelationshipSelfRS(): ' || sqlErrm;
  end;

  --get a record set
  procedure GetStateRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      )
  is

  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    --open recordset
    open rs for
      select *
      from stat_states t
           where active = 1;

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DEMOGRAPHICS.GetStateRS(): ' || sqlErrm;
  end;

  procedure GetGenderRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      )
  is

  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    --open recordset
    open rs for
      select *
      from stat_gender t
           where active = 1;

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DEMOGRAPHICS.GetGenderRS(): ' || sqlErrm;
  end;

 procedure GetGenderDescByIdRS (
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vGenderID               in varchar2,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2,
      rs                         out RetRefCursor
     )
   is

   begin

      po_nStatusCode := 0;--0 = success
      po_vStatusComment := '';

      --open recordset
      open rs for
        select *
        from stat_gender t
        where t.gender_id = pi_vGenderID
        and t.active = 1;

   exception
      when others
      then
         po_nStatusCode := 1;
         po_vStatusComment := 'PCK_DEMOGRAPHICS.GetGenderDescByIdRS(): ' || sqlErrm;
   end;

end PCK_DEMOGRAPHICS;
/

prompt
prompt Creating package body PCK_DEVICES
prompt =================================
prompt
create or replace package body PCK_DEVICES is

  --converted to use new encryption
  procedure GetDevicePatientRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vKey in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t1.*, 
             fnc_utl_decstr(t2.FIRST_NAME, pi_vKey, t2.PATIENT_ID)|| ' ' || fnc_utl_decstr(t2.LAST_NAME, pi_vKey, t2.PATIENT_ID) as patient_name, 
             t2.patient_id
        from (select d.*, 
                     dt.device_type_description
                from cpap_device d, 
                     cpap_device_type dt
               where dt.device_type_id = d.device_type_id) t1
        left join (select t.PATIENT_ID,
                          fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
                          fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
                          fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
                          fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
                          fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
                          fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
                          mid(fnc_utl_decstr(t.last_name, pi_vKey, t.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID), 6, 9) as LNSSNLAST4,
                          fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
                          t.MARITAL_STATUS_ID,
                          to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY') as dob,
                          t.HAS_FIRARM,
                          t.EDUCATION_LEVEL_ID,
                          t.PROVIDER_ID,
                          t.ADDRESS1,
                          t.ADDRESS2,
                          t.CITY,
                          t.POSTAL_CODE,
                          t.HOMEPHONE,
                          t.CELLPHONE,
                          t.WORKPHONE,
                          fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
                          t.STATE_ID,
                          t.HAS_REFERAL,
                          t.AWAITING_TRANSFER,
                          t.TRANSFER_DMIS_ID,
                          t.EDIPN,
                          t.FX_USER_ID,
                          t.LAST_UPDATED,
                          t.LAST_UPDATED_BY,
                          t.IS_HIGH_INTEREST,
                          t.PORTAL_USER_ID,
                          t.CURRENT_WEIGHT,
                          t.CURRENT_HEIGHT,
                          t.WRK_PHONE_CALL,
                          t.HOME_PHONE_CALL,
                          t.HOME_PHONE_MSG,
                          t.CELL_PHONE_CALL,
                          t.EMAIL_MSG,
                          t.DEVICE_ID,
                          GetPatientBMI(t.patient_id) as BMI,
	                        trunc(months_between(SYSDATE, to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY')) / 12) as patient_age
                     from patient_demographics t) t2
          on t2.device_id = t1.device_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DEVICES.GetDevicePatientRS(): ' || sqlErrm;
  end;
  
  procedure GetDevicesRS(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2,
                         rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select * from cpap_device t order by t.serial_number;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DEVICES.GetDevicesRS(): ' || sqlErrm;
  end;
 
end PCK_DEVICES;
/

prompt
prompt Creating package body PCK_DIAGNOSIS
prompt ===================================
prompt
create or replace package body PCK_DIAGNOSIS is

  function getAxis(diagid in number) return number is
    v_nAxis number := 0;
    rs1     PCK_COMMON.refCursor;
  
  begin
  
    open rs1 for
      select distinct t.diagnosis_axis
        from stat_diagnosis t
       where t.diagnosis_id = diagid;
  
    fetch rs1
      into v_nAxis;
    if rs1%notfound then
      close rs1;
      return 0;
    else
      close rs1;
      return v_nAxis;
    end if;
  
  end;

  function getDiagnosisTitle(diagnosisId in number) return varchar2 is
    v_vDiagnosisTitle varchar2(4000);
    rs1               PCK_COMMON.refCursor;
  
  begin
  
    open rs1 for
      select t.diagnosis_title
        from stat_diagnosis t
       where t.diagnosis_id = diagnosisId;
  
    fetch rs1
      into v_vDiagnosisTitle;
    if rs1%notfound then
      close rs1;
      return null;
    else
      close rs1;
      return v_vDiagnosisTitle;
    end if;
  end;

  function getDiagnosisDetails(diagnosisId in number) return varchar2 is
    v_vDiagnosisDetails varchar2(4000);
    rs1                 PCK_COMMON.refCursor;
  
  begin
  
    open rs1 for
      select t.diagnosis_details
        from stat_diagnosis t
       where t.diagnosis_id = diagnosisId;
  
    fetch rs1
      into v_vDiagnosisDetails;
    if rs1%notfound then
      close rs1;
      return null;
    else
      close rs1;
      return v_vDiagnosisDetails;
    end if;
  end;

  function getDiagnosisCode(diagnosisId in number) return varchar2 is
    v_vDiagnosisCode varchar2(128);
    rs1              PCK_COMMON.refCursor;
  
  begin
  
    open rs1 for
      select t.diag_code
        from stat_diagnosis t
       where t.diagnosis_id = diagnosisId;
  
    fetch rs1
      into v_vDiagnosisCode;
    if rs1%notfound then
      close rs1;
      return null;
    else
      close rs1;
      return v_vDiagnosisCode;
    end if;
  
  end;

  function getSpecifierText(specifierId in number) return varchar2 is
    v_vSpecifierText varchar2(128);
    rs1              PCK_COMMON.refCursor;
  
  begin
  
    open rs1 for
      select t.stat_specifier_text
        from stat_specifier t
       where t.stat_specifier_id = specifierId;
  
    fetch rs1
      into v_vSpecifierText;
    if rs1%notfound then
      close rs1;
      return null;
    else
      close rs1;
      return v_vSpecifierText;
    end if;
  
  end;

  procedure GetAxisItems(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_nAxis            in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2,
                         rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from stat_diagnosis t
       where t.diagnosis_axis = pi_nAxis
         and t.active = 1
         and t.menu_has_parent = 1
       order by t.menu_parent_id, t.diagnosis_id;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetAxisItems(): ' || sqlErrm;
  end;

  procedure GetAxisChildItems(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nAxis            in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select d.*
        from stat_diagnosis d
      --where d.diagnosis_axis = pi_nAxis
      --and d.active = 1
       where d.active = 1
         and d.menu_has_parent = 1
       order by d.menu_parent_id, d.sort_order, d.diagnosis_id;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetAxisChildItems(): ' || sqlErrm;
  end;

  procedure LoadSpecifiers(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nDiagId          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select ds.*, s.stat_specifier_text
        from stat_diagnosis_specifier ds
        left join (select * from stat_specifier) s
          on ds.stat_specifier_id = s.stat_specifier_id
       where ds.stat_diagnosis_id = pi_nDiagId;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.LoadSpecifiers(): ' || sqlErrm;
  end;

  --
  -- Add diagnosis
  procedure AddDiagnosis(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_vPatientID       in varchar2,
                         pi_vEncounterID     in varchar2,
                         pi_nTreatmentID     in number,
                         pi_nTreatDiagID     in number,
                         pi_nDiagnosisID     in number,
                         pi_nSpecifierID     in number,
                         pi_vDiagnosisText   in varchar2,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2) is
  
    v_treatDiagId  number(11);
    v_nSpecifierId number(11);
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    /*
    select seqtxdiagnosisid.nextval into v_treatDiagId from dual;
    
    if pi_nSpecifierID = -1 then
      v_nSpecifierId := null;
    else
      v_nSpecifierId := pi_nSpecifierID;
    end if;
    
    insert into treatment_diagnosis
      (treatment_diagnosis_id,
       treatment_id,
       patient_id,
       diagnosis_id,
       date_entered,
       date_discontinued,
       symptoms_duration,
       diagnosis_comments,
       diagnosis_axis_type,
       diagnosis_text,
       encounter_id,
       stat_specifier_id,
       stat_specifier_text,
       last_updated,
       last_updated_by)
    values
      (v_treatDiagId,
       pi_nTreatmentID,
       pi_vPatientID,
       pi_nDiagnosisID,
       sysdate,
       null,
       null,
       null,
       getAxis(pi_nDiagnosisID),
       pi_vDiagnosisText,
       pi_vEncounterID,
       v_nSpecifierId,
       null,
       sysdate,
       pi_nUserID);
       */
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.AddDiagnosis(): ' || sqlErrm;
  end;

  -- Delete diagnosis
  procedure DeleteDiagnosis(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPatientID       in varchar2,
                            pi_vEncounterID     in varchar2,
                            pi_nTreatmentID     in number,
                            pi_nTreatDiagID     in number,
                            pi_nDiagnosisID     in number,
                            pi_nSpecifierID     in number,
                            pi_vDiagnosisText   in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2) is
  
    v_treatDiagId number(11);
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    /*
    delete from treatment_diagnosis t
     where t.encounter_id = pi_vEncounterID
       and t.treatment_id = pi_nTreatmentID
       and t.diagnosis_id = pi_nDiagnosisID
       and t.treatment_diagnosis_id = pi_nTreatDiagID;
    */
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.DeleteDiagnosis(): ' || sqlErrm;
  end;

  -- Update remission stage
  procedure UpdateRemissionStage(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vEncounterID     in varchar2,
                                 pi_nTreatmentID     in number,
                                 pi_nTreatDiagID     in number,
                                 pi_nDiagnosisID     in number,
                                 pi_nSpecifierID     in number,
                                 pi_vDiagnosisText   in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
    v_treatDiagId number(11);
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    /*
     update treatment_diagnosis t
        set t.date_entered        = sysdate,
            t.stat_specifier_id   = pi_nSpecifierID,
            t.last_updated        = sysdate,
            t.last_updated_by     = pi_nUserID,
            t.stat_specifier_text = (select s.stat_specifier_text
                                       from stat_specifier s
                                      where s.stat_specifier_id =
                                            pi_nSpecifierID)
      where t.encounter_id = pi_vEncounterID
        and t.treatment_id = pi_nTreatmentID
        and t.treatment_diagnosis_id = pi_nTreatDiagID
        and t.diagnosis_id = pi_nDiagnosisID;
    */
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.UpdateRemissionStage(): ' ||
                           sqlErrm;
  end;

  --Insert diagnosis
  procedure InsertDiagnosis(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            --
                            pi_vPatientID   in varchar2,
                            pi_vEncounterID in varchar2,
                            pi_nTreatmentID in number,
                            pi_nDiagnosisID in number,
                            pi_nSpecifierID in number,
                            pi_vAxis3Text   in varchar2,
                            --
                            po_nProblemID     out number,
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2) is
  
    v_vDiagnosisText       varchar2(4000);
    v_vDiagnosisTitle      varchar2(4000);
    v_vSpecifierText       varchar2(4000);
    v_vIgnoreIntakeProblem varchar2(128);
    v_nAxisType            number;
    v_nProblemID           number;
    v_nSpecifierID         number;
    v_nItemsCount          number;
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_nItemsCount     := 0;
  
    select seqtxproblemid.nextval into v_nProblemID from dual;
    v_nAxisType := getAxis(pi_nDiagnosisID);
  
    v_vSpecifierText := null;
  
    if (pi_nSpecifierID = -1 or pi_nSpecifierID = 0) then
      v_nSpecifierID := null;
    else
      v_nSpecifierID := pi_nSpecifierID;
    end if;
  
    --build diagnosis text
    IF (v_nAxisType = 1) THEN
      v_vDiagnosisTitle := getDiagnosisTitle(pi_nDiagnosisID);
      v_vDiagnosisText  := v_vDiagnosisTitle;
      IF pi_nSpecifierID > 0 THEN
        v_vSpecifierText := getSpecifierText(pi_nSpecifierID);
      END IF;
    ELSIF (v_nAxisType = 3) THEN
      v_vDiagnosisText := pi_vAxis3Text;
    ELSE
      v_vDiagnosisTitle := getDiagnosisTitle(pi_nDiagnosisID);
      v_vDiagnosisText  := v_vDiagnosisTitle;
    END IF;
  
    /*
    ****************************************************************
    PREVENT ADD A DUPLICATE DIAGNOSIS ID
    ****************************************************************
    */
    if v_nAxisType <> 3 then
      if v_nAxisType <> 5 then
        select count(*)
          into v_nItemsCount
          from treatment_problem_list tpl
         where tpl.encounter_id = pi_vEncounterID
           and tpl.inactive <> 1
           and tpl.diagnostic_id = pi_nDiagnosisID;
      
        if v_nItemsCount > 0 then
          po_nStatusCode    := 1;
          po_vStatusComment := 'The selected diagnosis item is already in the patient''s problems list.';
          return;
        end if;
      
      elsif v_nAxisType = 5 then
        select count(*)
          into v_nItemsCount
          from treatment_problem_list tpl
         where tpl.encounter_id = pi_vEncounterID
           and tpl.inactive <> 1
           and tpl.diagnostic_axis_type = 5;
      
        if v_nItemsCount > 0 then
          po_nStatusCode    := 1; --0 = success
          po_vStatusComment := 'Only one diagnosis item is allowed for Axis V.';
          return;
        end if;
      
      end if;
    end if;
  
    --insert record into treatment_diagnosis
    insert into treatment_problem_list
      (problem_id,
       treatment_id,
       patient_id,
       encounter_id,
       diagnostic_id,
       last_updated,
       last_updated_by,
       symptom_duration,
       diagnostic_comment,
       diagnostic_axis_type,
       diagnostic_text,
       stat_specifier_id,
       stat_specifier_text,
       diag_code)
    values
      (v_nProblemID,
       pi_nTreatmentID,
       pi_vPatientID,
       pi_vEncounterID,
       pi_nDiagnosisID,
       sysdate,
       pi_nUserID,
       null,
       null,
       v_nAxisType,
       v_vDiagnosisText,
       v_nSpecifierID,
       v_vSpecifierText,
       getDiagnosisCode(pi_nDiagnosisID));
  
    --change problem status in encounter_intake_flag
    -- from potential to actual problem
    update encounter_intake_flag t
       set t.problem_status = 1
     where t.encounter_id = pi_vEncounterID
       and t.flag_id in
           (select p.flag_id
              from intake_problem_list p
             where p.diagnosis_id = pi_nDiagnosisID);
    commit;
  
    --update "last_updated" info in encounter table
    update encounter t
       set t.last_updated = sysdate, t.last_updated_by = pi_nUserID
     where t.patient_id = pi_vPatientID
       and t.encounter_id = pi_vEncounterID
       and t.treatment_id = pi_nTreatmentID;
    commit;
  
    po_nProblemID := v_nProblemID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.InsertDiagnosis(): ' || sqlErrm;
  end;

  --Update diagnosis
  procedure UpdateDiagnosis(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            --
                            pi_vPatientID   in varchar2,
                            pi_vEncounterID in varchar2,
                            pi_nTreatmentID in number,
                            pi_nProblemID   in number,
                            pi_nDiagnosisID in number,
                            pi_nSpecifierID in number,
                            pi_vAxis3Text   in varchar2,
                            pi_vComment     in varchar2,
                            pi_nSortOrder   in number,
                            --
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2) is
  
    v_vDiagnosisText  varchar2(4000);
    v_vDiagnosisTitle varchar2(4000);
    v_vSpecifierText  varchar2(4000);
    v_nAxisType       number;
    v_nTreatDiagID    number;
    v_nSpecifierID    number;
    v_nSortOrder      number;
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nAxisType      := getAxis(pi_nDiagnosisID);
    v_vSpecifierText := null;
  
    if (pi_nSpecifierID = -1 or pi_nSpecifierID = 0) then
      v_nSpecifierID := null;
    else
      v_nSpecifierID := pi_nSpecifierID;
    end if;
  
    v_nSortOrder := null;
    if pi_nSortOrder <> -1 then
      v_nSortOrder := pi_nSortOrder;
    end if;
  
    --build diagnosis text
    IF (v_nAxisType = 1) THEN
      v_vDiagnosisTitle := getDiagnosisTitle(pi_nDiagnosisID);
      v_vDiagnosisText  := v_vDiagnosisTitle;
      IF pi_nSpecifierID > 0 THEN
        v_vSpecifierText := getSpecifierText(pi_nSpecifierID);
        --v_vDiagnosisText := v_vDiagnosisText || ' - ' || v_vSpecifierText;
      END IF;
    ELSIF (v_nAxisType = 3) THEN
      v_vDiagnosisText := pi_vAxis3Text;
    ELSE
      v_vDiagnosisTitle := getDiagnosisTitle(pi_nDiagnosisID);
      v_vDiagnosisText  := v_vDiagnosisTitle;
    END IF;
  
    --update record in treatment_diagnosis
    update treatment_problem_list t
    
       set t.diagnostic_text     = v_vDiagnosisText,
           t.stat_specifier_id   = v_nSpecifierID,
           t.stat_specifier_text = v_vSpecifierText,
           t.diagnostic_comment  = pi_vComment,
           t.last_updated        = sysdate,
           t.last_updated_by     = pi_nUserID,
           t.sort_order          = v_nSortOrder
    
     where t.patient_id = pi_vPatientID
       and t.problem_id = pi_nProblemID;
  
    commit;
  
    --update "last_updated" info in encounter table
    update encounter t
       set t.last_updated = sysdate, t.last_updated_by = pi_nUserID
     where t.patient_id = pi_vPatientID
       and t.encounter_id = pi_vEncounterID
       and t.treatment_id = pi_nTreatmentID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.UpdateDiagnosis(): ' || sqlErrm;
  end;

  procedure GetDiagnosisByIdRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_nDiagnosisID     in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.*
        from stat_diagnosis t
       where t.diagnosis_id = pi_nDiagnosisID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetDiagnosisByIdRS(): ' ||
                           sqlErrm;
  end;

  --getStatSpecifiers
  procedure GetStatSpecifiersRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.*, t2.stat_specifier_text
        from stat_diagnosis_specifier t, stat_specifier t2
       where t.stat_specifier_id = t2.stat_specifier_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetStatSpecifiersRS(): ' ||
                           sqlErrm;
  end;


  procedure GetAllSpecifiersRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
    v_vSQL constant varchar(32767) := 'select t1.*, t2.stat_specifier_text
from stat_diagnosis_specifier t1, stat_specifier t2
where t2.stat_specifier_id = t1.stat_specifier_id
order by t1.stat_diagnosis_id, t1.stat_specifier_id';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetAllSpecifiersRS(): ' ||
                           sqlErrm;
  end;

  procedure UpdateDiagnosisA3(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nProblemID       in number,
                              pi_vPatientID       in varchar2,
                              pi_vDiagText        in varchar2,
                              pi_nSeeMedRec       in number,
                              pi_nContributory    in number,
                              pi_vDiagComment     in varchar2,
                              pi_nSortOrder       in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2) is
  
    v_vSQL constant varchar(32767) := 'update TREATMENT_PROBLEM_LIST t
                                          set DIAGNOSTIC_TEXT     = :DIAG_TEXT,
                                              SEE_MEDICAL_RECORD  = :SEE_MED_REC,
                                              CONTRIBUTORY        = :CONTRIBUTORY,
                                              DIAGNOSTIC_COMMENT  = :DIAG_COMMENT,
                                              SORT_ORDER          = :SORT_ORDER,
                                              LAST_UPDATED        = sysdate,
                                              LAST_UPDATED_BY     = :USER_ID
                                        where PATIENT_ID = :PATIENT_ID
                                          and PROBLEM_ID = :PROBLEM_ID';
  
    v_nSortOrder number := null;
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    if pi_nSortOrder <> -1 then
      v_nSortOrder := pi_nSortOrder;
    end if;
  
    EXECUTE IMMEDIATE v_vSQL
      using pi_vDiagText, pi_nSeeMedRec, pi_nContributory, pi_vDiagComment, v_nSortOrder, pi_nUserID, pi_vPatientID, pi_nProblemID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.UpdateDiagnosisA3(): ' || sqlErrm;
  end;

  -- GET ALL POTENTIAL PROBLEMS ---------------------------
  procedure GetPotentialProblemsRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   pi_vEncounterID     in varchar2,
                                   pi_nTreatmentID     in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
  
    v_vSQL constant varchar(32767) := 'select t.*, 
                                        PCK_DIAGNOSIS.getAxis(t.diagnosis_id) as diagnostic_axis
                                          from VW_INTAKE_PROBLEM_LIST t
                                         where t.flag_id in
                                              (select flag_id 
                                                 from encounter_intake_flag f
                                                where f.encounter_id  = :ENCOUNTER_ID
                                                  and f.flag_id is not null
                                                  and f.problem_status = 0
                                                  and f.ignore_intake_problem <> 1)';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
      USING pi_vEncounterID;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetPotentialProblemsRS(): ' ||
                           sqlErrm;
  end;

  -- GET PROBLEM CRITERIA
  procedure GetProblemCriteriaRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vEncounterID     in varchar2,
                                 pi_nIntkProblemID   in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for
      select t.*,
             (select count(*)
                from encounter_intake_responses r
               where r.encounter_id = pi_vEncounterID
                 and r.mid = t.mid
                 and instr(',' || t.rid || ',', ',' || r.rid || ',') > 0) as status
        from intake_problem_criteria t
       where t.intake_problem_id = pi_nIntkProblemID
       order by t.criteria_id;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetProblemCriteriaRS(): ' ||
                           sqlErrm;
  end;

  -- GET PROBLEM CRITERIA
  procedure GetCriteriaDefinitionsRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vEncounterID     in varchar2,
                                     pi_nIntkProblemID   in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor) is
  
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for
      select t.*,
             (select count(*)
                from encounter_intake_responses r
               where r.encounter_id = pi_vEncounterID
                 and r.mid = t.mid
                 and instr(',' || t.rid || ',', ',' || r.rid || ',') > 0) as status
        from intake_problem_criteria_def t
       where t.intake_problem_id = pi_nIntkProblemID
         and t.active = 1
       order by t.definition_id;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetCriteriaDefinitionsRS(): ' ||
                           sqlErrm;
  end;

  -- INSERT PROBLEM CRITERIA AND DEFINITION
  procedure InsertCriteriaDefinition(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_vEncounterID     in varchar2,
                                     pi_nTreatmentID     in number,
                                     pi_nDiagnosisID     in number,
                                     pi_nProblemID       in number,
                                     --pi_nIntakeProblemID in number,
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2) is
  
    rs1 RetRefCursor; --intake_problem
    rs2 RetRefCursor; --intake_problem_criteria
    rs3 RetRefCursor; --intake_problem_criteria_def
  
    v_recProblem    intake_problem_list%ROWTYPE;
    v_recCriteria   intake_problem_criteria%ROWTYPE;
    v_recDefinition intake_problem_criteria_def%ROWTYPE;
  
    v_criteriaID   number;
    v_definitionID number;
  
    v_nCriteriaStatus   number;
    v_nDefinitionStatus number;
  
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    -- Get Intake_Problem_List recordset
    open rs1 for
      select *
        from intake_problem_list t1
       where t1.diagnosis_id = pi_nDiagnosisID
      --where t1.intake_problem_id = pi_nIntakeProblemID
      /*and t1.flag_id in (select distinct flag_id
       from encounter_intake_flag t2
      where t2.encounter_id = pi_vEncounterID
        and t2.problem_status = 1)*/
      ;
  
    --Loop over all intake problems found
    LOOP
      v_recProblem := null;
      fetch rs1
        into v_recProblem;
      exit when not rs1%found;
    
      --get criterias for current problem
      open rs2 for
        select t3.*
          from intake_problem_criteria t3
         where t3.intake_problem_id = v_recProblem.Intake_Problem_Id
           and t3.active = 1;
    
      LOOP
        v_recCriteria := null;
        fetch rs2
          into v_recCriteria;
        exit when not rs2%found;
      
        select seqtxprobcriteria.nextval into v_criteriaID from dual;
      
        --determine criteria status
        select count(*)
          into v_nCriteriaStatus
          from encounter_intake_responses q1
         where q1.encounter_id = pi_vEncounterID
           and q1.mid = v_recCriteria.Mid
           and instr(',' || v_recCriteria.Rid || ',', ',' || q1.rid || ',') > 0;
        --and q1.rid = v_recCriteria.Rid;
      
        --Insert criteria found
        insert into treatment_prob_criteria
          (problem_id,
           treatment_id,
           patient_id,
           encounter_id,
           criteria_id,
           criteria,
           status,
           intake_problem_id,
           mid,
           rid)
        values
          (pi_nProblemID,
           pi_nTreatmentID,
           pi_vPatientID,
           pi_vEncounterID,
           v_recCriteria.Criteria_Id,
           v_recCriteria.Criteria,
           v_nCriteriaStatus,
           v_recCriteria.Intake_Problem_Id,
           v_recCriteria.Mid,
           v_recCriteria.Rid);
        commit;
      
        open rs3 for
          select *
            from intake_problem_criteria_def t4
           where t4.criteria_id = v_recCriteria.Criteria_Id
             and t4.active = 1;
      
        LOOP
          v_recDefinition := null;
          fetch rs3
            into v_recDefinition;
          exit when not rs3%found;
        
          --determine definition status
          select count(*)
            into v_nDefinitionStatus
            from encounter_intake_responses q1
           where q1.encounter_id = pi_vEncounterID
             and q1.mid = v_recDefinition.Mid
             and instr(',' || v_recDefinition.Rid || ',',
                       ',' || q1.rid || ',') > 0;
          --and q1.rid = v_recDefinition.Rid;
        
          select seqtxprobcriteriadef.nextval
            into v_definitionID
            from dual;
        
          insert into treatment_prob_criteria_def
            (problem_id,
             treatment_id,
             patient_id,
             encounter_id,
             criteria_id,
             definition,
             status,
             definition_id,
             intake_problem_id)
          values
            (pi_nProblemID,
             pi_nTreatmentID,
             pi_vPatientID,
             pi_vEncounterID,
             v_recCriteria.Criteria_Id,
             v_recDefinition.Definition,
             v_nDefinitionStatus,
             v_recDefinition.Definition_Id,
             v_recDefinition.Intake_Problem_Id);
          commit;
        
        END LOOP;
        close rs3;
      
      END LOOP;
      close rs2;
    
    END LOOP;
    close rs1;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetCriteriaDefinitionsRS(): ' ||
                           sqlErrm;
  end;

  --Get TREATMENT_PROBLEM_CRITERIA
  procedure GetTxProblemCriteriaRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   pi_vEncounterID     in varchar2,
                                   pi_nTreatmentId     in number,
                                   pi_nProblemID       in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
  
    v_vSQL constant varchar(32767) := 'select t.*
                                      from treatment_prob_criteria t
                                     where t.patient_id   = :PATIENT_ID
                                       and t.encounter_id = :ENCOUNTER_ID
                                       and t.treatment_id = :TREATMENT_ID
                                       and t.problem_id   = :PROBLEM_ID
                                  order by t.criteria_id';
  
  begin
    open rs for v_vSQL
      USING pi_vPatientID, pi_vEncounterID, pi_nTreatmentId, pi_nProblemID;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetTxProblemCriteriaRS(): ' ||
                           Sqlerrm;
  end;

  --Get TREATMENT_PROBLEM_CRITERIA_DEFINITIONS
  procedure GetTxProblemCriteriaDefRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vPatientID       in varchar2,
                                      pi_vEncounterID     in varchar2,
                                      pi_nTreatmentId     in number,
                                      pi_nProblemID       in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor) is
  
    v_vSQL constant varchar(32767) := 'select t.*
                                      from treatment_prob_criteria_def t
                                     where t.patient_id   = :PATIENT_ID
                                       and t.encounter_id = :ENCOUNTER_ID
                                       and t.treatment_id = :TREATMENT_ID
                                       and t.problem_id   = :PROBLEM_ID';
  
  begin
    open rs for v_vSQL
      USING pi_vPatientID, pi_vEncounterID, pi_nTreatmentId, pi_nProblemID;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetTxProblemCriteriaDefRS(): ' ||
                           Sqlerrm;
  end;

  procedure UpdateCriteria(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nProblemID       in number,
                           pi_nCriteriaID      in number,
                           pi_nStatus          in number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  
    v_vSQL constant varchar(32767) := 'update treatment_prob_criteria
                          set status = :STATUS
                        where problem_id = :PROBLEM_ID
                          and criteria_id = :CRITERIA_ID';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    EXECUTE IMMEDIATE v_vSQL
      using pi_nStatus, pi_nProblemID, pi_nCriteriaID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.UpdateCriteria(): ' || sqlErrm;
  end;

  procedure UpdateCriteriaDefinition(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     
                                     pi_nProblemID    in number,
                                     pi_nCriteriaID   in number,
                                     pi_nDefinitionID in number,
                                     pi_nStatus       in number,
                                     
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2) is
  
    v_vSQL constant varchar(32767) := 'update treatment_prob_criteria_def t
                                          set t.status = :STATUS
                                        where t.problem_id = :PROBLEM_ID
                                          and t.criteria_id = :CRITERIA_ID
                                          and t.definition_id = :DEFINITION_ID ';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    EXECUTE IMMEDIATE v_vSQL
      using pi_nStatus, pi_nProblemID, pi_nCriteriaID, pi_nDefinitionID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.UpdateCriteriaDefinition(): ' ||
                           sqlErrm;
  end;

  procedure DiscontinueDiagnosis(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_nProblemID       in number,
                                 pi_vInactiveComment in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
    v_vSQL constant varchar(32767) := 'update treatment_problem_list t
                                                  set t.inactive          = 1,
                                                      t.inactive_comment  = :INACTIVE_COMMENT,
                                                      t.last_updated      = sysdate,
                                                      t.last_updated_by   = :USER_ID
                                                where t.patient_id        = :PATIENT_ID
                                                  and t.problem_id        = :PROBLEM_ID';
  begin
    EXECUTE IMMEDIATE v_vSQL
      using pi_vInactiveComment, pi_nUserID, pi_vPatientID, pi_nProblemID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.DiscontinueDiagnosis(): ' ||
                           sqlErrm;
    
  end;

  procedure GetQuestionResponseRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vEncounterID     in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for
      select t1.*
        from (select ipc.intake_problem_id,
                     ipc.criteria_id,
                     0 as definition_id,
                     eir.*,
                     ir.response,
                     iq.question
                from encounter_intake_flag      eif,
                     intake_problem_list        ipl,
                     intake_problem_criteria    ipc,
                     encounter_intake_responses eir,
                     intake_response            ir,
                     intake_question            iq
               where eif.problem_status = 0
                 and eif.encounter_id = pi_vEncounterID
                 and ipl.flag_id = eif.flag_id
                 and ipc.intake_problem_id = ipl.intake_problem_id
                 and ipc.active = 1
                    --encounter_intake_responses
                 and eir.encounter_id = eif.encounter_id
                 and eir.mid = ipc.mid
                 and instr(',' || ipc.rid || ',', ',' || eir.rid || ',') > 0
                    --intake_response
                 and ir.mid = eir.mid
                 and ir.rid = eir.rid
                 and ir.qid = eir.qid
                    --intake_question
                 and iq.mid = eir.mid
                 and iq.qid = eir.qid) t1
      union
      select t2.*
        from (select ipc.intake_problem_id,
                     ipc.criteria_id,
                     ipc.definition_id,
                     eir.*,
                     ir.response,
                     iq.question
                from encounter_intake_flag       eif,
                     intake_problem_list         ipl,
                     intake_problem_criteria_def ipc,
                     encounter_intake_responses  eir,
                     intake_response             ir,
                     intake_question             iq
               where eif.problem_status = 0
                 and eif.encounter_id = pi_vEncounterID
                 and ipl.flag_id = eif.flag_id
                 and ipc.intake_problem_id = ipl.intake_problem_id
                 and ipc.active = 1
                    --encounter_intake_responses
                 and eir.encounter_id = eif.encounter_id
                 and eir.mid = ipc.mid
                 and instr(',' || ipc.rid || ',', ',' || eir.rid || ',') > 0
                    --intake_response
                 and ir.mid = eir.mid
                 and ir.rid = eir.rid
                 and ir.qid = eir.qid
                    --intake_question
                 and iq.mid = eir.mid
                 and iq.qid = eir.qid) t2;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetQuestionResponseRS(): ' ||
                           sqlErrm;
  end;

  -- Delete diagnosis
  procedure DiscardPossibleProblem(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vEncounterID     in varchar2,
                                   pi_nIntakeProblemID in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2) is
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update encounter_intake_flag t
       set t.ignore_intake_problem = 1
     where t.encounter_id = pi_vEncounterID
       and t.flag_id in
           (select distinct p.flag_id
              from intake_problem_list p
             where p.intake_problem_id = pi_nIntakeProblemID);
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.DiscardPossibleProblem(): ' ||
                           sqlErrm;
  end;

  /*
  **************************************************************************
  */

  function fUpdateEncDiagnosis(pi_vPatientID   varchar2,
                               pi_vEncounterID varchar2) return varchar2 is
  
    CURSOR curProbList is
      select *
        from treatment_problem_list p
       where encounter_id in
             (select t.encounter_id
                from encounter t
               where t.patient_id = pi_vPatientID
                 and t.encounter_date <=
                     (select encounter_date
                        from encounter
                       where encounter_id = pi_vEncounterID))
         and p.inactive <> 1
       order by p.diagnostic_axis_type;
  
    recProbList curProbList%rowtype;
    v_nRowCount number := 0;
    v_nAxis     number := 0;
    v_vSpacer   varchar2(64) := chr(10);
    v_vContrib  varchar2(4) := '';
    v_vMedRec   varchar2(4) := '';
    strDiag     varchar2(32767) := '';
  
  begin
  
    OPEN curProbList;
    LOOP
      FETCH curProbList
        INTO recProbList;
      EXIT WHEN curProbList%NOTFOUND;
      v_nRowCount := curProbList%rowcount;
    
      IF (recProbList.Diagnostic_Axis_Type is not null) THEN
        --write axis type header when moving to another axis group   
        /*
         IF (recProbList.Diagnostic_Axis_Type <> v_nAxis) THEN
         
           IF (v_nRowCount > 1) THEN
             strDiag := strDiag || v_vSpacer;
           END IF;
         
           IF (recProbList.Diagnostic_Axis_Type = 1) THEN
             --AXIS I HEADER
             strDiag := strDiag || 'AXIS I:' || v_vSpacer;
             v_nAxis := recProbList.Diagnostic_Axis_Type;
           ELSIF (recProbList.Diagnostic_Axis_Type = 2) THEN
             -- AXIS II HEADER
             strDiag := strDiag || 'AXIS II:' || v_vSpacer;
             v_nAxis := recProbList.Diagnostic_Axis_Type;
           ELSIF (recProbList.Diagnostic_Axis_Type = 3) THEN
             --AXIS III HEADER
             strDiag := strDiag || 'AXIS III:' || v_vSpacer;
             v_nAxis := recProbList.Diagnostic_Axis_Type;
           ELSIF (recProbList.Diagnostic_Axis_Type = 4) THEN
             --AXIS IV HEADER
             strDiag := strDiag || 'AXIS IV:' || v_vSpacer;
             v_nAxis := recProbList.Diagnostic_Axis_Type;
           ELSIF (recProbList.Diagnostic_Axis_Type = 5) THEN
             --AXIS V HEADER
             strDiag := strDiag || 'AXIS V:' || v_vSpacer;
             v_nAxis := recProbList.Diagnostic_Axis_Type;
           ELSE
             --AXIS X HEADER
             strDiag := strDiag || 'V & E CODES:' || v_vSpacer;
             v_nAxis := recProbList.Diagnostic_Axis_Type;
           END IF;
         END IF;
        */
        --start writing the problems
        strDiag := strDiag || chr(9);
      
        if (recProbList.Diag_Code is not null) then
          strDiag := strDiag || recProbList.Diag_Code || ' ';
        end if;
      
        if (recProbList.Diagnostic_Text is not null) then
          strDiag := strDiag || recProbList.Diagnostic_Text || ' ';
        end if;
      
        if (recProbList.Stat_Specifier_Text is not null) then
          strDiag := strDiag || recProbList.Stat_Specifier_Text || ' ';
        end if;
      
        if (recProbList.Contributory is not null) then
          if (recProbList.Contributory = 1) then
            v_vContrib := 'Yes ';
          else
            v_vContrib := 'No ';
          end if;
          strDiag := strDiag || chr(10) || chr(9) || 'Contributory: ' ||
                     v_vContrib;
        end if;
      
        /*
        if (recProbList.See_Medical_Record is not null) then
          if (recProbList.See_Medical_Record = 1) then
            v_vMedRec := 'Yes ';
          else
            v_vMedRec := 'No ';
          end if;
          strDiag := strDiag || 'See Medical Record: ' || v_vMedRec;
        end if;
        */
      
        if (recProbList.Diagnostic_Comment is not null) then
          strDiag := strDiag || chr(10) || chr(9);
          strDiag := strDiag || '[Comment: ' ||
                     recProbList.Diagnostic_Comment || ']' || chr(10);
        end if;
      
        strDiag := strDiag || chr(10);
      
      END IF;
    
    END LOOP;
    CLOSE curProbList;
  
    return strDiag;
  
  end fUpdateEncDiagnosis;

  /*
  -------------------------------------------------------------------------
          BUILD DIAGNOSIS DOCUMENTATION STRING
  --------------------------------------------------------------------------
  */

  function fGetDiagnosisString(pi_vPatientID   varchar2,
                               pi_vEncounterID varchar2) return varchar2 is
  
    CURSOR curProbList is
      select *
        from treatment_problem_list p
       where encounter_id in
             (select t.encounter_id
                from encounter t
               where t.patient_id = pi_vPatientID
                 and t.encounter_date <=
                     (select encounter_date
                        from encounter
                       where encounter_id = pi_vEncounterID))
         and p.inactive <> 1
       order by p.diagnostic_axis_type;
  
    recProbList curProbList%rowtype;
    recCriteria treatment_prob_criteria%rowtype;
    recDefs     treatment_prob_criteria_def%rowtype;
  
    curCriteria pck_common.refCursor;
    curDefs     pck_common.refCursor;
  
    v_nRowCount      number := 0;
    v_nCriteriaCount number := 0;
    v_nDefsCount     number := 0;
    v_nAxis          number := 0;
    v_vSpacer        varchar2(64) := chr(10);
    v_vContrib       varchar2(4) := '';
    v_vMedRec        varchar2(4) := '';
    strDiag          varchar2(32767) := '';
  
  begin
  
    OPEN curProbList;
    LOOP
      FETCH curProbList
        INTO recProbList;
      EXIT WHEN curProbList%NOTFOUND;
      v_nRowCount := curProbList%rowcount;
    
      IF (recProbList.Diagnostic_Axis_Type is not null) THEN
        --write axis type header when moving to another axis group   
        /*
        IF (recProbList.Diagnostic_Axis_Type <> v_nAxis) THEN
        
          IF (v_nRowCount > 1) THEN
            strDiag := strDiag || v_vSpacer;
          END IF;
        
          IF (recProbList.Diagnostic_Axis_Type = 1) THEN
            --AXIS I HEADER
            strDiag := strDiag || 'AXIS I:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 2) THEN
            -- AXIS II HEADER
            strDiag := strDiag || 'AXIS II:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 3) THEN
            --AXIS III HEADER
            strDiag := strDiag || 'AXIS III:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 4) THEN
            --AXIS IV HEADER
            strDiag := strDiag || 'AXIS IV:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 5) THEN
            --AXIS V HEADER
            strDiag := strDiag || 'AXIS V:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSE
            --AXIS X HEADER
            strDiag := strDiag || 'V & E CODES:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          END IF;
        END IF;
        */
      
        --start writing the problems
        strDiag := strDiag || chr(9);
      
        if (recProbList.Diag_Code is not null) then
          strDiag := strDiag || recProbList.Diag_Code || ' ';
        end if;
      
        if (recProbList.Diagnostic_Text is not null) then
          strDiag := strDiag || recProbList.Diagnostic_Text || ' ';
        end if;
      
        if (recProbList.Stat_Specifier_Text is not null) then
          strDiag := strDiag || recProbList.Stat_Specifier_Text || ' ';
        end if;
      
        if (recProbList.Contributory is not null) then
          if (recProbList.Contributory = 1) then
            v_vContrib := 'Yes ';
          else
            v_vContrib := 'No ';
          end if;
          strDiag := strDiag || chr(10) || chr(9) || 'Contributory: ' ||
                     v_vContrib;
        end if;
      
        /*
        if (recProbList.See_Medical_Record is not null) then
          if (recProbList.See_Medical_Record = 1) then
            v_vMedRec := 'Yes ';
          else
            v_vMedRec := 'No ';
          end if;
          strDiag := strDiag || 'See Medical Record: ' || v_vMedRec;
        end if;
        */
      
        if (recProbList.Diagnostic_Comment is not null) then
          strDiag := strDiag || chr(10) || chr(9);
          strDiag := strDiag || '[Comment: ' ||
                     recProbList.Diagnostic_Comment || ']';
        end if;
      
        strDiag := strDiag || chr(10);
      
      END IF;
    
    END LOOP;
    CLOSE curProbList;
  
    return strDiag;
  
  end fGetDiagnosisString;

  /*
  --------------------------------------------------------------------------
  */

  procedure UpdateDiagnosisProb(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nProblemID       in number,
                                pi_nDiagnosisID     in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2) is
  
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    update treatment_problem_list t
       set t.diagnostic_id   = pi_nDiagnosisID,
           t.diagnostic_text = getDiagnosisTitle(pi_nDiagnosisID),
           t.diag_code      =
           (select d.diag_code
              from stat_diagnosis d
             where d.diagnosis_id = pi_nDiagnosisID)
     where t.problem_id = pi_nProblemID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_DIAGNOSIS.UpdateDiagnosisProb(): ' ||
                           sqlErrm;
  end;

  procedure GetAllChildItemsRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.*
        from stat_diagnosis t
       where t.diagnosis_axis > 0
         and t.menu_has_parent = 1
       order by t.diagnosis_axis, t.sort_order, t.diagnosis_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetAllChildItemsRS(): ' ||
                           sqlErrm;
  end;

  procedure GetAxesTitlesRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from stat_diagnosis t
       where t.active = 1
         and t.menu_has_parent = 0
         and t.menu_parent_id = 0
       order by t.sort_order, t.diagnosis_axis;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_DIAGNOSIS.GetAxesTitlesRS(): ' || sqlErrm;
  end;

  /*
  -------------------------------------------------------------------------
          BUILD ASSESSMENT / PLAN DOCUMENTATION STRING
  --------------------------------------------------------------------------
  */

  function fGetAssessmentPlanString(pi_vPatientID   varchar2,
                                    pi_vEncounterID varchar2) return varchar2 is
  
    CURSOR curProbList is
      select *
        from treatment_problem_list p
       where encounter_id in
             (select t.encounter_id
                from encounter t
               where t.patient_id = pi_vPatientID
                 and t.encounter_date <=
                     (select encounter_date
                        from encounter
                       where encounter_id = pi_vEncounterID))
         and p.inactive <> 1
       order by p.diagnostic_axis_type;
  
    recProbList curProbList%rowtype;
    recCriteria treatment_prob_criteria%rowtype;
    recDefs     treatment_prob_criteria_def%rowtype;
  
    curCriteria pck_common.refCursor;
    curDefs     pck_common.refCursor;
  
    v_nRowCount      number := 0;
    v_nCriteriaCount number := 0;
    v_nDefsCount     number := 0;
    v_nAxis          number := 0;
    v_vSpacer        varchar2(64) := chr(10);
    v_vContrib       varchar2(4) := '';
    v_vMedRec        varchar2(4) := '';
    strDiag          varchar2(32767) := '';
  
  begin
  
    OPEN curProbList;
    LOOP
      FETCH curProbList
        INTO recProbList;
      EXIT WHEN curProbList%NOTFOUND;
      v_nRowCount := curProbList%rowcount;
    
      IF (recProbList.Diagnostic_Axis_Type is not null) THEN
      
        strDiag := strDiag || 'DIAGNOSIS:' || chr(10);
        --start writing the problems
        strDiag := strDiag || chr(9);
      
        if (recProbList.Diag_Code is not null) then
          strDiag := strDiag || recProbList.Diag_Code || ' ';
        end if;
      
        if (recProbList.Diagnostic_Text is not null) then
          strDiag := strDiag || recProbList.Diagnostic_Text || ' ';
        end if;
      
        if (recProbList.Stat_Specifier_Text is not null) then
          strDiag := strDiag || recProbList.Stat_Specifier_Text || ' ';
        end if;
      
        if (recProbList.Contributory is not null) then
          if (recProbList.Contributory = 1) then
            v_vContrib := 'Yes ';
          else
            v_vContrib := 'No ';
          end if;
          strDiag := strDiag || chr(10) || chr(9) || 'Contributory: ' ||
                     v_vContrib;
        end if;
      
        /*
        if (recProbList.See_Medical_Record is not null) then
          if (recProbList.See_Medical_Record = 1) then
            v_vMedRec := 'Yes ';
          else
            v_vMedRec := 'No ';
          end if;
          strDiag := strDiag || 'See Medical Record: ' || v_vMedRec;
        end if;
        */
      
        if (recProbList.Diagnostic_Comment is not null) then
          strDiag := strDiag || chr(10) || chr(9);
          strDiag := strDiag || '[Comment: ' ||
                     recProbList.Diagnostic_Comment || ']';
        end if;
      
        /*
          ---------------------------------------
          Get Problem Criteria
          ---------------------------------------
        */
        open curCriteria for
          select *
            from treatment_prob_criteria tpc
           where tpc.problem_id = recProbList.Problem_Id
             and tpc.encounter_id in
                 (select e.encounter_id
                    from encounter e
                   where e.patient_id = pi_vPatientID
                     and e.encounter_date <=
                         (select encounter_date
                            from encounter
                           where encounter_id = pi_vEncounterID))
             and tpc.status = 1;
      
        loop
          fetch curCriteria
            into recCriteria;
          exit when curCriteria%notfound;
          v_nCriteriaCount := curCriteria%rowcount;
        
          if (v_nCriteriaCount <= 1) then
            strDiag := strDiag || chr(10) || chr(9) || chr(9) ||
                       'ASSESSMENT:';
          end if;
        
          strDiag := strDiag || chr(10) || chr(9) || chr(9) || chr(9) ||
                     '[x] ' || recCriteria.Criteria;
        
          /*
          -----------------------------------------------------------
                         GET CRITERIA DEFINITIONS
          -----------------------------------------------------------
          */
        
          open curDefs for
            select *
              from treatment_prob_criteria_def tcd
             where tcd.patient_id = pi_vPatientID
               and tcd.problem_id = recCriteria.Problem_Id
               and tcd.criteria_id = recCriteria.Criteria_Id
               and tcd.status = 1
               and tcd.encounter_id in
                   (select e1.encounter_id
                      from encounter e1
                     where e1.patient_id = pi_vPatientID
                       and e1.encounter_date <=
                           (select encounter_date
                              from encounter
                             where encounter_id = pi_vEncounterID));
        
          loop
            fetch curDefs
              into recDefs;
            exit when curDefs%notfound;
            v_nDefsCount := curDefs%rowcount;
          
            if (v_nDefsCount <= 1) then
              strDiag := strDiag || chr(10) || chr(9) || chr(9) || chr(9) ||
                         chr(9) || 'PLAN:';
            end if;
          
            strDiag := strDiag || chr(10) || chr(9) || chr(9) || chr(9) ||
                       chr(9) || chr(9) || '(x) ' || recDefs.Definition;
          
          end loop;
        
          close curDefs;
        
          -- --------------------------------------------------------
        
        end loop;
        close curCriteria;
      
        strDiag := strDiag || chr(10);
      
      END IF;
    
    END LOOP;
    CLOSE curProbList;
  
    return strDiag;
  
  end fGetAssessmentPlanString;

/*
  --------------------------------------------------------------------------
  */

end PCK_DIAGNOSIS;
/

prompt
prompt Creating package body PCK_ENCOUNTER
prompt ===================================
prompt
create or replace package body PCK_ENCOUNTER is
  --------------------------------------------------------------------------
  --does the patient have an open encounter of this type?
  procedure GetCurrentTreatmentRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
  
    v_nCount number;
  
  begin
  
    v_nCount := 0;
  
    select count(*)
      into v_nCount
      from treatment
     where patient_id = pi_vPatientID
       and nvl(case_closed, 0) = 0;
  
    open rs for
      select *
        from treatment t
       where t.patient_id = pi_vPatientID
         and nvl(t.case_closed, 0) = 0;
  
    if v_nCount < 1 then
      po_nStatusCode    := 1;
      po_vStatusComment := 'Patient does not have an open treatment!';
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetCurrentTreatmentRS(): ' ||
                           sqlErrm;
  end;

    --------------------------------------------------------------------------
  --create a new encounter
  procedure CreateEncounter(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPatientID       in varchar2,
                            pi_vTreatmentID     in varchar2,
                            pi_vNewEncID        in varchar2,
                            pi_nEncounterType   in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2) is
  
    v_nCount        number;
    v_vPrevEnc      varchar2(255);
    v_vEncDiagnosis long;
    strSQL          long;
  
    --rsTreatDiag    refCursor;
    --v_recTreatDiag TREATMENT_DIAGNOSIS%ROWTYPE;
    v_treatDiagId number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_nCount          := 0;
    v_vPrevEnc        := '';
    v_vEncDiagnosis   := '';
    strSQL            := '';
    v_treatDiagId     := 0;
  
    ---
    --check to see if we have an open note of this type before
    --creating a new one...
  
    v_nCount := 0;
  
    --get the encounter_id,
    --diagnosis from the previous note
    v_vEncDiagnosis := '';
    if pi_nEncounterType != 99 then
      begin
      
        --get the most recent previous encounter
        --excluding admin notes.
        select e.encounter_id, e.encounter_diagnosis
          into v_vPrevEnc, v_vEncDiagnosis
          from encounter e
         where e.patient_id = pi_vPatientID
           and e.encounter_type_id != 99
           and e.encounter_date =
               (select max(t.encounter_date)
                  from encounter t
                 where t.patient_id = pi_vPatientID
                   and t.encounter_type_id != 99);
      exception
        when others then
          --nothing to do.
          null;
      end;
    end if;
  
    v_nCount := 0;
  
    --do the actual insert
    insert into encounter
      (encounter_id,
       treatment_id,
       patient_id,
       encounter_date,
       encounter_type_id,
       last_updated,
       last_updated_by,
       encounter_diagnosis)
    values
      (pi_vNewEncID,
       pi_vTreatmentID,
       pi_vPatientID,
       sysdate,
       pi_nEncounterType,
       sysdate,
       pi_nUserID,
       v_vEncDiagnosis);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.CreateEncounter(): ' || sqlErrm;
  end;

  procedure GetEncounterRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           pi_nTreatmentID     in number,
                           pi_vEncounterID     in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select e.*,
             t.case_closed,
             t.initial_visit_date,
             t.disposition_id,
             t.level_of_care_id
        from encounter e, treatment t
       where e.patient_id = pi_vPatientID
         and e.treatment_id = pi_nTreatmentID
         and e.encounter_id = pi_vEncounterID
         and e.treatment_id = t.treatment_id
         and e.patient_id = t.patient_id
         and t.treatment_id = pi_nTreatmentID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetEncounterRS(): ' || sqlErrm;
  end;

  --------------------------------------------------------------------------
  procedure GetTreatmentEncountersRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*
        from encounter t
       where patient_id = pi_vPatientID --Patient Specific
         and treatment_id = pi_nTreatmentID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetTreatmentEncountersRS(): ' ||
                           sqlErrm;
  end;

  --------------------------------------------------------------------------
  procedure GetAllEncounterListRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
  
    open rs for
      select t.*
        from encounter t
       where t.patient_id = pi_vPatientID
       order by t.encounter_date desc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetAllEncounterListRS(): ' ||
                           sqlErrm;
  end;

  --------------------------------------------------------------------------
  procedure GetAllEncounterIntakeRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor) is
  
    v_vPatientID   varchar2(256);
    v_nTreatmentID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    v_vPatientID := pi_vPatientID;
  
    open rs for
      select i.*, m.module, e.encounter_id, e.treatment_id
        from encounter_intake i, intake_module m, encounter e
       where i.encounter_id in
             (select t.encounter_id
                from encounter t
               where t.patient_id = v_vPatientID)
         and i.mid = m.mid
         and e.encounter_id = i.encounter_id
       order by i.intake_type desc, i.encounter_intake_id asc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetAllEncounterIntakeRS(): ' ||
                           sqlErrm;
  end;
  
 
  --------------------------------------------------------------------------
  procedure GetEncounterDates(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nSelectedCases   in number,
                              pi_nTreatmentID     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
    v_const_Search_All_Cases    number := 1;
    v_const_Search_Open_Cases   number := 2;
    v_const_Search_Closed_Cases number := 3;
  
    strSQL          varchar2(1000);
    strSelectSQL    varchar2(300) := '';
    strSelTreatment varchar2(64);
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    if pi_nSelectedCases = v_const_Search_Closed_Cases then
      strSelectSQL := ' and t1.case_closed <> 0';
    
    elsif pi_nSelectedCases = v_const_Search_Open_Cases then
      strSelectSQL := ' and t1.case_closed = 0';
    
    elsif pi_nSelectedCases = v_const_Search_All_Cases then
      strSelectSQL := '';
    end if;
  
    if pi_nTreatmentID = -1 or pi_nTreatmentID is null then
      strSelTreatment := '';
    else
      strSelTreatment := ' and e.treatment_id  = ' ||
                         to_char(pi_nTreatmentID);
    end if;
  
    strSQL := 'select e.*, t1.*';
    strSQL := strSQL || ' from encounter e';
    strSQL := strSQL || ' left join (select * from treatment) t1';
    strSQL := strSQL || ' on t1.patient_id = e.patient_id';
    strSQL := strSQL || ' and t1.treatment_id = e.treatment_id';
    strSQL := strSQL || ' where e.patient_id = ''' || pi_vPatientID || '''';
    strSQL := strSQL || strSelectSQL;
    strSQL := strSQL || strSelTreatment;
    strSQL := strSQL || ' order by e.encounter_date desc';
  
    --open recordset
    open rs for strSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetEncounterDates(): ' || sqlErrm;
  end;

  --------------------------------------------------------------------------
  procedure GetInitialVisitRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nTreatmentID     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*
        from encounter t
       where t.patient_id = pi_vPatientID
         and t.treatment_id = pi_nTreatmentID
         and t.encounter_type_id = 0;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetInitialVisitRS(): ' || sqlErrm;
  end;

  --------------------------------------------------------------------------
  procedure GetEncounterIntakeFlagsRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vEncounterID     in varchar2,
                                      pi_nMID             in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor) is
  
    v_nEncIntakeID number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get the latest encounter_intake_id
    --in case the intake was taken more than once in the same encounter
  
    select max(e.encounter_intake_id)
      into v_nEncIntakeID
      from encounter_intake_flag e
     where e.encounter_id = pi_vEncounterID
       and e.mid = pi_nMID;
  
    --open recordset
    open rs for
      select t.SESSION_FLAG_TX
        from ENCOUNTER_INTAKE_FLAG t
       where ENCOUNTER_ID = pi_vEncounterID
         and REPORT_TYPE_ID = 4
         AND MID = pi_nMID
         and t.encounter_intake_id = v_nEncIntakeID
       ORDER BY FLAG_ID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetEncounterIntakeFlagsRS(): ' ||
                           sqlErrm;
  end;
  
  procedure UpdateEncounterDiagnosis(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_vEncounterID     in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2) is
  
    CURSOR curProbList is
      select *
        from treatment_problem_list p
       where encounter_id in
             (select t.encounter_id
                from encounter t
               where t.patient_id = pi_vPatientID
                 and t.encounter_date <=
                     (select encounter_date
                        from encounter
                       where encounter_id = pi_vEncounterID))
         and p.inactive <> 1
       order by p.diagnostic_axis_type, p.diag_code;
  
    recProbList curProbList%rowtype;
    v_nRowCount number := 0;
    v_nAxis     number := 0;
    v_vSpacer   varchar2(64) := chr(10);
    v_vContrib  varchar2(4) := '';
    v_vMedRec   varchar2(4) := '';
    strDiag     varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    OPEN curProbList;
    LOOP
      FETCH curProbList
        INTO recProbList;
      EXIT WHEN curProbList%NOTFOUND;
      v_nRowCount := curProbList%rowcount;
    
      IF (recProbList.Diagnostic_Axis_Type is not null) THEN
        --write axis type header when moving to another axis group   
        IF (recProbList.Diagnostic_Axis_Type <> v_nAxis) THEN
        
          IF (v_nRowCount > 1) THEN
            strDiag := strDiag || v_vSpacer;
          END IF;
        
          IF (recProbList.Diagnostic_Axis_Type = 1) THEN
            --AXIS I HEADER
            strDiag := strDiag || 'AXIS I:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 2) THEN
            -- AXIS II HEADER
            strDiag := strDiag || 'AXIS II:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 3) THEN
            --AXIS III HEADER
            strDiag := strDiag || 'AXIS III:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 4) THEN
            --AXIS IV HEADER
            strDiag := strDiag || 'AXIS IV:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSIF (recProbList.Diagnostic_Axis_Type = 5) THEN
            --AXIS V HEADER
            strDiag := strDiag || 'AXIS V:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          ELSE
            --AXIS X HEADER
            strDiag := strDiag || 'V & E CODES:' || v_vSpacer;
            v_nAxis := recProbList.Diagnostic_Axis_Type;
          END IF;
        END IF;
      
        --start writing the problems
        strDiag := strDiag || chr(9);
      
        if (recProbList.Diag_Code is not null) then
          strDiag := strDiag || recProbList.Diag_Code || ' ';
        end if;
      
        if (recProbList.Diagnostic_Text is not null) then
          strDiag := strDiag || recProbList.Diagnostic_Text || ' ';
        end if;
      
        if (recProbList.Stat_Specifier_Text is not null) then
          strDiag := strDiag || recProbList.Stat_Specifier_Text || ' ';
        end if;
      
        if (recProbList.Contributory is not null) then
          if (recProbList.Contributory = 1) then
            v_vContrib := 'Yes ';
          else
            v_vContrib := 'No ';
          end if;
          strDiag := strDiag || chr(10) || chr(9) || 'Contributory: ' ||
                     v_vContrib;
        end if;
      
        if (recProbList.Diagnostic_Comment is not null) then
          strDiag := strDiag || chr(10) || chr(9);
          strDiag := strDiag || '[Comment: ' ||
                     recProbList.Diagnostic_Comment || ']' || chr(10);
        end if;
      
        strDiag := strDiag || chr(10);
      
      END IF;
    
    END LOOP;
    CLOSE curProbList;
  
    --save the generated string into ENCOUNTER.ENCOUNTER_DIAGNOSIS
    update encounter e
       set e.encounter_diagnosis = strDiag
     where e.encounter_id = pi_vEncounterID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.UpdateEncounterDiagnosis(): ' ||
                           sqlErrm;
  end;

  function fUpdateEncDiagnosis(pi_vPatientID   varchar2,
                               pi_vEncounterID varchar2) return varchar2 is
  
    CURSOR curProbList is
      select *
        from treatment_problem_list p
       where encounter_id in
             (select t.encounter_id
                from encounter t
               where t.patient_id = pi_vPatientID
                 and t.encounter_date <=
                     (select encounter_date
                        from encounter
                       where encounter_id = pi_vEncounterID))
         and p.inactive <> 1
       order by p.diagnostic_axis_type;
  
    recProbList curProbList%rowtype;
    v_nRowCount number := 0;
    v_nAxis     number := 0;
    v_vSpacer   varchar2(64) := chr(10);
    v_vContrib  varchar2(4) := '';
    v_vMedRec   varchar2(4) := '';
    strDiag     varchar2(32767) := '';
  
  begin
  
    OPEN curProbList;
    LOOP
      FETCH curProbList
        INTO recProbList;
      EXIT WHEN curProbList%NOTFOUND;
      v_nRowCount := curProbList%rowcount;
    
      IF (recProbList.Diagnostic_Axis_Type is not null) THEN      
        --start writing the problems
        strDiag := strDiag || chr(9);
      
        if (recProbList.Diag_Code is not null) then
          strDiag := strDiag || recProbList.Diag_Code || ' ';
        end if;
      
        if (recProbList.Diagnostic_Text is not null) then
          strDiag := strDiag || recProbList.Diagnostic_Text || ' ';
        end if;
      
        if (recProbList.Stat_Specifier_Text is not null) then
          strDiag := strDiag || recProbList.Stat_Specifier_Text || ' ';
        end if;
      
        if (recProbList.Contributory is not null) then
          if (recProbList.Contributory = 1) then
            v_vContrib := 'Yes ';
          else
            v_vContrib := 'No ';
          end if;
          strDiag := strDiag || chr(10) || chr(9) || 'Contributory: ' ||
                     v_vContrib;
        end if;
      
        if (recProbList.Diagnostic_Comment is not null) then
          strDiag := strDiag || chr(10) || chr(9);
          strDiag := strDiag || '[Comment: ' ||
                     recProbList.Diagnostic_Comment || ']' || chr(10);
        end if;
      
        strDiag := strDiag || chr(10);
      
      END IF;
    
    END LOOP;
    CLOSE curProbList;
  
    return strDiag;
  
  end fUpdateEncDiagnosis;

  -----------------------------------------------------
  procedure GetEducationFlagsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vPatientID       in varchar2,
                                pi_vEncounterID     in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from intake_flags t1
       where t1.session_flag_ed is not null
         and t1.flag_id in
             (select t2.flag_id
                from encounter_intake_flag t2
               where t2.encounter_id = pi_vEncounterID);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetEducationFlagsDS(): ' ||
                           sqlErrm;
  end;
 

  procedure GetAllEncounterTypesRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    --open recordset
    open rs for
      select *
        from stat_encounter_type t
       where active = 1
       order by encounter_type_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetAllEncounterTypesRS(): ' ||
                           sqlErrm;
  end;

  -- toggle note's LOCK state
  procedure LockNote(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     --
                     pi_vPatientID   in varchar2,
                     pi_vEncounterID in varchar2,
                     pi_nTreatmentID in number,
                     --
                     po_nStatusCode    out number,
                     po_vStatusComment out varchar2) is
  
    v_nLockRight  number := 64;
    v_nUserRights number;
    v_nNoteStatus number;
    v_nLock       number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --checks if the user have the right to Lock/unlock the note
    begin
    
      select r.user_rights
        into v_nUserRights
        from fx_user_rights r
       where r.fx_user_id = pi_nUserID;
    
      if bitand(v_nLockRight, v_nUserRights) <= 0 then
        po_nStatusCode    := 1;
        po_vStatusComment := 'You are not authorized to Lock/Unlock the Note.';
        return;
      end if;
    
    end;
  
    -- check the current status of the note
    select nvl(closed, 0)
      into v_nNoteStatus
      from encounter
     where patient_id = pi_vPatientID
       and encounter_id = pi_vEncounterID
       and treatment_id = pi_nTreatmentID;
  
    if v_nNoteStatus > 0 then
      v_nLock := 0;
    else
      v_nLock := 1;
    end if;
  
    -- toggle note's lock state
    update encounter e
       set e.closed          = v_nLock,
           e.last_updated    = sysdate,
           e.last_updated_by = pi_nUserID
     where e.patient_id = pi_vPatientID
       and e.encounter_id = pi_vEncounterID
       and e.treatment_id = pi_nTreatmentID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.LockNote(): ' || sqlErrm;
  end;

  -- *******************************************************************
  -- CREATE SELF MANAGEMENT (TYPE 99) ENCOUNTER

  procedure CreateSelfMgntEncounter(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    
                                    pi_vPatientID in varchar2,
                                    pi_vNewEncID  in varchar2,
                                    
                                    po_nStatusCode    out number,
                                    po_vStatusComment out varchar2) is
  
    v_nTreatmentID number := 1;
    v_nOpenSMEnc   number := 0;
    v_nPendingMods number := 0;
    
    curEnc RetRefCursor;
    recEnc encounter%rowtype;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get most recent open treatment id
    select max(t.treatment_id)
      into v_nTreatmentID
      from treatment t
     where t.patient_id = pi_vPatientID
       and t.case_closed = 0;
  
    -- get count of open Type 99 Encounters
    select count(*)
      into v_nOpenSMEnc
      from encounter t
     where t.patient_id = pi_vPatientID
       and t.encounter_type_id = 99
       and t.closed = 0;
  
    -- get count of pending modules
    select count(*)
      into v_nPendingMods
      from patient_module t
     where t.patient_id = pi_vPatientID
       and t.status = 0;
  
    -- only create a new Self Management encounter if there is no previos type 99 open
    -- and if patient have pending modules to complete
  
    if v_nOpenSMEnc = 0 and v_nPendingMods > 0 then
    
      CreateEncounter(pi_vSessionID       => pi_vSessionID,
                      pi_vSessionClientIP => pi_vSessionClientIP,
                      pi_nUserID          => pi_nUserID,
                      pi_vPatientID       => pi_vPatientID,
                      pi_vTreatmentID     => v_nTreatmentID,
                      pi_vNewEncID        => pi_vNewEncID,
                      pi_nEncounterType   => 99,
                      po_nStatusCode      => po_nStatusCode,
                      po_vStatusComment   => po_vStatusComment);
                      
       open curEnc for
         select *
         from encounter t
         where t.patient_id = pi_vPatientID
         and t.encounter_type_id = 99
         and t.encounter_id not in (pi_vNewEncID)
         and (t.patient_height is not null or t.patient_weight is not null)
         order by t.encounter_date desc;
         
         loop
           fetch curEnc
           into recEnc;
           exit when curEnc%notfound;
           
           if curEnc%rowcount < 2 then
             update encounter t
             set t.patient_height = recEnc.Patient_Height,
                 t.patient_weight = recEnc.Patient_Weight
             where t.encounter_id = pi_vNewEncID;
             
             commit;
           end if;
           
         end loop;
       close curEnc;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.CreateEncounter(): ' || sqlErrm;
  end;

  -- ******************************************************************
  -- GET MOST RECENT TYPE 99 OPEN ENCOUNTER
  procedure GetSelfMgntEncounterRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2,
                                   rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from encounter t
       where t.patient_id = pi_vPatientID
         and t.encounter_type_id = 99
         and t.closed = 0
         and t.encounter_date in (select max(e.encounter_date)
                                    from encounter e
                                   where e.patient_id = pi_vPatientID
                                     and e.encounter_type_id = 99
                                     and e.closed = 0);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetSelfMgntEncounterRS(): ' ||
                           sqlErrm;
  end;

  -- *******************************************************************
  -- GET MODULES GROUP STATUS

  procedure GetModuleGroupStatusRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2,
                                   rs                out RetRefCursor) is
  
    v_nDaysPrior number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    v_nDaysPrior := to_number(getParameterValue('DAYS_PRIOR'));
  
    --open recordset
    open rs for
      select t.event_id, t.module_group_id, nvl(t2.pending, 0) as pending
        from intake_module_group t
        left join (select m.module_group_id, count(*) as pending
                     from patient_module m
                    where m.status = 0
                      and m.patient_id = pi_vPatientID
                      and (to_date(to_char(sysdate, 'mm/dd/yyyy'),
                                   'mm/dd/yyyy') >=
                          (nvl(m.scheduled_date,
                                to_date(to_char(sysdate, 'mm/dd/yyyy'),
                                        'mm/dd/yyyy')) - v_nDaysPrior))
                    group by m.module_group_id) t2
          on t2.module_group_id = t.module_group_id
       where t.event_id is not null
         and t.module_group_id in
             (select distinct module_group_id
                from patient_module
               where patient_id = pi_vPatientID)
       order by t.module_group_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetModuleGroupStatusRS(): ' ||
                           sqlErrm;
  end;

  -- ****************************************************
  -- CLOSE SELF MANAGEMENT ENCOUNTER

  procedure CloseSelfMgntEncounter(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID   in varchar2,
                                   pi_vEncounterID in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2) is
  
    v_nTreatmentID number := 1;
    v_nOpenSMEnc   number := 0;
    v_nPendingMods number := 1;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get count of pending modules
    select count(*)
      into v_nPendingMods
      from patient_module t
     where t.patient_id = pi_vPatientID
       and t.status = 0;
  
    if v_nPendingMods < 1 then
    
      update encounter t
         set t.closed = 1
       where t.patient_id = pi_vPatientID
         and t.encounter_id = pi_vEncounterID;
    
      commit;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.CloseSelfMgntEncounter(): ' ||
                           sqlErrm;
  end;

  -- *************************************************************
  -- GET ENCOUNTER INTAKE ID
  procedure GetEncIntakeIdRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vEncounterID in varchar2,
                             pi_nMID         in number,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select nvl(max(t.encounter_intake_id), 0) as encounter_intake_id
        from Encounter_Intake_Responses t
       where t.encounter_id = pi_vEncounterID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetEncIntakeIdRS(): ' || sqlErrm;
  end;

  -- *************************************************************
  -- Check if module is assigned to patient
  procedure IsModuleAssigned(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vPatientID in varchar2,
                             pi_nMID       in number,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor) is
  
    v_nAssigned number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    select count(*)
      into v_nAssigned
      from patient_module t
     where t.patient_id = pi_vPatientID
       and t.mid = pi_nMID
       and t.status = 0;
  
    if v_nAssigned > 1 then
      v_nAssigned := 1;
    end if;
  
    open rs for
      select v_nAssigned as is_assigned from dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.IsModuleAssigned(): ' || sqlErrm;
  end;

  -- *************************************************************
  -- Get patient details
  procedure GetPatientDetialsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                
                                pi_vEncounterID in varchar2,
                                
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2,
                                rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.patient_height, t.patient_weight
        from encounter t
       where t.encounter_id = pi_vEncounterID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.GetPatientDetialsRS(): ' ||
                           sqlErrm;
  end;

  -- Update patient details
  procedure UpdatePatientDetials(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vEncounterID in varchar2,
                                 pi_nWeight      in number,
                                 pi_nHeight      in number,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update encounter e
       set e.patient_height = pi_nHeight, e.patient_weight = pi_nWeight
     where e.encounter_id = pi_vEncounterID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_ENCOUNTER.UpdatePatientDetials(): ' ||
                           sqlErrm;
  end;

end PCK_ENCOUNTER;
/

prompt
prompt Creating package body PCK_ENCOUNTER_INTAKE
prompt ==========================================
prompt
create or replace package body PCK_ENCOUNTER_INTAKE is

  ------------------------------------------------------------------
  -- get all the flags for an encounter
  ------------------------------------------------------------------
  procedure GetEncounterFlags(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vEncounterID     in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out Pck_Utl_Common.refCursor) is
    v_lSQL long := '';
  begin
  
    -- default status to ok
    po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Success;
    po_vStatusComment := null;
  
    v_lSQL := 'select t.*, it.topic, it.alternate_language as topic_alt, it.topic_image ';
    v_lSQL := v_lSQL || 'from encounter_intake_flag t, intake_topic it ';
    v_lSQL := v_lSQL || 'where t.encounter_id = ''';
    v_lSQL := v_lSQL || pi_vEncounterID;
    v_lSQL := v_lSQL || ''' and t.mid = it.mid ';
    v_lSQL := v_lSQL || 'and t.tid = it.tid ';
    v_lSQL := v_lSQL || 'order by t.mid, t.tid, t.flag_id';
  
    open rs for v_lSQL;
  
  exception
    when others then
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_ENCOUNTER_INTAKE.GetEncounterFlags(): ' ||
                           sqlCode || ': ' || sqlErrm;
  end;

  ------------------------------------------------------------------
  -- get all the flags for an encounter intake
  ------------------------------------------------------------------
  procedure GetEncounterIntakeFlags(pi_vSessionID         in varchar2,
                                    pi_vSessionClientIP   in varchar2,
                                    pi_nUserID            in number,
                                    pi_vEncounterID       in varchar2,
                                    pi_vEncounterIntakeID in number,
                                    po_nStatusCode        out number,
                                    po_vStatusComment     out varchar2,
                                    rs                    out Pck_Utl_Common.refCursor) is
    v_lSQL long := '';
  begin
  
    -- default status to ok
    po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Success;
    po_vStatusComment := null;
  
    v_lSQL := 'select t.*, it.topic, it.alternate_language as topic_alt, it.topic_image ';
    v_lSQL := v_lSQL || 'from encounter_intake_flag t, intake_topic it ';
    v_lSQL := v_lSQL || 'where t.encounter_id = ''';
    v_lSQL := v_lSQL || pi_vEncounterID;
    v_lSQL := v_lSQL || 'and t.encounter_intake_id = ';
    v_lSQL := v_lSQL || pi_vEncounterIntakeID;
    v_lSQL := v_lSQL || ' and t.mid = it.mid ';
    v_lSQL := v_lSQL || 'and t.tid = it.tid ';
    v_lSQL := v_lSQL || 'order by t.mid, t.tid, t.flag_id';
  
    open rs for v_lSQL;
  
  exception
    when others then
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_ENCOUNTER_INTAKE.GetEncounterIntakeFlags(): ' ||
                           sqlCode || ': ' || sqlErrm;
  end;

  ------------------------------------------------------------------
  procedure getIntakePatientID(pi_vSessionID         in varchar2,
                               pi_vSessionClientIP   in varchar2,
                               pi_nUserID            in number,
                               pi_vEncounterID       in varchar2,
                               pi_nEncounterIntakeID in number,
                               po_vPatientID         out varchar2,
                               po_nStatusCode        out number,
                               po_vStatusComment     out varchar2) is
  
  begin
  
    po_vPatientID     := '';
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    --get the latest un-complete encounter for this module
    begin
    
      --get the patient id from the
      --portal user id passed in
      select t.patient_id
        into po_vPatientID
        from encounter t
       where t.encounter_id = pi_vEncounterID;
    
    exception
      when others then
        po_vPatientID := '';
    end;
  
  exception
    when others then
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'getIntakeAltLang(): ' || sqlCode || ': ' ||
                           sqlErrm;
  end;

  ------------------------------------------------------------------
  procedure getIntakeAltLang(pi_vSessionID         in varchar2,
                             pi_vSessionClientIP   in varchar2,
                             pi_nUserID            in number,
                             pi_vEncounterID       in varchar2,
                             pi_nEncounterIntakeID in number,
                             po_nOutAltLang        out number,
                             po_nStatusCode        out number,
                             po_vStatusComment     out varchar2) is
  
  begin
  
    po_nOutAltLang    := 0;
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    --get the latest un-complete encounter for this module
    begin
    
      --get the patient id from the
      --portal user id passed in
      select t.alternate_language
        into po_nOutAltLang
        from encounter_intake t
       where t.encounter_id = pi_vEncounterID
         and t.encounter_intake_id = pi_nEncounterIntakeID;
    
    exception
      when others then
        po_nOutAltLang := 0;
    end;
  
  exception
    when others then
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'getIntakeAltLang(): ' || sqlCode || ': ' ||
                           sqlErrm;
  end;

  -----------------------------------------------------------
  -- Tries to retrieve the encounter ID for the passed MID.
  -- If there is no encounter, it inserts a new encounter
  -- of type 7 (portal visit)
  -----------------------------------------------------------
  procedure GetEncounterIDFromModule(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_nModuleID        in number,
                                     pi_vPatientID       in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_vEncounterID     out varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2) is
    v_nSeq number;
    v_nCnt number;
    null_data EXCEPTION;
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get the encounter id for the latest
    --encounter intake matching the
    --mid passed in and that is not completed
    --this is so we can continue an assessment
    select max(t.encounter_id)
      into po_vEncounterID
      from encounter_intake t, encounter e
     where t.encounter_id = e.encounter_id
       and e.patient_id = pi_vPatientID
       and t.mid = pi_nModuleID
       and nvl(complete, 0) < 1;
  
    --raise an exception
    if po_vEncounterID is null then
      RAISE null_data;
    end if;
  
    --if any of the above fail then we need to create a new:
    --   1. encounter (encounter type 99 = portal)
    --   2. encounter intake
    --get latest treatment id 
  exception
    when others then
      begin
        --encounter id if none, insert new encounter
      
        --get latest open encounter id, if not signed
        --then use it to create the encounter intake
        --just get the encounter for today if it exists
        select max(e.encounter_id)
          into po_vEncounterID
          from encounter e
         where e.patient_id = pi_vPatientID
           and e.provider_signature_id is null;
      
      exception
        when others then
          po_vEncounterID := null;
      end; --encounter id if none, insert new encounter
    
      if (po_vEncounterID is null) then
        begin
        
          --does not have an open encounter for today
          --so create a new one based on the patient_id and
          --a sequence
          select SEQ_ENCOUNTERID.nextval into v_nSeq from dual;
        
          --new encounter id
          po_vEncounterID := mid(pi_vPatientID,
                                 0,
                                 length(pi_vPatientID) -
                                 length(to_char(v_nSeq))) ||
                             to_char(v_nSeq);
        
          --insert a new encounter
          insert into encounter
            (encounter_id,
             encounter_date,
             treatment_id,
             patient_id,
             encounter_type_id)
          values
            (po_vEncounterID, sysdate, pi_nTreatmentID, pi_vPatientID, 99);
        
          commit;
        
        exception
          when others then
            po_nStatusCode    := 1;
            po_vStatusComment := 'PCK_ENCOUNTER_INTAKE.GetEncounterIDFromForModule(): ' ||
                                 sqlErrm;
        end;
      end if; --if (v_strEncounterID is null) then
  end;

  ------------------------------------------------------------------
  -- get the the encounter_intake_id.  It checks for the existance
  -- of a record by checking the COMPLETE field.  If null, then
  -- there is no record.  In this case it inserts a new record. if
  -- complete exist and 0 then it returns the current id. 
  --
  -- NOTE:
  -- It should never be called for a completed module 
  ------------------------------------------------------------------
  procedure NewEncounterIntake(pi_vSessionID         in varchar2,
                               pi_vSessionClientIP   in varchar2,
                               pi_nUserID            in number,
                               pi_nModuleID          in number,
                               pi_vEncounterID       in varchar2,
                               pi_nAltLang           in number,
                               po_nEncounterIntakeID out number,
                               po_nStatusCode        out number,
                               po_vStatusComment     out varchar2) is
    v_nIncompleteCount number := 0;
    v_nIntakeCount     number := 0;
    v_nEiid            number := 0;
  
    v_vIncompleteCountSql constant varchar(32767) := 'select count(t.encounter_intake_id)
          from encounter_intake t
          where t.encounter_id = :EncounterId
          and t.mid = :Mid
          and t.complete = 0';
  
    v_vIntakeCountSql constant varchar(32767) := 'select count(t.encounter_intake_id)
          from encounter_intake t
          where t.encounter_id = :EncounterId';
  
    v_vMaxIdSql constant varchar(32767) := 'select max(t.encounter_intake_id)
         from encounter_intake t
         where t.encounter_id = :EncounterId';
  
    v_vInsertSql constant varchar(32767) := 'insert into encounter_intake t
          (t.encounter_id,
          t.encounter_intake_id,
          t.mid,
          t.intake_type,
          t.score,
          t.read_only,
          t.complete,
          t.alternate_language,
          t.review_encounter_id)
          values
          (:EncounterId,
          :EncounterIntakeId,
          :Mid,
          :IntakeType,
          :Score,
          :ReadOnly,
          :Complete,
          :AlternateLanguage,
          :ReviewEncounterId)';
  
    v_vIncompleteIdSql constant varchar(32767) := 'select t.encounter_intake_id
          from encounter_intake t
          where t.encounter_id = :EncounterId
          and t.mid = :Mid
          and t.complete = 0';
  begin
  
    execute immediate v_vIncompleteCountSql
      into v_nIncompleteCount
      using pi_vEncounterID, pi_nModuleID;
  
    if v_nIncompleteCount = 0 then
    
      execute immediate v_vIntakeCountSql
        into v_nIntakeCount
        using pi_vEncounterID;
    
      if v_nIntakeCount = 0 then
      
        v_nEiid := 1;
      
      else
      
        execute immediate v_vMaxIdSql
          into v_nEiid
          using pi_vEncounterID;
      
        v_nEiid := v_nEiid + 1;
      
      end if;
    
      execute immediate v_vInsertSql
        using pi_vEncounterID, v_nEiid, pi_nModuleID, 1, 0, 0, 0, pi_nAltLang, '';
    
      po_nEncounterIntakeID := v_nEiid;
    
    else
    
      execute immediate v_vIncompleteIdSql
        into po_nEncounterIntakeID
        using pi_vEncounterID, pi_nModuleID;
    
    end if;
  
  exception
    when others then
      po_nEncounterIntakeID := -1;
      po_nStatusCode        := 1;
      po_vStatusComment     := 'PCK_ENCOUNTER_INTAKE.NewEncounterIntakeRS(): ' ||
                               sqlErrm;
  end;

  ------------------------------------------------------------------
  --get a piece
  ------------------------------------------------------------------
  function GetPiece(strData      in varchar2,
                    strDelimiter in varchar2,
                    nPosition    in NUMBER) return varchar2 is
    strWorking varchar2(4000);
    strPiece   varchar2(400);
    pos        number;
    nPos2      number;
    nCount     number;
  begin
  
    --the piece to return
    strPiece := '';
  
    --set working to data
    strWorking := strData;
  
    --put a delimeter on the front for parsing if needed
    if substr(strWorking, 1, 1) != strDelimiter then
      strWorking := strDelimiter || strWorking;
    end if;
  
    --find the piece between the ~'s ie... "~piece~"
    pos    := -1;
    nCount := -1;
    while (pos != 0) loop
      pos := instr(strWorking, strDelimiter);
      if pos != 0 then
        --increment count
        nCount := nCount + 1;
        --found the piece...
        if nCount = nPosition then
          if (pos + 1 > length(strWorking) - 1) then
            --nothing
            strPiece := '';
          else
            strWorking := substr(strWorking, pos + 1);
            nPos2      := instr(strWorking, strDelimiter);
            if nPos2 = 0 then
              --last piece
              strPiece := strWorking;
              return ltrim(rtrim(strPiece));
            else
              strPiece := substr(strWorking, 0, nPos2 - 1);
              return ltrim(rtrim(strPiece));
            end if;
          end if;
        else
          strWorking := substr(strWorking, pos + 1);
        end if;
      end if;
    end loop;
  
    return ltrim(rtrim(strPiece));
  
  exception
    when others then
      return '';
  end GetPiece;

  ------------------------------------------------------------------
  --get all Encounter Intake Responses
  ------------------------------------------------------------------
  procedure GetResponsesCountRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vEncounterID     in varchar2,
                                pi_vMIDs            in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select count(*) as count_resp, t.mid
        from encounter_intake_responses t
       where t.encounter_id = pi_vEncounterID
         and instr(',' || pi_vMIDs || ',', ',' || t.mid || ',') > 0
       group by t.mid
       order by t.mid;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetResponsesCountRS(): ' || sqlErrm;
  end;

  ------------------------------------------------------------------
  -- This SP will return a recordset with the data fields necessary
  -- to fill the education encounter list
  ------------------------------------------------------------------
  procedure GetIntakesForEducationRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select m.mid, m.module as mid, e.encounter_date as edate
        from intake_module m, encounter e, encounter_intake ei
       where e.patient_id = pi_vPatientID
         and ei.encounter_id = e.encounter_id
         and m.mid = ei.mid
       order by e.encounter_date;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetIntakesForEducationRS(): ' ||
                           sqlErrm;
  end;

  procedure GetIntakesForReviewRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  pi_vEncounterID      in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
    v_vPatientID  varchar2(50);
    v_nModalityID number;
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_vPatientID  := pi_vPatientID;
    
    --get modality id from encounter
    begin
        select e.encounter_type_id
          into v_nModalityID
          from encounter e
         where e.encounter_id = pi_vEncounterID
           and e.patient_id = v_vPatientID;
    exception
      when others then
        v_nModalityID := -1;
    end;
  
    open rs for
      select *
        from (select img.module_group_descr, m.module, p.*, imgm.sort_order
                from patient_module          p,
                     intake_module           m,
                     intake_module_group     img,
                     intake_module_group_mid imgm
               where m.mid = p.mid
                 and img.module_group_id = p.module_group_id
                 and imgm.module_group_id = p.module_group_id
                 and imgm.mid = p.mid
                 and p.patient_id = v_vPatientID
                    --and p.status = 1
                 and p.module_group_id in
                     (select g.module_group_id
                        from intake_module_group g
                       where g.stat_modality_id = v_nModalityID)) t1
        left join (select e.patient_id, i.*
                     from encounter e, encounter_intake i
                    where e.encounter_id = i.encounter_id
                      and i.intake_group_id in
                          (select g.module_group_id
                             from intake_module_group g
                            where g.stat_modality_id = v_nModalityID)
                      and e.patient_id = v_vPatientID) t2
          on t2.patient_id = t1.patient_id
         and t2.mid = t1.mid
         and t2.intake_group_id = t1.module_group_id
       order by t1.MODULE_GROUP_ID,
                t1.sort_order,
                t1.status desc,
                t1.date_completed;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetIntakesForReviewRS(): ' ||
                           sqlErrm;
  end;

end PCK_ENCOUNTER_INTAKE;
/

prompt
prompt Creating package body PCK_FX_SEC
prompt ================================
prompt
create or replace package body PCK_FX_SEC is
  
    
  --converted to use new encryption
  --validate the password against rules
  procedure ValidatePassword(pi_vKey in varchar2,
                             pi_nUserID        in number,
                             pi_vUserName      in varchar2,
                             pi_vOldPassword   in varchar2,
                             pi_vPassword      in varchar2,
                             pi_vCOldPassword  in varchar2,
                             pi_vCPassword     in varchar2,
                             pi_vCUserName     in varchar2,
                             pi_nResetPassword in number,
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2) is
  
    v_nFXUserID            number := 0;
    v_nUserCount           number := 0;
    v_dDatePasswordChanged date;
    v_vPREV_PWD1           varchar2(2000);
    v_vPREV_PWD2           varchar2(2000);
    v_vPREV_PWD3           varchar2(2000);
    v_vPREV_PWD4           varchar2(2000);
    v_vPREV_PWD5           varchar2(2000);
    v_vPREV_PWD6           varchar2(2000);
    v_vPREV_PWD7           varchar2(2000);
    v_vPREV_PWD8           varchar2(2000);
    v_vPREV_PWD9           varchar2(2000);
    v_vPREV_PWD10          varchar2(2000);
  
    --suat user personal information
    v_vUsrPDataName  varchar2(2000);
    v_vUsrPDataName1 varchar2(2000);
    v_vUsrPDataName2 varchar2(2000);
  
    v_vUsrPDataTitle    varchar2(2000);
    v_vUsrPDataUnit     varchar2(2000);
    v_vUsrPDataSquadron varchar2(2000);
    v_vUsrPDataPhone    varchar2(2000);
  
    --patient personal information
    v_vPatPDataFirstName  varchar2(2000);
    v_vPatPDataLastName   varchar2(2000);
    v_vPatPDataSSN        varchar2(2000);
    v_vPatPDataCity       varchar2(2000);
    v_vPatPDataPostalCode varchar2(2000);
    v_vPatPDataHomePhone  varchar2(2000);
    v_vPatPDataWorkPhone  varchar2(2000);
    v_dtPatPDataDOB       date;
    v_vPatPDataEDIPN      varchar2(2000);
    v_vPWDCheck           varchar2(4000);
  
    v_vCUserName1 varchar2(2000);
    v_vCUsername2 varchar2(2000);
    v_vUNCheck    varchar2(2000);
    v_nResetPWD   number;
  
    v_nPWDDiffCharacterCount number := 0;
    v_nPWDGreatest           number := 0;
    v_nPWDLeast              number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get data needed for the check
    select date_password_changed,
           PREV_PWD1,
           PREV_PWD2,
           PREV_PWD3,
           PREV_PWD4,
           PREV_PWD5,
           PREV_PWD6,
           PREV_PWD7,
           PREV_PWD8,
           PREV_PWD9,
           PREV_PWD10,
           nvl(t.reset_password, 0)
      into v_dDatePasswordChanged,
           v_vPREV_PWD1,
           v_vPREV_PWD2,
           v_vPREV_PWD3,
           v_vPREV_PWD4,
           v_vPREV_PWD5,
           v_vPREV_PWD6,
           v_vPREV_PWD7,
           v_vPREV_PWD8,
           v_vPREV_PWD9,
           v_vPREV_PWD10,
           v_nResetPWD
      from fx_user t
     where t.fx_user_id = pi_nUserID;
  
    --limit user changes to their account passwords 
    --once every 24 hours with the exception of privileged 
    --or administrative users. or in the case where the 
    --pwd was reset this keeps the user from spinning through pwds to get to
    --an old pwd for convenience
    if nvl(pi_nResetPassword, 0) < 1 then
      if (v_dDatePasswordChanged is not null) and
         (sysdate - 1 < v_dDatePasswordChanged) and
         not HASUSERRIGHT(v_nFXUserID, PCK_COMMON.c_nAdministratorUR) then
        po_nStatusCode    := 1;
        po_vStatusComment := 'Password cannot be changed in less than 24 hours since last change!';
        return;
      end if;
    end if;
  
    --make sure the password is not the same as the 10 past passwords
    if pi_nUserID > 0 then
    
      if pi_vPassword = v_vPREV_PWD1 or pi_vPassword = v_vPREV_PWD2 or
         pi_vPassword = v_vPREV_PWD3 or pi_vPassword = v_vPREV_PWD4 or
         pi_vPassword = v_vPREV_PWD5 or pi_vPassword = v_vPREV_PWD6 or
         pi_vPassword = v_vPREV_PWD7 or pi_vPassword = v_vPREV_PWD8 or
         pi_vPassword = v_vPREV_PWD9 or pi_vPassword = v_vPREV_PWD10 or
         pi_vPassword = pi_vOldPassword then
      
        po_nStatusCode    := 1;
        po_vStatusComment := 'New password cannot be the same as recent past password. Please choose a different password!';
        return;
      end if;
    
    end if;
  
    --ensure passwords do not contain personal information such as names, telephone numbers, account names, birthdates, or dictionary words. 
    for rec in (select t.restricted_name from fx_restricted_name t) loop
      if (instr(upper(pi_vCPassword), upper(rec.restricted_name)) > 0) then
        po_nStatusCode    := 1;
        po_vStatusComment := 'Password cannot contain personal information such as names, telephone numbers, account names, birthdates, or dictionary words!';
        return;
      end if;
    end loop;
  
    --new account passwords differ from the previous password by at least four characters when a password is changed. 
    select greatest(length(pi_vCOldPassword), length(pi_vCPassword)),
           least(length(pi_vCOldPassword), length(pi_vCPassword))
      into v_nPWDGreatest, v_nPWDLeast
      from dual;
    v_nPWDDiffCharacterCount := v_nPWDGreatest - v_nPWDLeast;
    if v_nPWDDiffCharacterCount < 4 then
      for i in 1 .. v_nPWDLeast loop
        if (substr(pi_vCOldPassword, i, 1) <> substr(pi_vCPassword, i, 1)) then
          v_nPWDDiffCharacterCount := v_nPWDDiffCharacterCount + 1;
        end if;
        -- exit stop_loop when v_nPWDDiffCharacterCount > 3;
      end loop; -- stop_loop;
      if v_nPWDDiffCharacterCount < 4 then
        po_nStatusCode    := 1;
        po_vStatusComment := 'Passwords must be different from the previous password by at least four characters!';
        return;
      end if;
    end if;
    /*for i in 1..(length(pi_vCPassword) - 4)
    loop
       if (instr(pi_vCOldPassword, substr(pi_vCPassword, i, 4)) > 0)
       then
          po_nStatusCode := 1;
          po_vStatusComment := 'Passwords must be different from the previous password by at least four characters!';
          return;
       end if;
    end loop;*/
  
    v_vPWDCheck   := upper(pi_vCPassword);
    v_vUNCheck    := upper(pi_vCUserName);
    v_vCUserName1 := pck_common.GetPiece(v_vUNCheck, '.', 0);
    v_vCUserName2 := pck_common.GetPiece(v_vUNCheck, '.', 1);
    if instr(v_vPWDCheck, pi_vCUserName) > 0 or
       instr(v_vPWDCheck, v_vCUserName1) > 0 or
       instr(v_vPWDCheck, v_vCUserName2) > 0 then
    
      po_nStatusCode    := 1;
      po_vStatusComment := 'Password cannot contain elements of your user name!';
      return;
    end if;
  
    --make sure the password does not contain personal information
    --suat user personal information
    begin
      select name, Title, Unit, Squadron, Phone
        into v_vUsrPDataName,
             v_vUsrPDataTitle,
             v_vUsrPDataUnit,
             v_vUsrPDataSquadron,
             v_vUsrPDataPhone
        from suat_user
       where fx_user_id = v_nFXUserID;
    
      v_vUsrPDataName     := upper(v_vUsrPDataName);
      v_vUsrPDataTitle    := upper(v_vUsrPDataTitle);
      v_vUsrPDataUnit     := upper(v_vUsrPDataUnit);
      v_vUsrPDataSquadron := upper(v_vUsrPDataSquadron);
      v_vUsrPDataPhone    := upper(v_vUsrPDataPhone);
    
      v_vUsrPDataName1 := pck_common.GetPiece(v_vUsrPDataName, ' ', 0);
      v_vUsrPDataName2 := pck_common.GetPiece(v_vUsrPDataName, ' ', 1);
    
      if instr(v_vPWDCheck, v_vUsrPDataName) > 0 or
         instr(v_vPWDCheck, v_vUsrPDataName1) > 0 or
         instr(v_vPWDCheck, v_vUsrPDataName2) > 0 or
         instr(v_vPWDCheck, v_vUsrPDataTitle) > 0 or
         instr(v_vPWDCheck, v_vUsrPDataUnit) > 0 or
         instr(v_vPWDCheck, v_vUsrPDataSquadron) > 0 or
         instr(v_vPWDCheck, v_vUsrPDataPhone) > 0 or
         instr(v_vPWDCheck, replace(v_vUsrPDataPhone, '-', '')) > 0 then
      
        po_nStatusCode    := 1;
        po_vStatusComment := 'Password cannot contain personal information such as names, telephone numbers, account names, birthdates, or dictionary words!';
        return;
      
      end if;
    
    exception
      when others then
        null;
    end;
  
    --patient personal information
    begin
    
      select fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
             fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
             fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
             t.City,
             t.Postal_Code,
             t.HomePhone,
             t.WorkPhone,
             to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY') as dob,
             t.EDIPN
        into v_vPatPDataFirstName,
             v_vPatPDataLastName,
             v_vPatPDataSSN,
             v_vPatPDataCity,
             v_vPatPDataPostalCode,
             v_vPatPDataHomePhone,
             v_vPatPDataWorkPhone,
             v_dtPatPDataDOB,
             v_vPatPDataEDIPN
        from patient_demographics t
       where t.fx_user_id = v_nFXUserID;
    
      if instr(v_vPWDCheck, v_vPatPDataFirstName) > 0 or
         instr(v_vPWDCheck, v_vPatPDataLastName) > 0 or
         instr(v_vPWDCheck, v_vPatPDataSSN) > 0 or
         instr(v_vPWDCheck, replace(v_vPatPDataSSN, '-', '')) > 0 or
        
         instr(v_vPWDCheck, v_vPatPDataCity) > 0 or
         instr(v_vPWDCheck, v_vPatPDataPostalCode) > 0 or
         instr(v_vPWDCheck, v_vPatPDataHomePhone) > 0 or
         instr(v_vPWDCheck, replace(v_vPatPDataHomePhone, '-', '')) > 0 or
        
         instr(v_vPWDCheck, v_vPatPDataWorkPhone) > 0 or
         instr(pi_vCPassword, to_char(v_dtPatPDataDOB, 'mmddyyyy')) > 0 or
         instr(pi_vCPassword, to_char(v_dtPatPDataDOB, 'ddmmyyyy')) > 0 or
         instr(pi_vCPassword, to_char(v_dtPatPDataDOB, 'mmddyy')) > 0 or
         instr(pi_vCPassword, to_char(v_dtPatPDataDOB, 'ddmmyy')) > 0 or
         instr(v_vPWDCheck, v_vPatPDataEDIPN) > 0 then
      
        po_nStatusCode    := 1;
        po_vStatusComment := 'Password cannot contain personal information such as names, telephone numbers, account names, birthdates, or dictionary words!';
        return;
      
      end if;
    exception
      when others then
        null;
    end;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '5. Invalid User Name/Password';
      return;
  end;

  -----------------------------------------------------------------------
  --delete all session values
  -----------------------------------------------------------------------
  procedure DeleteAllSessionValues(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2) is
    v_nCount number;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount := 0;
  
    delete from fx_session where db_session_id = pi_vSessionID;
    commit;
    delete from fx_session_value where db_session_id = pi_vSessionID;
    commit;
    delete from patient_lock where session_id = pi_vSessionID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '158 - An error occurred while removing session values, Please contact your system administrator.';
  end;

  --delete 1 session value
  procedure DeleteSessionValue(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vKey             in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2) is
    v_nCount number;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount := 0;
  
    --check that there is a session matching this session id and client ip
    select count(*)
      into v_nCount
      from fx_session
     where db_session_id = pi_vSessionID
       and client_ip = pi_vSessionClientIP;
  
    --scrap it all, someone has a mismatched ip/sessid combo
    --this will affewctivly log the user out
    if v_nCount < 1 then
    
      delete from fx_session where db_session_id = pi_vSessionID;
      commit;
      delete from fx_session_value where db_session_id = pi_vSessionID;
      commit;
    
      po_nStatusCode    := 1;
      po_vStatusComment := 'GetSessionValue: failed!';
      return;
    
    end if;
  
    delete from fx_session_value
     where db_session_id = pi_vSessionID
       and client_ip = pi_vSessionClientIP
       and upper(db_session_key) = upper(pi_vKey);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '159 - An error occurred while removing a session value, Please contact your system administrator.';
  end;

  --get a session value
  procedure GetSessionValue(pi_vDBSessionID     in varchar2,
                            pi_vWebSessionID    in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vKey             in varchar2,
                            po_vKeyValue        out varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2) is
    v_nCount number;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    po_vKeyValue      := '';
  
    v_nCount := 0;
  
    --check that there is a session matching this session id and client ip
    select count(*)
      into v_nCount
      from fx_session
     where db_session_id = pi_vDBSessionID
       and web_session_id = pi_vWebSessionID
       and client_ip = pi_vSessionClientIP;
  
    --scrap it all, someone has a mismatched ip/sessid combo
    --this will happen if the user times out for example
    --this will affewctivly log the user out
    if v_nCount < 1 then
    
      delete from fx_session where db_session_id = pi_vDBSessionID;
      commit;
    
      delete from fx_session_value where db_session_id = pi_vDBSessionID;
      commit;
    
      po_nStatusCode    := 1;
      po_vStatusComment := 'GetSessionValue failed, user may have timed out!';
      return;
    
    end if;
  
    select nvl(db_session_value, '')
      into po_vKeyValue
      from fx_session_value
     where db_session_id = pi_vDBSessionID
       and client_ip = pi_vSessionClientIP
       and upper(db_session_key) = upper(pi_vKey);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '160 - An error occurred while retrieving a session value, Please contact your system administrator.';
  end;

  --set a session value
  procedure SetSessionValue(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vKey             in varchar2,
                            pi_vKeyValue        in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2) is
    v_nCount number;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount := 0;
  
    --clear any old values
    delete from fx_session_value
     where db_session_id = pi_vSessionID
       and db_session_key = pi_vKey;
    commit;
  
    --check that there is a session matching this session iod and client ip
    select count(*)
      into v_nCount
      from fx_session
     where db_session_id = pi_vSessionID
       and client_ip = pi_vSessionClientIP;
  
    --scrap it all, someone has a mismatched ip/sessid combo
    --this will affewctivly log the user out
    if v_nCount < 1 then
    
      delete from fx_session where db_session_id = pi_vSessionID;
      commit;
      delete from fx_session_value where db_session_id = pi_vSessionID;
      commit;
    
      po_nStatusCode    := 1;
      po_vStatusComment := 'SetSessionValue: failed!';
      return;
    
    end if;
  
    --insert a record into fx_session_value
    insert into fx_session_value
      (db_session_id, db_session_key, db_session_value, client_ip)
    values
      (pi_vSessionID, pi_vKey, pi_vKeyValue, pi_vSessionClientIP);
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '161 - An error occurred while setting a session value , Please contact your system administrator.';
  end;

  --cac cert login
  procedure CertLogin(pi_vSessionID       in varchar2,
                      pi_vSessionClientIP in varchar2,
                      pi_nUserID          in number, --not used but passed in to maintain consistant default param list
                      pi_vCert            in varchar2,
                      po_nUserID          out number,
                      po_vDBSessionID     out varchar2,
                      po_nTimeout         out number,
                      po_nStatusCode      out number,
                      po_vStatusComment   out varchar2) is
    v_nFXUserID    number;
    v_vDBSessionID varchar2(4000);
    v_vEU          varchar2(4000);
    v_vEP          varchar2(4000);
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    po_nUserID     := 0;
    v_vDBSessionID := '';
  
    v_nFXUserID    := 0;
    v_vDBSessionID := '';
  
    --login
    begin
      select nvl(t.fx_user_id, 0), t.user_name, t.password
        into v_nFXUserID, v_vEU, v_vEP
        from fx_user t
       where certificate = pi_vCert;
    exception
      when others then
        v_nFXUserID := 0;
    end;
  
    if v_nFXUserID > 0 then
    
      --now login with this cac account
      Login(pi_vSessionID,
            pi_vSessionClientIP,
            pi_nUserID,
            v_vEU,
            v_vEP,
            pi_vCert,
            po_nUserID,
            po_vDBSessionID,
            po_nTimeout,
            po_nStatusCode,
            po_vStatusComment);
    
      return;
    else
    
      po_nUserID        := 0;
      po_nStatusCode    := 1;
      po_vStatusComment := 'Your CAC is not associated with an account!';
    
      --add an audit record
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (v_vDBSessionID,
         pi_vSessionClientIP,
         -1,
         sysdate,
         'CACLOGIN',
         'FAIL=' || pi_vCert || po_vStatusComment);
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '162 - An error occurred while logging in with CAC, Please contact your system administrator.';
    
      --add an audit record
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (v_vDBSessionID,
         pi_vSessionClientIP,
         -1,
         sysdate,
         'LOGIN',
         'FAIL=' || pi_vCert);
  end;
 
  --change password, this will also logg the user in
  procedure ChangePassword(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number, --not used but passed in to maintain consistant default param list
                           pi_vKey in varchar2,
                           pi_vUserName        in varchar2,
                           pi_vOldPassword     in varchar2,
                           pi_vPassword        in varchar2,
                           pi_vCert            in varchar2,
                           pi_vCOldPassword    in varchar2,
                           pi_vCPassword       in varchar2,
                           pi_vCUserName       in varchar2,
                           po_nUserID          out number,
                           po_vDBSessionID     out varchar2,
                           po_nTimeout         out number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
    v_nFXUserID            number := 0;
    v_nUserCount           number := 0;
    v_dDatePasswordChanged date;
    v_vPREV_PWD1           varchar2(2000);
    v_vPREV_PWD2           varchar2(2000);
    v_vPREV_PWD3           varchar2(2000);
    v_vPREV_PWD4           varchar2(2000);
    v_vPREV_PWD5           varchar2(2000);
    v_vPREV_PWD6           varchar2(2000);
    v_vPREV_PWD7           varchar2(2000);
    v_vPREV_PWD8           varchar2(2000);
    v_vPREV_PWD9           varchar2(2000);
    v_vPREV_PWD10          varchar2(2000);
  
    --suat user personal information
    v_vUsrPDataName  varchar2(2000);
    v_vUsrPDataName1 varchar2(2000);
    v_vUsrPDataName2 varchar2(2000);
  
    v_vUsrPDataTitle    varchar2(2000);
    v_vUsrPDataUnit     varchar2(2000);
    v_vUsrPDataSquadron varchar2(2000);
    v_vUsrPDataPhone    varchar2(2000);
  
    --patient personal information
    v_vPatPDataFirstName  varchar2(2000);
    v_vPatPDataLastName   varchar2(2000);
    v_vPatPDataSSN        varchar2(2000);
    v_vPatPDataCity       varchar2(2000);
    v_vPatPDataPostalCode varchar2(2000);
    v_vPatPDataHomePhone  varchar2(2000);
    v_vPatPDataWorkPhone  varchar2(2000);
    v_dtPatPDataDOB       date;
    v_vPatPDataEDIPN      varchar2(2000);
    v_vPWDCheck           varchar2(4000);
  
    v_vCUserName1    varchar2(2000);
    v_vCUsername2    varchar2(2000);
    v_vUNCheck       varchar2(2000);
    v_nResetPassword number;
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    po_nUserID        := 0;
    v_nFXUserID       := 0;
    v_vPWDCheck       := '';
    v_nResetPassword  := 0;
  
    -- make sure the user only updates his password
    begin
      select count(t.fx_user_id)
        into v_nUserCount
        from fx_user t
       where t.fx_user_id = pi_nUserID
         and t.user_name = pi_vUserName;
    exception
      when others then
        po_nStatusCode    := 1;
        po_vStatusComment := '1. Invalid User Name/Password';
        return;
    end;
  
    -- if no records were found the user was trying to update someone else
    if v_nUserCount = 0 and pi_nUserID > 0 then
      po_nStatusCode    := 1;
      po_vStatusComment := 'You may only change your password.';
      return;
    end if;
  
    --check for vaild current password
    begin
      select nvl(t.fx_user_id, 0),
             date_password_changed,
             PREV_PWD1,
             PREV_PWD2,
             PREV_PWD3,
             PREV_PWD4,
             PREV_PWD5,
             PREV_PWD6,
             PREV_PWD7,
             PREV_PWD8,
             PREV_PWD9,
             PREV_PWD10,
             nvl(RESET_PASSWORD, 0)
        into v_nFXUserID,
             v_dDatePasswordChanged,
             v_vPREV_PWD1,
             v_vPREV_PWD2,
             v_vPREV_PWD3,
             v_vPREV_PWD4,
             v_vPREV_PWD5,
             v_vPREV_PWD6,
             v_vPREV_PWD7,
             v_vPREV_PWD8,
             v_vPREV_PWD9,
             v_vPREV_PWD10,
             v_nResetPassword
        from fx_user t
       where upper(t.user_name) = upper(pi_vUserName)
         and t.password = pi_vOldPassword;
    
    exception
      when others then
        po_nStatusCode    := 1;
        po_vStatusComment := '2. Invalid User Name/Password';
        return;
    end;
  
    if v_nFXUserID < 1 then
      po_nStatusCode    := 1;
      po_vStatusComment := '3. Invalid User Name/Password';
      return;
    end if;
  
    --validate the password against rules
  
    ValidatePassword(pi_vKey,
                     v_nFXUserID,
                     pi_vUserName,
                     pi_vOldPassword,
                     pi_vPassword,
                     pi_vCOldPassword,
                     pi_vCPassword,
                     pi_vCUserName,
                     v_nResetPassword,
                     po_nStatusCode,
                     po_vStatusComment);
    if po_nStatusCode != 0 then
      return;
    end if;
  
    --save the current password as a past password
    update fx_user
       set prev_pwd1  = pi_vOldPassword,
           prev_pwd2  = v_vPREV_PWD1,
           prev_pwd3  = v_vPREV_PWD2,
           prev_pwd4  = v_vPREV_PWD3,
           prev_pwd5  = v_vPREV_PWD4,
           prev_pwd6  = v_vPREV_PWD5,
           prev_pwd7  = v_vPREV_PWD6,
           prev_pwd8  = v_vPREV_PWD7,
           prev_pwd9  = v_vPREV_PWD8,
           prev_pwd10 = v_vPREV_PWD9
     where lower(user_name) = lower(pi_vUserName)
       and password = pi_vOldPassword;
    commit;
  
    --update the users password to the new one
    update fx_user
       set password              = pi_vPassword,
           is_locked             = 0,
           is_inactive           = 0,
           date_modified         = sysdate,
           updated_by            = pi_nUserID,
           reset_password        = 0,
           date_password_changed = sysdate,
           login_attempts        = 0
     where lower(user_name) = lower(pi_vUserName)
       and password = pi_vOldPassword;
    commit;
  
    --now login with this new password
    Login(pi_vSessionID,
          pi_vSessionClientIP,
          pi_nUserID,
          pi_vUserName,
          pi_vPassword,
          pi_vCert,
          po_nUserID,
          po_vDBSessionID,
          po_nTimeout,
          po_nStatusCode,
          po_vStatusComment);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '163 - An error occurred while changing password, Please contact your system administrator.';
  end;

  --used for signing notes etc...
  procedure Sign(pi_vSessionID       in varchar2,
                 pi_vSessionClientIP in varchar2,
                 pi_nUserID          in number,
                 pi_vUserName        in varchar2,
                 pi_vPassword        in varchar2,
                 po_vProviderID      out varchar2,
                 po_nUserType        out number,
                 po_nStatusCode      out number,
                 po_vStatusComment   out varchar2)
  
   is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    po_vProviderID    := '';
  
    select u.provider_id, r.user_type
      into po_vProviderID, po_nUserType
      from fx_user t, suat_user u, fx_user_rights r
     where t.fx_user_id = u.fx_user_id
       and r.fx_user_id = u.fx_user_id
       and t.user_name = pi_vUserName
       and t.password = pi_vPassword;
  
    if po_vProviderID = '' then
    
      --add an audit record
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (pi_vSessionID,
         pi_vSessionClientIP,
         pi_nUserID,
         sysdate,
         'SIGN',
         'FAIL=' || pi_vUserName);
    end if;
  
  exception
    when others then
      po_nStatusCode := 9;
      --po_vStatusComment := '164 - An error occurred while signing, Please contact your system administrator.';
    
      po_vStatusComment := 'Invalid user name/password';
    
      --add an audit record
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (pi_vSessionID,
         pi_vSessionClientIP,
         pi_nUserID,
         sysdate,
         'SIGN',
         'FAIL=' || pi_vUserName);
    
  end;

  --login this is the version that requires a username and password
  --after a successful login the persons CAC will be associated with
  --this account...
  procedure Login(pi_vSessionID       in varchar2,
                  pi_vSessionClientIP in varchar2,
                  pi_nUserID          in number, --not used but passed in to maintain consistant default param list
                  pi_vUserName        in varchar2,
                  pi_vPassword        in varchar2,
                  pi_vCert            in varchar2,
                  po_nUserID          out number,
                  po_vDBSessionID     out varchar2,
                  po_nTimeout         out number,
                  po_nStatusCode      out number,
                  po_vStatusComment   out varchar2) is
    v_nFXUserID        number;
    v_nFXUserChangePWD number;
    v_nFXUserInactive  number;
    v_nFXUserLocked    number;
  
    v_vDBSessionID    varchar2(4000);
    v_nCurrAttempts   number;
    v_nCount          number;
    v_nCurrIPAttempts number;
    v_nIPIsLocked     number;
    v_dtIPlocked      date;
    v_nIPLockPeriod   number;
    v_dtIPCheck       date;
    v_dtExpires       date;
    v_dtLastLogin     date;
  
    v_nMAX_ACCOUT_LOGIN_ATTEMPTS number;
    v_nMAX_IP_LOGIN_ATTEMPTS     number;
    v_nMAX_IP_LOGIN_TIMEOUT      number;
    v_nStatusCode                number;
    v_vStatus                    varchar2(4000);
    v_vContent                   varchar2(4000);
    v_vAccountCert               varchar2(4000);
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    po_nUserID     := 0;
    v_vDBSessionID := '';
  
    v_nFXUserID        := 0;
    v_nFXUserChangePWD := 0;
    v_nFXUserInactive  := 0;
    v_nFXUserLocked    := 0;
  
    v_vDBSessionID    := '';
    v_nCurrAttempts   := 0;
    v_nCount          := 0;
    v_nCurrIPAttempts := 0;
    v_nIPIsLocked     := 0;
    v_nIPLockPeriod   := 0;
    v_dtIPCheck       := sysdate;
    v_vAccountCert    := '';
  
    --
    v_nMAX_ACCOUT_LOGIN_ATTEMPTS := 3;
    v_nMAX_IP_LOGIN_ATTEMPTS     := 10;
    v_nMAX_IP_LOGIN_TIMEOUT      := 20;
  
    --
    --check to see if we are IP locked
    --
    begin
    
      --is the ip locked
      select nvl(t.is_locked, 0)
        into v_nIPIsLocked
        from fx_iplogin_attempts t
       where t.client_ip = pi_vSessionClientIP;
    
      --time period in mins to lock
      select nvl(t.lock_period, v_nMAX_IP_LOGIN_TIMEOUT)
        into v_nIPLockPeriod
        from fx_iplogin_attempts t
       where t.client_ip = pi_vSessionClientIP;
    
      --date locked
      select nvl(t.date_last_attempt, sysdate)
        into v_dtIPlocked
        from fx_iplogin_attempts t
       where t.client_ip = pi_vSessionClientIP;
      if v_nIPIsLocked > 0 then
      
        --if the current date/time > (lock time + lock period)
        v_dtIPCheck := v_dtIPlocked + v_nIPLockPeriod / 1440;
        if sysdate > v_dtIPCheck then
        
          --if we are no longer ip locked clear the
          --fx_iplogin_attempts entry
          delete from fx_iplogin_attempts
           where client_ip = pi_vSessionClientIP;
          commit;
        
        else
        
          po_nUserID        := '0';
          po_nStatusCode    := 6;
          po_vStatusComment := 'IP Address Locked!';
          return;
        
        end if;
      
      end if;
    
    exception
      when others then
        v_nIPIsLocked := 0;
    end;
  
    --login
    begin
    
      --get the user id and status info about the account
      select nvl(t.fx_user_id, 0),
             nvl(t.reset_password, 0),
             nvl(t.is_inactive, 0),
             nvl(t.is_locked, 0),
             t.date_password_changed,
             t.date_last_login,
             t.certificate
        into v_nFXUserID,
             v_nFXUserChangePWD,
             v_nFXUserInactive,
             v_nFXUserLocked,
             v_dtExpires,
             v_dtLastLogin,
             v_vAccountCert
      
        from fx_user t
       where upper(t.user_name) = upper(pi_vUserName)
         and t.password = pi_vPassword;
    
    exception
      when others then
      
        v_nFXUserID := 0;
      
    end;
  
    if v_nFXUserID > 0 then
    
      --check to see if this user is locked...
      if v_nFXUserLocked > 0 then
        po_nUserID        := '0';
        po_nStatusCode    := 2;
        po_vStatusComment := 'Your account is locked!';
        return;
      end if;
    
      --check to see if the user is inactive
      if v_nFXUserInactive > 0 then
        po_nUserID        := '0';
        po_nStatusCode    := 3;
        po_vStatusComment := 'Your account is inactive!';
        return;
      end if;
    
      --check the date_password_changed value and compare it
      --to the rules for pwd expiration...
      if v_dtExpires < trunc(sysdate) - 60 then
      
        po_nUserID        := '0';
        po_nStatusCode    := 9;
        po_vStatusComment := 'Your account has expired! Please contact your System Administrator to reset your password. ';
        return;
      
      end if;
    
      --make sure the user has logged in in the last 35 days otherwise they are expired
      if v_dtLastLogin < trunc(sysdate) - 35 and
         v_dtExpires < trunc(sysdate) - 35 then
      
        po_nUserID        := '0';
        po_nStatusCode    := 9;
        po_vStatusComment := 'Your account has expired due to inactivity! Please contact your System Administrator to reset your password. ';
        return;
      
      end if;
    
      --make sure there is not already a cert attached to this account
      if v_vAccountCert is not null then
        if v_vAccountCert != pi_vCert then
        
          po_nUserID        := '0';
          po_nStatusCode    := 9;
          po_vStatusComment := 'There is already a certificate associated with this account! Please contact your System Administrator to reset your password. ';
          return;
        
        end if;
      end if;
    
      --update the cert so that we autologin next time
      update fx_user
         set certificate = '' --pi_vCert this app does not support cert!
       where fx_user_id = v_nFXUserID;
      commit;
    
      --reset the fx_user status info
      update fx_user
         set is_locked       = 0,
             is_inactive     = 0,
             date_last_login = sysdate,
             flogin_attempts = login_attempts,
             login_attempts  = 0,
             LAST_LOGIN_IP   = pi_vSessionClientIP
       where fx_user_id = v_nFXUserID;
      commit;
    
      --reset the ip login attempts
      delete from fx_iplogin_attempts
       where client_ip = pi_vSessionClientIP;
      commit;
    
      --set the timeout
      po_nTimeOut := 15;
      begin
      
        select nvl(t.session_timeout, 15)
          into po_nTimeout
          from fx_user t
         where fx_user_id = v_nFXUserID;
      exception
        when others then
        
          po_nTimeOut := 0;
        
      end;
    
      --check to see if the user needs to change pwd
      if v_nFXUserChangePWD > 0 then
        po_nStatusCode    := 4;
        po_vStatusComment := 'Please Change Password!';
        return;
      end if;
    
      --get a new db session id:
      v_vDBSessionID := '';
      select t.SID || DBMS_RANDOM.STRING('x', 5) || t.SERIAL# || t.USER# ||
             DBMS_RANDOM.STRING('x', 5) || userenv('sessionid')
        into v_vDBSessionID
        from sys.v_$session t
       where t.audsid = userenv('sessionid');
    
      --clean up any old sessions, users can only login once!!!
      delete from fx_session where fx_user_id = v_nFXUserID;
      commit;
      delete from fx_session where db_session_id = v_vDBSessionID;
      commit;
      delete from fx_session_value where db_session_id = v_vDBSessionID;
      commit;
    
      --insert a record into fx_session
      insert into fx_session
        (fx_user_id,
         web_session_id,
         db_session_id,
         date_created,
         date_last_action,
         expired,
         client_ip)
      values
        (v_nFXUserID,
         pi_vSessionID,
         v_vDBSessionID,
         sysdate,
         sysdate,
         0,
         pi_vSessionClientIP);
    
      commit;
    
      --add an audit record for the success
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (v_vDBSessionID,
         pi_vSessionClientIP,
         v_nFXUserID,
         sysdate,
         'LOGIN',
         'SUCCESS');
    
      commit;
    
      --return the user id
      po_nUserID      := v_nFXUserID;
      po_vDBSessionID := v_vDBSessionID;
    
    else
    
      po_nUserID        := '0';
      po_nStatusCode    := 1;
      po_vStatusComment := 'Invalid user name/password';
    
      --did we fail the login but have a valid user name?
      select count(*)
        into v_nCount
        from fx_user t
       where upper(t.user_name) = upper(pi_vUserName);
      if v_nCount > 0 then
      
        --get the number of current attempts
        begin
          select nvl(t.login_attempts, 0)
            into v_nCurrAttempts
            from fx_user t
           where upper(t.user_name) = upper(pi_vUserName);
        exception
          when others then
            v_nCurrAttempts := 0;
        end;
      
        --increment number of login attempts
        v_nCurrAttempts := v_nCurrAttempts + 1;
      
        --update the fx_user record
        update fx_user
           set login_attempts   = v_nCurrAttempts,
               LAST_FLOGIN_IP   = pi_vSessionClientIP,
               LAST_FLOGIN_DATE = sysdate
         where upper(user_name) = upper(pi_vUserName);
      
        --check to see if we need to lock the account
        if v_nCurrAttempts >= v_nMAX_ACCOUT_LOGIN_ATTEMPTS then
        
          update fx_user
             set is_locked = 1
           where upper(user_name) = upper(pi_vUserName);
          commit;
        
          po_nUserID        := '0';
          po_nStatusCode    := 7;
          po_vStatusComment := 'Invalid user name/password, Account Locked!';
        
        end if;
      
      else
      
        --attempting to login with a bad user name
        --need to track ip address and lock that ip
        --for a specified period of time
        v_nCount := 0;
        select count(*)
          into v_nCount
          from FX_IPLOGIN_ATTEMPTS t
         where client_ip = pi_vSessionClientIP;
        if v_nCount > 0 then
        
          --get the number of attempts from this ip
          begin
            select login_attempts
              into v_nCurrIPAttempts
              from FX_IPLOGIN_ATTEMPTS
             where client_ip = pi_vSessionClientIP;
          exception
            when others then
              v_nCurrIPAttempts := 0;
          end;
        
          --increment attempts
          v_nCurrIPAttempts := v_nCurrIPAttempts + 1;
        
          --update last attempt and date
          update FX_IPLOGIN_ATTEMPTS
             set date_last_attempt = sysdate,
                 login_attempts    = v_nCurrIPAttempts
           where client_ip = pi_vSessionClientIP;
          commit;
        
          --check and lock if necessary
          if v_nCurrIPAttempts >= v_nMAX_IP_LOGIN_ATTEMPTS then
          
            update FX_IPLOGIN_ATTEMPTS
               set is_locked = 1
             where client_ip = pi_vSessionClientIP;
            commit;
          
            po_nUserID        := '0';
            po_nStatusCode    := 3;
            po_vStatusComment := 'Invalid user name/password, IP Address Locked!';
          
            --email the SA and let them know...
            v_vContent := '';
            v_vContent := 'IP Address ' || pi_vSessionClientIP || ' ';
            v_vContent := v_vContent ||
                          'attempted to login 10 times with invalid user account information! ';
          end if;
        
        else
        
          --first bad ip attempt
          insert into FX_IPLOGIN_ATTEMPTS
            (client_ip,
             login_attempts,
             date_last_attempt,
             is_locked,
             lock_period)
          values
            (pi_vSessionClientIP, 1, sysdate, 0, v_nMAX_IP_LOGIN_TIMEOUT);
          commit;
        
        end if;
      
      end if;
    
      --add an audit record for the fail
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (v_vDBSessionID,
         pi_vSessionClientIP,
         -1,
         sysdate,
         'LOGIN',
         'FAIL=' || pi_vUserName);
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '165 - An error occurred while logging in, Please contact your system administrator.';
    
      --add an audit record
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (v_vDBSessionID,
         pi_vSessionClientIP,
         -1,
         sysdate,
         'LOGIN',
         'FAIL=' || pi_vUserName);
  end;

  --audit page acceess
  procedure AuditPageAccess(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPageName        in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2)
  
   is
    v_nCount        number;
    v_nPageUserType number;
    v_nPageRights   number;
    v_nUserType     number;
    v_nUserRights   number;
    v_nSessionCount number;
    v_nPageActive   number;
    v_nPageLoggedIn number;
  
  begin
    v_nSessionCount := 0;
    v_nPageUserType := 0;
    v_nPageRights   := 0;
    v_nUserType     := 0;
    v_nUserRights   := 0;
    v_nPageLoggedIn := 0;
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount := 0;
  
    select nvl(t.user_rights, 0),
           nvl(t.user_type, 0),
           nvl(t.active, 1),
           nvl(t.is_logged_in, 0)
      into v_nPageRights, v_nPageUserType, v_nPageActive, v_nPageLoggedIn
      from fx_page_access t
     where t.page_name = pi_vPageName;
  
    insert into fx_audit
      (db_session_id,
       client_ip,
       fx_user_id,
       audit_date,
       audit_name,
       audit_data)
    values
      (pi_vSessionID,
       pi_vSessionClientIP,
       pi_nUserID,
       sysdate,
       'PAGE_ACCESS: ' || pi_vPageName,
       '');
  
    commit;
  
    -- There are some pages disabled in this version
    if v_nPageActive = 0 then
    
      --if we get here then we need to fail
      po_nStatusCode    := 1;
      po_vStatusComment := 'You are not authorized to view this page!';
    
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (pi_vSessionID,
         pi_vSessionClientIP,
         pi_nUserID,
         sysdate,
         'FAILED_PAGE_ACCESS: ' || pi_vPageName,
         '');
    
      commit;
      return;
    
    end if;
  
    --allow access to everyone -not logged in
    if (v_nPageLoggedIn = 0) then
      --we are done
      return;
    end if;
  
    --allow access to everyone logged in
    if (v_nPageRights = 0) and (v_nPageUserType = 0) then
      --we are done
      return;
    end if;
  
    --
    --
    --all other pages from this point on require you to be logged in
    --and have some kind of permission
    --
    --
  
    --check that we have a valid user id
    if pi_nUserID < 1 then
    
      --if we get here then we need to fail
      po_nStatusCode    := 1;
      po_vStatusComment := 'You are not authorized to view this page!';
    
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (pi_vSessionID,
         pi_vSessionClientIP,
         pi_nUserID,
         sysdate,
         'FAILED_PAGE_ACCESS: ' || pi_vPageName,
         '');
    
      commit;
      return;
    
    end if;
  
    --check that we have a valid session record
    select count(*)
      into v_nSessionCount
      from fx_session t
     where t.fx_user_id = pi_nUserID
       and t.expired = 0;
    if v_nSessionCount != 1 then
    
      --if we get here then we need to fail
      po_nStatusCode    := 1;
      po_vStatusComment := 'You are not authorized to view this page!';
    
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (pi_vSessionID,
         pi_vSessionClientIP,
         pi_nUserID,
         sysdate,
         'FAILED_PAGE_ACCESS: ' || pi_vPageName,
         '');
    
      commit;
      return;
    
    end if;
  
    --otherwise we must check
    select t.user_type, t.user_rights
      into v_nUserType, v_nUserRights
      from fx_user_rights t
     where t.fx_user_id = pi_nUserID;
  
    if (((bitand(v_nUserRights, v_nPageRights) > 0) or v_nPageRights = 0) and
       ((bitand(v_nUserType, v_nPageUserType) > 0) or v_nPageUserType = 0))
    
     then
      return;
    end if;
  
    --if we get here then we need to fail
    po_nStatusCode    := 1;
    po_vStatusComment := 'You are not authorized to view this page!';
  
    insert into fx_audit
      (db_session_id,
       client_ip,
       fx_user_id,
       audit_date,
       audit_name,
       audit_data)
    values
      (pi_vSessionID,
       pi_vSessionClientIP,
       pi_nUserID,
       sysdate,
       'FAILED_PAGE_ACCESS: ' || pi_vPageName,
       '');
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '166 - An error occurred while auditing page access , Please contact your system administrator.';
    
      insert into fx_audit
        (db_session_id,
         client_ip,
         fx_user_id,
         audit_date,
         audit_name,
         audit_data)
      values
        (pi_vSessionID,
         pi_vSessionClientIP,
         pi_nUserID,
         sysdate,
         'FAILED_PAGE_ACCESS: ' || pi_vPageName,
         '');
    
      commit;
  end;
  
  --audit page acceess
  procedure AuditTransaction(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vSPName          in varchar2,
                             pi_clAuditXML       in clob,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2)

   is
    
    v_nCount number := 0;
    v_nCounter number := 1;
    
    --key for encryption
    v_rKey   raw(32) := sys.ic_utl_sec.c_rKey;
    
    --the encrypted audit text
    v_vAudit varchar(32767) := '';
    
    v_vWorking  varchar(32767) := '';
    
  begin

    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    v_nCount := 0;
    
    --if audit is < 4001 chars then enc the whole thing
    --otherwise enc it in pieces seperated by _ most calls will 
    --be under 4K!!!
    if length(pi_clAuditXML) < 2001 then 
      
       v_vAudit := sys.ic_utl_sec.encryptData(substr(pi_clAuditXML, 1, 2000),
                                                   v_rKey,
                                                   pi_vSessionClientIP);
    else
      
       --get a working string
       v_vWorking := pi_clAuditXML;
       v_vAudit := '';
       
       --how many times do we need to chunk it
       v_nCount := length(v_vWorking) / 1000;
       v_nCount := ceil(v_nCount);
       
       --loop and chunk
       for v_nCounter IN 1..v_nCount
       loop
         
           if v_nCounter = v_nCount then
           
              --last one so grab the rest
              v_vAudit := v_vAudit || sys.ic_utl_sec.encryptData(v_vWorking,
                                                                       v_rKey,
                                                                       pi_vSessionClientIP);
              v_vAudit := v_vAudit || '|';
              
           else
              
              --grab 1000 chars  
              v_vAudit := v_vAudit || sys.ic_utl_sec.encryptData(substr(v_vWorking, 1, 1000),
                                                                       v_rKey,
                                                                       pi_vSessionClientIP);
              v_vAudit := v_vAudit || '|';
              
              --adjust working to next 4k group
              v_vWorking := substr(v_vWorking, 1001);
           
           end if;    
       end loop;      
    
    end if;

    --insert the record into the audit table
    insert into fx_audit
      (db_session_id,
       client_ip,
       fx_user_id,
       audit_date,
       audit_name,
       audit_data)
    values
      (pi_vSessionID,
       pi_vSessionClientIP,
       pi_nUserID,
       sysdate,
       pi_vSPName,
       v_vAudit);

    commit;

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '167 - An error occurred while auditing a transaction, Please contact your system administrator.';
  end;


  --audit page acceess
 /* procedure AuditTransaction(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vSPName          in varchar2,
                             pi_clAuditXML       in clob,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2)
  
   is
    v_nCount number;
    v_rKey   raw(32) := sys.ic_utl_sec.c_rKey;
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount := 0;
  
    insert into fx_audit
      (db_session_id,
       client_ip,
       fx_user_id,
       audit_date,
       audit_name,
       audit_data)
    values
      (pi_vSessionID,
       pi_vSessionClientIP,
       pi_nUserID,
       sysdate,
       'ENC: ' || pi_vSPName,
       sys.ic_utl_sec.encryptData(substr(pi_clAuditXML, 1, 4000),
                                  v_rKey,
                                  pi_vSessionClientIP));
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '167 - An error occurred while auditing a transaction, Please contact your system administrator.';
  end;*/

  --LogOff
  procedure LogOff(pi_vSessionID       in varchar2,
                   pi_vSessionClientIP in varchar2,
                   pi_nUserID          in number,
                   po_nStatusCode      out number,
                   po_vStatusComment   out varchar2)
  
   is
    v_nCount number;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount := 0;
  
    --clean up any old sessions, users can only login once!!!
    delete from fx_session where fx_user_id = pi_nUserID;
    commit;
    delete from fx_session where db_session_id = pi_vSessionID;
    commit;
    delete from fx_session_value where db_session_id = pi_vSessionID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '168 - An error occurred while logging off, Please contact your system administrator.';
  end;

  --gets an fx_user record given the encrypted uid
  procedure GetFXUserRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        pi_vEncUID          in varchar2,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*,
             --less than or equal to zero means we are expired!
             floor(60 - (trunc(sysdate) - t.date_password_changed)) as days_till_expiration
        from fx_user t
       where user_name = pi_vEncUID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '169 - An error occurred while retrieving a user record, Please contact your system administrator.';
  end;

  --insert a record into the fx_user table
  --and update the fx_user_id in the suat_user table
  procedure InsertFXUser(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_vKey in varchar2,
                         pi_vProviderID      in varchar2,
                         pi_vUserName        in varchar2,
                         pi_vPassword        in varchar2,
                         pi_nAccountLocked   in number,
                         pi_nAccountInactive in number,
                         
                         pi_vCOldPassword in varchar2,
                         pi_vCPassword    in varchar2,
                         pi_vCUserName    in varchar2,
                         
                         po_nFXUserID      out number,
                         po_nStatusCode    out number,
                         po_vStatusComment out varchar2)
  
   is
    v_nCount    number;
    v_nFXUserID number;
    dtSys       date;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount    := 0;
    v_nFXUserID := 0;
    dtSys       := sysdate;
  
    --get a new user id from the sequence
    --
    select seqFXUserID.Nextval into v_nFXUserID from dual;
  
    insert into fx_user
      (fx_user_id,
       user_name,
       certificate,
       is_locked,
       is_inactive,
       date_created,
       date_modified,
       updated_by,
       reset_password,
       date_password_changed,
       date_last_login,
       session_timeout,
       login_attempts,
       password)
    values
      (v_nFXUserID, --fx_user_id,
       pi_vUserName, --user_name,
       '', --certificate,
       pi_nAccountLocked, --is_locked,
       pi_nAccountInactive, --is_inactive,
       dtSys, --date_created,
       dtSys, --date_modified,
       pi_nUserID, --updated_by,
       1, --ALWAYS MUST reset_password,
       dtSys, --date_password_changed,
       dtSys, --date_last_login,
       15, --session_timeout,
       0, --login_attempts,
       pi_vPassword --password
       );
  
    commit;
  
    --update the suat_user table fx id
    update suat_user
       set fx_user_id = v_nFXUserID
     where provider_id = pi_vProviderID;
    commit;
  
    --create user record in fx_user_rights
    insert into fx_user_rights
      (fx_user_id, user_rights, read_only)
    values
      (v_nFXUserID, 0, 0);
    commit;
  
    --have to insert the record before validating
    ValidatePassword(pi_vKey,
                     v_nFXUserID,
                     pi_vUserName,
                     'NA',
                     pi_vPassword,
                     'NA',
                     pi_vCPassword,
                     pi_vCUserName,
                     1,
                     po_nStatusCode,
                     po_vStatusComment);
  
    if po_nStatusCode != 0 then
    
      delete from fx_user where fx_user_id = v_nFXUserID;
      commit;
    
      po_nFXUserID := 0;
    
    end if;
  
    po_nFXUserID := v_nFXUserID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '170 - An error occurred while inserting a user, Please contact your system administrator.';
  end;

  --update an fx_user record
  procedure UpdateFXUser(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_nFXUserID        in number,
                         pi_vProviderID      in varchar2,
                         pi_vUserName        in varchar2,
                         pi_vPassword        in varchar2,
                         pi_nAccountLocked   in number,
                         pi_nAccountInactive in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2)
  
   is
    v_nCount  number;
    dtSys     date;
    v_currpwd varchar2(4000);
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount  := 0;
    dtSys     := sysdate;
    v_currpwd := '';
  
    --update date_password_changed if the user changed the pwd
    select password
      into v_currpwd
      from fx_user
     where fx_user_id = pi_nFXUserID;
    if v_currpwd != pi_vPassword then
    
      update fx_user
         set date_password_changed = dtSys
       where fx_user_id = pi_nFXUserID;
      commit;
    
    end if;
  
    update fx_user
       set certificate    = '',
           is_locked      = pi_nAccountLocked,
           is_inactive    = pi_nAccountInactive,
           date_modified  = dtSys,
           updated_by     = pi_nUserID,
           reset_password = 1, --always MUST CHANGE PASSWORD
           password       = pi_vPassword
     where fx_user_id = pi_nFXUserID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '171 - An error occurred while updating a user, Please contact your system administrator.';
  end;

  --update fx_user_rights
  procedure UpdateFXUserRights(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_nFxUserID        in number,
                               pi_nUserType        in number,
                               pi_nUserRights      in number,
                               pi_nUserReadOnly    in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update fx_user_rights
       set user_rights = pi_nUserRights,
           read_only   = pi_nUserReadOnly,
           user_type   = pi_nUserType
     where fx_user_id = pi_nFxUserID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_FX_SEC.UpdateSuatUserRights(): ' || sqlErrm;
  end;

  --update an fx_user record
  procedure UpdateFXUserPWD(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vKey in varchar2,
                            pi_nFXUserID        in number,
                            pi_vUserName        in varchar2,
                            pi_vPassword        in varchar2,
                            pi_nAccountLocked   in number,
                            pi_nAccountInactive in number,
                            
                            pi_vCPassword in varchar2,
                            pi_vCUserName in varchar2,
                            
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2)
  
   is
    v_nCount  number;
    dtSys     date;
    v_currpwd varchar2(4000);
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount  := 0;
    dtSys     := sysdate;
    v_currpwd := '';
  
    ValidatePassword(pi_vKey,
                     pi_nFXUserID,
                     pi_vUserName,
                     'NA',
                     pi_vPassword,
                     'NA',
                     pi_vCPassword,
                     pi_vCUserName,
                     1,
                     po_nStatusCode,
                     po_vStatusComment);
  
    if po_nStatusCode != 0 then
      return;
    end if;
  
    --update date_password_changed if the user changed the pwd
    select password
      into v_currpwd
      from fx_user
     where fx_user_id = pi_nFXUserID;
    if v_currpwd != pi_vPassword then
    
      update fx_user
         set date_password_changed = dtSys
       where fx_user_id = pi_nFXUserID;
      commit;
    
    end if;
  
    update fx_user
       set certificate    = '',
           is_locked      = pi_nAccountLocked,
           is_inactive    = pi_nAccountInactive,
           date_modified  = dtSys,
           updated_by     = pi_nUserID,
           reset_password = 1, --always MUST CHANGE PASSWORD
           password       = pi_vPassword
     where fx_user_id = pi_nFXUserID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '172 - An error occurred while resetting a password, Please contact your system administrator.';
  end;

  --update an fx_user record
  procedure UpdateFXUserOptions(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nFXUserID        in number,
                                pi_nAccountLocked   in number,
                                pi_nAccountInactive in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2)
  
   is
    dtSys date;
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    dtSys := sysdate;
  
    update fx_user
       set certificate   = '',
           is_locked     = pi_nAccountLocked,
           is_inactive   = pi_nAccountInactive,
           date_modified = dtSys,
           updated_by    = pi_nUserID
     where fx_user_id = pi_nFXUserID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '173 - An error occurred while updating a user account, Please contact your system administrator.';
  end;

  --gets an Username and Password given the providerid
  procedure GetFXUsernamePasswordRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vProviderID      in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select * from fx_user t where fx_user_id = pi_nUserID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '174 - An error occurred while retrieving a user account, Please contact your system administrator.';
  end;

  --gets an FXUserID given the providerid
  procedure GetFXUserIdRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vProviderID      in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select fx_user_id
        from suat_user t
       where provider_id = pi_vProviderID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '175 - An error occurred while retrieving a user ID, Please contact your system administrator.';
  end;

  --gets a FXUserID given the providerid
  procedure CheckFXUserRecRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vProviderID      in varchar2,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select count(f.fx_user_id) as FXUserCount
        from fx_user f
       where f.fx_user_id =
             (select s.fx_user_id
                from suat_user s
               where s.provider_id = pi_vProviderID);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '176 - An error occurred while checking a user record, Please contact your system administrator.';
  end;

  -- --------------------------------------------------------------------------------
  procedure GetSecurityQuestions(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nQuestionGrp     in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from stat_sec_questions q
       where q.active = 1
         and q.question_group = pi_nQuestionGrp;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_FX_SEC.GetSecurityQuestions(): ' || sqlErrm;
  end;

  procedure GetUserQuestions(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             --
                             pi_vUsername in varchar2,
                             --                                 
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor) is
  
    v_nFXUserID number := 0;
    v_nCount    number := 0;  
    
    v_nCurrIPAttempts number;
    v_nIPIsLocked     number;
    v_dtIPlocked      date;
    v_nIPLockPeriod   number;
    v_dtIPCheck       date;
    v_dtExpires       date;
    v_dtLastLogin     date;
    
    v_nMAX_IP_LOGIN_ATTEMPTS     number;
    v_nMAX_IP_LOGIN_TIMEOUT      number;
  
  begin    
       
    v_nCurrIPAttempts := 0;
    v_nIPIsLocked     := 0;
    v_nIPLockPeriod   := 0;
    v_dtIPCheck       := sysdate;
    
    v_nMAX_IP_LOGIN_ATTEMPTS     := 10;
    v_nMAX_IP_LOGIN_TIMEOUT      := 20;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --
    --check to see if we are IP locked
    --
    begin
    
      --is the ip locked
      select nvl(t.is_locked, 0)
        into v_nIPIsLocked
        from fx_iplogin_attempts t
       where t.client_ip = pi_vSessionClientIP;
    
      --time period in mins to lock
      select nvl(t.lock_period, v_nMAX_IP_LOGIN_TIMEOUT)
        into v_nIPLockPeriod
        from fx_iplogin_attempts t
       where t.client_ip = pi_vSessionClientIP;
    
      --date locked
      select nvl(t.date_last_attempt, sysdate)
        into v_dtIPlocked
        from fx_iplogin_attempts t
       where t.client_ip = pi_vSessionClientIP;
      if v_nIPIsLocked > 0 then
      
        --if the current date/time > (lock time + lock period)
        v_dtIPCheck := v_dtIPlocked + v_nIPLockPeriod / 1440;
        if sysdate > v_dtIPCheck then
        
          --if we are no longer ip locked clear the
          --fx_iplogin_attempts entry
          delete from fx_iplogin_attempts
           where client_ip = pi_vSessionClientIP;
          commit;
        
        else
        
          open rs
           for select (select 0 from dual) as fx_user_id,
                      (select '' from dual) as question_1,
                      (select '' from dual) as question_2,
                      (select 0 from dual) as is_locked,
                      (select 0 from dual) as is_locked
                 from dual;
               
          po_nStatusCode    := 6;
          po_vStatusComment := 'IP Address Locked!';
          return;
        
        end if;
      
      end if;
    
    exception
      when others then
        v_nIPIsLocked := 0;
    end;
    
    select count(*)
      into v_nCount
      from fx_user t
     where t.user_name = pi_vUsername;
  
    if v_nCount > 0 then
      select fx_user_id
        into v_nFXUserID
        from fx_user t
       where t.user_name = pi_vUsername;
    else
      --attempting to login with a bad user name
        --need to track ip address and lock that ip
        --for a specified period of time
        v_nCount := 0;
        select count(*)
          into v_nCount
          from FX_IPLOGIN_ATTEMPTS t
         where client_ip = pi_vSessionClientIP;
        if v_nCount > 0 then
        
          --get the number of attempts from this ip
          begin
            select login_attempts
              into v_nCurrIPAttempts
              from FX_IPLOGIN_ATTEMPTS
             where client_ip = pi_vSessionClientIP;
          exception
            when others then
              v_nCurrIPAttempts := 0;
          end;
        
          --increment attempts
          v_nCurrIPAttempts := v_nCurrIPAttempts + 1;
        
          --update last attempt and date
          update FX_IPLOGIN_ATTEMPTS
             set date_last_attempt = sysdate,
                 login_attempts    = v_nCurrIPAttempts
           where client_ip = pi_vSessionClientIP;
          commit;
        
          --check and lock if necessary
          if v_nCurrIPAttempts >= v_nMAX_IP_LOGIN_ATTEMPTS then
          
            update FX_IPLOGIN_ATTEMPTS
               set is_locked = 1
             where client_ip = pi_vSessionClientIP;
            commit;
          
            open rs
           for select (select 0 from dual) as fx_user_id,
                      (select '' from dual) as question_1,
                      (select '' from dual) as question_2,
                      (select 0 from dual) as is_locked,
                      (select 0 from dual) as is_locked
                 from dual;
                 
            po_nStatusCode    := 6;
            po_vStatusComment := 'Invalid username, IP Address Locked!';
 
          end if;
        
        else
        
          --first bad ip attempt
          insert into FX_IPLOGIN_ATTEMPTS
            (client_ip,
             login_attempts,
             date_last_attempt,
             is_locked,
             lock_period)
          values
            (pi_vSessionClientIP, 1, sysdate, 0, v_nMAX_IP_LOGIN_TIMEOUT);
          commit;
        
        end if;
    end if;
  
    --open recordset
    open rs for
      select v_nFXUserID as fx_user_id,
             (select question
                from stat_sec_questions q
               where q.question_id in
                     (select sq.question_id_1
                        from fx_sec_questions sq
                       where fx_user_id = v_nFXUserID)) as question_1,
             
             (select question
                from stat_sec_questions q
               where q.question_id in
                     (select sq.question_id_2
                        from fx_sec_questions sq
                       where fx_user_id = v_nFXUserID)) as question_2,
             
             (select t.is_locked
                from fx_user t
               where t.fx_user_id = v_nFXUserID) as is_locked,
               
               (select v_nIPIsLocked from dual) as ip_locked
        from dual; 
        
        
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_FX_SEC.GetUserQuestions(): ' || sqlErrm;
  end;

  procedure UpdateSecQuestions(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_nQuestionID_1 in number,
                               pi_vAnswer_1     in varchar2,
                               
                               pi_nQuestionID_2 in number,
                               pi_vAnswer_2     in varchar2,
                               
                               pi_nQuestionID_3 in number,
                               pi_vAnswer_3     in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2) is
  
    v_bIsUpdate boolean := false;
    v_nCount    number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select count(*)
      into v_nCount
      from fx_sec_questions f
     where f.fx_user_id = pi_nUserID;
  
    if v_nCount > 0 then
      v_bIsUpdate := true;
    end if;
  
    if v_bIsUpdate then
      update fx_sec_questions q
         set q.question_id_1 = pi_nQuestionID_1,
             q.answer_1      = pi_vAnswer_1,
             q.question_id_2 = pi_nQuestionID_2,
             q.answer_2      = pi_vAnswer_2
      --q.question_id_3 = pi_nQuestionID_3,
      --q.answer_3      = pi_vAnswer_3
       where q.fx_user_id = pi_nUserID;
    else
      insert into fx_sec_questions q
        (fx_user_id,
         question_id_1,
         answer_1,
         question_id_2,
         answer_2,
         question_id_3,
         answer_3)
      values
        (pi_nUserID,
         pi_nQuestionID_1,
         pi_vAnswer_1,
         pi_nQuestionID_2,
         pi_vAnswer_2,
         null,
         null);
    end if;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_FX_SEC.UpdateSecQuestions(): ' || sqlErrm;
  end;

  procedure CheckSecurityQuestions(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   --pi_nQuestionID_1 in number,
                                   pi_vAnswer_1 in varchar2,
                                   
                                   --pi_nQuestionID_2 in number,
                                   pi_vAnswer_2 in varchar2,
                                   
                                   --pi_nQuestionID_3 in number,
                                   pi_vAnswer_3 in varchar2,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2) is
  
    v_nValidQ1 number := 0;
    v_nValidQ2 number := 0;
    v_nValidQ3 number := 0;
  
    v_nAttempts number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select count(*)
      into v_nValidQ1
      from fx_sec_questions q
     where q.fx_user_id = pi_nUserID
       and q.answer_1 = pi_vAnswer_1;
  
    select count(*)
      into v_nValidQ2
      from fx_sec_questions q
     where q.fx_user_id = pi_nUserID
       and q.answer_2 = pi_vAnswer_2;
  
    /*
    select count(*)
      into v_nValidQ3
      from fx_sec_questions q
     where q.fx_user_id = pi_nUserID
       and q.answer_3 = pi_vAnswer_3;
    */
  
    if (v_nValidQ1 + v_nValidQ2 + v_nValidQ3) >= 2 then
    
      update fx_sec_questions t
         set t.answer_attempts = 0, t.last_updated = sysdate
       where t.fx_user_id = pi_nUserID;
      commit;
    
      po_nStatusCode    := 0; --0 = success
      po_vStatusComment := '';
    
    else
    
      select t.answer_attempts
        into v_nAttempts
        from fx_sec_questions t
       where t.fx_user_id = pi_nUserID;
    
      v_nAttempts := v_nAttempts + 1;
    
      update fx_sec_questions t
         set t.answer_attempts = v_nAttempts, t.last_updated = sysdate
       where t.fx_user_id = pi_nUserID;
      commit;
    
      if v_nAttempts >= 3 then
        update fx_user t
           set t.is_locked       = 1,
               t.flogin_attempts = v_nAttempts,
               t.last_updated    = sysdate
         where t.fx_user_id = pi_nUserID;
        commit;
      
        po_nStatusCode    := 9; --9 = account locked
        po_vStatusComment := 'Your security answer attempts have exceeded that set by the system, so your account has been locked. ';
        po_vStatusComment := po_vStatusComment ||
                             'Please contact the system administrator to reactivate your login. ';
        po_vStatusComment := po_vStatusComment ||
                             'Security answer is invalid.';
        return;
      else
        po_nStatusCode    := 1; --1 = invalid answer
        po_vStatusComment := 'Security answer is invalid.';
        return;
      end if;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_FX_SEC.CheckSecurityQuestions(): ' ||
                           sqlErrm;
  end;

  /***********************************************************
                       RESET PASSWORD
  ***********************************************************/
  procedure ResetPassword(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vKey in varchar2,
                          pi_nFXUserID        in number,
                          pi_vUserName        in varchar2,
                          pi_vPassword        in varchar2,
                          pi_vCPassword       in varchar2,
                          pi_vCUserName       in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2)
  
   is
    v_nCount  number;
    dtSys     date;
    v_currpwd varchar2(4000);
  
  begin
  
    --default status to good
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nCount  := 0;
    dtSys     := sysdate;
    v_currpwd := '';
  
    pck_fx_sec.ValidatePassword(pi_vKey,
                                pi_nFXUserID,
                                pi_vUserName,
                                'NA',
                                pi_vPassword,
                                'NA',
                                pi_vCPassword,
                                pi_vCUserName,
                                1,
                                po_nStatusCode,
                                po_vStatusComment);
    if po_nStatusCode != 0 then
      return;
    end if;
  
    --update date_password_changed if the user changed the pwd
    select password
      into v_currpwd
      from fx_user
     where fx_user_id = pi_nFXUserID;
    if v_currpwd != pi_vPassword then
    
      update fx_user
         set date_password_changed = dtSys,
             last_updated          = sysdate,
             last_updated_by       = pi_nFXUserID
       where fx_user_id = pi_nFXUserID;
      commit;
    
    end if;
  
    update fx_user
       set certificate     = '',
           is_locked       = 0,
           is_inactive     = 0,
           date_modified   = dtSys,
           updated_by      = pi_nFXUserID,
           reset_password  = 0,
           password        = pi_vPassword,
           last_updated    = sysdate,
           last_updated_by = pi_nFXUserID
     where fx_user_id = pi_nFXUserID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '178 - An error occurred while updating a patients password, Please contact your system administrator.';
  end;

end PCK_FX_SEC;
/

prompt
prompt Creating package body PCK_FX_SEC_PATIENT
prompt ========================================
prompt
create or replace package body PCK_FX_SEC_PATIENT is
  
  --gets an FXUserID given the patient
  procedure CheckPatientFXUserRecRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      pi_vKey in varchar2,
      pi_vPatientID       in varchar2,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor)
  is

  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    --open recordset
    open rs for
    select count(f.fx_user_id) as FXUserCount from fx_user f
    where f.fx_user_id = (select p.fx_user_id from patient_demographics p
                          where p.patient_id = pi_vPatientID);


  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '182 - An error occurred while checking a patients account, Please contact your system administrator.';
  end;


  --converted to use new encryption
  --gets an FXUserID given the providerid
  procedure GetPatientFXUserIdRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      pi_vKey in varchar2,
      pi_vPatientID      in varchar2,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      )
  is

  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    --open recordset
    open rs for
      select fx_user_id from patient_demographics t
       where patient_id = pi_vPatientID;

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '181 - An error occurred while retrieving a patients account, Please contact your system administrator.';
  end;

  --converted to use new encryption
  --gets an Username and Password given the providerid
  procedure GetPatientFXUsernamePasswordRS(
      pi_vSessionID       in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID          in number,
      pi_vKey in varchar2,
      pi_vPatientID       in varchar2,
      po_nStatusCode      out number,
      po_vStatusComment   out varchar2,
      rs                  out RetRefCursor
      )
  is

  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';

    --open recordset
    open rs for
      select * from fx_user t
           where fx_user_id = (select fx_user_id from patient_demographics t
                                      where patient_id = pi_vPatientID);

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := '180 - An error occurred while retrieving patients account information, Please contact your system administrator.';
  end;

 --insert a record into the fx_user table
   --and update the fx_user_id in the suat_user table
   procedure InsertPatientFXUser (
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vKey in varchar2,
      pi_vPatientID              in varchar2,
      pi_vUserName               in varchar2,
      pi_vPassword               in varchar2,
      pi_nAccountLocked          in number,
      pi_nAccountInactive        in number,
      
      pi_vCOldPassword           in varchar2,
      pi_vCPassword              in varchar2,
      pi_vCUserName              in varchar2,   
      po_nFXUserID               out number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     )

    is
     v_nCount            number;
     v_nFXUserID         number;
     dtSys               date;
     v_nUserType         number := 32768;

   begin

      --default status to good
      po_nStatusCode := 0; --0 = success
      po_vStatusComment := '';

      v_nCount := 0;
      v_nFXUserID := 0;
      dtSys := sysdate;

      --get a new user id from the sequence
      --
      select seqFXUserID.Nextval
      into v_nFXUserID
      from dual;

      insert into fx_user( fx_user_id,
                           user_name,
                           certificate,
                           is_locked,
                           is_inactive,
                           date_created,
                           date_modified,
                           updated_by,
                           reset_password,
                           date_password_changed,
                           date_last_login,
                           session_timeout,
                           login_attempts,
                           password,
                           last_updated,
                           last_updated_by
                           )
      values( v_nFXUserID,              --fx_user_id,
              pi_vUserName,             --user_name,
              '',                       --certificate,
              pi_nAccountLocked,        --is_locked,
              pi_nAccountInactive,      --is_inactive,
              dtSys,                    --date_created,
              dtSys,                    --date_modified,
              pi_nUserID,               --updated_by,
              1,                        --ALWAYS MUST reset_password,
              dtSys,                    --date_password_changed,
              dtSys,                    --date_last_login,
              30,                       --session_timeout,
              0,                        --login_attempts,
              pi_vPassword,              --password
              sysdate,
              pi_nUserID);

      commit;
      
      insert into fx_user_rights
      (fx_user_id,
       user_rights,
       read_only,
       user_type)
       values
       (v_nFXUserID,
       0,
       0,
       v_nUserType);
       
       commit;

      --update the suat_user table fx id
      update patient_demographics
      set fx_user_id = v_nFXUserID,
          last_updated = sysdate,
          last_updated_by = pi_nUserID
      where patient_id = pi_vPatientID;
      commit;
      
       --have to insert the record before validating
      pck_fx_sec.ValidatePassword(
                        pi_vKey,
                        v_nFXUserID,
                        pi_vUserName,
                        'NA',
                        pi_vPassword,
                        'NA',
                        pi_vCPassword,
                        pi_vCUserName,
                        1,
                        po_nStatusCode,
                        po_vStatusComment);
       
       if po_nStatusCode != 0 then
          
          --clear the fx record for the patient
          update patient_demographics
          set fx_user_id = null
          where fx_user_id =  v_nFXUserID;
          
          --remove the fx_user from the db
          delete from fx_user where fx_user_id = v_nFXUserID;
          commit;
          
          delete from fx_user_rights where fx_user_id = v_nFXUserID;
          commit;
       
          po_nFXUserID := 0;
       
       end if;
   

     po_nFXUserID := v_nFXUserID;

   exception
      when others
      then
         po_nStatusCode := 1;
         po_vStatusComment := '177 - An error occurred while inserting a pateint user record, Please contact your system administrator.';
   end;

   --update an fx_user record
   procedure UpdatePatientFXUserPWD(
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vKey in varchar2,
      pi_nFXUserID               in number,
      pi_vUserName               in varchar2,
      pi_vPassword               in varchar2,
      pi_nAccountLocked          in number,
      pi_nAccountInactive        in number,
      pi_vCPassword              in varchar2,
      pi_vCUserName              in varchar2,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     )

    is
     v_nCount            number;
     dtSys               date;
     v_currpwd           varchar2(4000);

   begin

      --default status to good
      po_nStatusCode := 0; --0 = success
      po_vStatusComment := '';

      v_nCount := 0;
      dtSys := sysdate;
      v_currpwd := '';

      pck_fx_sec.ValidatePassword(pi_vKey,
                                  pi_nFXUserID,
                                  pi_vUserName,
                                  'NA',
                                  pi_vPassword,
                                  'NA',
                                  pi_vCPassword,
                                  pi_vCUserName,
                                  1,
                                  po_nStatusCode,
                                  po_vStatusComment);
      if po_nStatusCode != 0 then
         return;
      end if;
                        
      --update date_password_changed if the user changed the pwd
      select password into v_currpwd
      from fx_user
      where fx_user_id = pi_nFXUserID;
      if v_currpwd != pi_vPassword then

          update fx_user
          set date_password_changed = dtSys,
              last_updated = sysdate,
              last_updated_by = pi_nUserID
          where fx_user_id = pi_nFXUserID;
          commit;

      end if;

      update fx_user
      set
          certificate = '',
          is_locked = pi_nAccountLocked,
          is_inactive = pi_nAccountInactive,
          date_modified = dtSys,
          updated_by = pi_nUserID,
          reset_password = 1, --always MUST CHANGE PASSWORD
          password = pi_vPassword,
          last_updated = sysdate,
          last_updated_by = pi_nUserID
      where fx_user_id = pi_nFXUserID;
      commit;

   exception
      when others
      then
         po_nStatusCode := 1;
         po_vStatusComment := '178 - An error occurred while updating a patients password, Please contact your system administrator.';
   end;

   --update an fx_user record
   procedure UpdatePatientFXUserOptions(
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_nFXUserID               in number,
      pi_nAccountLocked          in number,
      pi_nAccountInactive        in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     )

    is
     v_nCount            number;
     dtSys               date;

   begin

      --default status to good
      po_nStatusCode := 0; --0 = success
      po_vStatusComment := '';

      dtSys := sysdate;

      update fx_user
      set
          certificate = '',
          is_locked = pi_nAccountLocked,
          is_inactive = pi_nAccountInactive,
          date_modified = dtSys,
          updated_by = pi_nUserID,
          last_updated = sysdate,
          last_updated_by = pi_nUserID
      where fx_user_id = pi_nFXUserID;
      commit;
      
      -- when the account is re-activated, reset the answer attempts number in fx_sec_question
      if pi_nAccountLocked = 0 then
        
        update fx_sec_questions t
           set t.answer_attempts = 0,
               t.last_updated = sysdate
         where t.fx_user_id = pi_nFXUserID;
        commit;
        
      end if;

   exception
      when others
      then
         po_nStatusCode := 1;
         po_vStatusComment := '179 - An error occurred while updating a patients user account, Please contact your system administrator.';
   end;
 

end PCK_FX_SEC_PATIENT;
/

prompt
prompt Creating package body PCK_INTAKE
prompt ================================
prompt
create or replace package body PCK_INTAKE is

  procedure GetResponseLoadRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vLoadTable       in varchar2,
                              pi_vLoadField       in varchar2,
                              pi_vLoadFilter      in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
    strSQL long;
  
  begin
  
    strSQL            := '';
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    strSQL := strSQL || 'SELECT ' || pi_vLoadField;
    strSQL := strSQL || ' FROM ' || pi_vLoadTable;
  
    if length(pi_vLoadFilter) > 2 then
      strSQL := strSQL || ' ' || pi_vLoadFilter;
    end if;
  
    --open recordset
    open rs for strSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetResponseLoadRS(): ' || sqlErrm;
  end;

  procedure GetIntakeModulesRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
    
      select i.*
        from intake_module i
       where i.active = 1
      --and i.module_for = 1
       order by sort_order;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetIntakeModulesRS(): ' || sqlErrm;
  end;

  procedure GetPatientModulesRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vPatientID       in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
    
      select p.*, i.*
        from patient_module p, intake_module i
       where p.patient_id = pi_vPatientID
         and p.mid = i.mid
         and i.active = 1
         --and (p.date_completed is null or p.status < 1)
       order by i.sort_order asc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetPatientModulesRS(): ' || sqlErrm;
  end;

  procedure InsertPatientModules(pi_vSessionID        in varchar2,
                                 pi_vSessionClientIP  in varchar2,
                                 pi_nUserID           in number,
                                 pi_vPatientID        in varchar2,
                                 pi_vAssignProviderID in varchar2,
                                 pi_dDateAssigned     in date,
                                 pi_nMID              in number,
                                 pi_nModuleGroup      in number,
                                 pi_vStatus           in varchar2,
                                 po_nStatusCode       out number,
                                 po_vStatusComment    out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into patient_module
      (patient_id,
       assign_provider_id,
       date_assigned,
       mid,
       status,
       LAST_UPDATED,
       LAST_UPDATED_BY,
       module_group_id)
    values
      (pi_vPatientID,
       pi_vAssignProviderID,
       pi_dDateAssigned,
       pi_nMID,
       pi_vStatus,
       sysdate,
       pi_nUserID,
       pi_nModuleGroup);
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.InsertPatientModules(): ' || sqlErrm;
  end;

  --loops over the flags and generates problems
  procedure InsertTreatmentProblems(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    pi_nTreatmentID     in number,
                                    pi_vEncounterID     in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2)
  
   is
    rs           RetRefCursor;
    v_rec        stat_problem%ROWTYPE;
    v_nProblemID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_nProblemID      := 0;
  
    --get all the problems that the patient does not already have
    /*open rs for
      select *
        from stat_problem t
       where t.stat_problem_id in
             (select stat_problem_id
                from intake_flags f
               where f.flag_id in
                     (select ef.flag_id
                        from encounter_intake_flag ef
                       where ef.encounter_id = pi_vEncounterID))
            
         and t.stat_problem_id not in
             (select tp.stat_problem_id
                from treatment_problem tp
               where tp.treatment_id = pi_nTreatmentID
                 and tp.inactive = 0 --todo:
                 and tp.patient_id = pi_vPatientID);
    
    LOOP
      v_rec := null;
      FETCH rs
        INTO v_rec;
      EXIT WHEN NOT rs%found;
      if v_rec.stat_problem_id is not null then
      
        --get a new problem_id for the insert
        select seqproblemid.nextval into v_nProblemID from dual;
      
        -- Commented Out REVAMP      
        \*--insert the new problem
        insert into treatment_problem
          (treatment_id,
           patient_id,
           problem_id,
           problem_desc,
           problem_text,
           status,
           stat_referral_id,
           release_signed,
           inactive,
           stat_problem_id,
           LAST_UPDATED,
           LAST_UPDATED_BY)
        values
          (pi_nTreatmentID,
           pi_vPatientID,
           v_nProblemID,
           v_rec.stat_problem_desc,
           v_rec.stat_problem_text,
           0,
           -1,
           0,
           0,
           v_rec.stat_problem_id,
           sysdate,
           pi_nUserID);
        commit;*\
      
      end if;
    END LOOP;
    CLOSE rs;*/
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.InsertTreatmentProblems(): ' ||
                           sqlErrm;
  end;

  procedure DeletePatientModules(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vStatus          in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    delete from patient_module
     where patient_id = pi_vPatientID
       and status = pi_vStatus;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.DeletePatientModules(): ' || sqlErrm;
  end;

  procedure UpdatePatientModules(pi_vSessionID        in varchar2,
                                 pi_vSessionClientIP  in varchar2,
                                 pi_nUserID           in number,
                                 pi_vPatientID        in varchar2,
                                 pi_vAssignProviderID in varchar2,
                                 pi_dDateAssigned     in date,
                                 pi_dDateCompleted    in date,
                                 pi_nMID              in number,
                                 pi_vStatus           in varchar2,
                                 po_nStatusCode       out number,
                                 po_vStatusComment    out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update patient_module
       set assign_provider_id = pi_vAssignProviderID,
           date_assigned      = pi_dDateAssigned,
           date_completed     = pi_dDateCompleted,
           mid                = pi_nMID,
           status             = pi_vStatus,
           LAST_UPDATED       = sysdate,
           LAST_UPDATED_BY    = pi_nUserID
     where patient_id = pi_vPatientID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.UpdatePatientModules(): ' || sqlErrm;
  end;

  ------------------------------------------------------------

  procedure GetModuleGroupRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from intake_module_group t
       where t.active = 1
       order by t.module_group_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetModuleGroupRS(): ' || sqlErrm;
  end;

  procedure GetModulesListRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select m.module_group_id,
             m.mid,
             m.sort_order,
             m2.module,
             m2.description
        from (select imgm.*, img.module_group_descr
                from intake_module_group_mid imgm,
                     intake_module_group     img,
                     intake_module           im
               where img.module_group_id = imgm.module_group_id
                 and im.mid = imgm.mid
                 and im.active = 1) m
        left join (select * from intake_module im where im.active = 1) m2
          on m2.mid = m.mid
       order by m.module_group_id, m.sort_order;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetModulesListRS(): ' || sqlErrm;
  end;

  -----------------------------------------------------------------------------
  -- ASSIGN PATIENT MODULES
  procedure AssignPatientModules(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vPatientID  in varchar2,
                                 pi_vProviderID in varchar2,
                                 pi_vModules    in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
  
    v_vRecDelim   varchar2(1) := '^';
    v_vColDelim   varchar2(1) := '|';
    v_nRecPos     number := 0;
    v_nColPos     number := 0;
    v_nPrevRecPos number := 0;
    v_nPrevColPos number := 0;
    v_vRecord     varchar2(32767) := '';
    v_vColumn     varchar2(32767) := '';
    v_nColIndex   number := 0;
  
    --
    v_nMID number;
    v_nGID number;
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    --delete patient's module records first
    delete from PATIENT_MODULE t
     where t.patient_id = pi_vPatientID
       and t.status != 1;
    commit;
  
    if ((pi_vModules is null) or (LENGTH(pi_vModules) < 4)) then
      return;
    end if;
  
    --split records
    loop
      v_nRecPos := INSTR(pi_vModules, v_vRecDelim, v_nRecPos + 1);
      exit when v_nRecPos = 0;
      v_vRecord     := substr(pi_vModules,
                              v_nPrevRecPos + 1,
                              v_nRecPos - v_nPrevRecPos - 1);
      v_nPrevRecPos := v_nRecPos;
    
      --split columns from record
      v_nColPos     := 0;
      v_nPrevColPos := 0;
      v_vColumn     := '';
      v_nColIndex   := 0;
    
      loop
        v_nColPos := INSTR(v_vRecord, v_vColDelim, v_nColPos + 1);
        exit when v_nColPos = 0;
        v_vColumn     := substr(v_vRecord,
                                v_nPrevColPos + 1,
                                v_nColPos - v_nPrevColPos - 1);
        v_nPrevColPos := v_nColPos;
      
        --loop columns
        if v_nColIndex = 0 then
          v_nMID := to_number(v_vColumn);
        elsif v_nColIndex = 1 then
          v_nGID := to_number(v_vColumn);
        end if;
      
        v_nColIndex := v_nColIndex + 1;
      end loop;
    
      --insert settings
      insert into PATIENT_MODULE
        (patient_id,
         assign_provider_id,
         date_assigned,
         mid,
         status,
         last_updated,
         last_updated_by,
         module_group_id)
      values
        (pi_vPatientID,
         pi_vProviderID,
         sysdate,
         v_nMID,
         0,
         sysdate,
         pi_nUserID,
         v_nGID);
      commit;
    
    end loop;
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_INTAKE.AssignPatientModules(): ' || sqlCode || ': ' ||
                           sqlErrm;
    
  end;

  procedure GetPatIntakeAssignedRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
  
    v_nDaysPrior number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nDaysPrior := to_number(getParameterValue('DAYS_PRIOR'));
  
    --open recordset
    open rs for
    
      select t1.*,
             t2.sort_order,
             to_date(to_char(t1.date_assigned, 'mm/dd/yyyy'), 'mm/dd/yyyy') as mod_date,
             img.module_group_descr,
             im.module,
             im.description,
             img.event_id
        from patient_module          t1,
             intake_module_group_mid t2,
             intake_module_group     img,
             intake_module           im
       where t1.patient_id = pi_vPatientID
         and t2.module_group_id = t1.module_group_id
         and t2.mid = t1.mid
         and img.module_group_id = t1.module_group_id
         and im.mid = t1.mid
            
            --show only modules with null scheduled date or those with 
            --scheduled date close (- # days prior) to actual date
         and (to_date(to_char(sysdate, 'mm/dd/yyyy'), 'mm/dd/yyyy') >=
             (nvl(t1.scheduled_date,
                   to_date(to_char(sysdate, 'mm/dd/yyyy'), 'mm/dd/yyyy')) -
             v_nDaysPrior))
      
       order by img.event_id desc,
                t1.module_group_id,
                t2.sort_order,
                mod_date;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetPatIntakeAssignedRS(): ' ||
                           sqlErrm;
  end;

  -- **********************************************************************
  -- WRITE RESPONSES

  procedure WriteIntakeResponses(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vEncounterID in varchar2,
                                 pi_nEncIntakeID in number,
                                 pi_nMID         in number,
                                 pi_nIntakeGrpID in number,
                                 pi_vResponses   in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
  
    v_vRecDelim   varchar2(1) := '^';
    v_vColDelim   varchar2(1) := '|';
    v_nRecPos     number := 0;
    v_nColPos     number := 0;
    v_nPrevRecPos number := 0;
    v_nPrevColPos number := 0;
    v_vRecord     varchar2(32767) := '';
    v_vColumn     varchar2(32767) := '';
    v_nColIndex   number := 0;
  
    --
    v_nRID      number;
    v_nScoreVal number;
    v_vResponse varchar2(4000);
  
    --
    curRESP RetRefCursor;
    recRESP intake_response%rowtype;
  
    --
    v_vPatientID varchar2(50);
  
    --
    v_nModalityID number := null;
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    if ((pi_vResponses is null) or (LENGTH(pi_vResponses) < 4)) then
      return;
    end if;
  
    --get stat_modality_id from intake_group_id
    begin
      select g.stat_modality_id
        into v_nModalityID
        from intake_module_group g
       where g.module_group_id = pi_nIntakeGrpID;
    exception
      when others then
        v_nModalityID := null;
    end;
  
    --split records
    loop
      v_nRecPos := INSTR(pi_vResponses, v_vRecDelim, v_nRecPos + 1);
      exit when v_nRecPos = 0;
      v_vRecord     := substr(pi_vResponses,
                              v_nPrevRecPos + 1,
                              v_nRecPos - v_nPrevRecPos - 1);
      v_nPrevRecPos := v_nRecPos;
    
      --split columns from record
      v_nColPos     := 0;
      v_nPrevColPos := 0;
      v_vColumn     := '';
      v_nColIndex   := 0;
    
      loop
        v_nColPos := INSTR(v_vRecord, v_vColDelim, v_nColPos + 1);
        exit when v_nColPos = 0;
        v_vColumn     := substr(v_vRecord,
                                v_nPrevColPos + 1,
                                v_nColPos - v_nPrevColPos - 1);
        v_nPrevColPos := v_nColPos;
      
        --loop columns - JRL
        if v_nColIndex = 0 then
          v_vResponse := v_vColumn;
        
        elsif v_nColIndex = 1 then
          v_nRID := to_number(v_vColumn);
        
        elsif v_nColIndex = 2 then
          v_nScoreVal := to_number(v_vColumn);
        
        end if;
      
        v_nColIndex := v_nColIndex + 1;
      end loop;
    
      open curRESP for
        select *
          from intake_response r
         where r.mid = pi_nMID
           and r.rid = v_nRID;
    
      loop
        fetch curRESP
          into recRESP;
        exit when curRESP%notfound;
      
        if recRESP.Display_Type != 3 and recRESP.Display_Type != 5 then
          v_vResponse := recRESP.Response;
        end if;
      
        if recRESP.Unit is not null then
          v_vResponse := v_vResponse || ' ' || recRESP.Unit;
        end if;
      
        -- INSERT RESPONSE
        insert into encounter_intake_responses
          (encounter_id,
           encounter_intake_id,
           rid,
           mid,
           tid,
           qid,
           response_type,
           response_value,
           score_value,
           response_datetime,
           response_time,
           intake_group_id)
        values
          (pi_vEncounterID,
           pi_nEncIntakeID,
           v_nRID,
           pi_nMID,
           recRESP.Tid,
           recRESP.Qid,
           recRESP.Response_Type,
           v_vResponse,
           v_nScoreVal,
           sysdate,
           1,
           pi_nIntakeGrpID);
      
        commit;
      
      end loop;
      close curRESP;
    end loop;
  
    --Insert Encounter Intake
    InsertEncounterIntake(pi_vSessionID       => pi_vSessionID,
                          pi_vSessionClientIP => pi_vSessionClientIP,
                          pi_nUserID          => pi_nUserID,
                          pi_vEncounterID     => pi_vEncounterID,
                          pi_nMID             => pi_nMID,
                          pi_nEncIntakeID     => pi_nEncIntakeID,
                          pi_nModality        => v_nModalityID,
                          po_nStatusCode      => po_nStatusCode,
                          po_vStatusComment   => po_vStatusComment,
                          pi_nIntakeGroup     => pi_nIntakeGrpID);
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_INTAKE.WriteIntakeResponses(): ' || sqlCode || ': ' ||
                           sqlErrm;
    
  end;

  -- *****************************************************
  -- MARK MODULE COMPLETE
  procedure CompleteModule(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_vPatientID in varchar2,
                           pi_nMID       in number,
                           pi_nGroupID   in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update patient_module t
       set t.status          = 1,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID,
           t.date_completed  = sysdate
     where t.patient_id = pi_vPatientID
       and t.mid = pi_nMID
       and t.module_group_id = pi_nGroupID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.CompleteModule(): ' || sqlErrm;
  end;

  -- *****************************************************
  -- INSERT ENCOUNTER INTAKE 
  procedure InsertEncounterIntake(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  
                                  pi_vEncounterID in varchar2,
                                  pi_nMID         in number,
                                  pi_nEncIntakeID in number,
                                  pi_nModality    in number,
                                  pi_nIntakeGroup    in number,
                                  
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2) is
  
    curRESP RetRefCursor;
    recRESP encounter_intake_responses%rowtype;
  
    v_nScore number := null;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --update score in encounter_intake
    insert into encounter_intake t
      (encounter_id,
       encounter_intake_id,
       mid,
       intake_type,
       score,
       read_only,
       complete,
       alternate_language,
       stat_modality_id,
       intake_group_id)
    values
      (pi_vEncounterID,
       pi_nEncIntakeID,
       pi_nMID,
       1,
       v_nScore,
       0,
       1,
       0,
       pi_nModality,
       pi_nIntakeGroup);
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.InsertEncounterIntake(): ' ||
                           sqlErrm;
  end;

  -- *****************************************************
  -- Assign initial Assessments

  procedure AssignInitialAssessments(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     
                                     pi_vPatientID in varchar2,
                                     
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2) is
  
    curMods RetRefCursor;
    recMods intake_module_group_mid%rowtype;
  
    v_vProviderID varchar2(50);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select provider_id
      into v_vProviderID
      from suat_user u
     where u.fx_user_id = pi_nUserID;
  
    open curMods for
      select imgm.*
        from intake_module_group_mid imgm, intake_module im
       where im.active = 1
         and im.mid = imgm.mid
         and imgm.module_group_id = 1
       order by imgm.module_group_id, imgm.sort_order;
  
    loop
      fetch curMods
        into recMods;
      exit when curMods%notfound;
    
      insert into patient_module pm
        (patient_id,
         assign_provider_id,
         date_assigned,
         mid,
         status,
         last_updated,
         last_updated_by,
         module_group_id,
         language_used)
      values
        (pi_vPatientID,
         v_vProviderID,
         sysdate,
         recMods.Mid,
         0,
         sysdate,
         pi_nUserID,
         recMods.Module_Group_Id,
         0);
      commit;
    
    end loop;
    close curMods;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.AssignInitialAssessments(): ' ||
                           sqlErrm;
  end;

  -- *****************************************************
  -- Insert Encounter Intake Score

  procedure InsertEncIntakeScore(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vEncounterID in varchar2,
                                 pi_nEncIntakeID in number,
                                 pi_nMID         in number,
                                 pi_nScoreType   in number,
                                 pi_nScore       in number,
                                 pi_nPCent       in number,
                                 pi_vInterpret   in varchar2,
                                 pi_nSeries      in number,
                                 pi_nIntakeGroup      in number,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
  
    v_vSQL varchar2(32767) := 'select max(t.intake_score_id)
         from (select max(eis.intake_score_id) + 1 as intake_score_id
                 from encounter_intake_score eis
                where eis.encounter_id = :EncounterID
                union
               select 1
                 from dual) t';
  
    v_nIntScoreID number := 0;
    v_nCount      number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get intake scrore id
    execute immediate v_vSQL
      into v_nIntScoreID
      using pi_vEncounterID;
  
    --insert score
    insert into encounter_intake_score t
      (encounter_id,
       encounter_intake_id,
       intake_score_id,
       mid,
       score_type,
       score,
       pcent,
       interpret,
       series,
       intake_group_id)
    values
      (pi_vEncounterID,
       pi_nEncIntakeID,
       v_nIntScoreID,
       pi_nMID,
       pi_nScoreType,
       pi_nScore,
       pi_nPCent,
       pi_vInterpret,
       pi_nSeries,
       pi_nIntakeGroup);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.InsertEncIntakeScore(): ' || sqlErrm;
  end;

  -- ************************************************************************
  -- Get Patient Intake scores

  procedure GetPatIntakeScoresRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vPatientID in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2,
                                 rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t1.*,
             t2.module,
             (select to_date(to_char(max(e.response_datetime), 'mm/dd/yyyy'),
                             'mm/dd/yyyy')
                from encounter_intake_responses e
               where e.encounter_id = t1.encounter_id
                 and e.mid = t1.mid
                 and e.encounter_intake_id = t1.encounter_intake_id) as intake_date
        from encounter_intake_score t1, intake_module t2
       where t2.mid = t1.mid
         and t1.encounter_id in
             (select encounter_id
                from encounter e
               where e.patient_id = pi_vPatientID);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetPatIntakeScoresRS(): ' || sqlErrm;
  end;

  -- *******************************************************
  -- GET INTAKE REPORT
  procedure GetIntakeReport(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            
                            pi_vEncounterID in varchar2,
                            pi_nEncIntakeID in number,
                            
                            po_nStatusCode    out number,
                            po_vStatusComment out varchar2,
                            rs                out RetRefCursor) is
  
    v_clobReport clob := '';
    v_bHeader    boolean := true;
    v_nQID       number := 0;
    v_nTID       number := 0;
  
    v_nMID number := -1;
  
    -- report sections
    v_vHeader      varchar2(4000) := '';
    v_vModuleTitle varchar2(4000) := '';
  
    v_nCountScore number := 0;
    v_vScoreHTML  varchar2(32767) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get module id
    select distinct mid
      into v_nMID
      from encounter_intake_responses t
     where t.encounter_id = pi_vEncounterID
       and t.encounter_intake_id = pi_nEncIntakeID;
  
    if v_nMID > 0 then
      select module
        into v_vModuleTitle
        from intake_module m
       where m.mid = v_nMID;
    
      v_vHeader := v_vHeader || '<h2>' || v_vModuleTitle || '</h2>' ||
                   chr(10);
    
    end if;
  
    -- get score and interpretaion
    select count(*)
      into v_nCountScore
      from encounter_intake_score t
     where t.encounter_id = pi_vEncounterID
       and t.encounter_intake_id = pi_nEncIntakeID
       and t.mid = v_nMID;
  
    if v_nCountScore > 0 then
      v_vScoreHTML := '<table style="margin:10px; border:1px solid #d1d1d1; border-collapse:collapse;">' ||
                      '<thead>' ||
                      '<th style="border:1px solid #d1d1d1; font-weight:bold; padding:5px;">Score</th>' ||
                      '<th style="border:1px solid #d1d1d1; font-weight:bold; padding:5px;">Interpretation</th>' ||
                      '</thead><tbody>';
    
      for rec in (select to_char(t.score) as score,
                         nvl(t.interpret, 'NA') as interpret
                    from encounter_intake_score t
                   where t.encounter_id = pi_vEncounterID
                     and t.encounter_intake_id = pi_nEncIntakeID
                     and t.mid = v_nMID) loop
        v_vScoreHTML := v_vScoreHTML || '<tr>' ||
                        '<td style="border:1px solid #d1d1d1; padding:3px;">' ||
                        rec.score || '</td>' ||
                        '<td style="border:1px solid #d1d1d1; padding:3px;">' ||
                        rec.interpret || '</td>' || '</tr>';
      end loop;
    
      v_vScoreHTML := v_vScoreHTML || '</tbody></table>';
    end if;
  
    v_clobReport := v_clobReport || '<div class="intake-report">' ||
                    chr(10);
  
    v_clobReport := v_clobReport || v_vHeader || chr(10);
  
    -- print interpretation, if there is any
    v_clobReport := v_clobReport || v_vScoreHTML || chr(10);
  
    for rec in (select t.*, q.question
                  from encounter_intake_responses t, intake_question q
                 where t.encounter_id = pi_vEncounterID
                   and t.encounter_intake_id = pi_nEncIntakeID
                   and t.mid = v_nMID
                   and q.qid = t.qid
                   and q.tid = t.tid
                   and q.mid = t.mid
                   and t.response_value is not null
                 order by t.mid, t.tid, t.qid, t.rid)
    
     loop
    
      --print the question
      if ((rec.qid != v_nQID) or (rec.tid != v_nTID)) then
        v_bHeader := true;
        v_nQID    := rec.qid;
        v_nTID    := rec.tid;
      else
        v_bHeader := false;
      end if;
    
      if v_bHeader then
        v_clobReport := v_clobReport || chr(10) || '<h4>' || rec.question ||
                        '</h4>' || chr(10);
      end if;
    
      v_clobReport := v_clobReport || chr(9) ||
                      '<span class="intake-response">' ||
                      rec.response_value || '</span>' || chr(10);
    
    end loop;
  
    v_clobReport := v_clobReport || '</div">' || chr(10);
  
    open rs for
      select v_clobReport as report_text from dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetIntakeReport(): ' || sqlErrm;
  end;

  procedure GetIntakeReportCSVRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vEncounterID     in varchar2,
                                 pi_nEncIntakeID     in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
    v_vSQL varchar2(32767) := 'select m.module, q.question, r.response_value
         from encounter_intake_responses r, intake_question q, intake_module m
        where r.mid = m.mid
          and r.mid = q.mid
          and r.tid = q.tid
          and r.qid = q.qid
          and r.encounter_id = :Eid
          and r.encounter_intake_id = :Eiid
          and r.response_value is not null
     order by r.mid, r.tid, r.qid, r.rid';
  begin
    open rs for v_vSQL
      using pi_vEncounterID, pi_nEncIntakeID;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetIntakeReportCSVRS: ' || sqlErrm;
  end;

  procedure GetSymptomsFUResponsesRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor) is
  
    v_nEncIntID number := -1;
    v_nMID      number := 0;
  
  begin
    --get the latest intake_id for mid3019
    begin
      select max(r.encounter_intake_id)
        into v_nEncIntID
        from encounter_intake_responses r
       where r.mid = 3019
         and r.encounter_id in
             (select encounter_id
                from encounter e
               where e.patient_id = pi_vPatientID);
    
      if v_nEncIntID is null then
        v_nEncIntID := -1;
        v_nMID      := 0;
      else
        v_nMID := 3019;
      end if;
    
      if v_nEncIntID < 0 then
        select max(r.encounter_intake_id)
          into v_nEncIntID
          from encounter_intake_responses r
         where r.mid = 3018
           and r.encounter_id in
               (select encounter_id
                  from encounter e
                 where e.patient_id = pi_vPatientID);
      
        if v_nEncIntID is null then
          v_nEncIntID := -1;
          v_nMID      := 0;
        else
          v_nMID := 3018;
        end if;
      end if;
    
    exception
      when others then
        null;
    end;
  
    --get the responses dataset
    open rs for
      select *
        from encounter_intake_responses t
       where t.mid = v_nMID
         and t.encounter_id in
             (select encounter_id
                from encounter e
               where e.patient_id = pi_vPatientID)
         and t.encounter_intake_id = v_nEncIntID
       order by mid, tid, qid, rid;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetSymptomsFUResponsesRS(): ' ||
                           sqlErrm;
  end;

  PROCEDURE GetScoreDataStringRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor)
  
   IS
    v_vPatientID  VARCHAR2(50) := pi_vPatientID;
    v_nEncTypeID  NUMBER := 99;
    v_nMaxSeries  NUMBER := 1;
    v_nCurrSeries NUMBER := 1;
    v_nCurrMID    NUMBER := 0;
    v_dtRespDate  DATE := null;
    v_vLabel      VARCHAR2(32767) := NULL;
    v_vDATA       VARCHAR2(32767) := '';
    curEnc        RetRefCursor;
    CURSOR curMID IS
      SELECT DISTINCT mid
        FROM encounter_intake_score s
       WHERE s.encounter_id IN
             (SELECT encounter_id
                FROM encounter e
               WHERE e.patient_id = v_vPatientID
                 AND e.encounter_type_id = v_nEncTypeID)
       ORDER BY mid;
  BEGIN
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- open the string
    v_vDATA := v_vDATA || '[';
    FOR recMID IN curMID LOOP
      BEGIN
        SELECT MAX(series)
          INTO v_nMaxSeries
          FROM encounter_intake_score
         WHERE mid = recMID.mid
           AND encounter_id IN
               (SELECT encounter_id
                  FROM encounter e
                 WHERE e.patient_id = v_vPatientID
                   AND e.encounter_type_id = v_nEncTypeID);
      EXCEPTION
        WHEN OTHERS THEN
          v_nMaxSeries := 1;
      END;
      -- write segment: {"mid": ####, "mid_data": [
      v_vDATA := v_vDATA || '{"mid": ' || TO_CHAR(recMID.mid) ||
                 ', "mid_data": [';
      FOR n IN 1 .. v_nMaxSeries LOOP
        v_nCurrSeries := n;
        v_vDATA       := v_vDATA || '{"data": [';
        FOR recEnc IN (SELECT t1.*, t2.encounter_date
                         FROM encounter_intake_score t1, encounter t2
                        WHERE t2.encounter_id = t1.encounter_id
                          AND mid = recMID.mid
                          AND series = n
                          AND t2.encounter_id IN
                              (SELECT DISTINCT encounter_id
                                 FROM encounter
                                WHERE encounter_type_id = v_nEncTypeID
                                  AND patient_id = v_vPatientID)
                        ORDER BY t2.encounter_date, t1.encounter_intake_id) LOOP
          --get the date of the assessment not the encounter
          begin
            select max(r.response_datetime)
              into v_dtRespDate
              from encounter_intake_responses r
             where r.encounter_id = recEnc.Encounter_Id
               and r.mid = recEnc.mid
               and r.encounter_intake_id = recEnc.Encounter_Intake_Id;
          exception
            when others then
              v_dtRespDate := recEnc.Encounter_Date;
          end;
        
          --write the POINT data
          v_vDATA := v_vDATA || '["' || TO_CHAR(v_dtRespDate, 'mm/dd/yyyy') ||
                     '", "' || TO_CHAR(recEnc.score) || '"],';
          IF (recMID.mid IN (3016, 3020)) THEN
            IF recEnc.interpret IS NOT NULL THEN
              v_vLabel := recEnc.interpret;
            END IF;
          END IF;
        END LOOP;
        v_vDATA := SUBSTR(v_vDATA, 1, LENGTH(v_vDATA) - 1);
        v_vDATA := v_vDATA || ']';
        IF (v_vLabel IS NOT NULL OR LENGTH(v_vLabel) > 0) THEN
          v_vDATA  := v_vDATA || ', "label": "' || v_vLabel || '" ';
          v_vLabel := null;
        END IF;
        v_vDATA := v_vDATA || '},';
      END LOOP;
      -- close the string here
      v_vDATA := SUBSTR(v_vDATA, 1, LENGTH(v_vDATA) - 1);
      v_vDATA := v_vDATA || ']},';
    END LOOP;
    -- ******************************
    -- END OF LOOPS
    if LENGTH(v_vDATA) > 1 then
      v_vDATA := SUBSTR(v_vDATA, 1, LENGTH(v_vDATA) - 1);
    end if;
    v_vDATA := v_vDATA || ']';
    --dbms_output.put_line(v_vDATA);
  
    OPEN rs FOR
      SELECT v_vDATA AS mid_data FROM dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.GetScoreDataStringRS(): ' || sqlErrm;
  END;

end;
/

prompt
prompt Creating package body PCK_JOBS
prompt ==============================
prompt
create or replace package body PCK_JOBS is

  --private sp that logs the status of the job
  procedure LogJobStatus(pi_vJobName    in varchar2,
                         pi_nStatusCode in number,
                         pi_vStatus     in clob)
  
   is
  
  begin
  
    insert into fx_job_status
      (job_name, status_code, job_status)
    values
      (pi_vJobName, pi_nStatusCode, pi_vStatus);
    commit;
  
  exception
    when others then
      null;
    
  end;

  ----------------------------------------
  --import resmed data
  ----------------------------------------
  procedure ImportRESMEDData is
    v_vKey         varchar2(4000) := null;
    nStatusCode    number := 0;
    vStatusComment varchar2(4000) := '';
  
  begin
  
    --get the key
    sys.ic_utl_gk('DRDB', v_vKey);
  
    --return if key comes back empty
    if v_vKey is null then
      nStatusCode    := 1;
      vStatusComment := 'Retrieval of Key failed!';
    else
      --run the sp
      PCK_CPAP_IMPORT.ImportRESMEDData(v_vKey, nStatusCode, vStatusComment);
    end if;
  
    --log the status                                  
    LogJobStatus('PCK_CPAP_IMPORT.ImportRESMEDData',
                 nStatusCode,
                 vStatusComment);
  
    v_vKey := '';
  
  exception
    when others then
      nStatusCode    := 1;
      vStatusComment := sqlErrm;
      v_vKey         := '';
    
      --log the status                                  
      LogJobStatus('PCK_CPAP_IMPORT.ImportRESMEDData',
                   nStatusCode,
                   vStatusComment);
    
  end;

  ----------------------------------------
  --import philips data
  ----------------------------------------
  procedure ImportPhillipsData is
    v_vKey         varchar2(4000) := null;
    nStatusCode    number := 0;
    vStatusComment varchar2(4000) := '';
  
  begin
  
    --get the key
    sys.ic_utl_gk('DRDB', v_vKey);
  
    --return if key comes back empty
    if v_vKey is null then
      nStatusCode    := 1;
      vStatusComment := 'Retrieval of Key failed!';
    else
      --run the sp
      PCK_CPAP_IMPORT.ImportPhilipsData(v_vKey,
                                        nStatusCode,
                                        vStatusComment);
    end if;
  
    --log the status                                  
    LogJobStatus('PCK_CPAP_IMPORT.ImportPhilipsData',
                 nStatusCode,
                 vStatusComment);
  
    v_vKey := '';
  
  exception
    when others then
      nStatusCode    := 1;
      vStatusComment := sqlErrm;
      v_vKey         := '';
    
      --log the status                                  
      LogJobStatus('PCK_CPAP_IMPORT.ImportPhilipsData',
                   nStatusCode,
                   vStatusComment);
    
  end;

  ----------------------------------------
  --send pataient reminder  
  ----------------------------------------
  procedure SendPatEventReminder is
    v_vKey         varchar2(4000) := '';
    nStatusCode    number := 0;
    vStatusComment varchar2(4000) := '';
  
  begin
  
    --get the key
    sys.ic_utl_gk('DRDB', v_vKey);
  
    --run the sp
    PCK_PATIENT_EVENTS.SendPatEventReminder(v_vKey,
                                            nStatusCode,
                                            vStatusComment);
  
    --log the status                                  
    LogJobStatus('PCK_PATIENT_EVENTS.SendPatEventReminder',
                 nStatusCode,
                 vStatusComment);
  
    v_vKey := '';
  
  exception
    when others then
      nStatusCode    := 1;
      vStatusComment := sqlErrm;
      v_vKey         := '';
    
      --log the status                                  
      LogJobStatus('PCK_PATIENT_EVENTS.SendPatEventReminder',
                   nStatusCode,
                   vStatusComment);
  end;

end;
/

prompt
prompt Creating package body PCK_MESSAGES
prompt ==================================
prompt
create or replace package body PCK_MESSAGES is

  --converted to use new encryption
  -- **************************************************************
  --  SEND EXTERNAL MESSAGE NOTIFICATION
  procedure SendExternalNotification(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vKey             in varchar2,
                                     pi_nMessageID       in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2) is
  
    curRecipient RetRefCursor;
    recRecipient message_recipient%rowtype;
  
    curPat RetRefCursor;
    --recPat patient_demographics%rowtype;
  
    curProvider RetRefCursor;
    recProvider suat_user%rowtype;
  
    --
  
    v_nSendEmail  number := 1;
    v_nSendTxtMsg number := 0;
  
    v_vEmailSubject varchar2(255) := 'Portal Message';
    v_vMsgText      varchar2(32767) := 'Please log into the portal, there is an important message waiting for you.  Thank you.';
    v_vEmailAddress varchar2(255) := null;
    v_vTxtMsgNumber varchar2(255) := null;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open curRecipient for
      select *
        from message_recipient t
       where t.message_id = pi_nMessageID
         and t.is_to = 1;
  
    loop
      fetch curRecipient
        into recRecipient;
      exit when curRecipient%notfound;
    
      for recPat in 
        (select t.PATIENT_ID
          from patient_demographics t
         where t.fx_user_id = recRecipient.Recipient_Id)
    
      loop
      
        -- ***************************************************************
        --get patient's messaging preferences
        Pck_Patient_Events.CheckPatMessagesPrefs(pi_vKey,
                                                 recPat.patient_id,
                                                 v_nSendTxtMsg,
                                                 v_nSendEmail);
      
        v_nSendEmail := 1;
      
        --get patient's contact info
    begin
      select REGEXP_REPLACE(t.CELLPHONE, '\D', '')
        into v_vTxtMsgNumber
        from patient_demographics t
       where t.patient_id = recPat.Patient_Id;
    exception
      when others then
        v_vTxtMsgNumber := null;
    end;
  
    begin
      select fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email
        into v_vEmailAddress
        from patient_demographics t
       where t.patient_id = recPat.Patient_Id;
    exception
      when others then
        v_vEmailAddress := null;
    end;
      
        --send external notification

          PRC_UTL_SEND_EMAIL_TEXT_MSG(pi_vEmailSender      => 'revamp-notifications@intellicacorp.com',
                                      pi_vEmailRecipients  => v_vEmailAddress,
                                      pi_vEmailSubject     => v_vEmailSubject,
                                      pi_vEmailMessage     => v_vMsgText,
                                      pi_vTextingRecipient => v_vTxtMsgNumber,
                                      pi_vTextingMessage   => v_vMsgText);
      
        -- ***************************************************************
      
      end loop;
    
      open curProvider for
        select *
          from suat_user t
         where t.fx_user_id = recRecipient.Recipient_Id;
    
      loop
        fetch curProvider
          into recProvider;
        exit when curProvider%notfound;
      
        -- ***************************************************************
        if recProvider.Email is not null then
          PRC_UTL_SEND_EMAIL_TEXT_MSG(pi_vEmailSender      => 'revamp-notifications@intellicacorp.com',
                                      pi_vEmailRecipients  => recProvider.Email,
                                      pi_vEmailSubject     => v_vEmailSubject,
                                      pi_vEmailMessage     => v_vMsgText,
                                      pi_vTextingRecipient => recProvider.Phone,
                                      pi_vTextingMessage   => v_vMsgText);
        end if;
        -- ***************************************************************
      
      end loop;
      close curProvider;
    
    end loop;
    close curRecipient;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.SendExternalNotification(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  function fGetRecipientsList(pi_vKey in varchar2, pi_nMessageID varchar2)
    return varchar2 is
    curRecipients PCK_COMMON.RefCursor;
    strText       varchar2(32767) := '';
    strRecipients varchar2(32767) := '';
  begin
    open curRecipients for
      select r.recipient
        from (select fx_user_id, t1.name as recipient
                from suat_user t1
              union
              select fx_user_id,
                     (fnc_utl_decstr(t2.LAST_NAME, pi_vKey, t2.PATIENT_ID) || ', ' ||
                     fnc_utl_decstr(t2.FIRST_NAME, pi_vKey, t2.PATIENT_ID)) as recipient
                from patient_demographics t2
               where t2.fx_user_id is not null) r
       where r.fx_user_id in
             (select distinct recipient_id
                from message_recipient t
               where t.is_sender = 0
                 and t.is_to = 1
                 and t.message_id = pi_nMessageID);
  
    strRecipients := pck_common.join(curRecipients, ' ; ');
  
    close curRecipients;
  
    return strRecipients;
  
  end fGetRecipientsList;

  --converted to use new encryption
  procedure GetProviderPatientsRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vKey             in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
  
    v_vDIMSID varchar2(50) := '-1';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select nvl(t.dims_id, '-1')
      into v_vDIMSID
      from suat_user t
     where t.fx_user_id = pi_nUserID;
  
    open rs for
      select p.PATIENT_ID,
             fnc_utl_decstr(p.FIRST_NAME, pi_vKey, p.PATIENT_ID) as first_name,
             fnc_utl_decstr(p.MI, pi_vKey, p.PATIENT_ID) as mi,
             fnc_utl_decstr(p.LAST_NAME, pi_vKey, p.PATIENT_ID) as last_name,
             fnc_utl_decstr(p.FMP, pi_vKey, p.PATIENT_ID) as fmp,
             fnc_utl_decstr(p.SPONSOR_SSN, pi_vKey, p.PATIENT_ID) as sponsor_ssn,
             fnc_utl_decstr(p.SSN, pi_vKey, p.PATIENT_ID) as ssn,
             mid(fnc_utl_decstr(p.last_name, pi_vKey, p.PATIENT_ID), 1, 1) ||
             mid(fnc_utl_decstr(p.ssn, pi_vKey, p.PATIENT_ID), 6, 9) as LNSSNLAST4,
             fnc_utl_decstr(p.GENDER, pi_vKey, p.PATIENT_ID) as gender,
             p.MARITAL_STATUS_ID,
             to_date(fnc_utl_decstr(p.dob, pi_vKey, p.PATIENT_ID),
                     'MM/DD/YYYY') as dob,
             p.HAS_FIRARM,
             p.EDUCATION_LEVEL_ID,
             p.PROVIDER_ID,
             p.ADDRESS1,
             p.ADDRESS2,
             p.CITY,
             p.POSTAL_CODE,
             p.HOMEPHONE,
             p.CELLPHONE,
             p.WORKPHONE,
             fnc_utl_decstr(p.EMAIL, pi_vKey, p.PATIENT_ID) as email,
             p.STATE_ID,
             p.HAS_REFERAL,
             p.AWAITING_TRANSFER,
             p.TRANSFER_DMIS_ID,
             p.EDIPN,
             p.FX_USER_ID,
             p.LAST_UPDATED,
             p.LAST_UPDATED_BY,
             p.IS_HIGH_INTEREST,
             p.PORTAL_USER_ID,
             p.CURRENT_WEIGHT,
             p.CURRENT_HEIGHT,
             p.WRK_PHONE_CALL,
             p.HOME_PHONE_CALL,
             p.HOME_PHONE_MSG,
             p.CELL_PHONE_CALL,
             p.EMAIL_MSG,
             p.DEVICE_ID,
             GetPatientBMI(p.patient_id) as BMI,
             trunc(months_between(SYSDATE,
                                  to_date(fnc_utl_decstr(p.dob,
                                                         pi_vKey,
                                                         p.PATIENT_ID),
                                          'MM/DD/YYYY')) / 12) as patient_age,
             (fnc_utl_decstr(p.LAST_NAME, pi_vKey, p.PATIENT_ID) || ', ' ||
             fnc_utl_decstr(p.FIRST_NAME, pi_vKey, p.PATIENT_ID)) as patient_name
        from patient_demographics p
       where p.provider_id in
             (select s.provider_id
                from suat_user s
               where s.dims_id = v_vDIMSID)
       order by patient_name;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetProviderPatientsRS(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  procedure SendMessage(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        
                        pi_vKey        in varchar2,
                        pi_vRecipients in varchar2,
                        pi_vSubject    in varchar2,
                        pi_clobBody    in clob,
                        
                        po_nMessageID     out number,
                        po_nStatusCode    out number,
                        po_vStatusComment out varchar2) is
  
    v_vSenderName varchar2(128) := '';
    v_nMessageID  number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get sender's name from user id
    select recipient
      into v_vSenderName
      from (select fx_user_id, t1.name as recipient
              from suat_user t1
            union
            select fx_user_id,
                   (fnc_utl_decstr(t2.LAST_NAME, pi_vKey, t2.PATIENT_ID) || ', ' ||
                   fnc_utl_decstr(t2.FIRST_NAME, pi_vKey, t2.PATIENT_ID)) as recipient
              from patient_demographics t2
             where t2.fx_user_id is not null) r
     where r.fx_user_id = pi_nUserID;
  
    --get message id from sequence
    select seqmsgid.nextval into v_nMessageID from dual;
  
    --insert message contents
    insert into message_contents
      (message_id, from_usr_id, subject, body, date_sent, sender_name)
    values
      (v_nMessageID,
       pi_nUserID,
       pi_vSubject,
       pi_clobBody,
       sysdate,
       v_vSenderName);
    commit;
  
    --insert message for sender
    insert into message_recipient
      (message_id,
       recipient_id,
       is_to,
       is_cc,
       is_bcc,
       unread,
       deleted,
       is_sender)
    values
      (v_nMessageID, pi_nUserID, 0, 0, 0, 0, 0, 1);
    commit;
  
    --bulk inser message for recipients
    BulkSendMessages(pi_vSessionID       => pi_vSessionID,
                     pi_vSessionClientIP => pi_vSessionClientIP,
                     pi_nUserID          => pi_nUserID,
                     pi_nMessageID       => v_nMessageID,
                     pi_vRecipient       => pi_vRecipients,
                     pi_vSubject         => pi_vSubject,
                     pi_clobBody         => pi_clobBody,
                     po_nStatusCode      => po_nStatusCode,
                     po_vStatusComment   => po_vStatusComment);
  
    po_nMessageID := v_nMessageID;
  
    --send external notification
    SendExternalNotification(pi_vSessionID,
                             pi_vSessionClientIP,
                             pi_nUserID,
                             pi_vKey,
                             v_nMessageID,
                             po_nStatusCode,
                             po_vStatusComment);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.SendMessage(): ' || sqlErrm;
  end;

  procedure GetUserMessagesRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vKey             in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t1.message_id,
             t1.from_usr_id,
             htf.escape_sc(t1.subject) as subject,
             htf.escape_sc(t1.body) as body,
             t1.date_sent,
             t1.sender_name,
             t2.*,
             fGetRecipientsList(pi_vKey, t1.message_id) as recipients
      
        from message_contents t1, message_recipient t2
       where t2.message_id = t1.message_id
         and t2.recipient_id = pi_nUserID
         and (t2.is_to = 1 or t2.is_cc = 1 or t2.is_bcc = 1)
         and t2.is_sender = 0
         and t2.deleted = 0
       order by t1.date_sent desc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetUserMessagesRS(): ' || sqlErrm;
  end;

  procedure GetUnreadMessagesRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from message_recipient t2
       where t2.recipient_id = pi_nUserID
         and (t2.is_to = 1 or t2.is_cc = 1 or t2.is_bcc = 1)
         and t2.is_sender = 0
         and t2.deleted = 0
         and t2.unread = 1;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetUnreadMessagesRS(): ' ||
                           sqlErrm;
  end;

  procedure GetDeletedMessagesRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t1.*,
             t2.*,
             fGetRecipientsList(pi_vKey, t1.message_id) as recipients
      
        from message_contents t1, message_recipient t2
       where t2.message_id = t1.message_id
         and t2.recipient_id = pi_nUserID
         and t2.deleted = 1
       order by t1.date_sent desc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetDeletedMessagesRS(): ' ||
                           sqlErrm;
  end;

  procedure GetSentMessagesRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vKey             in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t1.*, t2.*
        from (select s1.*,
                     PCK_MESSAGES.fGetRecipientsList(pi_vKey, s1.message_id) as recipients
                from message_recipient s1
               where s1.recipient_id = pi_nUserID
                 and (s1.is_to = 0 and s1.is_sender = 1)
                 and s1.deleted = 0) t1
      
        left join (select * from message_contents) t2
          on t2.message_id = t1.message_id
       order by t2.date_sent desc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetSentMessagesRS(): ' || sqlErrm;
  end;

  procedure GetRecipientsListRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nMessageID       in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.recipient_id
        from message_recipient t
       where t.message_id = pi_nMessageID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetRecipientsListRS(): ' ||
                           sqlErrm;
  end;
 
  procedure MarkAsRead(pi_vSessionID       in varchar2,
                       pi_vSessionClientIP in varchar2,
                       pi_nUserID          in number,
                       pi_nMessageID       in number,
                       po_nStatusCode      out number,
                       po_vStatusComment   out varchar2) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update message_recipient t
       set t.unread = 0
     where t.message_id = pi_nMessageID
       and t.recipient_id = pi_nUserID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.MarkAsRead(): ' || sqlErrm;
  end;

  procedure MarkAsDeleted(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_nMessageID       in number,
                          pi_nIsSentMsg       in number,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update message_recipient t
       set t.deleted = 1
     where t.message_id = pi_nMessageID
       and t.recipient_id = pi_nUserID
       and t.is_sender = pi_nIsSentMsg;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.MarkAsDeleted(): ' || sqlErrm;
  end;
  
  procedure GetAllProviderRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2,
                             rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from suat_user s
       where s.fx_user_id in
             (select fx_user_id from fx_user_rights t where t.user_type = 1)
       order by s.name;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MESSAGES.GetAllProviderRS(): ' || sqlErrm;
  end;

  procedure BulkSendMessages(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_nMessageID in number,
                             pi_vRecipient in varchar2,
                             pi_vSubject   in varchar2,
                             pi_clobBody   in clob,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2) is
  
    v_vRecDelim   varchar2(1) := ',';
    v_nRecPos     number := 0;
    v_nPrevRecPos number := 0;
    v_vRecord     varchar2(32767) := '';
    v_vColumn     varchar2(32767) := '';
    --
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    if ((pi_vRecipient is null) or (LENGTH(pi_vRecipient) < 2)) then
      return;
    end if;
  
    --split records
    loop
      v_nRecPos := INSTR(pi_vRecipient, v_vRecDelim, v_nRecPos + 1);
      exit when v_nRecPos = 0;
      v_vRecord     := substr(pi_vRecipient,
                              v_nPrevRecPos + 1,
                              v_nRecPos - v_nPrevRecPos - 1);
      v_nPrevRecPos := v_nRecPos;
    
      --insert message
      insert into message_recipient
        (message_id,
         recipient_id,
         is_to,
         is_cc,
         is_bcc,
         unread,
         deleted,
         is_sender)
      values
        (pi_nMessageID, to_number(v_vRecord), 1, 0, 0, 1, 0, 0);
      commit;
    
    end loop;
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_MESSAGES.BulkSendMessages(): ' || sqlCode || ': ' ||
                           sqlErrm;
    
  end;

end PCK_MESSAGES;
/

prompt
prompt Creating package body PCK_MILITARY
prompt ==================================
prompt
create or replace package body PCK_MILITARY is

  --get a record set
  procedure GetMilitaryServiceRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
   
    --open recordset
    open rs for
      select * from stat_military_service t where active = 1;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MILITARY.GetMilitaryServiceRS(): ' ||
                           sqlErrm;
  end;

  procedure GetMilitaryDutyStationRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor) is
    v_vSQL          long := '';
    v_bMAJCOMRights boolean := false;
    v_bHQRights     boolean := false;
    v_nDIMS_ID      number := 0;
    v_nMAJCOM_ID    number := 0;
  begin
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    -- get base id
    begin
      select t.dims_id
        into v_nDIMS_ID
        from suat_user t
       where t.fx_user_id = pi_nUserID;
    exception
      when others then
        null;
    end;
  
    -- build sql
    v_vSQL := 'select distinct t.* ';
    v_vSQL := v_vSQL || 'from stat_dims_base t ';
    v_vSQL := v_vSQL || 'where t.active = 1 ';
    v_vSQL := v_vSQL || ' order by t.sort_order';
  
    --open recordset
    open rs for v_vSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_MILITARY.GetMilitaryDutyStationRS(): ' ||
                           sqlErrm;
  end;

end PCK_MILITARY;
/

prompt
prompt Creating package body PCK_NOTE_PREFILL
prompt ======================================
prompt
create or replace package body PCK_NOTE_PREFILL is

  function fnGetQuestionResponse(pi_vPatientID in varchar2,
                                 pi_nMID       in number,
                                 pi_nTID       in number,
                                 pi_nQID       in number,
                                 pi_nModGroup  in number) return varchar2 is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
    v_nQID       number;
  
    v_nCount          number := 0;
    v_vResponse       varchar2(32767) := '_______________';
    po_vResponseValue varchar2(32767);
  
    rs RetRefCursor;
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
    v_nTID       := pi_nTID;
    v_nQID       := pi_nQID;
  
    for rec in (select *
                  from (select e.patient_id, r.*
                          from encounter_intake_responses r, encounter e
                         where e.encounter_id = r.encounter_id
                           and e.patient_id = v_vPatientID
                           and r.intake_group_id = v_nGroup
                           and r.mid = v_nMID
                           and r.tid = v_nTID
                           and r.qid = v_nQID
                         order by r.response_datetime desc) t
                 where ROWNUM < 2) loop
      if rec.response_value is not null then
        v_vResponse := rec.response_value;
      end if;
    end loop;
  
    po_vResponseValue := v_vResponse;
    return po_vResponseValue;
  
  exception
    when others then
      return po_vResponseValue;
  end;

  function fnGetQuestionScore(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nTID       in number,
                              pi_nQID       in number,
                              pi_nModGroup  in number) return varchar2 is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
    v_nQID       number;
  
    v_nCount          number := 0;
    v_vResponse       varchar2(32767) := '____';
    po_vResponseValue varchar2(32767);
  
    rs RetRefCursor;
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
    v_nTID       := pi_nTID;
    v_nQID       := pi_nQID;
  
    for rec in (select *
                  from (select e.patient_id, r.*
                          from encounter_intake_responses r, encounter e
                         where e.encounter_id = r.encounter_id
                           and e.patient_id = v_vPatientID
                           and r.intake_group_id = v_nGroup
                           and r.mid = v_nMID
                           and r.tid = v_nTID
                           and r.qid = v_nQID
                         order by r.response_datetime desc) t
                 where ROWNUM < 2) loop
      if rec.response_value is not null then
        v_vResponse := rec.score_value;
      end if;
    end loop;
  
    po_vResponseValue := v_vResponse;
    return po_vResponseValue;
  
  exception
    when others then
      return po_vResponseValue;
  end;

  function fnGetQuestionResponseList(pi_vPatientID in varchar2,
                                     pi_nMID       in number,
                                     pi_nTID       in number,
                                     pi_nQID       in number,
                                     pi_nModGroup  in number) return varchar2 is
  
    v_vPatientID   varchar2(50);
    v_nGroup       number;
    v_nMID         number;
    v_nTID         number;
    v_nQID         number;
    v_nEncIntakeID number := null;
  
    v_nCount          number := 0;
    v_vResponse       varchar2(32767) := '';
    po_vResponseValue varchar2(32767);
  
    rs RetRefCursor;
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
    v_nTID       := pi_nTID;
    v_nQID       := pi_nQID;
  
    --get most recent encounter_intake_id
    for rec in (select *
                  from (select e.patient_id, r.*
                          from encounter_intake_responses r, encounter e
                         where e.encounter_id = r.encounter_id
                           and e.patient_id = v_vPatientID
                           and r.intake_group_id = v_nGroup
                           and r.mid = v_nMID
                           and r.tid = v_nTID
                           and r.qid = v_nQID
                         order by r.response_datetime desc) t
                 where ROWNUM < 2) loop
      if rec.encounter_intake_id is not null then
        v_nEncIntakeID := rec.encounter_intake_id;
      end if;
    end loop;
  
    if v_nEncIntakeID is not null then
      for rec in (select *
                    from (select e.patient_id, r.*
                            from encounter_intake_responses r, encounter e
                           where e.encounter_id = r.encounter_id
                             and e.patient_id = v_vPatientID
                             and r.intake_group_id = v_nGroup
                             and r.mid = v_nMID
                             and r.tid = v_nTID
                             and r.qid = v_nQID
                             and r.encounter_intake_id = v_nEncIntakeID
                           order by r.response_datetime desc) t) loop
        if rec.encounter_intake_id is not null then
          v_vResponse := v_vResponse || chr(9) || rec.response_value || chr(10);
        end if;
      end loop;
    end if;
  
    po_vResponseValue := v_vResponse;
    return po_vResponseValue;
  
  exception
    when others then
      return po_vResponseValue;
  end;

  function fnGetResponseByID(pi_vPatientID in varchar2,
                             pi_nMID       in number,
                             pi_nTID       in number,
                             pi_nQID       in number,
                             pi_nRID       in number,
                             pi_nModGroup  in number) return varchar2 is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
    v_nQID       number;
    v_nRID       number;
  
    v_nCount          number := 0;
    v_vResponse       varchar2(32767) := '_______________';
    po_vResponseValue varchar2(32767);
  
    rs RetRefCursor;
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
    v_nTID       := pi_nTID;
    v_nQID       := pi_nQID;
    v_nRID       := pi_nRID;
  
    for rec in (select *
                  from (select e.patient_id, r.*
                          from encounter_intake_responses r, encounter e
                         where e.encounter_id = r.encounter_id
                           and e.patient_id = v_vPatientID
                           and r.intake_group_id = v_nGroup
                           and r.mid = v_nMID
                           and r.tid = v_nTID
                           and r.qid = v_nQID
                           and r.rid = v_nRID
                         order by r.response_datetime desc) t
                 where ROWNUM < 2) loop
      if rec.response_value is not null then
        v_vResponse := rec.response_value;
      end if;
    end loop;
  
    po_vResponseValue := v_vResponse;
    return po_vResponseValue;
  
  exception
    when others then
      return po_vResponseValue;
  end;

  function fnHasResponse(pi_vPatientID in varchar2,
                         pi_nMID       in number,
                         pi_nTID       in number,
                         pi_nQID       in number,
                         pi_nModGroup  in number) return number is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
    v_nQID       number;
  
    v_nCount number := 0;
  
    rs RetRefCursor;
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
    v_nTID       := pi_nTID;
    v_nQID       := pi_nQID;
  
    begin
      select count(*)
        into v_nCount
        from (select e.patient_id, r.*
                from encounter_intake_responses r, encounter e
               where e.encounter_id = r.encounter_id
                 and e.patient_id = v_vPatientID
                 and r.intake_group_id = v_nGroup
                 and r.mid = v_nMID
                 and r.tid = v_nTID
                 and r.qid = v_nQID
               order by r.response_datetime desc) t;
    exception
      when others then
        return 0;
    end;
    return v_nCount;
  exception
    when others then
      return v_nCount;
  end;

  function fnHasResponseByID(pi_vPatientID in varchar2,
                             pi_nMID       in number,
                             pi_nTID       in number,
                             pi_nQID       in number,
                             pi_nRID       in number,
                             pi_nModGroup  in number) return number is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
    v_nQID       number;
    v_nRID       number;
  
    v_nCount number := 0;
  
    rs RetRefCursor;
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
    v_nTID       := pi_nTID;
    v_nQID       := pi_nQID;
    v_nRID       := pi_nRID;
  
    begin
      select count(*)
        into v_nCount
        from (select e.patient_id, r.*
                from encounter_intake_responses r, encounter e
               where e.encounter_id = r.encounter_id
                 and e.patient_id = v_vPatientID
                 and r.intake_group_id = v_nGroup
                 and r.mid = v_nMID
                 and r.tid = v_nTID
                 and r.qid = v_nQID
                 and r.rid = v_nRID
               order by r.response_datetime desc) t;
    exception
      when others then
        return 0;
    end;
    return v_nCount;
  exception
    when others then
      return v_nCount;
  end;

  function fnGetScore(pi_vPatientID in varchar2,
                      pi_nMID       in number,
                      pi_nModGroup  in number,
                      pi_nInterpret in number) return varchar2 is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
  
    v_nCount       number := 0;
    v_vResponse    varchar2(32767) := ' ';
    v_vEncounterID varchar2(50) := '-1';
  
    po_vResponseValue varchar2(32767);
  
    rs RetRefCursor;
  
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
  
    --get encounter_id for the questionnaire
    for rec in (select *
                  from (select e.patient_id, r.*
                          from encounter_intake_responses r, encounter e
                         where e.encounter_id = r.encounter_id
                           and e.patient_id = v_vPatientID
                           and r.intake_group_id = v_nGroup
                           and r.mid = v_nMID
                         order by r.response_datetime desc) t
                 where ROWNUM < 2) loop
      v_vEncounterID := rec.encounter_id;
    end loop;
  
    --get score 
    for rec in (select *
                  from (select *
                          from encounter_intake_score
                         where encounter_id = v_vEncounterID
                           and mid = v_nMID
                           and intake_group_id = v_nGroup
                         order by encounter_intake_id desc, series) t
                 where ROWNUM < 2) loop
      if rec.score is not null then
        v_vResponse := to_char(rec.score);
        if pi_nInterpret > 0 then
          v_vResponse := v_vResponse || ' ' || rec.interpret;
        end if;
      else
        v_vResponse := '____________';
      end if;
    end loop;
  
    po_vResponseValue := v_vResponse;
    return po_vResponseValue;
  
  exception
    when others then
      return po_vResponseValue;
  end;

  function fnGetScoreData(pi_vPatientID in varchar2,
                          pi_nMID       in number,
                          pi_nModGroup  in number,
                          pi_nInterpret in number) return varchar2 is
  
    v_vPatientID varchar2(50);
    v_nGroup     number;
    v_nMID       number;
    v_nTID       number;
  
    v_nCount       number := 0;
    v_vResponse    varchar2(32767) := '____________';
    v_vEncounterID varchar2(50) := '-1';
  
    v_vScoreDate varchar2(50) := '-1';
  
    po_vResponseValue varchar2(32767);
  
    rs RetRefCursor;
  
  begin
    v_vPatientID := pi_vPatientID;
    v_nGroup     := pi_nModGroup;
    v_nMID       := pi_nMID;
  
    --get encounter_id for the questionnaire
    for rec in (select *
                  from (select e.patient_id, r.*
                          from encounter_intake_responses r, encounter e
                         where e.encounter_id = r.encounter_id
                           and e.patient_id = v_vPatientID
                           and r.intake_group_id = v_nGroup
                           and r.mid = v_nMID
                         order by r.response_datetime desc) t
                 where ROWNUM < 2) loop
      v_vEncounterID := rec.encounter_id;
      v_vScoreDate   := to_char(rec.response_datetime, 'mm/dd/yyyy');
    end loop;
  
    --get score 
    for rec in (select *
                  from (select *
                          from encounter_intake_score
                         where encounter_id = v_vEncounterID
                           and mid = v_nMID
                           and intake_group_id = v_nGroup
                         order by encounter_intake_id desc, series) t
                 where ROWNUM < 2) loop
      if rec.score is not null then
        v_vResponse := to_char(rec.score);
        if pi_nInterpret > 0 then
          v_vResponse := v_vResponse || ' ' || rec.interpret;
        end if;
        v_vResponse := v_vResponse || '; ' || v_vScoreDate;
      else
        v_vResponse := '____________';
      end if;
    end loop;
  
    po_vResponseValue := v_vResponse;
    return po_vResponseValue;
  
  exception
    when others then
      return po_vResponseValue;
  end;

  function fnGet1MOTxSymptoms(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nGroup1    in number,
                              pi_nGroup2    in number) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
    v_nMID       number := pi_nMID;
    v_nGroup1    number := pi_nGroup1;
    v_nGroup2    number := pi_nGroup2;
    v_vData      varchar2(32767) := '';
    v_nHeader    number := 0;
  
  begin
  
    v_vData := v_vData || 'SYMPTOMS:' || chr(10) || chr(10);
    for rec in (select *
                  from (select e.patient_id, i.response as symptom, t.*
                          from encounter_intake_responses t,
                               encounter                  e,
                               intake_response            i
                         where e.encounter_id = t.encounter_id
                           and i.mid = t.mid
                           and i.tid = t.tid
                           and i.qid = t.qid
                           and i.rid = t.rid
                           and e.patient_id = v_vPatientID
                           and t.intake_group_id = v_nGroup1
                           and t.mid = v_nMID
                           and (t.rid >= 6002 and t.rid <= 6052)
                         order by t.response_time desc) r
                 where ROWNUM < 6) loop
      if v_nHeader = 0 then
        v_vData   := v_vData || rec.symptom || chr(10);
        v_nHeader := 1;
      end if;
      for rec2 in (select *
                     from (select e.patient_id, i.response as symptom, t.*
                             from encounter_intake_responses t,
                                  encounter                  e,
                                  intake_response            i
                            where e.encounter_id = t.encounter_id
                              and i.mid = t.mid
                              and i.tid = t.tid
                              and i.qid = t.qid
                              and i.rid = t.rid
                              and e.patient_id = v_vPatientID
                              and t.intake_group_id = v_nGroup2
                              and t.mid = v_nMID
                              and t.rid = rec.rid
                            order by t.response_time desc) r
                    where ROWNUM < 2) loop
        v_vData := v_vData || chr(9) || '1-Week rating: ' ||
                   rec2.response_value || chr(10);
        v_vData := v_vData || chr(9) || 'Current rating: ' ||
                   rec.response_value || chr(10);
      end loop;
      v_vData   := v_vData || chr(10);
      v_nHeader := 0;
    end loop;
  
    return v_vData;
  
  exception
    when others then
      return v_vData;
  end;

  function fnGet1MOOSASymptoms(pi_vPatientID in varchar2,
                               pi_nMID       in number,
                               pi_nGroup1    in number,
                               pi_nGroup2    in number) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
    v_nMID       number := pi_nMID;
    v_nGroup1    number := pi_nGroup1;
    v_nGroup2    number := pi_nGroup2;
    v_vData      varchar2(32767) := '';
    v_nHeader    number := 0;
  
  begin
  
    v_vData := v_vData || 'SYMPTOMS:' || chr(10) || chr(10);
    for rec in (select *
                  from (select e.patient_id, i.response as symptom, t.*
                          from encounter_intake_responses t,
                               encounter                  e,
                               intake_response            i
                         where e.encounter_id = t.encounter_id
                           and i.mid = t.mid
                           and i.tid = t.tid
                           and i.qid = t.qid
                           and i.rid = t.rid
                           and e.patient_id = v_vPatientID
                           and t.intake_group_id = v_nGroup1
                           and t.mid = v_nMID
                           and (t.rid >= 2002 and t.rid <= 2042)
                         order by t.response_time desc) r
                 where ROWNUM < 6) loop
      if v_nHeader = 0 then
        v_vData   := v_vData || rec.symptom || chr(10);
        v_nHeader := 1;
      end if;
      for rec2 in (select *
                     from (select e.patient_id, i.response as symptom, t.*
                             from encounter_intake_responses t,
                                  encounter                  e,
                                  intake_response            i
                            where e.encounter_id = t.encounter_id
                              and i.mid = t.mid
                              and i.tid = t.tid
                              and i.qid = t.qid
                              and i.rid = t.rid
                              and e.patient_id = v_vPatientID
                              and t.intake_group_id = v_nGroup2
                              and t.mid = v_nMID
                              and t.rid = rec.rid
                            order by t.response_time desc) r
                    where ROWNUM < 2) loop
        v_vData := v_vData || chr(9) || '1-Week rating: ' ||
                   rec2.response_value || chr(10);
        v_vData := v_vData || chr(9) || 'Current rating: ' ||
                   rec.response_value || chr(10);
      end loop;
      v_vData   := v_vData || chr(10);
      v_nHeader := 0;
    end loop;
  
    return v_vData;
  
  exception
    when others then
      return v_vData;
  end;

  -- **************************************************************
  function fnGet3MOTxSymptoms(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nGroup1    in number,
                              pi_nGroup2    in number) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
    v_nMID       number := pi_nMID;
    v_nGroup1    number := pi_nGroup1;
    v_nGroup2    number := pi_nGroup2;
    v_vData      varchar2(32767) := '';
    v_nHeader    number := 0;
  
  begin
  
    v_vData := v_vData || 'SYMPTOMS:' || chr(10) || chr(10);
    for rec in (select *
                  from (select e.patient_id, i.response as symptom, t.*
                          from encounter_intake_responses t,
                               encounter                  e,
                               intake_response            i
                         where e.encounter_id = t.encounter_id
                           and i.mid = t.mid
                           and i.tid = t.tid
                           and i.qid = t.qid
                           and i.rid = t.rid
                           and e.patient_id = v_vPatientID
                           and t.intake_group_id = v_nGroup1
                           and t.mid = v_nMID
                           and (t.rid >= 6002 and t.rid <= 6052)
                         order by t.response_time desc) r
                 where ROWNUM < 6) loop
      if v_nHeader = 0 then
        v_vData   := v_vData || rec.symptom || chr(10);
        v_nHeader := 1;
      end if;
      for rec2 in (select *
                     from (select e.patient_id, i.response as symptom, t.*
                             from encounter_intake_responses t,
                                  encounter                  e,
                                  intake_response            i
                            where e.encounter_id = t.encounter_id
                              and i.mid = t.mid
                              and i.tid = t.tid
                              and i.qid = t.qid
                              and i.rid = t.rid
                              and e.patient_id = v_vPatientID
                              and t.intake_group_id = v_nGroup2
                              and t.mid = v_nMID
                              and t.rid = rec.rid
                            order by t.response_time desc) r
                    where ROWNUM < 2) loop
        v_vData := v_vData || chr(9) || '1-Month rating: ' ||
                   rec2.response_value || chr(10);
        v_vData := v_vData || chr(9) || 'Current rating: ' ||
                   rec.response_value || chr(10);
      end loop;
      v_vData   := v_vData || chr(10);
      v_nHeader := 0;
    end loop;
  
    return v_vData;
  
  exception
    when others then
      return v_vData;
  end;

  function fnGet3MOOSASymptoms(pi_vPatientID in varchar2,
                               pi_nMID       in number,
                               pi_nGroup1    in number,
                               pi_nGroup2    in number) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
    v_nMID       number := pi_nMID;
    v_nGroup1    number := pi_nGroup1;
    v_nGroup2    number := pi_nGroup2;
    v_vData      varchar2(32767) := '';
    v_nHeader    number := 0;
  
  begin
  
    v_vData := v_vData || 'SYMPTOMS:' || chr(10) || chr(10);
    for rec in (select *
                  from (select e.patient_id, i.response as symptom, t.*
                          from encounter_intake_responses t,
                               encounter                  e,
                               intake_response            i
                         where e.encounter_id = t.encounter_id
                           and i.mid = t.mid
                           and i.tid = t.tid
                           and i.qid = t.qid
                           and i.rid = t.rid
                           and e.patient_id = v_vPatientID
                           and t.intake_group_id = v_nGroup1
                           and t.mid = v_nMID
                           and (t.rid >= 2002 and t.rid <= 2042)
                         order by t.response_time desc) r
                 where ROWNUM < 6) loop
      if v_nHeader = 0 then
        v_vData   := v_vData || rec.symptom || chr(10);
        v_nHeader := 1;
      end if;
      for rec2 in (select *
                     from (select e.patient_id, i.response as symptom, t.*
                             from encounter_intake_responses t,
                                  encounter                  e,
                                  intake_response            i
                            where e.encounter_id = t.encounter_id
                              and i.mid = t.mid
                              and i.tid = t.tid
                              and i.qid = t.qid
                              and i.rid = t.rid
                              and e.patient_id = v_vPatientID
                              and t.intake_group_id = v_nGroup2
                              and t.mid = v_nMID
                              and t.rid = rec.rid
                            order by t.response_time desc) r
                    where ROWNUM < 2) loop
        v_vData := v_vData || chr(9) || '1-Month rating: ' ||
                   rec2.response_value || chr(10);
        v_vData := v_vData || chr(9) || 'Current rating: ' ||
                   rec.response_value || chr(10);
      end loop;
      v_vData   := v_vData || chr(10);
      v_nHeader := 0;
    end loop;
  
    return v_vData;
  
  exception
    when others then
      return v_vData;
  end;

  -- **************************************************************

  function fnGet1WKTxSymptoms(pi_vPatientID in varchar2,
                              pi_nMID       in number,
                              pi_nGroup1    in number,
                              pi_nGroup2    in number) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
    v_nMID       number := pi_nMID;
    v_nGroup1    number := pi_nGroup1;
    v_nGroup2    number := pi_nGroup2;
    v_vData      varchar2(32767) := '';
    v_nHeader    number := 0;
  
  begin
  
    v_vData := v_vData || 'SYMPTOMS:' || chr(10) || chr(10);
    for rec in (select *
                  from (select e.patient_id, i.response as symptom, t.*
                          from encounter_intake_responses t,
                               encounter                  e,
                               intake_response            i
                         where e.encounter_id = t.encounter_id
                           and i.mid = t.mid
                           and i.tid = t.tid
                           and i.qid = t.qid
                           and i.rid = t.rid
                           and e.patient_id = v_vPatientID
                           and t.intake_group_id = v_nGroup1
                           and t.mid = v_nMID
                           and (t.rid >= 6002 and t.rid <= 6052)
                         order by t.response_time desc) r
                 where ROWNUM < 6) loop
      if v_nHeader = 0 then
        v_vData   := v_vData || rec.symptom || chr(10);
        v_nHeader := 1;
      end if;
      --v_vData := v_vData || chr(9) || '1-Week rating: ' || rec2.response_value || chr(10);
      v_vData := v_vData || chr(9) || 'Current rating: ' ||
                 rec.response_value || chr(10);
    
      /*
      for rec2 in (select *
                     from (select e.patient_id, i.response as symptom, t.*
                             from encounter_intake_responses t,
                                  encounter                  e,
                                  intake_response            i
                            where e.encounter_id = t.encounter_id
                              and i.mid = t.mid
                              and i.tid = t.tid
                              and i.qid = t.qid
                              and i.rid = t.rid
                              and e.patient_id = v_vPatientID
                              and t.intake_group_id = v_nGroup2
                              and t.mid = v_nMID
                              and t.rid = rec.rid
                            order by t.response_time desc) r
                    where ROWNUM < 2) loop
        --v_vData := v_vData || chr(9) || '1-Week rating: ' || rec2.response_value || chr(10);
        v_vData := v_vData || chr(9) || 'Current rating: ' ||
                   rec.response_value || chr(10);
      end loop;
      */
      v_vData   := v_vData || chr(10);
      v_nHeader := 0;
    end loop;
  
    return v_vData;
  
  exception
    when others then
      return v_vData;
  end;

  function fnGet1WKOSASymptoms(pi_vPatientID in varchar2,
                               pi_nMID       in number,
                               pi_nGroup1    in number,
                               pi_nGroup2    in number) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
    v_nMID       number := pi_nMID;
    v_nGroup1    number := pi_nGroup1;
    v_nGroup2    number := pi_nGroup2;
    v_vData      varchar2(32767) := '';
    v_nHeader    number := 0;
  
  begin
  
    v_vData := v_vData || 'SYMPTOMS:' || chr(10) || chr(10);
    for rec in (select *
                  from (select e.patient_id, i.response as symptom, t.*
                          from encounter_intake_responses t,
                               encounter                  e,
                               intake_response            i
                         where e.encounter_id = t.encounter_id
                           and i.mid = t.mid
                           and i.tid = t.tid
                           and i.qid = t.qid
                           and i.rid = t.rid
                           and e.patient_id = v_vPatientID
                           and t.intake_group_id = v_nGroup1
                           and t.mid = v_nMID
                           and (t.rid >= 2002 and t.rid <= 2042)
                         order by t.response_time desc) r
                 where ROWNUM < 6) loop
      if v_nHeader = 0 then
        v_vData   := v_vData || rec.symptom || chr(10);
        v_nHeader := 1;
      end if;
      for rec2 in (select *
                     from (select e.patient_id, i.response as symptom, t.*
                             from encounter_intake_responses t,
                                  encounter                  e,
                                  intake_response            i
                            where e.encounter_id = t.encounter_id
                                 --and i.mid = t.mid
                              and i.mid = t.mid
                              and i.tid = t.tid
                              and i.qid = t.qid
                              and i.rid = t.rid
                              and e.patient_id = v_vPatientID
                              and t.intake_group_id = 1
                              and t.mid = 3018
                              and t.rid = rec.rid
                            order by t.response_time desc) r
                    where ROWNUM < 2) loop
        v_vData := v_vData || chr(9) || 'Baseline rating: ' ||
                   rec2.response_value || chr(10);
        --v_vData := v_vData || chr(9) || 'Current rating: ' || rec.response_value || chr(10);
      end loop;
    
      v_vData := v_vData || chr(9) || 'Current rating: ' ||
                 rec.response_value || chr(10);
    
      v_vData   := v_vData || chr(10);
      v_nHeader := 0;
    end loop;
  
    return v_vData;
  
  exception
    when others then
      return v_vData;
  end;

  -- ***********************************************************************

  function fnPAPUsage(pi_vPatientID in varchar2) return varchar2 is
  
    v_vPatientID varchar2(50) := pi_vPatientID;
  
    -- TEMPLATE variables 
    v_vReport varchar2(32767) := '';
  
    v_dtDate1 date := null;
    v_vDate1  varchar2(128) := '____/____/________';
  
    v_dtDate2 date := null;
    v_vDate2  varchar2(128) := '____/____/________';
  
    v_nDiffDays number := null;
    v_vDiffDays varchar2(32) := '________';
  
    v_nDaysUsed number := null;
    v_vDaysUsed varchar2(32) := '________';
  
    v_nDaysNotUsed number := null;
    v_vDaysNotUsed varchar2(32) := '________';
  
    v_nPCentDaysUsed number := null;
    v_vPCentDaysUsed varchar2(7) := '______';
  
    v_nCumUsage    number := 0;
    v_nMaxUsage    number := 0;
    v_nMinUsage    number := 0;
    v_nAvgUsageDU  number := 0;
    v_nAvgUsageAll number := 0;
  
    v_nAvgAHI number := null;
    v_vAvgAHI varchar2(7) := '______';
  
    v_nMinTreshold number := 240;
  
    v_nAboveTreshold number := null;
    v_vAboveTreshold varchar2(7) := '______';
  
    v_nBelowTreshold number := null;
    v_vBelowTreshold varchar2(7) := '______';
  
  begin
  
    --get date range variables
    --Date 1
    begin
      select min(t.therapy_date)
        into v_dtDate1
        from patient_cpap t
       where t.patient_id = v_vPatientID;
    exception
      when others then
        null;
    end;
  
    if v_dtDate1 is not null then
      v_dtDate1 := to_date(to_char(v_dtDate1, 'mm/dd/yyyy'), 'mm/dd/yyyy');
      v_vDate1  := to_char(v_dtDate1, 'mm/dd/yyyy');
    
      --Date 2
      v_dtDate2 := to_date(to_char(sysdate, 'mm/dd/yyyy'), 'mm/dd/yyyy');
      v_vDate2  := to_char(v_dtDate2, 'mm/dd/yyyy');
    
      --diff days
      v_nDiffDays := (v_dtDate2 - v_dtDate1);
      v_vDiffDays := to_char(v_nDiffDays);
    
      -- get days of usage
      begin
        select count(*)
          into v_nDaysUsed
          from (select distinct p.therapy_date
                  from patient_cpap p
                 where p.patient_id = v_vPatientID) t;
      exception
        when others then
          v_nDaysUsed := null;
      end;
    
      if v_nDaysUsed is not null then
        v_vDaysUsed := to_char(v_nDaysUsed);
      
        --get days of not usage
        v_nDaysNotUsed := v_nDiffDays - v_vDaysUsed;
        if v_nDaysNotUsed < 0 then
          v_nDaysNotUsed := 0;
        end if;
        v_vDaysNotUsed := to_char(v_nDaysNotUsed);
      end if;
    
      --get percent of days used
      if v_nDaysUsed is not null then
        v_nPCentDaysUsed := (v_nDaysUsed / v_nDiffDays) * 100;
        v_vPCentDaysUsed := to_char(v_nPCentDaysUsed, '999.99');
      end if;
    
    end if;
  
    -- Get Cumulative Usage
    for rec in (select distinct *
                  from PATIENT_CPAP t
                 where t.patient_id = pi_vPatientID
                 order by t.therapy_date) loop
      if v_nCumUsage is null then
        v_nCumUsage := 0;
      end if;
      v_nCumUsage := v_nCumUsage + rec.minutes_of_use;
    end loop;
  
    -- Get Average Usage (All days)
    if v_nCumUsage is not null then
      v_nAvgUsageAll := v_nCumUsage / v_nDiffDays;
    end if;
  
    -- Get Maximun Usage
    begin
      select max(t.MINUTES_OF_USE)
        into v_nMaxUsage
        from (select distinct *
                from PATIENT_CPAP t
               where t.patient_id = pi_vPatientID
               order by t.therapy_date) t;
    exception
      when others then
        null;
    end;
  
    -- Get Minimum Usage
    begin
      select min(t.MINUTES_OF_USE)
        into v_nMinUsage
        from (select distinct *
                from PATIENT_CPAP t
               where t.patient_id = pi_vPatientID
               order by t.therapy_date) t;
    exception
      when others then
        null;
    end;
  
    -- Get Average AHI
    begin
      select avg(t.ahi)
        into v_nAvgAHI
        from (select distinct *
                from PATIENT_CPAP t
               where t.patient_id = pi_vPatientID
               order by t.therapy_date) t;
    exception
      when others then
        null;
    end;
  
    if v_nAvgAHI is not null then
      v_vAvgAHI := to_char(v_nAvgAHI, '999.99');
    end if;
  
    -- Get Average Usage (days used)
    begin
      select avg(t.minutes_of_use)
        into v_nAvgUsageDU
        from (select distinct *
                from PATIENT_CPAP t
               where t.patient_id = pi_vPatientID
               order by t.therapy_date) t;
    exception
      when others then
        null;
    end;
  
    -- Get days above treshold
    begin
      select count(*)
        into v_nAboveTreshold
        from (select *
                from (select distinct *
                        from PATIENT_CPAP t
                       where t.patient_id = pi_vPatientID
                       order by t.therapy_date) t
               where t.minutes_of_use >= v_nMinTreshold);
    exception
      when others then
        null;
    end;
  
    if v_nAboveTreshold is not null then
      v_vAboveTreshold := to_char((v_nAboveTreshold / v_nDaysUsed) * 100,
                                  '999.99');
    end if;
  
    -- Get days below treshold
    begin
      select count(*)
        into v_nBelowTreshold
        from (select *
                from (select distinct *
                        from PATIENT_CPAP t
                       where t.patient_id = pi_vPatientID
                       order by t.therapy_date) t
               where t.minutes_of_use < v_nMinTreshold);
    exception
      when others then
        null;
    end;
  
    if v_nBelowTreshold is not null then
      v_vBelowTreshold := to_char((v_nBelowTreshold / v_nDaysUsed) * 100,
                                  '999.99');
    end if;
  
    -- TEMPLATE FORMAT     
    v_vReport := v_vReport || 'Date range: from: ' || v_vDate1 || ' to ' ||
                 v_vDate2 || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Days with Device Usage: ' || v_vDaysUsed ||
                 ' days' || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Days without Device Usage: ' ||
                 v_vDaysNotUsed || ' days' || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Percent Days with Device Usage: ' ||
                 v_vPCentDaysUsed || '%' || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Cumulative Usage: ' ||
                 fnGetTimeDescription(v_nCumUsage) || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Maximum Usage (1 Day): ' ||
                 fnGetTimeDescription(v_nMaxUsage) || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Minimum Usage (1 Day): ' ||
                 fnGetTimeDescription(v_nMinUsage) || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Average Usage (Days Used): ' ||
                 fnGetTimeDescription(v_nAvgUsageDU) || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Average Usage (All Days): ' ||
                 fnGetTimeDescription(v_nAvgUsageAll) || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Percent of Days with Usage >= 4 Hours: ' ||
                 v_vAboveTreshold || '%' || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Percent of Days with Usage < 4 Hours: ' ||
                 v_vBelowTreshold || '%' || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Total Blower Time: ' ||
                 fnGetTimeDescription(v_nCumUsage) || chr(10);
    v_vReport := v_vReport || chr(10);
  
    v_vReport := v_vReport || 'Average AHI: ' || v_vAvgAHI || chr(10);
  
    --return report string
    return v_vReport;
  
  exception
    when others then
      return v_vReport;
  end;

  function fnGetTimeDescription(minutes in number) return varchar2 is
  
    v_nDays     number;
    v_nHours    number;
    v_nMinutes  number;
    v_nSeconds  number;
    v_nTotal    number;
    v_vTimeDesc varchar2(32767) := '_____ day(s) _____ hr(s). _____ min(s). _____ sec(s).';
  
  begin
  
    if minutes > 0 then
      v_vTimeDesc := '';
    
      v_nTotal := minutes;
    
      v_nDays    := floor(v_nTotal / (24 * 60));
      v_nHours   := floor((v_nTotal - (v_nDays * (24 * 60))) / 60);
      v_nMinutes := floor(v_nTotal - (v_nDays * (24 * 60)) -
                          (v_nHours * 60));
      v_nSeconds := floor((v_nTotal - floor(v_nTotal)) * 60);
    
      if v_nDays > 0 then
        v_vTimeDesc := to_char(v_nDays) || ' day(s) ';
      end if;
    
      if v_nHours > 0 then
        v_vTimeDesc := v_vTimeDesc || to_char(v_nHours) || ' hr(s). ';
      end if;
    
      if v_nMinutes > 0 then
        v_vTimeDesc := v_vTimeDesc || to_char(v_nMinutes) || ' min(s). ';
      end if;
    
      if v_nSeconds > 0 then
        v_vTimeDesc := v_vTimeDesc || to_char(v_nSeconds) || ' sec(s). ';
      end if;
    
    end if;
  
    if length(v_vTimeDesc) < 1 then
      v_vTimeDesc := '_____ day(s) _____ hr(s). _____ min(s). _____ sec(s).';
    end if;
  
    return v_vTimeDesc;
  
  exception
    when others then
      return v_vTimeDesc;
  end;
  
  function fnGetPatientBMI(pi_vPatientID in varchar2, pi_nGroupID in number) return varchar2 
    is
      v_vResult   varchar2(255) := '';
      v_nHeight number := -1;  
      v_nWeight number := -1;
      v_nMID number := 3002;
      v_nBMI number := 0;
             
    begin
      
      --get weight
      begin
        select distinct t.patient_weight
        into v_nWeight
        from encounter t, encounter_intake_responses r
        where r.encounter_id = t.encounter_id
        and r.mid = v_nMID
        and r.intake_group_id = pi_nGroupID
        and t.encounter_type_id = 99
        and t.patient_weight is not null
        and t.patient_id = pi_vPatientID; 
        
        exception when others
          then v_nWeight := 0;
      end; 
    
     --get height
      begin
        select distinct t.patient_height
        into v_nHeight
        from encounter t, encounter_intake_responses r
        where r.encounter_id = t.encounter_id
        and r.mid = v_nMID
        and r.intake_group_id = pi_nGroupID
        and t.encounter_type_id = 99
        and t.patient_height is not null
        and t.patient_id = pi_vPatientID; 
        
        exception when others
          then v_nWeight := 0;
      end;
      
      --calculate BMI
      if (v_nWeight > 0) and (v_nHeight > 0) then
        v_nBMI := (v_nWeight / power(v_nHeight,2)) * 703;
        v_vResult := to_char(v_nBMI, '99.99');
      end if;
      
      return v_vResult;
      
      exception when others
        then return '';
      
    end;

end PCK_NOTE_PREFILL;
/

prompt
prompt Creating package body PCK_PATIENT
prompt =================================
prompt
create or replace package body PCK_PATIENT is

  v_rKey raw(32) := sys.ic_utl_sec.c_rKey;
  
  --converted to use new encryption - no changes
  procedure UpdateCPAPDevice(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vKey in varchar2,
                             pi_vPatientID in varchar2,
                             pi_nDeviceID  in number,
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2) is
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update patient_demographics t
       set t.device_id = pi_nDeviceID
     where t.patient_id = pi_vPatientID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdateCPAPDevice(): ' || sqlErrm;
  end;
  
  --converted to use new encryption 
  procedure GetMilitaryDetailsRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey in varchar2,
                                 pi_vPatientID       in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select pmd.*, 
             t.PATIENT_ID,
             fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
             fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
             fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
             fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
             fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
             fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
             mid(fnc_utl_decstr(t.last_name, pi_vKey, t.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID), 6, 9) as LNSSNLAST4,
             fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
             t.MARITAL_STATUS_ID,
             to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY') as dob,
             t.HAS_FIRARM,
             t.EDUCATION_LEVEL_ID,
             t.PROVIDER_ID,
             t.ADDRESS1,
             t.ADDRESS2,
             t.CITY,
             t.POSTAL_CODE,
             t.HOMEPHONE,
             t.CELLPHONE,
             t.WORKPHONE,
             fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
             t.STATE_ID,
             t.HAS_REFERAL,
             t.AWAITING_TRANSFER,
             t.TRANSFER_DMIS_ID,
             t.EDIPN,
             t.FX_USER_ID,
             t.LAST_UPDATED,
             t.LAST_UPDATED_BY,
             t.IS_HIGH_INTEREST,
             t.PORTAL_USER_ID,
             t.CURRENT_WEIGHT,
             t.CURRENT_HEIGHT,
             t.WRK_PHONE_CALL,
             t.HOME_PHONE_CALL,
             t.HOME_PHONE_MSG,
             t.CELL_PHONE_CALL,
             t.EMAIL_MSG,
             t.DEVICE_ID,
             GetPatientBMI(t.patient_id) as BMI,
	           trunc(months_between(SYSDATE, to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY')) / 12) as patient_age
        from patient_military_detail pmd, patient_demographics t
       where pmd.patient_id = pi_vPatientID
         and t.patient_id = pmd.patient_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetMilitaryDetailsRS(): ' ||
                           sqlErrm;
  end;
  
  --converted to use new encryption
  --gets basic patient demographic data given the patients fx_user_id
  procedure GetPatientIDRS(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vKey in varchar2,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2,
                           rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.PATIENT_ID,
             fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
             fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
             fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
             fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
             fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
             fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
             mid(fnc_utl_decstr(t.last_name, pi_vKey, t.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID), 6, 9) as LNSSNLAST4,
             fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
             t.MARITAL_STATUS_ID,
             to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY') as dob,
             t.HAS_FIRARM,
             t.EDUCATION_LEVEL_ID,
             t.PROVIDER_ID,
             t.ADDRESS1,
             t.ADDRESS2,
             t.CITY,
             t.POSTAL_CODE,
             t.HOMEPHONE,
             t.CELLPHONE,
             t.WORKPHONE,
             fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
             t.STATE_ID,
             t.HAS_REFERAL,
             t.AWAITING_TRANSFER,
             t.TRANSFER_DMIS_ID,
             t.EDIPN,
             t.FX_USER_ID,
             t.LAST_UPDATED,
             t.LAST_UPDATED_BY,
             t.IS_HIGH_INTEREST,
             t.PORTAL_USER_ID,
             t.CURRENT_WEIGHT,
             t.CURRENT_HEIGHT,
             t.WRK_PHONE_CALL,
             t.HOME_PHONE_CALL,
             t.HOME_PHONE_MSG,
             t.CELL_PHONE_CALL,
             t.EMAIL_MSG,
             t.DEVICE_ID,
             GetPatientBMI(t.patient_id) as BMI,
	           trunc(months_between(SYSDATE, to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY')) / 12) as patient_age
      from patient_demographics t 
      where t.fx_user_id = pi_nUserID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetPatientIDRS(): ' || sqlErrm;
  end;
  
  --converted to new encryption
  --gets dataset to populate Patient Portal Lookup List
  procedure GetPatientPortalListRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vKey in varchar2,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out Pck_Utl_Common.refCursor) is
  
  begin
      
    --default status to ok
    po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Success;
    po_vStatusComment := null;
  
    open rs for
      select t.patient_id,
             fnc_utl_decstr(t.first_name, pi_vKey, t.patient_id) as first_name,
             fnc_utl_decstr(t.mi, pi_vKey, t.patient_id) as mi,
             fnc_utl_decstr(t.last_name, pi_vKey, t.patient_id) as last_name,
             fnc_utl_decstr(t.last_name, pi_vKey, t.patient_id) || ', ' ||
             fnc_utl_decstr(t.first_name, pi_vKey, t.patient_id) || ' ' ||
             fnc_utl_decstr(t.mi, pi_vKey, t.patient_id) as name,
             t.homephone as phone,
             fnc_utl_decstr(t.email, pi_vKey, t.patient_id) as email,
             t.fx_user_id,
             t2.user_name,
             t2.is_locked,
             t2.is_inactive
        from patient_demographics t, fx_user t2
       where t.fx_user_id = t2.fx_user_id
         and t.provider_id in
             (select provider_id
                from suat_user s
               where s.dims_id in
                     (select dims_id
                        from suat_user
                       where fx_user_id = pi_nUserID))
       order by fnc_utl_decstr(t.last_name, pi_vKey, t.patient_id),
                fnc_utl_decstr(t.first_name, pi_vKey, t.patient_id);
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PATIENT.GetPatientPortalListDS(): ' ||
                           sqlCode || ': ' || sqlErrm;
    
  end;

  --converted to new encryption
  procedure UpdatePatientDemographics(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vKey             in varchar2,
                                      pi_vPatientID       in varchar2,
                                      pi_vFirstName       in varchar2,
                                      pi_vMI              in varchar2,
                                      pi_vLastName        in varchar2,
                                      pi_vSponsorSSN      in varchar2,
                                      pi_vSSN             in varchar2,
                                      pi_vGender          in varchar2,
                                      pi_vDateOfBirth     in varchar2,
                                      pi_vProviderID      in varchar2,
                                      pi_vAddress1        in varchar2,
                                      pi_vAddress2        in varchar2,
                                      pi_vCity            in varchar2,
                                      pi_vPostal_Code     in varchar2,
                                      pi_vHomePhone       in varchar2,
                                      pi_vCellPhone       in varchar2,
                                      pi_vWorkPhone       in varchar2,
                                      pi_vEmail           in varchar2,
                                      pi_vStateID         in varchar2,
                                      pi_nCellPhoneMsg    in number,
                                      pi_nEmailMsg        in number,
                                      pi_nCallPreference  in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2) is
  
    v_nMAJCOM_ID number := 0;
    v_vPMDSQL    long := '';
  
    v_vDOB      varchar2(50) := '';
    v_nCallPref number := null;
  
    v_nHomeCall number := 0;
    v_nCellCall number := 0;
    v_nWorkCall number := 0;
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    if pi_nCallPreference > 0 then
      if bitand(pi_nCallPreference, 1) > 0 then
        v_nHomeCall := 1;
      end if;
    
      if bitand(pi_nCallPreference, 2) > 0 then
        v_nCellCall := 1;
      end if;
    
      if bitand(pi_nCallPreference, 4) > 0 then
        v_nWorkCall := 1;
      end if;
    end if;
  
    if pi_vDateOfBirth != '-1' then
      v_vDOB := pi_vDateOfBirth;
    end if;
  
    update patient_demographics
       set first_name      = fnc_utl_encstr(upper(pi_vFirstName), pi_vKey, upper(pi_vPatientID)),
           mi              = fnc_utl_encstr(upper(pi_vMI), pi_vKey, upper(pi_vPatientID)),
           last_name       = fnc_utl_encstr(upper(pi_vLastName), pi_vKey, upper(pi_vPatientID)),
           sponsor_ssn     = fnc_utl_encstr(pi_vSponsorSSN, pi_vKey, upper(pi_vPatientID)),
           ssn             = fnc_utl_encstr(pi_vSSN, pi_vKey, upper(pi_vPatientID)),
           gender          = fnc_utl_encstr(pi_vGender, pi_vKey, upper(pi_vPatientID)),
           dob             = fnc_utl_encstr(v_vDOB, pi_vKey, upper(pi_vPatientID)),
           provider_id     = pi_vProviderID,
           address1        = pi_vAddress1,
           address2        = pi_vAddress2,
           city            = upper(pi_vCity),
           postal_code     = pi_vPostal_Code,
           homephone       = pi_vHomePhone,
           cellphone       = pi_vCellPhone,
           workphone       = pi_vWorkPhone,
           email           = fnc_utl_encstr(pi_vEmail, pi_vKey, upper(pi_vPatientID)),
           wrk_phone_call  = v_nWorkCall,
           home_phone_call = v_nHomeCall,
           cell_phone_call = v_nCellCall,
           home_phone_msg  = pi_nCellPhoneMsg,
           email_msg       = pi_nEmailMsg,
           state_id        = pi_vStateID,
           last_updated    = sysdate,
           last_updated_by = pi_nUserID
     where patient_id = pi_vPatientID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdatePatientDemographics(): ' ||
                           sqlErrm;
  end;

  
  --converted to use new encryption
  --get a record set of patients back that match criteria
  procedure GetPatientLookupRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vKey in varchar2,
                               pi_nSelectedCases   in number,
                               pi_nSearchType      in number,
                               pi_vSearchValue     in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
    v_nEncounterID              number;
    v_const_Search_All_Cases    number := 1;
    v_const_Search_Open_Cases   number := 2;
    v_const_Search_Closed_Cases number := 3;
  
    v_const_search_last_name number := 1;
    v_const_search_edipn     number := 2;
    v_const_search_fmp_ssn   number := 3;
    v_const_search_user_id   number := 4;
  
    strSQL       varchar2(4000);
    strSelectSQL varchar2(4000);
  
  begin
  
    v_nEncounterID    := 0;
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    if pi_nSelectedCases = v_const_Search_All_Cases then
      strSelectSQL := ' and t.case_closed in (0,1)';
    elsif pi_nSelectedCases = v_const_Search_Open_Cases then
      strSelectSQL := ' and t.case_closed = 0';
    elsif pi_nSelectedCases = v_const_Search_Closed_Cases then
      strSelectSQL := ' and t.case_closed = 1';
    end if;
  
    strSQL := 'select ';
    strSQL := strSQL || ' p.PATIENT_ID, ';
    strSQL := strSQL || ' fnc_utl_decstr(p.FIRST_NAME, '''|| pi_vKey ||''', p.PATIENT_ID) as first_name, '; 
    strSQL := strSQL || ' fnc_utl_decstr(p.MI, '''|| pi_vKey ||''', p.PATIENT_ID) as mi, '; 
    strSQL := strSQL || ' fnc_utl_decstr(p.LAST_NAME, '''|| pi_vKey ||''', p.PATIENT_ID) as last_name, ';
    strSQL := strSQL || ' fnc_utl_decstr(p.FMP, '''|| pi_vKey ||''', p.PATIENT_ID) as fmp, ';
    strSQL := strSQL || ' fnc_utl_decstr(p.SPONSOR_SSN, '''|| pi_vKey ||''', p.PATIENT_ID) as sponsor_ssn, ';
    strSQL := strSQL || ' fnc_utl_decstr(p.SSN, '''|| pi_vKey ||''', p.PATIENT_ID) as ssn, ';
    strSQL := strSQL || ' mid(fnc_utl_decstr(p.last_name, '''|| pi_vKey ||''', p.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(p.ssn, '''|| pi_vKey ||''', p.PATIENT_ID), 6, 9) as LNSSNLAST4, ';
    strSQL := strSQL || ' mid(fnc_utl_decstr(p.last_name, '''|| pi_vKey ||''', p.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(p.ssn, '''|| pi_vKey ||''', p.PATIENT_ID), 6, 9) as fmpssnlast4, ';
    strSQL := strSQL || ' fnc_utl_decstr(p.GENDER, '''|| pi_vKey ||''', p.PATIENT_ID) as gender, ';
    strSQL := strSQL || ' p.MARITAL_STATUS_ID, ';
    strSQL := strSQL || ' to_date(fnc_utl_decstr(p.dob, '''|| pi_vKey ||''', p.PATIENT_ID), ''MM/DD/YYYY'') as dob, ';
    strSQL := strSQL || ' to_char(to_date(fnc_utl_decstr(p.dob, '''|| pi_vKey ||''', p.PATIENT_ID), ''MM/DD/YYYY''), ''MM/DD/YYYY'') as birthdate, ';
    strSQL := strSQL || ' p.HAS_FIRARM, ';
    strSQL := strSQL || ' p.EDUCATION_LEVEL_ID, ';
    strSQL := strSQL || ' p.PROVIDER_ID, ';
    strSQL := strSQL || ' p.ADDRESS1, ';
    strSQL := strSQL || ' p.ADDRESS2, ';
    strSQL := strSQL || ' p.CITY, ';
    strSQL := strSQL || ' p.POSTAL_CODE, ';
    strSQL := strSQL || ' p.HOMEPHONE, ';
    strSQL := strSQL || ' p.CELLPHONE, ';
    strSQL := strSQL || ' p.WORKPHONE, ';
    strSQL := strSQL || ' fnc_utl_decstr(p.EMAIL, '''|| pi_vKey ||''', p.PATIENT_ID) as email, ';
    strSQL := strSQL || ' p.STATE_ID, ';
    strSQL := strSQL || ' p.HAS_REFERAL, ';
    strSQL := strSQL || ' p.AWAITING_TRANSFER, ';
    strSQL := strSQL || ' p.TRANSFER_DMIS_ID, ';
    strSQL := strSQL || ' p.EDIPN, ';
    strSQL := strSQL || ' p.FX_USER_ID, ';
    strSQL := strSQL || ' p.LAST_UPDATED, ';
    strSQL := strSQL || ' p.LAST_UPDATED_BY, ';
    strSQL := strSQL || ' p.IS_HIGH_INTEREST, ';
    strSQL := strSQL || ' p.PORTAL_USER_ID, ';
    strSQL := strSQL || ' p.CURRENT_WEIGHT, ';
    strSQL := strSQL || ' p.CURRENT_HEIGHT, ';
    strSQL := strSQL || ' p.WRK_PHONE_CALL, ';
    strSQL := strSQL || ' p.HOME_PHONE_CALL, ';
    strSQL := strSQL || ' p.HOME_PHONE_MSG, ';
    strSQL := strSQL || ' p.CELL_PHONE_CALL, ';
    strSQL := strSQL || ' p.EMAIL_MSG, ';
    strSQL := strSQL || ' p.DEVICE_ID, ';
    strSQL := strSQL || ' GetPatientBMI(p.patient_id) as BMI, ';
    strSQL := strSQL || ' trunc(months_between(SYSDATE, to_date(fnc_utl_decstr(p.dob, '''|| pi_vKey ||''', t.PATIENT_ID), ''MM/DD/YYYY'')) / 12) as patient_age, ';
    strSQL := strSQL || ' t.case_closed ';
    strSQL := strSQL || ' from patient_demographics p, ';
    strSQL := strSQL || ' treatment t, patient_military_detail pm';
    strSQL := strSQL || ' where p.patient_id = t.patient_id';
    strSQL := strSQL || ' and p.provider_id in (';
    strSQL := strSQL || 'select provider_id ';
    strSQL := strSQL || '  from suat_user s ';
    strSQL := strSQL ||' where s.dims_id in (select dims_id from suat_user where fx_user_id = ' || pi_nUserID || ')) ';
  
    -- is the search by last name?
    if pi_nSearchType = v_const_search_last_name then
      strSQL := strSQL || ' and  p.patient_id = pm.patient_id(+)'; --we can have patients that do not have mil details
      strSQL := strSQL ||
                ' and t.initial_visit_date = (select MAX(tr.initial_visit_date) from treatment tr where tr.patient_id = p.patient_id)';
      strSQL := strSQL || ' and UPPER(';
      strSQL := strSQL || 'fnc_utl_decstr(p.LAST_NAME, '''|| pi_vKey ||''', p.PATIENT_ID)';
      strSQL := strSQL || ') like UPPER(''' ||
                pi_vSearchValue || ''')';
      strSQL := strSQL || strSelectSQL ||
                ' order by p.last_name, p.first_name asc';
    
      -- is the search by user id?   
    elsif pi_nSearchType = v_const_search_user_id then
      strSQL := strSQL || ' and  p.patient_id = pm.patient_id(+)'; --we can have patients that do not have mil details
      strSQL := strSQL ||
                ' and t.initial_visit_date = (select MAX(tr.initial_visit_date) from treatment tr where tr.patient_id = p.patient_id)';
      strSQL := strSQL || ' and p.fx_user_id = ''' || pi_vSearchValue || '''';
      strSQL := strSQL || strSelectSQL ||
                ' order by p.last_name, p.first_name asc';
    
      --is the search by lastname initial SS last 4
    elsif pi_nSearchType = v_const_search_fmp_ssn then
      strSQL := strSQL || ' and  p.patient_id = pm.patient_id(+)'; --we can have patients that do not have mil details
      strSQL := strSQL ||
                ' and t.initial_visit_date = (select MAX(tr.initial_visit_date) from treatment tr where tr.patient_id = p.patient_id)';
      strSQL := strSQL || ' and ';
      
      strSQL := strSQL || ' mid(fnc_utl_decstr(p.last_name, '''|| pi_vKey ||''', p.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(p.ssn, '''|| pi_vKey ||''', p.PATIENT_ID), 6, 9) ';
      strSQL := strSQL || ' = ''' || pi_vSearchValue || '''';
      strSQL := strSQL || strSelectSQL ||
                ' order by p.last_name, p.first_name asc';
    end if;
  
    open rs for strSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.getPatientLookupRS(): ' || sqlErrm;
  end;
  
  
  --converted to use new encryption
  procedure GetPatientDemographicsRS(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vKey             in varchar2,
                                     pi_vPatientID       in varchar2,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2,
                                     rs                  out RetRefCursor) is
    v_nTreatmentID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_nTreatmentID    := 0;
    
    select max(treatment_id)
      into v_nTreatmentID
      from treatment
     where patient_id = pi_vPatientID;
  
    open rs for
      select t.PATIENT_ID,
             fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
             fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
             fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
             fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
             fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
             fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
             mid(fnc_utl_decstr(t.last_name, pi_vKey, t.PATIENT_ID), 1, 1) || mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID), 6, 9) as LNSSNLAST4,
             fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
             t.MARITAL_STATUS_ID,
             to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY') as dob,
             t.HAS_FIRARM,
             t.EDUCATION_LEVEL_ID,
             t.PROVIDER_ID,
             t.ADDRESS1,
             t.ADDRESS2,
             t.CITY,
             t.POSTAL_CODE,
             t.HOMEPHONE,
             t.CELLPHONE,
             t.WORKPHONE,
             fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
             t.STATE_ID,
             t.HAS_REFERAL,
             t.AWAITING_TRANSFER,
             t.TRANSFER_DMIS_ID,
             t.EDIPN,
             t.FX_USER_ID,
             t.LAST_UPDATED,
             t.LAST_UPDATED_BY,
             t.IS_HIGH_INTEREST,
             t.PORTAL_USER_ID,
             t.CURRENT_WEIGHT,
             t.CURRENT_HEIGHT,
             t.WRK_PHONE_CALL,
             t.HOME_PHONE_CALL,
             t.HOME_PHONE_MSG,
             t.CELL_PHONE_CALL,
             t.EMAIL_MSG,
             t.DEVICE_ID,
             GetPatientBMI(t.patient_id) as BMI,
             (select s.name
                from suat_user s
               where s.provider_id = t.PROVIDER_ID) as provider_name,
             trunc(months_between(SYSDATE, to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID), 'MM/DD/YYYY')) / 12) as patient_age,
             m.*,  
             '' as MILITARY_STATUS_TITLE,
             '' as MILITARY_SERVICE_TITLE,
             '' as MARITAL_STATUS_TITLE,
             '' as GRADE,
             (select gender_desc
                from stat_gender s
               where s.gender_id = decode( fnc_utl_decstr(t.gender, pi_vKey, pi_vPatientID), 'U', 0, 'M', 1, 'F', 2)
                 and s.active = 1) GENDER_DESC,
             (select base
                from stat_dims_base s
               where s.dims_id = m.permanent_duty_station_id) as BASE,
             (select count(*)
                from encounter_intake ei
               where encounter_id in
                     (select ee.encounter_id
                        from encounter ee, treatment tr
                       where ee.patient_id = pi_vPatientID
                         and ee.treatment_id = v_nTreatmentID
                         and tr.patient_id = ee.patient_id
                         and tr.treatment_id = v_nTreatmentID
                         and NVL(tr.case_closed, 0) <> 1)
                 and mid in (1, 100, 1050) --todo hard coded
                 and (select count(*)
                        from encounter_intake_responses
                       where encounter_id = ei.encounter_id
                         and encounter_intake_id = ei.encounter_intake_id
                         and mid in (1, 100, 1050)) > 0) as referral_count,
             
             (select count(*)
                from treatment t
               where t.patient_id = pi_vPatientID
                 and nvl(t.case_closed, 0) != 1) as OPENCASE_COUNT,
             
             t.wrk_phone_call,
             t.home_phone_call,
             t.home_phone_msg,
             t.email_msg
      
        from patient_demographics t, patient_military_detail m
       where t.patient_id = pi_vPatientID
         and t.patient_id = m.patient_id(+); --we can have patients that do not have mil details
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetPatientDemographicsRS(): ' ||
                           sqlErrm;
  end;
    
  
--converted to use new encryption
procedure InsertPatientDemographics(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      --Patient Table
                                      pi_vKey in varchar2,
                                      pi_vPatientID      in varchar2,
                                      pi_vEncounterID    in varchar2,
                                      pi_vFirstName      in varchar2,
                                      pi_vMI             in varchar2,
                                      pi_vLastName       in varchar2,
                                      pi_vSponsorSSN     in varchar2,
                                      pi_vSSN            in varchar2,
                                      pi_vGender         in varchar2,
                                      pi_vDateOfBirth    in varchar2,
                                      pi_vProviderID     in varchar2,
                                      pi_vAddress1       in varchar2,
                                      pi_vAddress2       in varchar2,
                                      pi_vCity           in varchar2,
                                      pi_vPostal_Code    in varchar2,
                                      pi_vHomePhone      in varchar2,
                                      pi_vCellPhone      in varchar2,
                                      pi_vWorkPhone      in varchar2,
                                      pi_vEmail          in varchar2,
                                      pi_vStateID        in varchar2,
                                      pi_nCellPhoneMsg   in number,
                                      pi_nEmailMsg       in number,
                                      pi_nCallPreference in number,
                                      po_nStatusCode     out number,
                                      po_vStatusComment  out varchar2) is
    v_nRelationshipID number;
    v_nSSNCount       number;
    v_vDOB            varchar2(50) := '';
    v_nCallPref       number := null;
  
    v_nHomeCall number := 0;
    v_nCellCall number := 0;
    v_nWorkCall number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_nRelationshipID := 0;
    v_nSSNCount       := 0;
  
    if pi_nCallPreference > 0 then
      if bitand(pi_nCallPreference, 1) > 0 then
        v_nHomeCall := 1;
      end if;
    
      if bitand(pi_nCallPreference, 2) > 0 then
        v_nCellCall := 1;
      end if;
    
      if bitand(pi_nCallPreference, 4) > 0 then
        v_nWorkCall := 1;
      end if;
    end if;
  
    --SSN Check For Duplicate
    select count(ssn) into v_nSSNCount from patient_demographics t 
    where fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) = pi_vSSN;
  
    if (v_nSSNCount > 0) then
      po_nStatusCode    := Pck_Common.c_nResultStatus_Error;
      po_vStatusComment := po_vStatusComment ||
                           'Social Security Number already exists. ';
    end if;
  
    -- return if error
    if po_nStatusCode = Pck_Common.c_nResultStatus_Error then
      po_vStatusComment := 'Error: ' || rtrim(po_vStatusComment, ', ');
      return;
    end if;
  
    if pi_vDateOfBirth != '-1' then
      v_vDOB := pi_vDateOfBirth;
    end if;
  
    insert into patient_demographics t
      (patient_id,
       first_name,
       mi,
       last_name,
       fmp,
       sponsor_ssn,
       ssn,
       gender,
       dob,
       provider_id,
       address1,
       address2,
       city,
       postal_code,
       homephone,
       cellphone,
       workphone,
       email,
       state_id,
       home_phone_call,
       cell_phone_call,
       wrk_phone_call,
       home_phone_msg,
       email_msg,
       last_updated,
       last_updated_by)
    values
     ( upper(pi_vPatientID),
       fnc_utl_encstr(upper(pi_vFirstName), pi_vKey, upper(pi_vPatientID)),
       fnc_utl_encstr(upper(pi_vMI), pi_vKey, upper(pi_vPatientID)),
       fnc_utl_encstr(upper(pi_vLastName), pi_vKey, upper(pi_vPatientID)),
       '  ',
       fnc_utl_encstr(pi_vSponsorSSN, pi_vKey, upper(pi_vPatientID)),
       fnc_utl_encstr(pi_vSSN, pi_vKey, upper(pi_vPatientID)),
       fnc_utl_encstr(pi_vGender, pi_vKey, upper(pi_vPatientID)),
       fnc_utl_encstr(v_vDOB, pi_vKey, upper(pi_vPatientID)),
       pi_vProviderID,
       pi_vAddress1,
       pi_vAddress2,
       upper(pi_vCity),
       pi_vPostal_Code,
       pi_vHomePhone,
       pi_vCellPhone,
       pi_vWorkPhone,
       fnc_utl_encstr(pi_vEmail, pi_vKey, upper(pi_vPatientID)),
       pi_vStateID,
       v_nHomeCall,
       v_nCellCall,
       v_nWorkCall,
       pi_nCellPhoneMsg,
       pi_nEmailMsg,
       sysdate,
       pi_nUserID);
    commit;
  
    --Create Initial Patient Sponsor Record Needed By Assessments --Assessments can only to Updates
    insert into patient_sponsor
      (patient_id, relationship_id, last_updated, last_updated_by)
    values
      (pi_vPatientID, v_nRelationshipID, sysdate, pi_nUserID);
    commit;
  
    --Create Initial Emergency Contact Record Needed By Assessments --Assessments can only to Updates
    insert into patient_emergency_contact
      (patient_id, relationship_id, last_updated, last_updated_by)
    values
      (pi_vPatientID, v_nRelationshipID, sysdate, pi_nUserID);
    commit;
  
    insert into treatment
      (treatment_id,
       patient_id,
       initial_visit_date,
       last_updated,
       last_updated_by)
    values
      (1, pi_vPatientID, sysdate, sysdate, pi_nUserID);
    commit;
  
    --REVAMP 20130219 DS: As requested by VA (Dr Kuna), do not create a default encounter
    /*
    insert into encounter
      (encounter_id,
       treatment_id,
       patient_id,
       encounter_date,
       last_updated,
       last_updated_by)
    values
      (pi_vEncounterID, 1, pi_vPatientID, sysdate, sysdate, pi_nUserID);
    commit;
    */
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.InsertPatientDemographics(): ' ||
                           sqlErrm;
    
  end;
    
  --does the patient only have 1 encounter
  --for the latest treatment?
  procedure InitialEncounter(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             po_nInitialEnc      out number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2) is
  
    v_nCount       number;
    v_nTreatmentID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_nCount          := 0;
    v_nTreatmentID    := 0;
    po_nInitialEnc    := 0;
  
    --get the number of encounters for the
    --current open treatment
    select count(*)
      into v_nCount
      from encounter e
     where e.patient_id = pi_vPatientID
       and e.encounter_type_id in (0, 6, 8)
       and e.treatment_id =
           (select max(treatment_id)
              from treatment t
             where t.patient_id = pi_vPatientID
               and nvl(t.case_closed, 0) = 0);
  
    if (v_nCount = 1) then
      po_nInitialEnc := 1;
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_INTAKE.InitialEncounter(): ' || sqlErrm;
  end;
    
  procedure GetPatientTreatmentIdRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select treatment_id
        from treatment t
       where patient_id = pi_vPatientID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetPatientTreatmentIdRS(): ' ||
                           sqlErrm;
  end;

  procedure GetPatientSponsorRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_vPatientID       in varchar2,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select * from patient_sponsor t where patient_id = pi_vPatientID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetPatientSponsorRS(): ' || sqlErrm;
  end;

  procedure InsertPatientSponsor(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vName            in varchar2,
                                 pi_nRelationshipID  in number,
                                 pi_vAddress1        in varchar2,
                                 pi_vCity            in varchar2,
                                 pi_vPostalCode      in varchar2,
                                 pi_vHomePhone       in varchar2,
                                 pi_vWorkPhone       in varchar2,
                                 pi_vEmail           in varchar2,
                                 pi_nStateID         in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into patient_sponsor
      (patient_id,
       name,
       relationship_id,
       address1,
       city,
       postal_code,
       homephone,
       workphone,
       email,
       state_id,
       last_updated,
       last_updated_by)
    values
      (pi_vPatientID,
       pi_vName,
       pi_nRelationshipID,
       pi_vAddress1,
       pi_vCity,
       pi_vPostalCode,
       pi_vHomePhone,
       pi_vWorkPhone,
       pi_vEmail,
       pi_nStateID,
       sysdate,
       pi_nUserID);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.InsertPatientSponsor(): ' ||
                           sqlErrm;
  end;

  procedure UpdatePatientSponsor(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vName            in varchar2,
                                 pi_nRelationshipID  in number,
                                 pi_vAddress1        in varchar2,
                                 pi_vCity            in varchar2,
                                 pi_vPostalCode      in varchar2,
                                 pi_vHomePhone       in varchar2,
                                 pi_vWorkPhone       in varchar2,
                                 pi_vEmail           in varchar2,
                                 pi_nStateID         in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update patient_sponsor
       set name            = pi_vName,
           relationship_id = pi_nRelationshipID,
           address1        = pi_vAddress1,
           city            = pi_vCity,
           postal_code     = pi_vPostalCode,
           homephone       = pi_vHomePhone,
           workphone       = pi_vWorkPhone,
           email           = pi_vEmail,
           state_id        = pi_nStateID,
           last_updated    = sysdate,
           last_updated_by = pi_nUserID
     where patient_id = pi_vPatientID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdatePatientSponsor(): ' ||
                           sqlErrm;
  end;

  procedure GetPatientEmergencyContactRS(pi_vSessionID       in varchar2,
                                         pi_vSessionClientIP in varchar2,
                                         pi_nUserID          in number,
                                         pi_vPatientID       in varchar2,
                                         po_nStatusCode      out number,
                                         po_vStatusComment   out varchar2,
                                         rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from patient_emergency_contact t
       where patient_id = pi_vPatientID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetPatientEmergencyContactRS(): ' ||
                           sqlErrm;
  end;

  procedure InsertPatientEmergencyContact(pi_vSessionID       in varchar2,
                                          pi_vSessionClientIP in varchar2,
                                          pi_nUserID          in number,
                                          pi_vPatientID       in varchar2,
                                          pi_vName            in varchar2,
                                          pi_nRelationshipID  in number,
                                          pi_vAddress1        in varchar2,
                                          pi_vCity            in varchar2,
                                          pi_vPostal_Code     in varchar2,
                                          pi_vHomePhone       in varchar2,
                                          pi_vWorkPhone       in varchar2,
                                          pi_vEmail           in varchar2,
                                          pi_nStateID         in number,
                                          po_nStatusCode      out number,
                                          po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into patient_emergency_contact
      (patient_id,
       name,
       relationship_id,
       address1,
       city,
       postal_code,
       homephone,
       workphone,
       email,
       state_id,
       last_updated,
       last_updated_by)
    values
      (pi_vPatientID,
       pi_vName,
       pi_nRelationshipID,
       pi_vAddress1,
       pi_vCity,
       pi_vPostal_Code,
       pi_vHomePhone,
       pi_vWorkPhone,
       pi_vEmail,
       pi_nStateID,
       sysdate,
       pi_nUserID);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.InsertPatientEmergencyContact(): ' ||
                           sqlErrm;
  end;

  procedure UpdatePatientEmergencyContact(pi_vSessionID       in varchar2,
                                          pi_vSessionClientIP in varchar2,
                                          pi_nUserID          in number,
                                          pi_vPatientID       in varchar2,
                                          pi_vName            in varchar2,
                                          pi_nRelationshipID  in number,
                                          pi_vAddress1        in varchar2,
                                          pi_vCity            in varchar2,
                                          pi_vPostal_Code     in varchar2,
                                          pi_vHomePhone       in varchar2,
                                          pi_vWorkPhone       in varchar2,
                                          pi_vEmail           in varchar2,
                                          pi_nStateID         in number,
                                          po_nStatusCode      out number,
                                          po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update patient_emergency_contact
       set name            = pi_vName,
           relationship_id = pi_nRelationshipID,
           address1        = pi_vAddress1,
           city            = pi_vCity,
           postal_code     = pi_vPostal_Code,
           homephone       = pi_vHomePhone,
           workphone       = pi_vWorkPhone,
           email           = pi_vEmail,
           state_id        = pi_nStateID,
           last_updated    = sysdate,
           last_updated_by = pi_nUserID
     where patient_id = pi_vPatientID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdatePatientEmergencyContact(): ' ||
                           sqlErrm;
  end;

  
  procedure GetPatientMilDetailByIdRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_vPatientID       in varchar2,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select m.*
        from patient_military_detail m
       where m.patient_id = pi_vPatientID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.GetPatientMilDetailByIdRS(): ' ||
                           sqlErrm;
  end;

  procedure DelIncPatIntakeAssessments(pi_vSessionID       in varchar2,
                                       pi_vSessionClientIP in varchar2,
                                       pi_nUserID          in number,
                                       pi_vPatientID       in varchar2,
                                       po_nStatusCode      out number,
                                       po_vStatusComment   out varchar2) is
    v_nNumOfIncAssessments number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    for rec in ( -- select all INCOMPLETE encounter intakes for module for patient
                select ei.*
                  from encounter_intake ei
                 where ei.encounter_id in
                       ( -- select all encounters for patient
                        select e.encounter_id
                          from encounter e
                         where e.patient_id = pi_vPatientID))
    
     loop
      begin
      
        v_nNumOfIncAssessments := 0;
      
        --select all encounter intakes responses for module for encounter by mid
        select count(eir.encounter_id)
          into v_nNumOfIncAssessments
          from encounter_intake_responses eir
         where eir.encounter_id = rec.encounter_id
           and eir.mid = rec.mid;
      
        if v_nNumOfIncAssessments = 0 then
        
          delete from encounter_intake ei
           where ei.encounter_id = rec.encounter_id
             and ei.encounter_intake_id = rec.encounter_intake_id
             and ei.mid = rec.mid;
        
          commit;
        
        end if;
      
      exception
        when others then
          rollback;
      end;
    end loop;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.DelIncPatIntakeAssessments(): ' ||
                           sqlErrm;
  end;

  procedure IncPatIntakeAssessments(pi_vSessionID            in varchar2,
                                    pi_vSessionClientIP      in varchar2,
                                    pi_nUserID               in number,
                                    pi_vPatientID            in varchar2,
                                    po_nHasIncPatAssessments out number,
                                    po_nStatusCode           out number,
                                    po_vStatusComment        out varchar2
                                    
                                    ) is
  
    v_nNumOfIncAssessments number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    for rec in ( -- select all INCOMPLETE encounter intakes for module for patient
                select ei.*
                  from encounter_intake ei
                 where ei.encounter_id in
                       ( -- select all encounters for patient
                        select e.encounter_id
                          from encounter e
                         where e.patient_id = pi_vPatientID))
    
     loop
      begin
      
        v_nNumOfIncAssessments := 0;
      
        --select all encounter intakes responses for module for encounter by mid
        select count(eir.encounter_id)
          into v_nNumOfIncAssessments
          from encounter_intake_responses eir
         where eir.encounter_id = rec.encounter_id
           and eir.mid = rec.mid;
      
        if v_nNumOfIncAssessments = 0 then
          po_nHasIncPatAssessments := 1;
        end if;
      
      exception
        when others then
          rollback;
      end;
    end loop;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.IncPatIntakeAssessments(): ' ||
                           sqlErrm;
  end;
  
  procedure UpdateMilitaryDetails(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  pi_vFMP             in varchar2,
                                  pi_vEDIPN           in varchar2,
                                  pi_vSponsorSSN      in varchar2,
                                  pi_vService         in varchar2,
                                  pi_vPayGrade        in varchar2,
                                  pi_vDutyStation     in varchar2,
                                  pi_vStatus          in varchar2,
                                  pi_nSquadron        in number,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2) is
    v_nMAJCOM_ID number := 0;
    v_vPMDSQL    long := '';
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get the patients majcom incase his dims changed
    begin
      select t.majcom_id
        into v_nMAJCOM_ID
        from stat_dims_base t
       where t.dims_id = pi_vDutyStation;
    exception
      when others then
        null;
    end;
  
    -- build patient military detail update sql
    v_vPMDSQL := 'update patient_military_detail ';
    v_vPMDSQL := v_vPMDSQL || 'set ';
  
    -- if the patient is in the military add two more fields
    --if pi_vFMP = 20
    --then
    v_vPMDSQL := v_vPMDSQL || 'military_service_id = ' || pi_vService || ', ';
    v_vPMDSQL := v_vPMDSQL || 'rank_id = ' || pi_vPayGrade || ', ';
    --end if;
  
    -- add remaining fields
    v_vPMDSQL := v_vPMDSQL || 'majcom_id = ' || to_char(v_nMAJCOM_ID) || ', ';
    v_vPMDSQL := v_vPMDSQL || 'permanent_duty_station_id = ' ||
                 pi_vDutyStation || ', ';
    v_vPMDSQL := v_vPMDSQL || 'military_status_id = ' || pi_vStatus || ', ';
    v_vPMDSQL := v_vPMDSQL || 'squadron_id = ' || pi_nSquadron || ', ';
    v_vPMDSQL := v_vPMDSQL || 'last_updated = ''' || sysdate || ''', ';
    v_vPMDSQL := v_vPMDSQL || 'last_updated_by = ' || pi_nUserID || ' ';
    v_vPMDSQL := v_vPMDSQL || 'where patient_id = ''' || pi_vPatientID || '''';
  
    -- execute patient military detail update sql
    prc_utl_execute_sql(v_vPMDSQL);
    commit;
  
    update patient_demographics
       set fmp             = sys.ic_utl_sec.encryptData(pi_vFMP,
                                                        v_rKey,
                                                        upper(pi_vPatientID)),
           edipn           = pi_vEDIPN,
           sponsor_ssn     = sys.ic_utl_sec.encryptData(pi_vSponsorSSN,
                                                        v_rKey,
                                                        upper(pi_vPatientID)),
           last_updated    = sysdate,
           last_updated_by = pi_nUserID
     where patient_id = pi_vPatientID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdateMilitaryDetails(): ' ||
                           sqlErrm;
  end;

  procedure UpdateMilitaryDetails2(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vPatientID       in varchar2,
                                   pi_vFMP             in varchar2,
                                   pi_vEDIPN           in varchar2,
                                   pi_vSponsorSSN      in varchar2,
                                   pi_vService         in varchar2,
                                   pi_vPayGrade        in varchar2,
                                   pi_vDutyStation     in varchar2,
                                   pi_vStatus          in varchar2,
                                   pi_nSquadron        in number,
                                   pi_vUnit            in varchar2,
                                   pi_nGTScore         in number,
                                   pi_nMonthInCombat   in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2) is
    v_nMAJCOM_ID     number := 0;
    v_vPMDSQL        varchar2(32767) := '';
    v_vMonthInCombat varchar2(8) := 'null';
    v_vGTScore       varchar2(8) := 'null';
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get the patients majcom incase his dims changed
    begin
      select t.majcom_id
        into v_nMAJCOM_ID
        from stat_dims_base t
       where t.dims_id = pi_vDutyStation;
    exception
      when others then
        null;
    end;
  
    if pi_nGTScore <> -1 then
      v_vGTScore := to_char(pi_nGTScore);
    end if;
  
    if pi_nMonthInCombat <> -1 then
      v_vMonthInCombat := to_char(pi_nMonthInCombat);
    end if;
  
    v_vPMDSQL := v_vPMDSQL || 'update patient_military_detail t ';
    v_vPMDSQL := v_vPMDSQL || '   set t.military_service_id        = ''' ||
                 pi_vService || ''', ';
    v_vPMDSQL := v_vPMDSQL || '       t.rank_id                    = ''' ||
                 pi_vPayGrade || ''', ';
    v_vPMDSQL := v_vPMDSQL || '       t.majcom_id                  = ' ||
                 to_char(v_nMAJCOM_ID) || ', ';
    v_vPMDSQL := v_vPMDSQL || '       t.permanent_duty_station_id  = ''' ||
                 pi_vDutyStation || ''', ';
    v_vPMDSQL := v_vPMDSQL || '       t.military_status_id         = ''' ||
                 pi_vStatus || ''', ';
    v_vPMDSQL := v_vPMDSQL || '       t.squadron_id                = ' ||
                 to_char(pi_nSquadron) || ', ';
    v_vPMDSQL := v_vPMDSQL || '       t.unit                       = ''' ||
                 pi_vUnit || ''', ';
    v_vPMDSQL := v_vPMDSQL || '       t.gt_score                   = ' ||
                 v_vGTScore || ', ';
    v_vPMDSQL := v_vPMDSQL || '       t.months_in_combat           = ' ||
                 v_vMonthInCombat || ' ';
    v_vPMDSQL := v_vPMDSQL || ' where t.patient_id                 = ''' ||
                 pi_vPatientID || ''' ';
  
    execute immediate v_vPMDSQL;
    commit;
  
    update patient_demographics
       set fmp             = sys.ic_utl_sec.encryptData(pi_vFMP,
                                                        v_rKey,
                                                        upper(pi_vPatientID)),
           edipn           = pi_vEDIPN,
           sponsor_ssn     = sys.ic_utl_sec.encryptData(pi_vSponsorSSN,
                                                        v_rKey,
                                                        upper(pi_vPatientID)),
           last_updated    = sysdate,
           last_updated_by = pi_nUserID
     where patient_id = pi_vPatientID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdateMilitaryDetails2(): ' ||
                           sqlErrm;
  end;

  procedure DeletePatientAssignedModule(pi_vPatientID     in varchar2,
                                        nMID              in number,
                                        po_nStatusCode    out number,
                                        po_vStatusComment out varchar2)
  
   is
    v_vSQL constant varchar2(32767) := 'delete from patient_module where patient_id = :pi_vPatientID 
                                                                   and mid = :nMID 
                                                                   and status = 0
                                                                   and date_completed is null';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
      using pi_vPatientID, nMID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PATIENT.DeletePatientAssignedModule(): ' ||
                           sqlErrm;
  end;

  procedure UpdatePatientModuleStatus(pi_vPATIENT_ID    in VARCHAR2,
                                      pi_vMID           in NUMBER,
                                      pi_vSTATUS        in NUMBER,
                                      po_nStatusCode    out number,
                                      po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update patient_module
       set STATUS = pi_vSTATUS
    
     where PATIENT_ID = pi_vPATIENT_ID
       and MID = pi_vMID
       and STATUS = 0
       and DATE_COMPLETED is NULL;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT.UpdatePatientModule(): ' || sqlErrm;
  end;

  --get the list of modules (assessments) 
  --assigned to the patient
  procedure getPatientModuleRS(pi_vSessionID        in varchar2,
                               pi_vSessionClientIP  in varchar2,
                               pi_nUserID           in number,
                               pi_vPatientID        in varchar2, -- JRL added
                               pi_nSelectedLanguage in number,
                               po_nStatusCode       out number,
                               po_vStatusComment    out varchar2,
                               rs                   out Pck_Utl_Common.refCursor) is
    v_nSeq number;
    v_nCnt number;
    v_nSelectedLanguage number;
    v_nCount            number;
  
  begin
  
    v_nCount := 0;
    v_nSeq   := 0;
    v_nCnt   := 0;
    v_nSelectedLanguage := pi_nSelectedLanguage;
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
    
    --get a recordset of mids the patient
    --needs to complete
    select count(*)
      into v_nCount
      from patient_module t, intake_module_group_mid t3
     where t.patient_id = pi_vPatientID
       and t.module_group_id = t3.module_group_id
       and t.mid = t3.mid
       and t.status = 0
       and t.date_completed is null
     order by t.module_group_id asc, t3.sort_order asc;
  
    if v_nCount < 1 then
    
      --PSAM does not use the group concelpt just yet and
      --i broke this...
    
      open rs for
      
        select distinct t.mid, t.date_assigned
          from patient_module t
         where t.patient_id = pi_vPatientID
           and t.date_completed is null
           and t.status = 0
         order by t.date_assigned asc;
    
    else
    
      -- english selected
      if v_nSelectedLanguage = 0 then
      
        open rs for
        
          select t.mid,
                 t.date_assigned,
                 t3.module_group_id,
                 t3.sort_order,
                 t4.module,
                 t4.description
            from patient_module          t,
                 intake_module_group_mid t3,
                 intake_module           t4
           where t.patient_id = pi_vPatientID
             and t.mid = t4.mid
             and t.module_group_id = t3.module_group_id
             and t.mid = t3.mid
             and t.date_completed is null
             and t.status = 0
           order by t.module_group_id asc;
      else
      
        open rs for
        
          select t.mid, t.date_assigned, t3.module_group_id, t3.sort_order
            from patient_module          t,
                 intake_module_group_mid t3,
                 intake_module           t4
           where t.patient_id = pi_vPatientID
             and t.mid = t4.mid
             and t.module_group_id = t3.module_group_id
             and t.mid = t3.mid
             and t.date_completed is null
             and t.status = 0
           order by t.module_group_id asc;
      
      end if;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PATIENT.getPatientModuleRS(): ' || sqlCode || ': ' ||
                           sqlErrm;
  end;

  --counts the number of intakes that have not been conpleted
  procedure getPatientModuleCount(pi_vPatientID     in varchar2,
                                  po_nMIDCount      out number,
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2) is
    v_nCount number;
  
  begin
  
    v_nCount          := 0;
    po_nMIDCount      := 0;
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    select count(*)
      into v_nCount
      from patient_module
     where patient_id = pi_vPatientID
       and status = 0
       and date_completed is NULL;
  
    po_nMIDCount := v_nCount;
  
  exception
    when others then
      po_nStatusCode    := -1;
      po_vStatusComment := 'PCK_PATIENT.getPatientModuleRS(): ' || sqlCode || ': ' ||
                           sqlErrm;
  end;

  procedure updatePatFxUserRights is
    curPat pck_common.refCursor;
    recPat patient_demographics%rowtype;
  
  begin
  
    open curPat for
      select p.*
        from patient_demographics p
       where p.fx_user_id is not null
         and p.fx_user_id not in (select fx_user_id from fx_user_rights);
  
    loop
      fetch curPat
        into recPat;
      exit when curPat%notfound;
    
      insert into fx_user_rights
        (fx_user_id, user_rights, read_only, user_type)
      values
        (recPat.Fx_User_Id, 0, 0, 0);
      commit;
    
    end loop;
    close curPat;
  
  end;

end PCK_PATIENT;
/

prompt
prompt Creating package body PCK_PATIENT_EVENTS
prompt ========================================
prompt
create or replace package body PCK_PATIENT_EVENTS is

  --converted to use new encryption
  --get all patients list rs
  procedure GetAllPatientsListRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out Pck_Utl_Common.refCursor) is
  
  begin
  
    po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Success;
    po_vStatusComment := null;
  
    open rs for
      select t.patient_id,
             fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) || ', ' ||
             fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) || ' ' ||
             fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as name,
             t.homephone as phone,
             fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
             t.fx_user_id
        from patient_demographics t
       where t.provider_id in
             (select provider_id
                from suat_user s
               where s.dims_id in
                     (select dims_id
                        from suat_user su
                       where su.fx_user_id = pi_nUserID))
       order by fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID),
                fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID);
  
  exception
    when others then
    
      po_nStatusCode    := Pck_Utl_Common.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetAllPatientsListRS(): ' ||
                           sqlCode || ': ' || sqlErrm;
    
  end;

  --converted to use new encryption
  --get pat by overdue evt rs
  procedure GetPatByOverdueEvtRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t.patient_id,
             fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) || ', ' ||
             fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) || ' ' ||
             fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as name,
             t.homephone as phone,
             fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
             t.fx_user_id
        from patient_demographics t
       where t.patient_id in
             (select distinct patient_id
                from patient_event t
               where t.event_date is not null
                 and nvl(t.status, 0) < 1
                 and to_date(to_char(t.event_date, 'mm/dd/yyyy'),
                             'mm/dd/yyyy') <=
                     to_date(to_char(sysdate, 'mm/dd/yyyy'), 'mm/dd/yyyy'))
         and t.provider_id in
             (select provider_id
                from suat_user s
               where s.dims_id in
                     (select dims_id
                        from suat_user su
                       where su.fx_user_id = pi_nUserID))
      
       order by fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID),
                fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetPatByOverdueEvtRS(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- ******************************************
  procedure GetPatByEvtDueDateRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 
                                 pi_vKey   in varchar2,
                                 pi_vDate1 in varchar2,
                                 pi_vDate2 in varchar2,
                                 
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2,
                                 rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    if pi_vDate1 is null and pi_vDate2 is null then
    
      -- get all patients list
      GetAllPatientsListRS(pi_vSessionID       => pi_vSessionID,
                           pi_vSessionClientIP => pi_vSessionClientIP,
                           pi_nUserID          => pi_nUserID,
                           pi_vKey             => pi_vKey,
                           po_nStatusCode      => po_nStatusCode,
                           po_vStatusComment   => po_vStatusComment,
                           rs                  => rs);
    
    elsif pi_vDate1 is not null and pi_vDate2 is null then
    
      -- get patients with events due date after or on date1
      open rs for
        select t.patient_id,
               fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) || ', ' ||
               fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) || ' ' ||
               fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as name,
               t.homephone as phone,
               fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
               t.fx_user_id
          from patient_demographics t
         where t.patient_id in
               (select e.patient_id
                  from patient_event e
                 where e.event_date is not null
                   and e.event_date >= to_date(pi_vDate1, 'mm/dd/yyyy')
                   and e.status = 0)
              
           and t.provider_id in
               (select provider_id
                  from suat_user s
                 where s.dims_id in
                       (select dims_id
                          from suat_user su
                         where su.fx_user_id = pi_nUserID))
        
         order by fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID),
                  fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID);
    
    elsif pi_vDate1 is null and pi_vDate2 is not null then
    
      -- get patients with events due date before or on than date2
      open rs for
        select t.patient_id,
               fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) || ' ' ||
               fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) || ' ' ||
               fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as name,
               t.homephone as phone,
               fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
               t.fx_user_id
          from patient_demographics t
         where t.patient_id in
               (select e.patient_id
                  from patient_event e
                 where e.event_date is not null
                   and e.event_date <= to_date(pi_vDate2, 'mm/dd/yyyy')
                   and e.status = 0)
              
           and t.provider_id in
               (select provider_id
                  from suat_user s
                 where s.dims_id in
                       (select dims_id
                          from suat_user su
                         where su.fx_user_id = pi_nUserID))
        
         order by fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID),
                  fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID);
    
    elsif pi_vDate1 is not null and pi_vDate2 is not null then
    
      -- get patients with events due in date range of date1 and date2
      open rs for
        select t.patient_id,
               fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) || ' ' ||
               fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) || ' ' ||
               fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as name,
               t.homephone as phone,
               fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
               t.fx_user_id
          from patient_demographics t
         where t.patient_id in
               (select e.patient_id
                  from patient_event e
                 where e.event_date is not null
                   and (e.event_date >= to_date(pi_vDate1, 'mm/dd/yyyy') and
                       e.event_date <= to_date(pi_vDate2, 'mm/dd/yyyy'))
                   and e.status = 0)
              
           and t.provider_id in
               (select provider_id
                  from suat_user s
                 where s.dims_id in
                       (select dims_id
                          from suat_user su
                         where su.fx_user_id = pi_nUserID))
        
         order by fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID),
                  fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID);
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetPatByEvtDueDateRS(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- *********************************************************************
  procedure SendEventReminder(pi_vKey           in varchar2,
                              pi_vPatientID     in varchar2,
                              pi_nEventID       in number,
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2) is
    curMsgPrefs RetRefCursor;
    curEvt      RetRefCursor;
    curPat      RetRefCursor;
  
    v_nSendEmail  number := 1; --need to change the send messages procedure; right now email is required
    v_nSendTxtMsg number := 0;
  
    v_vEmailSubject varchar2(255) := 'Portal Message';
    v_vMsgText      varchar2(32767) := 'Please log into the portal, there is an important message waiting for you.  Thank you.';
    v_vEmailAddress varchar2(255) := null;
    v_vTxtMsgNumber varchar2(255) := null;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get patient's messaging preferences
    CheckPatMessagesPrefs(pi_vKey,
                          pi_vPatientID,
                          v_nSendTxtMsg,
                          v_nSendEmail);
  
    v_nSendEmail := 1;
  
    --get patient's contact info
    begin
      for rec in (select t.PATIENT_ID,
                         fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
                         fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
                         fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
                         fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
                         fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
                         fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
                         mid(fnc_utl_decstr(t.last_name,
                                            pi_vKey,
                                            t.PATIENT_ID),
                             1,
                             1) ||
                         mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID),
                             6,
                             9) as LNSSNLAST4,
                         fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
                         t.MARITAL_STATUS_ID,
                         to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID),
                                 'MM/DD/YYYY') as dob,
                         t.HAS_FIRARM,
                         t.EDUCATION_LEVEL_ID,
                         t.PROVIDER_ID,
                         t.ADDRESS1,
                         t.ADDRESS2,
                         t.CITY,
                         t.POSTAL_CODE,
                         t.HOMEPHONE,
                         t.CELLPHONE,
                         t.WORKPHONE,
                         fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
                         t.STATE_ID,
                         t.HAS_REFERAL,
                         t.AWAITING_TRANSFER,
                         t.TRANSFER_DMIS_ID,
                         t.EDIPN,
                         t.FX_USER_ID,
                         t.LAST_UPDATED,
                         t.LAST_UPDATED_BY,
                         t.IS_HIGH_INTEREST,
                         t.PORTAL_USER_ID,
                         t.CURRENT_WEIGHT,
                         t.CURRENT_HEIGHT,
                         t.WRK_PHONE_CALL,
                         t.HOME_PHONE_CALL,
                         t.HOME_PHONE_MSG,
                         t.CELL_PHONE_CALL,
                         t.EMAIL_MSG,
                         t.DEVICE_ID,
                         GetPatientBMI(t.patient_id) as BMI,
                         trunc(months_between(SYSDATE,
                                              to_date(fnc_utl_decstr(t.dob,
                                                                     pi_vKey,
                                                                     t.PATIENT_ID),
                                                      'MM/DD/YYYY')) / 12) as patient_age
                    from patient_demographics t
                   where t.patient_id = pi_vPatientID) loop
      
        if rec.cellphone is not null then
          v_vTxtMsgNumber := rec.cellphone;
        end if;
      
        if rec.email is not null then
          v_vEmailAddress := rec.email;
        end if;
      
      end loop;
    end;
  
    --send internal notification
    SendInternalReminder(pi_vKey,
                         pi_vPatientID,
                         pi_nEventID,
                         po_nStatusCode,
                         po_vStatusComment);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.SendEventReminder(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- ************************************************************************
  -- SEND INTERNAL REMINDER
  procedure SendInternalReminder(pi_vKey           in varchar2,
                                 pi_vPatientID     in varchar2,
                                 pi_nEventID       in number,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
    v_nSenderID   number := 983; --temp front desk user
    v_clobMessage clob;
  
    v_vEvtName varchar2(4000);
    v_vEvtDate varchar2(4000);
  
    v_nRecipientID number := -1;
    v_nMessageID   number;
  
    v_vSubject varchar2(255) := 'Portal Message';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get event's REMINDER message
    select e.Reminder_Message, e.event
      into v_clobMessage, v_vEvtName
      from stat_event e
     where e.event_id = pi_nEventID;
  
    -- get event date
    select to_char(t.event_date, 'Month DD, YYYY')
      into v_vEvtDate
      from patient_event t
     where t.patient_id = pi_vPatientID
       and t.event_id = pi_nEventID;
  
    -- parse internal message using template's sp
    v_clobMessage := pck_template.fnGetParsedTemplateText(pi_vPatientID    => pi_vPatientID,
                                                          pi_vKey          => pi_vKey,
                                                          pi_vTemplateText => v_clobMessage);
  
    -- replace event name
    v_clobMessage := replace(v_clobMessage, '[EVENT_NAME]', v_vEvtName);
  
    -- replace event date
    v_clobMessage := replace(v_clobMessage, '[EVENT_DATE]', v_vEvtDate);
  
    --get recipient id (fx_user_id)
    begin
    
      select nvl(p.fx_user_id, -1) as fx_user_id
        into v_nRecipientID
        from patient_demographics p
       where p.patient_id = pi_vPatientID;
    
    exception
      when others then
        v_nRecipientID := -1;
    end;
  
    -- Send message
    pck_messages.SendMessage(pi_vSessionID       => '',
                             pi_vSessionClientIP => '',
                             pi_nUserID          => v_nSenderID,
                             pi_vKey             => pi_vKey,
                             pi_vRecipients      => to_char(v_nRecipientID) || ',',
                             pi_vSubject         => v_vSubject,
                             pi_clobBody         => v_clobMessage,
                             po_nMessageID       => v_nMessageID,
                             po_nStatusCode      => po_nStatusCode,
                             po_vStatusComment   => po_vStatusComment);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.SendInternalReminder(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- COMPELTED SPECIFIC EVENT -----------------------------------------------------------
  procedure CompletedSpecificEvent(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_vKey             in varchar2,
                                   pi_vPatientID       in varchar2,
                                   pi_nEventID         in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2) is
  
    curMsgPrefs RetRefCursor;
    curEvt      RetRefCursor;
    curPat      RetRefCursor;
  
    v_nPatEventID  number;
    v_nCountPatEvt number := 0;
  
    bSendNoficationEvt boolean := false;
  
    v_nSendEmail  number := 1; --need to change the send messages procedure; right now email is required
    v_nSendTxtMsg number := 0;
  
    v_vEmailSubject varchar2(255) := 'REVAMP Notification';
    v_vMsgText      varchar2(32767) := '';
    v_vEmailAddress varchar2(255) := null;
    v_vTxtMsgNumber varchar2(255) := null;
  
    v_nNotifSent number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- check the status for the event id
    select count(*)
      into v_nCountPatEvt
      from patient_event t
     where t.patient_id = pi_vPatientID
       and t.event_id = pi_nEventID
       and t.notification_sent = 0
       and t.status = 0;
  
    if v_nCountPatEvt > 0 then
      bSendNoficationEvt := true;
    end if;
  
    --get patient's messaging preferences
    CheckPatMessagesPrefs(pi_vKey,
                          pi_vPatientID,
                          v_nSendTxtMsg,
                          v_nSendEmail);
  
    v_nSendEmail := 1;
  
    --get patient's contact info
    begin
      for rec in (select t.PATIENT_ID,
                         fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
                         fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
                         fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
                         fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
                         fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
                         fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
                         mid(fnc_utl_decstr(t.last_name,
                                            pi_vKey,
                                            t.PATIENT_ID),
                             1,
                             1) ||
                         mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID),
                             6,
                             9) as LNSSNLAST4,
                         fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
                         t.MARITAL_STATUS_ID,
                         to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID),
                                 'MM/DD/YYYY') as dob,
                         t.HAS_FIRARM,
                         t.EDUCATION_LEVEL_ID,
                         t.PROVIDER_ID,
                         t.ADDRESS1,
                         t.ADDRESS2,
                         t.CITY,
                         t.POSTAL_CODE,
                         t.HOMEPHONE,
                         t.CELLPHONE,
                         t.WORKPHONE,
                         fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
                         t.STATE_ID,
                         t.HAS_REFERAL,
                         t.AWAITING_TRANSFER,
                         t.TRANSFER_DMIS_ID,
                         t.EDIPN,
                         t.FX_USER_ID,
                         t.LAST_UPDATED,
                         t.LAST_UPDATED_BY,
                         t.IS_HIGH_INTEREST,
                         t.PORTAL_USER_ID,
                         t.CURRENT_WEIGHT,
                         t.CURRENT_HEIGHT,
                         t.WRK_PHONE_CALL,
                         t.HOME_PHONE_CALL,
                         t.HOME_PHONE_MSG,
                         t.CELL_PHONE_CALL,
                         t.EMAIL_MSG,
                         t.DEVICE_ID,
                         GetPatientBMI(t.patient_id) as BMI,
                         trunc(months_between(SYSDATE,
                                              to_date(fnc_utl_decstr(t.dob,
                                                                     pi_vKey,
                                                                     t.PATIENT_ID),
                                                      'MM/DD/YYYY')) / 12) as patient_age
                    from patient_demographics t
                   where t.patient_id = pi_vPatientID) loop
      
        if rec.cellphone is not null then
          v_vTxtMsgNumber := rec.cellphone;
        end if;
      
        if rec.email is not null then
          v_vEmailAddress := rec.email;
        end if;
      
      end loop;
    end;
  
    --update event
    if bSendNoficationEvt then
    
      if pi_nEventID > 0 then
        --send internal notification
        SendInternalNotification(pi_vSessionID       => pi_vSessionID,
                                 pi_vSessionClientIP => pi_vSessionClientIP,
                                 pi_nUserID          => pi_nUserID,
                                 pi_vKey             => pi_vKey,
                                 pi_vPatientID       => pi_vPatientID,
                                 pi_nEventID         => pi_nEventID,
                                 po_nStatusCode      => po_nStatusCode,
                                 po_vStatusComment   => po_vStatusComment);
      
        -- get event's internal message
        select e.external_message
          into v_vMsgText
          from stat_event e
         where e.event_id = pi_nEventID;
      
        --send external notification
        if v_vEmailAddress is not null then
          PRC_UTL_SEND_EMAIL_TEXT_MSG(pi_vEmailSender      => 'revamp-notifications@intellicacorp.com',
                                      pi_vEmailRecipients  => v_vEmailAddress,
                                      pi_vEmailSubject     => v_vEmailSubject,
                                      pi_vEmailMessage     => v_vMsgText,
                                      pi_vTextingRecipient => v_vTxtMsgNumber,
                                      pi_vTextingMessage   => v_vMsgText);
        end if;
      
        v_nNotifSent := 1;
      
      end if;
    
      --update event
      update patient_event t
         set t.status            = 1,
             t.status_date       = sysdate,
             t.notification_sent = v_nNotifSent
       where t.patient_id = pi_vPatientID
         and t.event_id = pi_nEventID;
    
      commit;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.CompletedSpecificEvent(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- send event's notification ------------------------------------------
  procedure SendEventNotification(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  
                                  pi_vKey       in varchar2,
                                  pi_vPatientID in varchar2,
                                  pi_nEventID   in number,
                                  
                                  po_nStatusCode    out number,
                                  po_vStatusComment out varchar2) is
  
    curMsgPrefs RetRefCursor;
    curEvt      RetRefCursor;
    curPat      RetRefCursor;
  
    v_nSendEmail  number := 1; --need to change the send messages procedure; right now email is required
    v_nSendTxtMsg number := 0;
  
    v_vEmailSubject varchar2(255) := 'Portal Message';
    v_vMsgText      varchar2(32767) := 'Please log into the portal, there is an important message waiting for you.  Thank you.';
    v_vEmailAddress varchar2(255) := null;
    v_vTxtMsgNumber varchar2(255) := null;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get patient's messaging preferences
    CheckPatMessagesPrefs(pi_vKey,
                          pi_vPatientID,
                          v_nSendTxtMsg,
                          v_nSendEmail);
  
    v_nSendEmail := 1;
  
    --get patient's contact info
    begin
      for rec in (select t.PATIENT_ID,
                         fnc_utl_decstr(t.FIRST_NAME, pi_vKey, t.PATIENT_ID) as first_name,
                         fnc_utl_decstr(t.MI, pi_vKey, t.PATIENT_ID) as mi,
                         fnc_utl_decstr(t.LAST_NAME, pi_vKey, t.PATIENT_ID) as last_name,
                         fnc_utl_decstr(t.FMP, pi_vKey, t.PATIENT_ID) as fmp,
                         fnc_utl_decstr(t.SPONSOR_SSN, pi_vKey, t.PATIENT_ID) as sponsor_ssn,
                         fnc_utl_decstr(t.SSN, pi_vKey, t.PATIENT_ID) as ssn,
                         mid(fnc_utl_decstr(t.last_name,
                                            pi_vKey,
                                            t.PATIENT_ID),
                             1,
                             1) ||
                         mid(fnc_utl_decstr(t.ssn, pi_vKey, t.PATIENT_ID),
                             6,
                             9) as LNSSNLAST4,
                         fnc_utl_decstr(t.GENDER, pi_vKey, t.PATIENT_ID) as gender,
                         t.MARITAL_STATUS_ID,
                         to_date(fnc_utl_decstr(t.dob, pi_vKey, t.PATIENT_ID),
                                 'MM/DD/YYYY') as dob,
                         t.HAS_FIRARM,
                         t.EDUCATION_LEVEL_ID,
                         t.PROVIDER_ID,
                         t.ADDRESS1,
                         t.ADDRESS2,
                         t.CITY,
                         t.POSTAL_CODE,
                         t.HOMEPHONE,
                         t.CELLPHONE,
                         t.WORKPHONE,
                         fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email,
                         t.STATE_ID,
                         t.HAS_REFERAL,
                         t.AWAITING_TRANSFER,
                         t.TRANSFER_DMIS_ID,
                         t.EDIPN,
                         t.FX_USER_ID,
                         t.LAST_UPDATED,
                         t.LAST_UPDATED_BY,
                         t.IS_HIGH_INTEREST,
                         t.PORTAL_USER_ID,
                         t.CURRENT_WEIGHT,
                         t.CURRENT_HEIGHT,
                         t.WRK_PHONE_CALL,
                         t.HOME_PHONE_CALL,
                         t.HOME_PHONE_MSG,
                         t.CELL_PHONE_CALL,
                         t.EMAIL_MSG,
                         t.DEVICE_ID,
                         GetPatientBMI(t.patient_id) as BMI,
                         trunc(months_between(SYSDATE,
                                              to_date(fnc_utl_decstr(t.dob,
                                                                     pi_vKey,
                                                                     t.PATIENT_ID),
                                                      'MM/DD/YYYY')) / 12) as patient_age
                    from patient_demographics t
                   where t.patient_id = pi_vPatientID) loop
      
        if rec.cellphone is not null then
          v_vTxtMsgNumber := rec.cellphone;
        end if;
      
        if rec.email is not null then
          v_vEmailAddress := rec.email;
        end if;
      
      end loop;
    end;
  
    --send internal notification
    SendInternalNotification(pi_vSessionID       => pi_vSessionID,
                             pi_vSessionClientIP => pi_vSessionClientIP,
                             pi_nUserID          => pi_nUserID,
                             pi_vKey             => pi_vKey,
                             pi_vPatientID       => pi_vPatientID,
                             pi_nEventID         => pi_nEventID,
                             po_nStatusCode      => po_nStatusCode,
                             po_vStatusComment   => po_vStatusComment);
  
    --send external notification
    if v_vEmailAddress is not null then
      PRC_UTL_SEND_EMAIL_TEXT_MSG(pi_vEmailSender      => 'revamp-notifications@intellicacorp.com',
                                  pi_vEmailRecipients  => v_vEmailAddress,
                                  pi_vEmailSubject     => v_vEmailSubject,
                                  pi_vEmailMessage     => v_vMsgText,
                                  pi_vTextingRecipient => v_vTxtMsgNumber,
                                  pi_vTextingMessage   => v_vMsgText);
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.SendEventNotification(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- COMPELTED EVENT -----------------------------------------------------------
  procedure CompletedEvent(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           
                           pi_vKey       in varchar2,
                           pi_vPatientID in varchar2,
                           pi_nEventID   in number,
                           
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2) is
  
    curMsgPrefs RetRefCursor;
    curEvt      RetRefCursor;
    curPat      RetRefCursor;
  
    v_nNextEventID number := -1;
    v_nPatEventID  number;
    v_nCountPatEvt number := 0;
    v_nHasModGroup number := 0;
  
    bUpdateEvt    boolean := false;
    v_nSendEmail  number := 1; --need to change the send messages procedure; right now email is required
    v_nSendTxtMsg number := 0;
  
    v_vEmailSubject varchar2(255) := 'Portal Message';
    v_vMsgText      varchar2(32767) := 'Please log into the portal, there is an important message waiting for you.  Thank you.';
    v_vEmailAddress varchar2(255) := null;
    v_vTxtMsgNumber varchar2(255) := null;
  
    v_nNotifSent number := 0;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- check the status for the event id
    begin
      select count(*)
        into v_nCountPatEvt
        from patient_event t
       where t.patient_id = pi_vPatientID
         and t.event_id = pi_nEventID
         and t.notification_sent = 0
         and t.status = 0;
    exception
      when others then
        v_nCountPatEvt := 0;
    end;
  
    if v_nCountPatEvt > 0 then
      bUpdateEvt := true;
    end if;
  
    --check if the event has a module group associated to it
    begin
      select count(*)
        into v_nHasModGroup
        from intake_module_group t
       where t.event_id = pi_nEventID;
    exception
      when others then
        v_nHasModGroup := 0;
    end;
  
    --get patient's messaging preferences
    PCK_PATIENT_EVENTS.CheckPatMessagesPrefs(pi_vKey,
                                             pi_vPatientID,
                                             v_nSendTxtMsg,
                                             v_nSendEmail);
  
    v_nSendEmail := 1;
  
    --get patient's contact info
    begin
      select REGEXP_REPLACE(t.CELLPHONE, '\D', '')
        into v_vTxtMsgNumber
        from patient_demographics t
       where t.patient_id = pi_vPatientID;
    exception
      when others then
        v_vTxtMsgNumber := null;
    end;
  
    begin
      select fnc_utl_decstr(t.EMAIL, pi_vKey, t.PATIENT_ID) as email
        into v_vEmailAddress
        from patient_demographics t
       where t.patient_id = pi_vPatientID;
    exception
      when others then
        v_vEmailAddress := null;
    end;
  
    --get next event id 
  
    begin
      select event_id
        into v_nNextEventID
        from stat_event e
       where e.trigger_event_id = pi_nEventID
         and e.triggered_by = 1
         and e.active = 1;
    exception
      when others then
        v_nNextEventID := -1;
    end;
  
    --update event
    if bUpdateEvt then
    
      if v_nNextEventID > 0 then
        --send internal notification
        SendInternalNotification(pi_vSessionID       => pi_vSessionID,
                                 pi_vSessionClientIP => pi_vSessionClientIP,
                                 pi_nUserID          => pi_nUserID,
                                 pi_vKey             => pi_vKey,
                                 pi_vPatientID       => pi_vPatientID,
                                 pi_nEventID         => v_nNextEventID,
                                 po_nStatusCode      => po_nStatusCode,
                                 po_vStatusComment   => po_vStatusComment);
      
        v_nNotifSent := 1;
      
      end if;
    
      --update event
      if v_nHasModGroup < 1 then
      
        update patient_event t
           set t.status            = 1,
               t.status_date       = sysdate,
               t.notification_sent = 1
         where t.patient_id = pi_vPatientID
           and t.event_id = pi_nEventID;
      else
        -- if the event has an associated module group
        -- do not update the event's date
        update patient_event t
           set t.status            = 1,
               t.status_date       = sysdate,
               t.notification_sent = 1
         where t.patient_id = pi_vPatientID
           and t.event_id = pi_nEventID;
      end if;
    
      commit;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.CompletedEvent(): ' ||
                           sqlErrm;
  end;

  --converted to use new encryption
  -- SEND INTERNAL NOTIFICATION -------------------------------------------------------------
  procedure SendInternalNotification(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     
                                     pi_vKey       in varchar2,
                                     pi_vPatientID in varchar2,
                                     pi_nEventID   in number,
                                     
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2) is
  
    v_nSenderID   number := 983; --temp front desk user
    v_clobMessage clob;
  
    v_nRecipientID number := -1;
    v_nMessageID   number;
  
    v_vSubject varchar2(255) := 'Portal Message';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get event's internal message
    select e.internal_message
      into v_clobMessage
      from stat_event e
     where e.event_id = pi_nEventID;
  
    -- parse internal message using template's sp
    v_clobMessage := pck_template.fnGetParsedTemplateText(pi_vPatientID    => pi_vPatientID,
                                                          pi_vKey          => pi_vKey,
                                                          pi_vTemplateText => v_clobMessage);
  
    --get recipient id (fx_user_id)
    begin
    
      select p.fx_user_id
        into v_nRecipientID
        from patient_demographics p
       where p.patient_id = pi_vPatientID;
    
    exception
      when others then
        v_nRecipientID := -1;
    end;
  
    -- Send message
    pck_messages.SendMessage(pi_vSessionID       => pi_vSessionID,
                             pi_vSessionClientIP => pi_vSessionClientIP,
                             pi_nUserID          => v_nSenderID,
                             pi_vKey             => pi_vKey,
                             pi_vRecipients      => to_char(v_nRecipientID) || ',',
                             pi_vSubject         => v_vSubject,
                             pi_clobBody         => v_clobMessage,
                             po_nMessageID       => v_nMessageID,
                             po_nStatusCode      => po_nStatusCode,
                             po_vStatusComment   => po_vStatusComment);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.SendInternalNotification(): ' ||
                           sqlErrm;
  end;

  --get patient events rs
  procedure GetPatientEventsRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vPatientID       in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t1.*,
             t2.patient_id,
             t2.pat_event_id,
             t2.event_date,
             t2.status,
             t2.status_date,
             t2.notification_sent,
             t2.comments,
             t2.reminder_sent,
             t2.date_readonly
        from (select e.*
                 from stat_event e
                where e.active = 1
                  and e.event_id < 10000 --WorkFlow Events -Event ID's < 10000
               order by e.event_id) t1
      
        left join (select p.*,
                          IsEventDateReadOnly(p.patient_id, p.event_id) as date_readonly
                     from patient_event p
                    where p.patient_id = pi_vPatientID) t2
      
          on t2.event_id = t1.event_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetPatientEventsRS(): ' ||
                           sqlErrm;
  end;

  --get all patient events rs
  procedure GetAllPatientEventsRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select t2.patient_id,
             t1.event_id,
             t2.event_date,
             nvl(t2.status, 0) as status
        from (select e.*
                from stat_event e
               where e.active = 1
                 and e.event_group = 1) t1
      
        left join (select *
                     from patient_event p
                    where p.patient_id in
                          (select patient_id
                             from patient_demographics d
                            where d.provider_id in
                                  (select provider_id
                                     from suat_user s
                                    where s.dims_id in
                                          (select dims_id
                                             from suat_user su
                                            where su.fx_user_id = pi_nUserID)))) t2
          on t2.event_id = t1.event_id
       order by t2.patient_id, t2.event_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetAllPatientEventsRS(): ' ||
                           sqlErrm;
  end;

  --check pat messages prefs
  procedure CheckPatMessagesPrefs(pi_vKey       in varchar2,
                                  pi_vPatientID in varchar2,
                                  po_nTextMsg   out number,
                                  po_nEmail     out number) is
  
    v_nCount number := 0;
  
  begin
  
    po_nTextMsg := 0;
    po_nEmail   := 0;
  
    select count(*)
      into v_nCount
      from patient_demographics t
     where t.patient_id = pi_vPatientID;
  
    if v_nCount > 0 then
      select t.home_phone_msg, t.email_msg
        into po_nTextMsg, po_nEmail
        from patient_demographics t
       where t.patient_id = pi_vPatientID;
    end if;
  
  exception
    when others then
      po_nTextMsg := 0;
      po_nEmail   := 0;
  end;

  --Add all events for patient
  procedure AddAllEvents(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         
                         pi_vPatientID in varchar2,
                         
                         po_nStatusCode    out number,
                         po_vStatusComment out varchar2) is
  
    curEvents RetRefCursor;
    recEvent  stat_event%rowtype;
  
    v_nEvtCount number := 0;
    v_nPatEvtID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get all the events recordset 
    open curEvents for
      select *
        from stat_event e
       where e.active = 1
         and e.event_group = 1
       order by e.event_id;
  
    loop
      fetch curEvents
        into recEvent;
      exit when curEvents%notfound;
    
      select count(*)
        into v_nEvtCount
        from patient_event p
       where p.patient_id = pi_vPatientID
         and p.event_id = recEvent.Event_Id;
    
      if v_nEvtCount < 1 then
      
        select seqpateventid.nextval into v_nPatEvtID from dual;
      
        insert into patient_event t
          (patient_id, pat_event_id, event_id, status)
        values
          (pi_vPatientID, v_nPatEvtID, recEvent.Event_Id, 0);
        commit;
      
      end if;
    
    end loop;
    close curEvents;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.AddAllEvents(): ' || sqlErrm;
  end;

  --Update patient event
  procedure UpdatePatientEvent(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_vKey       in varchar2,
                               pi_vPatientID in varchar2,
                               pi_nEventID   in number,
                               pi_vEventDate in varchar2,
                               pi_nStatus    in number,
                               pi_vComments  in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2) is
  
    v_vSQL           varchar2(32767) := '';
    v_nEvtType       number := 0;
    v_dtScheduledFor date := null;
  
    v_nCount    number := 0;
    v_nModGroup number := -1;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select e.triggered_by
      into v_nEvtType
      from stat_event e
     where e.event_id = pi_nEventID;
  
    v_vSQL := v_vSQL || 'update patient_event t ';
    v_vSQL := v_vSQL || 'set ';
  
    if LENGTH(pi_vEventDate) > 7 then
      v_vSQL := v_vSQL || ' t.event_date  = to_date(''' || pi_vEventDate ||
                ''', ''mm/dd/yyyy''), ';
    
      v_dtScheduledFor := to_date(pi_vEventDate, 'mm/dd/yyyy');
    end if;
  
    v_vSQL := v_vSQL || '       t.status      = ' || pi_nStatus || ', ';
  
    if (v_nEvtType != 1 and v_nEvtType != 4) then
      if (UpdateStatusDate(pi_vPatientID => pi_vPatientID,
                           pi_nEventID   => pi_nEventID,
                           pi_nStatus    => pi_nStatus,
                           pi_vEventDate => pi_vEventDate) > 0) then
        v_vSQL := v_vSQL || '       t.status_date = sysdate, ';
      end if;
    end if;
  
    v_vSQL := v_vSQL || '       t.comments    = ''' || pi_vComments ||
              ''' ';
    v_vSQL := v_vSQL || ' where t.patient_id = ''' || pi_vPatientID ||
              ''' ';
    v_vSQL := v_vSQL || '   and t.event_id = ' || pi_nEventID || ' ';
  
    execute immediate v_vSQL;
    commit;
  
    --first delete module group items for the event with status 0
    --  
    begin
      select m.module_group_id
        into v_nModGroup
        from intake_module_group m
       where m.event_id = pi_nEventID;
    exception
      when others then
        v_nModGroup := 0;
    end;
  
    select count(*)
      into v_nCount
      from patient_module m
     where m.patient_id = pi_vPatientID
       and m.module_group_id = v_nModGroup
       and nvl(m.status, 0) > 0;
  
    if v_nCount = 0 then
    
      delete from patient_module p
       where p.patient_id = pi_vPatientID
         and p.status = 0
         and p.module_group_id = v_nModGroup;
      commit;
    
      if LENGTH(pi_vEventDate) > 7 then
        AssignModuleGroupEvent(pi_vSessionID       => pi_vSessionID,
                               pi_vSessionClientIP => pi_vSessionClientIP,
                               pi_nUserID          => pi_nUserID,
                               pi_vPatientID       => pi_vPatientID,
                               pi_nEventID         => pi_nEventID,
                               pi_dtEventDate      => v_dtScheduledFor,
                               po_nStatusCode      => po_nStatusCode,
                               po_vStatusComment   => po_vStatusComment);
      end if;
    
    end if;
  
    -- send notification
    if pi_nStatus = 1 and v_nEvtType = 2 then
      begin
        SendInternalNotification(pi_vSessionID       => pi_vSessionID,
                                 pi_vSessionClientIP => pi_vSessionClientIP,
                                 pi_nUserID          => pi_nUserID,
                                 
                                 pi_vKey       => pi_vKey,
                                 pi_vPatientID => pi_vPatientID,
                                 pi_nEventID   => pi_nEventID,
                                 
                                 po_nStatusCode    => po_nStatusCode,
                                 po_vStatusComment => po_vStatusComment);
      
        update patient_event t
           set t.reminder_sent = 1
         where t.patient_id = pi_vPatientID
           and t.event_id = pi_nEventID;
      
        commit;
      
      exception
        when others then
          null;
      end;
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.UpdatePatientEvent(): ' ||
                           sqlErrm;
  end;

  -- get stat events
  procedure GetStatEventsRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor) is
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select *
        from stat_event t
       where t.active = 1
         and t.event_group = 1
       order by t.event_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetStatEventsRS(): ' ||
                           sqlErrm;
  end;

  --Add Specific event for patient
  procedure AddSpecificEvent(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             pi_nEventID         in number,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2) is
  
    curEvents RetRefCursor;
    recEvent  stat_event%rowtype;
  
    v_nEvtCount number := 0;
    v_nPatEvtID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --get all the events recordset 
    open curEvents for
      select *
        from stat_event e
       where e.event_id = pi_nEventID
         and e.active = 1;
  
    loop
      fetch curEvents
        into recEvent;
      exit when curEvents%notfound;
    
      select seqpateventid.nextval into v_nPatEvtID from dual;
    
      insert into patient_event t
        (patient_id, pat_event_id, event_id, status)
      values
        (pi_vPatientID, v_nPatEvtID, recEvent.Event_Id, 0);
      commit;
    
    end loop;
    close curEvents;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.AddSpecificEvent(): ' ||
                           sqlErrm;
  end;

  -- ****************************************************************
  procedure AssignModuleGroupEvent(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID  in varchar2,
                                   pi_nEventID    in number,
                                   pi_dtEventDate in date,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2) is
  
    v_nCount    number := 0;
    v_nModGroup number;
  
    v_vProviderID varchar2(50);
  
    curMods RetRefCursor;
    recMods intake_module_group_mid%rowtype;
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := '';
  
    select provider_id
      into v_vProviderID
      from suat_user u
     where u.fx_user_id = pi_nUserID;
  
    select count(*)
      into v_nCount
      from intake_module_group t
     where t.event_id = pi_nEventID;
  
    if v_nCount > 0 then
    
      select t.module_group_id
        into v_nModGroup
        from intake_module_group t
       where t.event_id = pi_nEventID;
    
      open curMods for
        select imgm.*
          from intake_module_group_mid imgm, intake_module im
         where im.active = 1
           and im.mid = imgm.mid
           and imgm.module_group_id = v_nModGroup
         order by imgm.module_group_id, imgm.sort_order;
    
      loop
        fetch curMods
          into recMods;
        exit when curMods%notfound;
      
        insert into patient_module pm
          (patient_id,
           assign_provider_id,
           date_assigned,
           mid,
           status,
           last_updated,
           last_updated_by,
           module_group_id,
           language_used,
           SCHEDULED_DATE)
        values
          (pi_vPatientID,
           v_vProviderID,
           sysdate,
           recMods.Mid,
           0,
           sysdate,
           pi_nUserID,
           recMods.Module_Group_Id,
           0,
           pi_dtEventDate);
        commit;
      
      end loop;
      close curMods;
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.AssignModuleGroupEvent(): ' ||
                           sqlErrm;
  end;

  -- **************************************************************************
  -- SEND PATIENT EVENT REMINDER

  procedure SendPatEventReminder(pi_vKey           in varchar2,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
    curEvent RetRefCursor;
    recEvent stat_event%rowtype;
  
    curPatEvt RetRefCursor;
    recPatEvt patient_event%rowtype;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open curPatEvt for
      select *
        from patient_event t
       where t.event_date is not null
         and t.reminder_sent = 0
         and t.status != 1
         and to_date(to_char(sysdate, 'mm/dd/yyyy'), 'mm/dd/yyyy') >=
             (to_date(to_char(t.event_date, 'mm/dd/yyyy'), 'mm/dd/yyyy') -
             to_number(getParameterValue('DAYS_PRIOR')));
    loop
      fetch curPatEvt
        into recPatEvt;
      exit when curPatEvt%notfound;
    
      begin
        --send reminder for patient event
        SendEventReminder(pi_vKey,
                          recPatEvt.Patient_Id,
                          recPatEvt.Event_Id,
                          po_nStatusCode,
                          po_vStatusComment);
      
        -- set reminder status to sent
        update patient_event e
           set e.reminder_sent = 1
         where e.patient_id = recPatEvt.Patient_Id
           and e.event_id = recPatEvt.Event_Id;
      
        commit;
      
      end;
    
    end loop;
    close curPatEvt;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.SendPatEventReminder(): ' ||
                           sqlErrm;
  end;

  function IsEventDateReadOnly(pi_vPatientID in varchar2,
                               pi_nEventID   in number) return number is
    Result   number := 0;
    v_nCount number := 0;
  
  begin
  
    select count(*)
      into v_nCount
      from patient_module m
     where m.patient_id = pi_vPatientID
       and m.module_group_id in
           (select im.module_group_id
              from intake_module_group im
             where im.event_id = pi_nEventID)
       and nvl(m.status, 0) > 0;
  
    if (v_nCount > 0) then
      Result := 1;
    end if;
  
    return(Result);
  end IsEventDateReadOnly;

  procedure CheckPAPEventALL(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vKey in varchar2,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2) is
  
    cursor curPap is
      select distinct patient_id from patient_cpap;
  
    v_dtPAPDate      date;
    v_nStatusCode    number;
    v_vStatusComment varchar2(32767);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    for pap_rec in curPAP loop
      select min(therapy_date)
        into v_dtPAPDate
        from patient_cpap
       where patient_id = pap_rec.patient_id;
    
      pck_patient_events.CompletedEvent(pi_vSessionID,
                                        pi_vSessionClientIP,
                                        pi_nUserID,
                                        pi_vKey,
                                        pap_rec.patient_id,
                                        10,
                                        v_nStatusCode,
                                        v_vStatusComment);
    
      update patient_event t
         set t.status_date = v_dtPAPDate
       where t.event_id = 10
         and t.patient_id = pap_rec.patient_id;
      commit;
    
    end loop;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.CheckPAPEventALL(): ' ||
                           sqlErrm;
  end;

  procedure CheckPAPEvent(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          
                          pi_vKey       in varchar2,
                          pi_vPatientID in varchar2,
                          
                          po_nStatusCode    out number,
                          po_vStatusComment out varchar2) is
  
    v_nCount         number;
    v_dtPAPDate      date;
    v_nStatusCode    number;
    v_vStatusComment varchar2(32767);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_nCount          := 0;
  
    begin
      select count(*)
        into v_nCount
        from patient_cpap
       where patient_id = pi_vPatientID;
    exception
      when others then
        v_nCount := 0;
    end;
  
    if v_nCount > 0 then
    
      select min(therapy_date)
        into v_dtPAPDate
        from patient_cpap
       where patient_id = pi_vPatientID;
    
      pck_patient_events.CompletedEvent(pi_vSessionID,
                                        pi_vSessionClientIP,
                                        pi_nUserID,
                                        pi_vKey,
                                        pi_vPatientID,
                                        10,
                                        v_nStatusCode,
                                        v_vStatusComment);
    
      update patient_event t
         set t.status_date = v_dtPAPDate
       where t.event_id = 10
         and t.patient_id = pi_vPatientID;
      commit;
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.CheckPAPEvent(): ' ||
                           sqlErrm;
  end;

  function UpdateStatusDate(pi_vPatientID in varchar2,
                            pi_nEventID   in number,
                            pi_nStatus    in number,
                            pi_vEventDate in varchar2) return number is
    v_nResult number := 0;
  
    v_dtDate1  date := null;
    v_dtDate2  date := null;
    v_nStatus1 number := 0;
    v_nStatus2 number := 0;
  
    v_vDateRegExpPatt varchar2(32767);
  
    v_bDate   boolean;
    v_bStatus boolean;
  
  begin
    --set regular expresion to evaluate date format
    v_vDateRegExpPatt := '^(0[1-9]|1[0-2]|[1-9]{1})/([1-9]{1}|0[1-9]|[12]\d|3[01])/20(1[3-9]|[2-9]\d)$';
  
    -- set event status (2) from parameter
    v_nStatus2 := pi_nStatus;
  
    --set event date (2) from parameter
    if LENGTH(pi_vEventDate) > 0 then
      begin
        if (regexp_count(pi_vEventDate, v_vDateRegExpPatt) > 0) then
          v_dtDate2 := to_date(pi_vEventDate, 'mm/dd/yyyy');
        end if;
      exception
        when others then
          v_dtDate2 := null;
      end;
    end if;
  
    -- get event record
    for rec in (select *
                  from patient_event
                 where patient_id = pi_vPatientID
                   and event_id = pi_nEventID) loop
      --set event date (1) from record
      if rec.event_date is not null then
        v_dtDate1 := to_date(to_char(rec.event_date, 'mm/dd/yyyy'),
                             'mm/dd/yyyy');
      end if;
    
      --set status (1) from record
      if rec.status is not null then
        v_nStatus1 := rec.status;
      end if;
    
    end loop;
  
    -- evaluate date and status
    if (v_dtDate1 is null) and (v_dtDate2 is null) then
      v_bDate := TRUE;
    else
      v_bDate := (v_dtDate1 = v_dtDate2);
    end if;
  
    v_bStatus := (v_nStatus1 = v_nStatus2);
  
    if v_bDate and v_bStatus then
      v_nResult := 0;
    else
      v_nResult := 1;
    end if;
  
    return(v_nResult);
  end UpdateStatusDate;

  -- Get JSON string of patient events
  procedure GetAllPatEventsJSONRS(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vKey             in varchar2,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2,
                                  rs                  out RetRefCursor) is
    clobEvents clob := '';
    cTmp       clob;
    nStatus    number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --build the JSON string
    clobEvents := clobEvents || '{';
    clobEvents := clobEvents || '"events":[';
  
    for rec in (select t.patient_id,
                       nvl(t.fx_user_id, 0) as fx_user_id,
                       fnc_utl_decstr(t.last_name, pi_vKey, t.patient_id) || ', ' ||
                       fnc_utl_decstr(t.first_name, pi_vKey, t.patient_id) as fullname,
                       t.cellphone,
                       t.homephone
                  from patient_demographics t, fx_user f
                 where t.provider_id in
                       (select s.provider_id
                          from suat_user s
                         where s.dims_id in
                               (select dims_id
                                  from suat_user u
                                 where u.fx_user_id = pi_nUserID))
                   and t.fx_user_id = f.fx_user_id(+)
                   and f.is_inactive != 1
                 order by fnc_utl_decstr(t.last_name, pi_vKey, t.patient_id),
                          fnc_utl_decstr(t.first_name, pi_vKey, t.patient_id)) loop
    
      clobEvents := clobEvents || '{';
      clobEvents := clobEvents || '"patient_id": "' || rec.patient_id || '",';
      clobEvents := clobEvents || '"fx_user_id": ' ||
                    to_char(rec.fx_user_id) || ',';
      clobEvents := clobEvents || '"name": "' || rec.fullname || '",';
    
      if rec.cellphone is null then
        clobEvents := clobEvents || '"phone": "' || rec.homephone || '",';
      else
        clobEvents := clobEvents || '"phone": "' || rec.cellphone || '",';
      end if;
    
      clobEvents := clobEvents || '"event": [';
    
      -- loop the events table
    
      cTmp := '';
    
      for rec2 in (select *
                     from patient_event e
                    where e.patient_id = rec.patient_id
                      and e.event_id < 100
                      and e.event_id in (select event_id
                                           from stat_event s
                                          where s.event_id < 100
                                            and s.active = 1)
                    order by e.event_id)
      
       loop
        cTmp := cTmp || '{';
        cTmp := cTmp || '"event_id": ' || to_char(rec2.event_id) || ',';
      
        --event date
        if rec2.event_date is null then
          cTmp := cTmp || '"event_date": "",';
        else
          cTmp := cTmp || '"event_date": "' ||
                  to_char(rec2.event_date, 'MM/DD/YYYY') || '",';
        end if;
      
        --status
        if rec2.status is null then
          cTmp := cTmp || '"status": 0,';
        else
        
          if ((rec2.status = 0) and (rec2.event_date is not null)) then
            if sysdate > rec2.event_date then
              cTmp := cTmp || '"status": 3,';
            elsif (rec2.event_date >=
                  to_date(trunc(sysdate -
                                 (to_number(to_char(sysdate, 'D')) - 1))) or
                  rec2.event_date <=
                  to_date(trunc(sysdate +
                                 (7 - to_number(to_char(sysdate, 'D')))))) then
              cTmp := cTmp || '"status": 2,';
            end if;
          else
            cTmp := cTmp || '"status": ' || to_char(rec2.status) || ',';
          end if;
        
        end if;
      
        --status date
        if rec2.status_date is null then
          cTmp := cTmp || '"status_date": ""';
        else
          cTmp := cTmp || '"status_date": "' ||
                  to_char(rec2.status_date, 'MM/DD/YYYY') || '"';
        end if;
      
        cTmp := cTmp || '},';
      end loop;
    
      if length(cTmp) > 2 then
        cTmp := substr(cTmp, 1, length(cTmp) - 1);
      end if;
    
      clobEvents := clobEvents || cTmp;
    
      clobEvents := clobEvents || ']';
      clobEvents := clobEvents || '},';
    
    end loop;
  
    -- close the JSON string 
  
    if length(clobEvents) > 11 then
      clobEvents := substr(clobEvents, 1, length(clobEvents) - 1);
    end if;
  
    clobEvents := clobEvents || ']}';
  
    open rs for
      select clobEvents as events from dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_EVENTS.GetAllPatEventsJSONRS(): ' ||
                           sqlErrm;
  end;

end PCK_PATIENT_EVENTS;
/

prompt
prompt Creating package body PCK_PATIENT_LOCK
prompt ======================================
prompt
create or replace package body PCK_PATIENT_LOCK is

  procedure GetPatientLock(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           rs                  out RetRefCursor,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  
    v_nCount         number := 0;
    v_nUserIDrec     number := 0;
    v_vProviderIDrec varchar(50) := '';
    v_vSessionIDrec  varchar(500) := '';
    v_nElapsedTime   number := 0;
    v_nIdleTime      number := 16; --unlock the record after # idle minutes
  
    curPatLock RetRefCursor;
    recPatLock vw_patient_lock%rowtype;
  
  begin
  
    -- delete records with idle times > v_nIdleTime
    open curPatLock for
      select * from vw_patient_lock v where v.elapsed_time > v_nIdleTime;
  
    loop
      fetch curPatLock
        into recPatLock;
      exit when curPatLock%notfound;
      delete from patient_lock pl
       where pl.patient_id = recPatLock.PATIENT_ID;
      commit;
    end loop;
  
    close curPatLock;
  
    select count(*)
      into v_nCount
      from vw_patient_lock vpl
     where vpl.PATIENT_ID = pi_vPatientID;
  
    if (v_nCount > 0) then
      select l.provider_id,
             l.session_id,
             l.fx_user_id,
             nvl(l.elapsed_time, 0)
        into v_vProviderIDrec,
             v_vSessionIDrec,
             v_nUserIDrec,
             v_nElapsedTime
        from vw_patient_lock l
       where l.patient_id = pi_vPatientID;
    
      --is the record locked by this user?  
      if (pi_nUserID = v_nUserIDrec) then
      
        -- if user left session without using the LogOut link,
        -- this record remains locked
        -- if is the same user who tries to access the record in 
        -- a different session, updated the session info in the record
        if (nvl(pi_vSessionID, 'null') != nvl(v_vSessionIDrec, 'null')) then
        
          --unlock previous looked up patients in this session 
          delete 
            from patient_lock p 
           where p.fx_user_id = pi_nUserID
             and p.session_id = pi_vSessionID;
          commit;
        
          --refresh patient's record lock
          update patient_lock pl
          set pl.session_id = pi_vSessionID,
              pl.lock_time = sysdate
          where pl.fx_user_id = pi_nUserID
            and pl.patient_id = pi_vPatientID;
          commit;
        
        end if;
      end if;
    else
      --lock the patient's record by this provider
      InsertPatientLock(pi_vSessionID       => pi_vSessionID,
                        pi_vSessionClientIP => pi_vSessionClientIP,
                        pi_nUserID          => pi_nUserID,
                        pi_vPatientID       => pi_vPatientID,
                        po_nStatusCode      => po_nStatusCode,
                        po_vStatusComment   => po_vStatusComment);
    end if;
  
    --return recordset of patient lock status
    open rs for
      select * from vw_patient_lock v where v.PATIENT_ID = pi_vPatientID;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_LOCK.GetPatientLock(): ' || sqlErrm;
  end;

  procedure InsertPatientLock(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2) is
  
    v_vProviderID   varchar(50) := '';
    v_vProviderName varchar(128) := '';
    v_vProviderEmail varchar(255) := '';
  
  begin
  
    --unlock previous looked up patient record in this session
    delete from patient_lock p
     where p.session_id = pi_vSessionID
       and p.fx_user_id = pi_nUserID;
    commit;
  
    select s.provider_id, s.name, s.email
      into v_vProviderID, v_vProviderName, v_vProviderEmail
      from suat_user s
     where s.fx_user_id = pi_nUserID;
  
    insert into patient_lock
      (patient_id,
       provider_id,
       provider_name,
       session_id,
       lock_time,
       fx_user_id,
       email)
    values
      (pi_vPatientID,
       v_vProviderID,
       v_vProviderName,
       pi_vSessionID,
       sysdate,
       pi_nUserID,
       v_vProviderEmail);
    commit;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_LOCK.InsertPatientLock(): ' ||
                           sqlErrm;
  end;

  procedure DeletePatientLock(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2) is
  
  begin
  
    delete from patient_lock p
     where p.patient_id = pi_vPatientID
       and p.fx_user_id = pi_nUserID;
    commit;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_LOCK.DeletePatientLock(): ' ||
                           sqlErrm;
  end;

  procedure RefreshPatientLock(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vPatientID       in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2) is
  
  begin
  
    update patient_lock p
       set p.lock_time = sysdate
     where p.session_id = pi_vSessionID
       and p.patient_id = pi_vPatientID
       and p.fx_user_id = pi_nUserID;
    commit;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_LOCK.RefreshPatientLock(): ' ||
                           sqlErrm;
  end;

end PCK_PATIENT_LOCK;
/

prompt
prompt Creating package body PCK_PATIENT_TX_STEP
prompt =========================================
prompt
create or replace package body PCK_PATIENT_TX_STEP is

  procedure InsertPatientStep(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              
                              pi_vPatientID in varchar2,
                              pi_nStep      in number,
                              
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2) is
  
    v_nProfile                number := 1;
    v_nStartedBaseline        number := 2;
    v_nBaselineQuestionnaires number := 4;
    v_nStartedVideos          number := 8;
    v_nVideos                 number := 16;
    v_nCPAPData               number := 32;
  
    v_nStep number := 0;
  
    v_nCount       number;
    v_nRecCount    number := 0;
    v_nCurrentStep number := 0;
  
  begin
  
    select count(*)
      into v_nRecCount
      from patient_treatment_step t
     where t.patient_id = pi_vPatientID;
  
    if v_nRecCount > 0 then
      select treatment_step
        into v_nCurrentStep
        from patient_treatment_step t
       where t.patient_id = pi_vPatientID;
    end if;
  
    if (bitand(v_nCurrentStep, v_nProfile) = 0) then
      -- set step value for complete patient profile (from the portal)
      -- only if this step was not set before
      if (bitand(pi_nStep, v_nProfile) = v_nProfile) then
        v_nStep := v_nStep + v_nProfile;
      end if;
    elsif (bitand(v_nCurrentStep, v_nProfile) = v_nProfile) then
      v_nStep := v_nStep + v_nProfile;
    end if;
  
    --insert step other than PROFILE
    if (bitand(pi_nStep, v_nProfile) = 0) then
      v_nStep := v_nStep + pi_nStep;
    end if;
  
    --check status of Baseline questionnaires
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_module t
     where t.patient_id = pi_vPatientID
       and (t.module_group_id = 2 and t.status = 1);
  
    if v_nCount > 0 then
      v_nStep := v_nStep + v_nStartedBaseline;
    end if;
  
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_event t
     where t.patient_id = pi_vPatientID
       and (t.status = 1 and t.event_id = 5);
  
    if v_nCount > 0 then
      v_nStep := v_nStep + v_nBaselineQuestionnaires;
    end if;
  
    --check status of video events
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_event t
     where t.patient_id = pi_vPatientID
       and (t.status = 1 and t.event_id in (3, 4));
  
    if v_nCount = 1 then
      v_nStep := v_nStep + v_nStartedVideos;
    elsif v_nCount = 2 then
      v_nStep := v_nStep + v_nStartedVideos + v_nVideos;
    end if;
  
    --check status of CPAP Data
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_cpap t
     where t.patient_id = pi_vPatientID;
  
    if v_nCount > 0 then
      v_nStep := v_nStep + v_nCPAPData;
    end if;
  
    --insert or update
    if v_nRecCount > 0 then
      update patient_treatment_step t
         set t.treatment_step = v_nStep
       where t.patient_id = pi_vPatientID;
    else
      insert into patient_treatment_step
        (patient_id, treatment_step)
      values
        (pi_vPatientID, v_nStep);
    end if;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_TX_STEP.InsertPatientStep(): ' ||
                           sqlErrm;
  end;

  procedure UpdatePatientSteps(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               
                               pi_vPatientID in varchar2,
                               
                               po_nStatusCode    out number,
                               po_vStatusComment out varchar2) is
  
    v_nProfile                number := 1;
    v_nStartedBaseline        number := 2;
    v_nBaselineQuestionnaires number := 4;
    v_nStartedVideos          number := 8;
    v_nVideos                 number := 16;
    v_nCPAPData               number := 32;
  
    v_nStep number := 0;
  
    v_nCount       number;
    v_nRecCount    number := 0;
    v_nCurrentStep number := 0;
  
  begin
  
    select count(*)
      into v_nRecCount
      from patient_treatment_step t
     where t.patient_id = pi_vPatientID;
  
    if v_nRecCount > 0 then
      select treatment_step
        into v_nCurrentStep
        from patient_treatment_step t
       where t.patient_id = pi_vPatientID;
    end if;
  
    if (bitand(v_nCurrentStep, v_nProfile) = v_nProfile) then
      v_nStep := v_nStep + v_nProfile;
    end if;
  
    --check status of Baseline questionnaires
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_module t
     where t.patient_id = pi_vPatientID
       and (t.module_group_id = 2 and t.status = 1);
  
    if v_nCount > 0 then
      v_nStep := v_nStep + v_nStartedBaseline;
    end if;
  
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_event t
     where t.patient_id = pi_vPatientID
       and (t.status = 1 and t.event_id = 5);
  
    if v_nCount > 0 then
      v_nStep := v_nStep + v_nBaselineQuestionnaires;
    end if;
  
    --check status of video events
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_event t
     where t.patient_id = pi_vPatientID
       and (t.status = 1 and t.event_id in (3, 4));
  
    if v_nCount = 1 then
      v_nStep := v_nStep + v_nStartedVideos;
    elsif v_nCount = 2 then
      v_nStep := v_nStep + v_nStartedVideos + v_nVideos;
    end if;
  
    --check status of CPAP Data
    v_nCount := 0;
    select count(*)
      into v_nCount
      from patient_cpap t
     where t.patient_id = pi_vPatientID;
  
    if v_nCount > 0 then
      v_nStep := v_nStep + v_nCPAPData;
    end if;
  
    --insert or update
    if v_nRecCount > 0 then
      update patient_treatment_step t
         set t.treatment_step = v_nStep
       where t.patient_id = pi_vPatientID;
    else
      insert into patient_treatment_step
        (patient_id, treatment_step)
      values
        (pi_vPatientID, v_nStep);
    end if;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_TX_STEP.UpdatePatientSteps(): ' ||
                           sqlErrm;
  end;

  procedure DeletePatientStep(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              
                              pi_vPatientID in varchar2,
                              pi_nStep      in number,
                              
                              po_nStatusCode    out number,
                              po_vStatusComment out varchar2) is
  
    v_nStep        number;
    v_nRecCount    number := 0;
    v_nCurrentStep number := 0;
  
  begin
  
    select count(*)
      into v_nRecCount
      from patient_treatment_step t
     where t.patient_id = pi_vPatientID;
  
    if v_nRecCount > 0 then
      select treatment_step
        into v_nCurrentStep
        from patient_treatment_step t
       where t.patient_id = pi_vPatientID;
    
      if (bitand(v_nCurrentStep, pi_nStep) = pi_nStep) then
        v_nStep := v_nCurrentStep - pi_nStep;
      end if;
    
      update patient_treatment_step t
         set t.treatment_step = v_nStep
       where t.patient_id = pi_vPatientID;
      commit;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_TX_STEP.DeletePatientStep(): ' ||
                           sqlErrm;
  end;

  procedure GetPatientStepRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             
                             pi_vPatientID in varchar2,
                             
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor) is
  
  begin
  
    open rs for
      select nvl(t.treatment_step, 0) as step,
             nvl(t.notification_step, 0) as notification_step
        from patient_treatment_step t
       where t.patient_id = pi_vPatientID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_TX_STEP.GetPatientStepRS(): ' ||
                           sqlErrm;
  end;

  procedure UpdateNotificationStep(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   
                                   pi_vPatientID        in varchar2,
                                   pi_nNotificationStep in number,
                                   
                                   po_nStatusCode    out number,
                                   po_vStatusComment out varchar2) is
  
    v_nNotificationStep number := 0;
  
  begin
  
    select t.notification_step
      into v_nNotificationStep
      from patient_treatment_step t
     where t.patient_id = pi_vPatientID;
  
    if bitand(v_nNotificationStep, pi_nNotificationStep) = 0 then
      v_nNotificationStep := v_nNotificationStep + pi_nNotificationStep;
    
      update patient_treatment_step t
         set t.notification_step = v_nNotificationStep
       where t.patient_id = pi_vPatientID;
    
      commit;
    
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PATIENT_TX_STEP.UpdateNotificationStep(): ' ||
                           sqlErrm;
  end;

end PCK_PATIENT_TX_STEP;
/

prompt
prompt Creating package body PCK_PAT_ETHNICITY_RACE
prompt ============================================
prompt
create or replace package body PCK_PAT_ETHNICITY_RACE is

  procedure InsertPatientEthnicity(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    pi_nEthnicityID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is
    v_vSQL constant varchar2(32767) :=
      'insert into patient_ethnicity
       (patient_id,
        ethnicity_id)
        values
       (:PatientID,
        :EthnicityID)';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
    using pi_vPatientID, pi_nEthnicityID;
    commit;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.InsertPatientEthnicity(): ' || sqlErrm;
  end;
  
  procedure InsertPatientRace(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    pi_nRaceID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is
    v_vSQL constant varchar2(32767) :=
      'insert into patient_race
       (patient_id,
        race_id)
        values
       (:PatientID,
        :RaceID)';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
    using pi_vPatientID, pi_nRaceID;
    commit;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.InsertPatientRace(): ' || sqlErrm;
  end;
  
  procedure InsertPatEthRaceSource(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    pi_nSourceID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is
    v_vSQL constant varchar2(32767) :=
      'insert into pat_eth_race_source
       (patient_id,
        eth_race_source_id)
        values
       (:PatientID,
        :EthRaceSourceID)';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
    using pi_vPatientID, pi_nSourceID;
    commit;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.InsertPatEthRaceSource(): ' || sqlErrm;
  end;
  
  procedure GetEthnicityRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor)
  is
    v_vSQL varchar2(32767) :=
      'select t.*
       from stat_ethnicity t
       order by t.sort_order';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.GetEthnicityRS(): ' || sqlErrm;
  end;
  
  procedure GetRaceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor)
  is
    v_vSQL varchar2(32767) :=
      'select t.*
       from stat_race t
       order by t.sort_order';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.GetRaceRS(): ' || sqlErrm;
  end;
  
  procedure GetEthRaceSourceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor)
  is
    v_vSQL varchar2(32767) :=
      'select t.*
       from stat_eth_race_source t';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.GetEthRaceSourceRS(): ' || sqlErrm;
  end;
  
  procedure GetPatientEthnicityRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor)
  is
    v_vSQL varchar2(32767) :=
      'select p.*, e.ethnicity_name
       from patient_ethnicity p, stat_ethnicity e
       where p.patient_id = :PatientID
       and p.ethnicity_id = e.ethnicity_id';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
    using pi_vPatientID;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.GetPatientEthnicityRS(): ' || sqlErrm;
  end;
  
  procedure GetPatientRaceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor)
  is
    v_vSQL varchar2(32767) :=
      'select p.*, r.race_title
       from patient_race p, stat_race r
       where p.patient_id = :PatientID
       and p.race_id = r.race_id';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
    using pi_vPatientID;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.GetPatientRaceRS(): ' || sqlErrm;
  end;
  
  function GetPatientRaceListString(
    pi_vPatientID in varchar2)
  return varchar2
  is
    v_vSQL varchar2(32767) :=
      'select r.race_title
       from patient_race p, stat_race r
       where p.patient_id = :PatientID
       and p.race_id = r.race_id';
       
    curPatientRaces pck_common.refCursor;
    
    v_vRace varchar2(32767) := '';
    
    v_vRaceList varchar2(32767) := '';
  begin
    open curPatientRaces for v_vSQL
    using pi_vPatientID;
    
    fetch curPatientRaces into v_vRace;
    
    v_vRaceList := v_vRace;
    
    loop
    
      fetch curPatientRaces into v_vRace;
      exit when not curPatientRaces%found;
      
      v_vRaceList := v_vRaceList || ', ' || v_vRace;
    
    end loop;
    
    return replace(v_vRaceList, ', ' || v_vRace, ' and ' || v_vRace);
  exception
    when others then
      return null;
  end;
  
  procedure GetPatEthRaceSourceRS(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2,
    rs out RetRefCursor)
  is
    v_vSQL varchar2(32767) :=
      'select p.*, s.eth_race_source_name
       from pat_eth_race_source p, stat_eth_race_source s
       where p.patient_id = :PatientID
       and p.eth_race_source_id = s.eth_race_source_id';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
    using pi_vPatientID;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.GetPatientRaceRS(): ' || sqlErrm;
  end;
  
  procedure DeletePatientEthnicity(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is
    v_vSQL constant varchar2(32767) :=
      'delete from patient_ethnicity p
       where p.patient_id = :PatientID';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
    using pi_vPatientID;
    commit;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.DeletePatientEthnicity(): ' || sqlErrm;
  end;
  
  procedure DeletePatientRace(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is
    v_vSQL constant varchar2(32767) :=
      'delete from patient_race p
       where p.patient_id = :PatientID';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
    using pi_vPatientID;
    commit;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.DeletePatientRace(): ' || sqlErrm;
  end;
  
  procedure DeletePatEthRaceSource(
    pi_vSessionID in varchar2,
    pi_vSessionClientIP in varchar2,
    pi_nUserID in number,
    pi_vPatientID in varchar2,
    po_nStatusCode out number,
    po_vStatusComment out varchar2)
  is
    v_vSQL constant varchar2(32767) :=
      'delete from pat_eth_race_source p
       where p.patient_id = :PatientID';
  begin
    po_nStatusCode := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    execute immediate v_vSQL
    using pi_vPatientID;
    commit;
  exception
    when others then
      po_nStatusCode := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_PAT_ETHNICITY_RACE.DeletePatEthRaceSource(): ' || sqlErrm;
  end;

end PCK_PAT_ETHNICITY_RACE;
/

prompt
prompt Creating package body PCK_PROVIDER
prompt ==================================
prompt
create or replace package body PCK_PROVIDER is

procedure GetProviderRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        pi_vDIMSID          in varchar2,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out RetRefCursor)
  is
        v_vSQL varchar2(32767) := '';
  begin

    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    v_vSQL := v_vSQL || '      select t.provider_id, t.name ';
    v_vSQL := v_vSQL || '    from suat_user t, fx_user_rights r ';
    v_vSQL := v_vSQL || '   where t.dims_id = ''' || pi_vDIMSID || '''';
    v_vSQL := v_vSQL || '     and r.fx_user_id = t.fx_user_id ';
    v_vSQL := v_vSQL || '     and r.user_type in (1,2) ';
    v_vSQL := v_vSQL || 'order by t.name ';

    --open recordset
    open rs for v_vSQL;

  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_PROVIDER.GetProviderRS(): ' || sqlErrm;
  end;

end PCK_PROVIDER;
/

prompt
prompt Creating package body PCK_REFERRAL_CLINIC
prompt =========================================
prompt
create or replace package body PCK_REFERRAL_CLINIC is

  procedure GetReferralClinicRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nStatReferralID  in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*
        from stat_referral t
       where stat_referral_id = pi_nStatReferralID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_REFERRAL_CLINIC.GetReferralClinicRS(): ' ||
                           sqlErrm;
  end;

  procedure GetReferralClinicLookUpRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor) is
  
    strSQL varchar2(4000);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
  
    strSQL := strSQL || ' select t.*';
    strSQL := strSQL || ' from stat_referral t';
    strSQL := strSQL || ' where t.active = 1';
  
    open rs for strSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_REFERRAL_CLINIC.GetReferralClinicLookUpRS(): ' ||
                           sqlErrm;
  end;

  procedure InsertReferralClinic(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vReferralDesc    in varchar2,
                                 pi_vReferralText    in varchar2,
                                 pi_vProviderName in varchar2,
                                 pi_vAddress      in varchar2,
                                 pi_vCity         in varchar2,
                                 pi_nStateID      in number,
                                 pi_vPostalCode   in varchar2,
                                 pi_vPhone        in varchar2,
                                 pi_vFax          in varchar2,
                                 po_nReferralID    out number,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
    v_nReferralID number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    po_nReferralID    := -1;
  
    --get a new encounter_intake_id
    select SEQREFERRALID.Nextval into v_nReferralID from dual;
  
    insert into stat_referral
      (stat_referral_id,
       stat_referral_desc,
       stat_referral_text,
       provider_name,
       street_address,
       city,
       state,
       postal_code,
       phone,
       fax
       )
    values
      (v_nReferralID,
       pi_vReferralDesc,
       pi_vReferralText,
       pi_vProviderName,
       pi_vAddress,
       pi_vCity,
       pi_nStateID,
       pi_vPostalCode,
       pi_vPhone,
       pi_vFax
       );
    commit;
  
    po_nReferralID := v_nReferralID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_REFERRAL_CLINIC.InsertReferralClinic(): ' ||
                           sqlErrm;
  end;

  procedure UpdateReferralClinic(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_nReferralID      in number,
                                 pi_vReferralDesc    in varchar2,
                                 pi_vReferralText    in varchar2,
                                 pi_vProviderName in varchar2,
                                 pi_vAddress      in varchar2,
                                 pi_vCity         in varchar2,
                                 pi_nStateID      in number,
                                 pi_vPostalCode   in varchar2,
                                 pi_vPhone        in varchar2,
                                 pi_vFax          in varchar2,
                                 po_nStatusCode    out number,
                                 po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update stat_referral
       set stat_referral_desc = pi_vReferralDesc,
           stat_referral_text = pi_vReferralText,
           provider_name  = pi_vProviderName,
           street_address = pi_vAddress,
           city           = pi_vCity,
           state          = pi_nStateID,
           postal_code    = pi_vPostalCode,
           phone          = pi_vPhone,
           fax            = pi_vFax
         where stat_referral_id = pi_nReferralID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_REFERRAL_CLINIC.UpdateReferralClinic(): ' ||
                           sqlErrm;
  end;

  procedure DiscontinueReferralClinic(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      pi_nReferralID      in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    update stat_referral t
       set t.active = 0
     where t.stat_referral_id = pi_nReferralID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_REFERRAL_CLINIC.DiscontinueReferralClinic(): ' ||
                           sqlErrm;
  end;

end PCK_REFERRAL_CLINIC;
/

prompt
prompt Creating package body PCK_REVAMP_REPORT
prompt =======================================
prompt
create or replace package body PCK_REVAMP_REPORT is

  procedure GetReportRS(pi_vSessionID       in varchar2,
                        pi_vSessionClientIP in varchar2,
                        pi_nUserID          in number,
                        po_nStatusCode      out number,
                        po_vStatusComment   out varchar2,
                        rs                  out PCK_COMMON.refCursor) is
    v_vResult   varchar2(32767);
    v_clobRpt   clob := '';
    v_vXSLTPath varchar2(255) := 'revamp_report.xsl';
    v_cur       PCK_COMMON.refCursor;
    v_vName     varchar2(32767);
    v_nValue    number;
    v_vQuery    varchar2(32767);
  
    cursor curGen is
      select 'name' as name, 0 as value from dual;
    recGen curGen%rowtype;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    v_clobRpt := v_clobRpt || '<?xml version="1.0" ?> ' || chr(10);
    v_clobRpt := v_clobRpt || '<?xml-stylesheet type="text/xsl" href="' ||
                 v_vXSLTPath || '" ?> ' || chr(10);
    v_clobRpt := v_clobRpt || '<report> ' || chr(10);
    v_clobRpt := v_clobRpt || '<info> ' || chr(10);
    v_clobRpt := v_clobRpt || '    <date_generated> ' || chr(10);
    v_clobRpt := v_clobRpt || to_char(sysdate, 'YYYY-MM-DD HH:mm:SS AM') ||
                 chr(10);
    v_clobRpt := v_clobRpt || '    </date_generated> ' || chr(10);
    v_clobRpt := v_clobRpt || '</info> ' || chr(10);
    v_clobRpt := v_clobRpt || '<results> ' || chr(10);
  
    for rec in (select *
                  from stat_revamp_report_query t
                 where t.is_distribution != 1
                   and t.visible > 0
                 order by t.s1, t.s2, t.var_id) loop
    
      v_vResult := null;
    
      v_clobRpt := v_clobRpt || '<result> ' || chr(10);
    
      if rec.query is not null then
        v_vQuery := replace(rec.query, '~patients~', fnGetPatSelectString);
        execute immediate v_vQuery
          into v_vResult;
      end if;
    
      --dbms_output.put_line(to_char(rec.var_id));
    
      --description
      v_clobRpt := v_clobRpt || '<description> ' || chr(10);
      v_clobRpt := v_clobRpt || htf.escape_sc(rec.full_description) ||
                   chr(10);
      v_clobRpt := v_clobRpt || '</description> ' || chr(10);
    
      --data_entry
      v_clobRpt := v_clobRpt || '<data_entry> ' || chr(10);
      v_clobRpt := v_clobRpt || htf.escape_sc(rec.data_entry) || chr(10);
      v_clobRpt := v_clobRpt || '</data_entry> ' || chr(10);
    
      --value
      v_clobRpt := v_clobRpt || '<value> ' || chr(10);
    
      if v_vResult is not null then
        v_clobRpt := v_clobRpt || v_vResult || chr(10);
      else
        if rec.query is not null then
          v_clobRpt := v_clobRpt || 'NULL' || chr(10);
        else
          v_clobRpt := v_clobRpt || '' || chr(10);
        end if;
      end if;
    
      v_clobRpt := v_clobRpt || '</value> ' || chr(10);
    
      --query
      v_clobRpt := v_clobRpt || '<query> ' || chr(10);
      v_clobRpt := v_clobRpt || htf.escape_sc(rec.query) || chr(10);
      v_clobRpt := v_clobRpt || '</query> ' || chr(10);
    
      v_clobRpt := v_clobRpt || '</result> ' || chr(10);
    
    end loop;
  
    v_clobRpt := v_clobRpt || '</results> ' || chr(10);
  
    -- Get Race distribution
    v_clobRpt := v_clobRpt || '<races> ' || chr(10);
    for rec in (select *
                  from stat_revamp_report_query t
                 where t.var_id = 9998) loop
      open v_cur for replace(rec.query, '~patients~', fnGetPatSelectString);
      loop
        fetch v_cur
          into v_vName, v_nValue;
        exit when v_cur%NOTFOUND;
        v_clobRpt := v_clobRpt || '<race> ' || chr(10);
      
        v_clobRpt := v_clobRpt || '<name> ' || chr(10);
        v_clobRpt := v_clobRpt || v_vName || chr(10);
        v_clobRpt := v_clobRpt || '</name> ' || chr(10);
      
        v_clobRpt := v_clobRpt || '<value> ' || chr(10);
        v_clobRpt := v_clobRpt || to_char(v_nValue) || chr(10);
        v_clobRpt := v_clobRpt || '</value> ' || chr(10);
      
        v_clobRpt := v_clobRpt || '</race> ' || chr(10);
      end loop;
    end loop;
    v_clobRpt := v_clobRpt || '</races> ' || chr(10);
  
    -- Get Ethnicity distribution
    v_clobRpt := v_clobRpt || '<ethnicities> ' || chr(10);
    for rec in (select *
                  from stat_revamp_report_query t
                 where t.var_id = 9999) loop
      open v_cur for replace(rec.query, '~patients~', fnGetPatSelectString);
      loop
        fetch v_cur
          into v_vName, v_nValue;
        exit when v_cur%NOTFOUND;
        v_clobRpt := v_clobRpt || '<ethnicity> ' || chr(10);
      
        v_clobRpt := v_clobRpt || '<name> ' || chr(10);
        v_clobRpt := v_clobRpt || v_vName || chr(10);
        v_clobRpt := v_clobRpt || '</name> ' || chr(10);
      
        v_clobRpt := v_clobRpt || '<value> ' || chr(10);
        v_clobRpt := v_clobRpt || to_char(v_nValue) || chr(10);
        v_clobRpt := v_clobRpt || '</value> ' || chr(10);
      
        v_clobRpt := v_clobRpt || '</ethnicity> ' || chr(10);
      end loop;
    end loop;
    v_clobRpt := v_clobRpt || '</ethnicities> ' || chr(10);
  
    v_clobRpt := v_clobRpt || '</report> ';
  
    -- open recordset
    open rs for
      select v_clobRpt as revamp_report from dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_REVAMP_REPORT.GetReportRS(): ' || sqlErrm;
  end;

  function fnGetPatSelectString return varchar2 is
    v_vSQL varchar2(4000) := '';
  begin
    v_vSQL := v_vSQL || 'select patient_id ';
    v_vSQL := v_vSQL || 'from patient_demographics p ';
    v_vSQL := v_vSQL || 'where p.fx_user_id not in ';
    v_vSQL := v_vSQL ||
              '(select fx_user_id from fx_user where is_inactive = 1) ';
    v_vSQL := v_vSQL || 'and p.provider_id not in ';
    v_vSQL := v_vSQL ||
              '(select provider_id from suat_user where dims_id = ''0127'')';
    return v_vSQL;
  end;

  -- Get Score changes
  function fnGetScoreChange(pi_vPatientID in varchar2,
                            pi_nMID       in number,
                            pi_nGrpID1    in number,
                            pi_nGrpID2    in number) return number is
    v_nResult number := null;
    v_nScore1 number := null;
    v_nScore2 number := null;
  
  begin
    -- get score1 value
    begin
      select t.score
        into v_nScore1
        from encounter_intake_score t, encounter e
       where t.encounter_id = e.encounter_id
         and t.mid = pi_nMID
         and t.intake_group_id = pi_nGrpID1
         and e.patient_id = pi_vPatientID;
    exception
      when others then
        v_nScore1 := null;
    end;
  
    -- get score2 value
    begin
      select t.score
        into v_nScore2
        from encounter_intake_score t, encounter e
       where t.encounter_id = e.encounter_id
         and t.mid = pi_nMID
         and t.intake_group_id = pi_nGrpID2
         and e.patient_id = pi_vPatientID;
    exception
      when others then
        v_nScore2 := null;
    end;
  
    if ((v_nScore1 is not null) and (v_nScore2 is not null)) then
      v_nResult := v_nScore2 - v_nScore1;
    end if;
  
    return v_nResult;
  end;

end PCK_REVAMP_REPORT;
/

prompt
prompt Creating package body PCK_REVAMP_TIU
prompt ====================================
prompt
CREATE OR REPLACE PACKAGE BODY "PCK_REVAMP_TIU" AS

procedure GetEncTIUNoteDiagRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_vPatientID             in varchar2,
      pi_nTreatmentID           in number,
      pi_vEncounterID           in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

begin

    --todo:need error codes in db
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_OS', '');

    --open the result set
    open rs for
    select * from treatment_problem_list t
    where t.inactive = 0
      and t.patient_id = pi_vPatientID
      and t.treatment_id = pi_nTreatmentID
      and t.encounter_id in (select e.encounter_id
                              from encounter e
                              where e.treatment_id = pi_nTreatmentID
                              and e.patient_id = pi_vPatientID
                              and trunc(e.encounter_date) <=
                              (select trunc(encounter_date)
                                from encounter
                                where patient_id = pi_vPatientID
                                and treatment_id = pi_nTreatmentID
                                and encounter_id = pi_vEncounterID));

    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_OS', '');

end;

procedure GetEncounterTIUNote (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_vPatientID             in varchar2,
      pi_nTreatmentID           in number,
      pi_vEncounterID           in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

begin

    --todo:need error codes in db
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_OS', '');

    --open the result set
    open rs for
    SELECT t.*
      FROM encounter_tiu_note t
     WHERE t.patient_id = pi_vpatientid
     and t.treatment_id = pi_nTreatmentID
     and t.encounter_id = pi_vEncounterID;

    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_OS', '');

end;


  procedure SaveEncounterTIUNote(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_vPatientID             in varchar2,
      pi_nMDWSPatientID         in number,
      pi_vMDWSUserID            in varchar2,
      pi_nClinicID              in number,
      pi_VNoteTitleIEN          in varchar2,
      pi_nTreatmentID           in number,
      pi_vEncounterID           in varchar2,
      pi_vMDWSEncounterID       in varchar2,
      pi_vNoteResultID          in varchar2,
      pi_vVisitTimeStamp        in varchar2,
      pi_dtNoteDate             in date,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2)
  is

  begin

     po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
     po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_LOGIN', '');

     insert into encounter_tiu_note (
                   MDWS_REGION_ID,
                   MDWS_SITE_ID,
                   PATIENT_ID,
                   MDWS_PATIENT_ID,
                   MDWS_USER_ID,
                   CLINIC_ID,
                   NOTE_TITLE_IEN,
                   TREATMENT_ID,
                   ENCOUNTER_ID,
                   MDWS_ENCOUNTER_ID,
                   NOTE_RESULT_ID,
                   VISIT_TIMESTAMP,
                   NOTE_DATE)
    values(
            pi_nRegionID,
            pi_nSIteID,
            pi_vPatientID,
            pi_nMDWSPatientID,
            pi_vMDWSUserID,
            pi_nClinicID,
            pi_VNoteTitleIEN,
            pi_nTreatmentID,
            pi_vEncounterID,
            pi_vMDWSEncounterID,
            pi_vNoteResultID,
            pi_vVisitTimeStamp,
            pi_dtNoteDate);

    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_LOGIN', '');

end;

procedure UpdateMDWSAccount (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                 in number,
      pi_vNoteTitleLabel          in varchar2,
      pi_nNoteClinicID           in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     )
 is
     v_vSQL constant long :=
            'update fx_user
             set mdws_note_title_label = :label,
                 mdws_note_clinic_id = :clinic
             where fx_user_id = :USER_ID';

   begin

    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_SAVE_AUDIT', v_vSQL);

    --execute the sql with bind vars and commit
    EXECUTE IMMEDIATE v_vSQL
    using pi_vNoteTitleLabel,
          pi_nNoteClinicID,
          pi_nUserID;

    commit;

   exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_SAVE_AUDIT', v_vSQL);

  end;

  procedure UpdateMDWSAccount (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                 in number,
      pi_vKey                    in varchar2,
      pi_nFXUserID               in number,
      pi_vUserName               in varchar2,
      pi_vPassword               in varchar2,
      pi_nRegionID               in number,
      pi_nSiteID                 in number,
      pi_nMDWSUserID             in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     )
 is
     v_vSQL constant long :=
            'update fx_user
             set mdws_user_name = :USER_NAME,
                 mdws_pwd = :PWD,
                 mdws_region_id = :REGION_ID,
                 mdws_site_id = :SITE_ID,
                 mdws_user_id = :MDWSUSER_ID
             where fx_user_id = :USER_ID';

   begin

    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_SAVE_AUDIT', v_vSQL);

    --execute the sql with bind vars and commit
    EXECUTE IMMEDIATE v_vSQL
    using fnc_utl_encstr(upper(pi_vusername), pi_vKey, pi_nfxuserid),
          fnc_utl_encstr(pi_vpassword, pi_vKey, pi_nfxuserid),
          pi_nregionid,
          pi_nsiteid,
          pi_nMDWSUserID,
          pi_nfxuserid;

    commit;

   exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_SAVE_AUDIT', v_vSQL);

  end;

  procedure GetMDWSPatientIDRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_vPatientID             in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

begin

    --todo:need error codes in db
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_OS', '');

    --open the result set
    open rs for
    SELECT t.patient_id, t.mdws_patient_id, t.provider_id
      FROM patient_demographics t
     WHERE t.patient_id = pi_vpatientid;

    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_OS', '');

end;

procedure GetMDWSAccountRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                 in number,
      pi_vKey                    in varchar2,
      pi_nFXUserID              in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

begin

    --todo:need error codes in db
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_OS', '');

    --open the result set
    open rs for
    SELECT t.fx_user_id,
           fnc_utl_decstr(t.mdws_user_name, pi_vkey, t.fx_user_id) as mdws_user_name,
           fnc_utl_decstr(t.mdws_pwd, pi_vkey, t.fx_user_id) as mdws_pwd,
           t.mdws_region_id,
           t.mdws_site_id,
           t.mdws_note_title_label,
           t.mdws_note_clinic_id
       FROM fx_user t
       WHERE t.fx_user_id = pi_nfxuserid;

    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_OS', '');

end;

  procedure AuditTransaction (
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vSPName                 in varchar2,
      pi_clAuditXML              in clob,
      pi_nStatus                 in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2
     )

    is

     v_vSQL constant long :=
            'insert into fx_audit( db_session_id,
                                   client_ip,
                                   fx_user_id,
                                   audit_date,
                                   audit_name,
                                   audit_data)
              values( :REVAMP_TIU,
                      :CLIENT_IP,
                      :USER_ID,
                      :AUDIT_DATE,
                      :SP_NAME,
                      :AUDIT_XML)';

     v_nAuditID number;

   begin

    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_SAVE_AUDIT', v_vSQL);

    --execute the sql with bind vars and commit
    EXECUTE IMMEDIATE v_vSQL
    USING 'REVAMP_TIU',
          pi_vSessionClientIP,
          pi_nUserID,
          sysdate,
          pi_vSPName,
          pi_clAuditXML;

    commit;

   exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_SAVE_AUDIT', v_vSQL);

  end;

/************************************************************************/
/*
saves a clinic to the database
*/
procedure SaveClinic(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_nClinicID              in number,
      pi_vClinicLabel           in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2)
  is

    v_vSQLInsert constant varchar2(4000) :=
         'insert into
          tiu_utl_Clinic(Clinic_id,
                               Clinic_label,
                               xfer_system_id,
                               xfer_date,
                               region_id,
                               site_id
                          )
          values(:Clinic_ID,
                 :Clinic_LABEL,
                 :XFER_SYSTEM_ID,
                 sysdate,
                 :REGION_ID,
                 :SITE_ID)';

     v_vSQLUpdate constant varchar2(4000) :=
         'update tiu_utl_Clinic
          set Clinic_label = :Clinic_LABEL,
              xfer_system_id = :XFER_SYSTEM_ID,
              xfer_date = sysdate
          where Clinic_id = :Clinic_ID
           and region_id = :REGION_ID
           and site_id = :SITE_ID';

     v_vSQLCount varchar2(4000) := '';
     v_nCount number := 0;

  begin

     --todo:error messages
     v_nCount := 0;
     po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
     po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_LOGIN', '');

     --check that a record exisits
     v_vSQLCount := 'select count(*) from tiu_utl_Clinic ';
     v_vSQLCount := v_vSQLCount || 'WHERE clinic_id = ' || pi_nClinicID;
     v_vSQLCount := v_vSQLCount || ' and region_id = ' || pi_nRegionID;
     v_vSQLCount := v_vSQLCount || ' and site_id = ' || pi_nSiteID;

     v_nCount:= to_number(PCK_REVAMP_TIU_COMMON.GetDynamicSQLValue(v_vSQLCount));

     --insert if the record is not there
     if (v_nCount < 1) then

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLInsert
        USING pi_nClinicID,
              pi_vClinicLabel,
              pi_nXferSystemID,
              pi_nRegionID,
              pi_nSiteID;
        commit;

      else

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLUpdate
        USING pi_vClinicLabel,
              pi_nXferSystemID,
              pi_nClinicID,
              pi_nRegionID,
              pi_nSiteID;

        commit;

      end if;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_LOGIN', '');

end;

/*****
Description: Gets all specialties
******/
procedure GetClinicRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

     v_vSQL varchar2(500) :=
      'SELECT t.*
       FROM tiu_utl_Clinic t
       order by upper(t.Clinic_label) asc';
begin

    --todo:need error codes in db
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_OS', v_vSQL);

    --open the result set
    open rs for v_vSQL;
    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_OS', v_vSQL);

end;

/*
saves a Region to the database
*/
procedure SaveRegion(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_vRegionName            in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2)
  is

    v_vSQLInsert constant varchar2(4000) :=
         'insert into
          tiu_utl_region( region_id,
                             region_name,
                             xfer_system_id,
                             xfer_date
                          )
          values(:region_id,
                 :region_name,
                 :xfer_system_id,
                 sysdate)';

     v_vSQLUpdate constant varchar2(4000) :=
         'update tiu_utl_region
          set region_name = :region_name,
              xfer_system_id = :XFER_SYSTEM_ID,
              xfer_date = sysdate
          where region_id = :region_id';

     v_vSQLCount varchar2(4000) := '';
     v_nCount number := 0;

  begin

     v_nCount := 0;
     po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
     po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('update_successful', '');

     --check for a valid session
     --no check since this is called before the user logs in

     --check that a record exisits
     v_vSQLCount := 'select count(*) from tiu_utl_region ';
     v_vSQLCount := v_vSQLCount || 'WHERE region_id = ' || pi_nRegionID;
     v_nCount:= to_number(PCK_REVAMP_TIU_COMMON.GetDynamicSQLValue(v_vSQLCount));

     --insert if the record is not there
     if (v_nCount < 1) then

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLInsert
        USING pi_nRegionID,
              pi_vRegionName,
              pi_nXferSystemID;
        commit;

      else

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLUpdate
        USING pi_vRegionName,
              pi_nXferSystemID,
              pi_nRegionID;
        commit;

      end if;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('update_failed', '');

end;

/*
saves a site to the database
*/
procedure SaveSite(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_vSiteName            in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2)
  is

    v_vSQLInsert constant varchar2(4000) :=
         'insert into
          tiu_utl_site( region_id,
                           site_id,
                           site_name,
                           xfer_system_id,
                           xfer_date
                          )
          values(:region_id,
                 :site_id,
                 :site_name,
                 :xfer_system_id,
                 sysdate)';

     v_vSQLUpdate constant varchar2(4000) :=
         'update tiu_utl_site
          set site_name = :site_name,
              xfer_system_id = :XFER_SYSTEM_ID,
              xfer_date = sysdate
          where region_id = :region_id
            and site_id = :site_id';

     v_vSQLCount varchar2(4000) := '';
     v_nCount number := 0;

  begin

     v_nCount := 0;
     po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
     po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('update_successful', '');

     --check for a valid session
     --no check since this is called before the user logs in

     --check that a record exisits
     v_vSQLCount := 'select count(*) from tiu_utl_site ';
     v_vSQLCount := v_vSQLCount || 'WHERE region_id = ' || pi_nRegionID;
     v_vSQLCount := v_vSQLCount || ' AND site_id = ' || pi_nSiteID;

     v_nCount:= to_number(PCK_REVAMP_TIU_COMMON.GetDynamicSQLValue(v_vSQLCount));

     --insert if the record is not there
     if (v_nCount < 1) then

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLInsert
        USING pi_nRegionID,
              pi_nSiteID,
              pi_vSiteName,
              pi_nXferSystemID;
        commit;

      else

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLUpdate
        USING pi_vSiteName,
              pi_nXferSystemID,
              pi_nRegionID,
              pi_nSiteID;
        commit;

      end if;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('update_failed', '');

end;

/*****
Description: Gets regions
******/
procedure GetRegionRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

     v_vSQL varchar2(500) :=
      'SELECT t.*
       FROM tiu_utl_region t
       order by upper(t.region_name) asc';
begin

    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('query_successful', v_vSQL);

    --check for a valid session
    --no check needed, this is called before the user logs in

    --open the result set
    open rs for v_vSQL;
    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('query_failed', v_vSQL);

end;

/*****
Description: Gets region sites
******/
procedure GetSiteRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nRegionID              in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

     v_vSQL varchar2(500) :=
      'SELECT t.*
       FROM tiu_utl_site t
       WHERE t.region_id = :region_id
       order by upper(t.site_name) asc';
begin

    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('query_successful', v_vSQL);

    --check for a valid session
    --no check needed, this is called before the user logs in

    --open the result set
    open rs for v_vSQL using pi_nregionid;
    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('query_failed', v_vSQL);

end;

/**************************************************************************/

/*****
Description:
Inserts or updates a mdws patient in patient_demographics.
******/
procedure SavePatient (   pi_vSessionID        in varchar2,
                          pi_vSessionClientIP  in varchar2,
                          pi_nUserID           in number,
                          pi_nXferSystemID     in number,
                          pi_vNewPatientID     in varchar2,
                          pi_vNewEncounterID   in varchar2,
                          pi_vKey              in varchar2,
                          pi_nRegionID              in number,
                          pi_nSiteID                in number,
                          pi_vMDWSPatientID    in varchar2,
                          pi_vSSN              in varchar2,
                          pi_dtDOB             in date,
                          pi_vFirstName        in varchar2,
                          pi_vFullName         in varchar2,
                          pi_vLastName         in varchar2,
                          pi_vMI               in varchar2,
                          pi_nSex              in number,
                          pi_vHomeAddr1        in varchar2,
                          pi_vHomeAddr2        in varchar2,
                          pi_vHomeCity         in varchar2,
                          pi_vHomeState        in varchar2,
                          pi_vHomeZip          in varchar2,
                          pi_vHomePhone        in varchar2,
                          po_nStatusCode       out number,
                          po_vStatusComment    out varchar2
                       )
is

   v_nRelationshipID number;
   v_nCount number;
   v_vSQLCount varchar2(2000);
   v_vSex varchar2(20);
   v_vProviderID varchar2(255);

begin
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_SAVE_IG', '');
    v_nCount := 0;
    v_vSQLCount := '';
    v_vSex := 'U';
    v_vProviderID := '';
    v_nRelationshipID := 0;

    --get count
    v_vSQLCount := 'SELECT count(*) FROM patient_demographics WHERE mdws_patient_id = ''';
    v_vSQLCount := v_vSQLCount || to_char(pi_vMDWSPatientID);
    v_vSQLCount := v_vSQLCount || '''';

    --get existing item,ts,os,ds ids
    v_nCount := to_number(PCK_REVAMP_TIU_COMMON.GetDynamicSQLValue(v_vSQLCount));

    --translate gender
    if(pi_nSex = 1) then
      v_vSex := 'M';
    end if;
    if(pi_nSex = 2) then
      v_vSex := 'F';
    end if;

    --default the provider to the person logged in
    select t.provider_id into v_vProviderID
    from suat_user t
    where t.fx_user_id = pi_nuserid;

    if(v_nCount < 1) then

        --insert new record into the patient demographics table
        insert into patient_demographics( patient_id,
                                          mdws_patient_id,
                                          mdws_region_id,
                                          mdws_site_id,
                                          first_name,
                                          last_name,
                                          mi,
                                          ssn,
                                          gender,
                                          dob,
                                          provider_id)
        values
        (
           upper(pi_vNewPatientID),
           pi_vMDWSPatientID,
           pi_nRegionID,
           pi_nSiteID,
           fnc_utl_encstr(upper(pi_vFirstName), pi_vKey, upper(pi_vNewPatientID)),
           fnc_utl_encstr(upper(pi_vLastName), pi_vKey, upper(pi_vNewPatientID)),
           fnc_utl_encstr(upper(pi_vMI), pi_vKey, upper(pi_vNewPatientID)),
           fnc_utl_encstr(upper(pi_vSSN), pi_vKey, upper(pi_vNewPatientID)),
           fnc_utl_encstr(v_vSex, pi_vKey, upper(pi_vNewPatientID)),
           fnc_utl_encstr(to_char(pi_dtdob,'mm/dd/yyyy'), pi_vKey, upper(pi_vNewPatientID)),
           v_vProviderID
        );
        commit;

        --Create Initial Patient Sponsor Record Needed By Assessments --Assessments can only to Updates
        insert into patient_sponsor
          (patient_id, relationship_id, last_updated, last_updated_by)
        values
          (pi_vNewPatientID, v_nRelationshipID, sysdate, pi_nUserID);
        commit;

        --Create Initial Emergency Contact Record Needed By Assessments --Assessments can only to Updates
        insert into patient_emergency_contact
          (patient_id, relationship_id, last_updated, last_updated_by)
        values
          (pi_vNewPatientID, v_nRelationshipID, sysdate, pi_nUserID);
        commit;

        --insert a new treatment record
        insert into treatment
          (treatment_id,
           patient_id,
           initial_visit_date,
           last_updated,
           last_updated_by)
        values
          (1, pi_vNewPatientID, sysdate, sysdate, pi_nUserID);
        commit;

        --add all the events
        pck_patient_events.addallevents(pi_vSessionID,
                                        pi_vSessionClientIP,
                                        pi_nUserID,
                                        pi_vNewPatientID,
                                        po_nStatusCode,
                                        po_vStatusComment);

        --insert patient step
        PCK_PATIENT_TX_STEP.InsertPatientStep(pi_vSessionID,
                                              pi_vSessionClientIP,
                                              pi_nUserID,
                                              pi_vNewPatientID,
                                              0,
                                              po_nStatusCode,
                                              po_vStatusComment);

       --assign assessments
       PCK_INTAKE.AssignInitialAssessments(pi_vSessionID,
                                              pi_vSessionClientIP,
                                              pi_nUserID,
                                              pi_vNewPatientID,
                                              po_nStatusCode,
                                              po_vStatusComment);
   else

        null;

   end if;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_SAVE', '');
end;


/**************************************************************************/
/*
saves a note title to the database
*/
procedure SaveNoteTitle(
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nXferSystemID          in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      pi_nNoteTitleTag          in number,
      pi_vNoteTitleLabel        in varchar2,
      pi_vNoteTitleDetails      in varchar2,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2)
  is

    v_vSQLInsert constant varchar2(4000) :=
         'insert into
          tiu_utl_note_title(note_title_tag,
                               note_title_label,
                               note_title_details,
                               xfer_system_id,
                               xfer_date,
                               region_id,
                               site_id
                          )
          values(:note_title_tag,
                 :NOTE_TITLE_LABEL,
                 :NOTE_TITLE_DETAILS,
                 :XFER_SYSTEM_ID,
                 sysdate,
                 :REGION_ID,
                 :SITE_ID)';

     v_vSQLUpdate constant varchar2(4000) :=
         'update tiu_utl_note_title
          set note_title_details = :NOTE_TITLE_DETAILS,
              note_title_tag = :NOTE_TITLE_TAG,
              xfer_system_id = :XFER_SYSTEM_ID,
              xfer_date = sysdate
          where note_title_label = :NOTE_TITLE_LABEL
          and  region_id = :REGION_ID
          and  site_id = :SITE_ID';

     v_vSQLCount varchar2(4000) := '';
     v_nCount number := 0;

  begin

     --todo:error messages
     v_nCount := 0;
     po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
     po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_LOGIN', '');

     --check that a record exisits
     v_vSQLCount := 'select count(*) from tiu_utl_note_title ';
     v_vSQLCount := v_vSQLCount || 'WHERE note_title_label = ''' || pi_vNoteTitleLabel || '''';
     v_vSQLCount := v_vSQLCount || ' and site_id = ' || pi_nSiteID;
     v_vSQLCount := v_vSQLCount || ' and region_id = ' || pi_nRegionID;
     v_nCount:= to_number(PCK_REVAMP_TIU_COMMON.GetDynamicSQLValue(v_vSQLCount));

     --insert if the record is not there
     if (v_nCount < 1) then

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLInsert
        USING pi_nNoteTitleTag,
              pi_vNoteTitleLabel,
              pi_vNoteTitleDetails,
              pi_nXferSystemID,
              pi_nRegionID,
              pi_nSiteID;
        commit;

      else

        --execute the sql with bind vars
        EXECUTE IMMEDIATE v_vSQLUpdate
        USING pi_vNoteTitleDetails,
              pi_nNoteTitleTag,
              pi_nXferSystemID,
              pi_vNoteTitleLabel,
              pi_nRegionID,
              pi_nSiteID;
        commit;

      end if;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_LOGIN', '');

end;

/*****
Description: Gets all note tiles
******/
procedure GetNoteTitleRS (
      pi_vSessionID             in varchar2,
      pi_vSessionClientIP       in varchar2,
      pi_nUserID                in number,
      pi_nRegionID              in number,
      pi_nSiteID                in number,
      po_nStatusCode            out number,
      po_vStatusComment         out varchar2,
      rs                        out PCK_REVAMP_TIU_COMMON.refCursor
      )
is

     v_vSQL varchar2(500) :=
      'SELECT t.*
       FROM tiu_utl_note_title t
       WHERE region_id = :REGION_ID
       AND site_id = :SITE_ID
       order by upper(t.note_title_label) asc';
begin

    --todo:need error codes in db
    po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Success;
    po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('SUCCESS_QUERY_OS', v_vSQL);

    --open the result set
    open rs for v_vSQL
    using pi_nregionid,
          pi_nSiteID;
    commit;

exception
    when others then
      po_nStatusCode    := PCK_REVAMP_TIU_COMMON.c_nStatus_Error;
      po_vStatusComment := PCK_REVAMP_TIU_COMMON.GetStatusComment('FAILED_QUERY_OS', v_vSQL);

end;

END PCK_REVAMP_TIU;
/

prompt
prompt Creating package body PCK_REVAMP_TIU_COMMON
prompt ===========================================
prompt
CREATE OR REPLACE PACKAGE BODY "PCK_REVAMP_TIU_COMMON" is

/*****
Description:
helper function used to get data by using dynamic sql
"into" statement. all data is returned as a vachar2
and can be casted as needed. We use dynamic sql for
security reasons.
*****/
function GetDynamicSQLValue (
      pi_vSql in varchar2
      ) return varchar2
is
    type refCursor  is ref cursor;
    rc   refCursor;
    v_vData varchar2(4000);

begin
    open  rc for pi_vSql;
    fetch rc into v_vData;
    close rc;

    return v_vData;

exception
    when others
    then
    return null;
end;

/*
checks for a valid entry in the fx_session table
*/
function CheckFXSession (
      pi_vSessionID in varchar2,
      pi_vSessionClientIP in varchar2,
      pi_nUserID in number
      ) return boolean
is
   v_vSQL varchar2(4000);
   v_nCount number;

   v_vSQLUpdate constant varchar2(4000) :=
      'UPDATE tiu_fx_session
       set session_updated = sysdate
       WHERE client_ip = :CLIENT_IP
       AND user_id = :USER_ID
       AND asp_session_id = :SESSION_ID';

begin
    v_nCount := 0;

    --does a session record exisit for this user
    v_vSQL := '';
    v_vSQL := 'select count(*) from tiu_fx_session ';
    v_vSQL := v_vSQL || ' WHERE asp_session_id = ''' || pi_vSessionID || '''';
    v_vSQL := v_vSQL || ' AND client_ip = ''' || pi_vSessionClientIP || '''';
    v_vSQL := v_vSQL || ' AND user_id  = ' || pi_nUserID;

    --get the count
    v_nCount:= to_number(PCK_REVAMP_TIU_COMMON.GetDynamicSQLValue(v_vSQL));

    if (v_nCount > 0) then

     --update the date last updated for the session
     EXECUTE IMMEDIATE v_vSQLUpdate
     USING pi_vsessionclientip,
           pi_nuserid,
           pi_vSessionID;
     commit;

     --session is valid so return true
     return true;

    else
      return false;
    end if;

exception
    when others
    then
    return false;
end;


/*****
Description:
helper function used to get the next value from a sequence
TODO: SAFER TO REMOVE THIS FUNCTION I THINK
*****/
function GetNextSequenceValue (
      pi_vSequenceName in varchar2
      ) return number

is
     v_vSQL     varchar2(4000);
     v_SeqValue varchar2(4000);

begin

     v_vSQL := '';
     v_vSQL := v_vSQL || 'SELECT ' || pi_vSequenceName || '.nextval FROM dual';
     v_SeqValue := GetDynamicSQLValue(v_vSQL);

     return to_number(v_SeqValue);

exception
    when others
    then
    return null;

end;

/*****
Description:
helper function used to get age given date of birth
*****/
function GetAge(pi_dtDOB in date)
  return number
is
  v_nAge  number;
begin
  v_nAge := trunc(months_between(sysdate,pi_dtDOB)/12);
  return v_nAge;
end;


/*****
Description:
helper function used to generate comment text
*****/
function GetStatusComment (
    pi_vPCKStatusLabel in varchar2,
    pi_vDetails in varchar2
    ) return varchar2

is
     v_vStatusComment varchar2(32000);
     v_vSQL           varchar2(4000);

begin

     v_vSQL := '';
     v_vSQL := v_vSQL || 'select t.pck_status_comment ';
     v_vSQL := v_vSQL || 'from fx_pck_status t ';
     v_vSQL := v_vSQL || 'where upper(t.pck_status_label) = upper(''' || pi_vPCKStatusLabel || ''')';

     v_vStatusComment := GetDynamicSQLValue(v_vSQL);

     --if we are in debug mode add the package name and sqlerror
     if PCK_REVAMP_TIU_COMMON.c_nDebug_Mode = 1 then
        v_vStatusComment := v_vStatusComment || ' (' || sqlErrm;
        v_vStatusComment := v_vStatusComment || ': ' || pi_vDetails  || ')';
     end if;

     v_vStatusComment := trim(v_vStatusComment);

     --for some reason 1000 is the max.
     if length(v_vStatusComment) > 1000 then
      v_vStatusComment := substr(v_vStatusComment,1,1000);
     end if;

     return v_vStatusComment;

exception
   when others then
     v_vStatusComment := c_vStatus_undefined;
     return v_vStatusComment;

end;

 /*
 gets a zero based piece given a string, delimeter and posiiton
 */
 function GetPiece( strData      in varchar2,
                    strDelimiter in varchar2,
                    nPosition    in NUMBER) return varchar2
 is

    strWorking varchar2(4000);
    strPiece   varchar2(400);
    pos        number;
    nPos2      number;
    nCount     number;

 begin

    --the piece to return
    strPiece := '';

    --set working to data
    strWorking := strData;

    --put a delimeter on the front for parsing if needed
    if substr(strWorking, 1, 1) != strDelimiter then
      strWorking := strDelimiter || strWorking;
    end if;

    --put a delimeter on the end
    strWorking := strWorking  || strDelimiter;

    --find the piece between the ~'s ie... "~piece~"
    pos    := -1;
    nCount := -1;
    while (pos != 0) loop
      pos := instr(strWorking, strDelimiter);
      if pos != 0 then
        --increment count
        nCount := nCount + 1;
        --found the piece...
        if nCount = nPosition then
          if (pos + 1 > length(strWorking) - 1) then
            --nothing
            strPiece := '';
          else
            strWorking := substr(strWorking, pos + 1);
            nPos2      := instr(strWorking, strDelimiter);
            if nPos2 = 0 then
              --last piece
              strPiece := strWorking;
              return ltrim(rtrim(strPiece));
            else
              strPiece := substr(strWorking, 0, nPos2 - 1);
              return ltrim(rtrim(strPiece));
            end if;
          end if;
        else
          strWorking := substr(strWorking, pos + 1);
        end if;
      end if;
    end loop;

    return ltrim(rtrim(strPiece));

  exception
    when others then
      return '';
end GetPiece;

end PCK_REVAMP_TIU_COMMON;
/

prompt
prompt Creating package body PCK_SOAPP_REPORT
prompt ======================================
prompt
create or replace package body PCK_SOAPP_REPORT is

--converted to new encryption - no changes needed...
procedure updtAssessment(pi_vSessionID        in varchar2,
                           pi_vSessionClientIP  in varchar2,
                           pi_nUserID           in number,
                           pi_vKey in varchar2,
                           pi_vPatientID        in varchar2,
                           pi_vEncounterID      in varchar2,
                           pi_nTreatmentID      in number,
                           pi_vAssessment       in clob,
                           pi_nDLCID            in number,
                           pi_vDLCJustification in varchar2,
                           pi_nIsHighInterest   in number,
                           po_nStatusCode    out number,
                           po_vStatusComment out varchar2) is
  
    v_const_duty_limited number := 1;
    v_clobTxPlan    clob := '';
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
        
    update encounter t
       set t.assessment      = pi_vAssessment,
           t.treatment_plan = v_clobTxPlan,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id = pi_vEncounterID;
    commit;
  
    update patient_demographics t
       set t.is_high_interest = pi_nIsHighInterest,
           t.last_updated     = sysdate,
           t.last_updated_by  = pi_nUserID
     where t.patient_id = pi_vPatientID;
    commit;
  
    if pi_nDLCID > 0 then
      update patient_military_detail t
         set t.is_duty_limited = v_const_duty_limited,
             t.last_updated    = sysdate,
             t.last_updated_by = pi_nUserID
       where t.patient_id = pi_vPatientID;
    
      update encounter t
         set t.dlc_id            = pi_nDLCID,
             t.dlc_justification = pi_vDLCJustification,
             t.last_updated      = sysdate,
             t.last_updated_by   = pi_nUserID
       where t.encounter_id = pi_vEncounterID;
    end if;
    
    pck_encounter.UpdateEncounterDiagnosis(pi_vSessionID => pi_vSessionID,
                                          pi_vSessionClientIP => pi_vSessionClientIP,
                                          pi_nUserID => pi_nUserID,
                                          pi_vPatientID => pi_vPatientID,
                                          pi_vEncounterID => pi_vEncounterID,
                                          pi_nTreatmentID => pi_nTreatmentID, 
                                          po_nStatusCode => po_nStatusCode, 
                                          po_vStatusComment => po_vStatusComment);
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtAssessment(): ' || sqlErrm;
  end;

  procedure updtSubjective(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           pi_vEncounterID     in varchar2,
                           pi_nTreatmentID     in number,
                           pi_vSubjective      in clob,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
                           
  v_clobTxPlan    clob := '';
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';                                            
    
    update encounter t
       set t.subjective      = pi_vSubjective,
           t.treatment_plan  = v_clobTxPlan,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id    = pi_vEncounterID;
    commit;
    
    pck_encounter.UpdateEncounterDiagnosis(pi_vSessionID => pi_vSessionID,
                                          pi_vSessionClientIP => pi_vSessionClientIP,
                                          pi_nUserID => pi_nUserID,
                                          pi_vPatientID => pi_vPatientID,
                                          pi_vEncounterID => pi_vEncounterID,
                                          pi_nTreatmentID => pi_nTreatmentID, 
                                          po_nStatusCode => po_nStatusCode, 
                                          po_vStatusComment => po_vStatusComment);
     
    
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtSubjective(): ' || sqlErrm;
  end;

  procedure updtObjective(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vPatientID       in varchar2,
                          pi_vEncounterID     in varchar2,
                          pi_nTreatmentID     in number,
                          pi_vObjective       in clob,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2) is
                           
  v_clobTxPlan    clob := '';
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    update encounter t
       set t.objective      = pi_vObjective,
           t.treatment_plan  = v_clobTxPlan,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id    = pi_vEncounterID;
    commit;
    
    pck_encounter.UpdateEncounterDiagnosis(pi_vSessionID => pi_vSessionID,
                                          pi_vSessionClientIP => pi_vSessionClientIP,
                                          pi_nUserID => pi_nUserID,
                                          pi_vPatientID => pi_vPatientID,
                                          pi_vEncounterID => pi_vEncounterID,
                                          pi_nTreatmentID => pi_nTreatmentID, 
                                          po_nStatusCode => po_nStatusCode, 
                                          po_vStatusComment => po_vStatusComment);
                                          
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtObjective(): ' || sqlErrm;
  end;

  procedure Sign(pi_vSessionID        in varchar2,
                 pi_vSessionClientIP  in varchar2,
                 pi_nUserID           in number,
                 pi_vPatientID        in varchar2,
                 pi_nTreatmentID      in number,
                 pi_vEncounterID      in varchar2,
                 pi_vSignedProviderID in varchar2,
                 pi_nSignedUserType   in number,
                 pi_nCloseEncounter   in number,
                 po_nStatusCode       out number,
                 po_vStatusComment    out varchar2) is
  
    v_vHasSessionTime         long := '';
    v_vHasRecordsMaintainedAt long := '';
    v_nClosed                 number := 0;
    v_vEncounterTypeID        number := 0;
    v_nCloseNote              number := 0;
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    -- get records maintained at, session time and encounter type id
    -- so we can make sure that the required fields for this encounter
    -- are populated
    begin
      select t.records_maintained_at, t.session_time, t.encounter_type_id
        into v_vHasRecordsMaintainedAt,
             v_vHasSessionTime,
             v_vEncounterTypeID
        from encounter t
       where t.encounter_id = pi_vEncounterID;
    exception
      when others then
        null;
    end;
  
    --is this note closed?
    select nvl(e.closed, 0)
      into v_nClosed
      from encounter e
     where e.patient_id = pi_vPatientID
       and e.treatment_id = pi_nTreatmentID
       and e.encounter_id = pi_vEncounterID;
  
    --if closed then sign to the addendum blocks
    if v_nClosed = 1 then
    
      if pi_nSignedUserType = 1 then
        -- provider
      
        update encounter t
           set t.ad_provider_signature_id = pi_vSignedProviderID,
               t.ad_provider_date_signed  = sysdate,
               t.last_updated             = sysdate,
               t.last_updated_by          = pi_nUserID
        --can't un-close a closed encounter t.closed = pi_nCloseEncounter
         where t.encounter_id = pi_vEncounterID
           and t.patient_id = pi_vPatientID
           and t.treatment_id = pi_nTreatmentID;
        commit;
      
      end if;
    
      if pi_nSignedUserType = 2 then
        -- provider intern
      
        select count(*)
          into v_nCloseNote
          from suat_user u, fx_user_rights ur
         where u.provider_id = pi_vSignedProviderID
           and ur.fx_user_id = u.fx_user_id
           and (bitand(256, ur.user_rights) > 0);
      
        if (v_nCloseNote < 1) then
          po_nStatusCode    := 1;
          po_vStatusComment := 'You don''t have access to sign a Note''s Addendum.';
          return;
        end if;
      
        update encounter t
           set t.ad_adc_signature_id = pi_vSignedProviderID,
               t.ad_adc_date_signed  = sysdate,
               t.last_updated        = sysdate,
               t.last_updated_by     = pi_nUserID
         where t.encounter_id = pi_vEncounterID
           and t.patient_id = pi_vPatientID
           and t.treatment_id = pi_nTreatmentID;
        commit;
      
      end if;
    
      if ((pi_nSignedUserType != 1) and (pi_nSignedUserType != 2)) then
      
        po_nStatusCode    := 1;
        po_vStatusComment := 'You don''t have access to sign a Note''s Addendum.';
        return;
              
      end if;
    
    end if;
  
    --else sign to the correct normal sig block
    if v_nClosed != 1 then
    
      if pi_nSignedUserType = 1 then
        -- provider
      
        update encounter t
           set t.provider_signature_id = pi_vSignedProviderID,
               t.date_signed           = sysdate,
               t.closed                = 1,
               t.last_updated          = sysdate,
               t.last_updated_by       = pi_nUserID
         where t.encounter_id = pi_vEncounterID
           and t.patient_id = pi_vPatientID
           and t.treatment_id = pi_nTreatmentID;
      
        commit;
      
      end if;
    
      if pi_nSignedUserType = 2 then
        -- provider intern
      
        update encounter t
           set t.adc_signature_id = pi_vSignedProviderID,
               t.adc_date_signed  = sysdate,
               t.closed           = 0,
               t.last_updated     = sysdate,
               t.last_updated_by  = pi_nUserID
         where t.encounter_id = pi_vEncounterID
           and t.patient_id = pi_vPatientID
           and t.treatment_id = pi_nTreatmentID;
        commit;
      
      end if;
    end if;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.Sign(): ' || sqlErrm;
  end;

  procedure updtPlan(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     pi_vPatientID       in varchar2,
                     pi_vEncounterID     in varchar2,
                     pi_nTreatmentID     in number,
                     pi_vPlan            in clob,
                     po_nStatusCode      out number,
                     po_vStatusComment   out varchar2) is
                           
  v_clobTxPlan    clob := '';
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
        
    update encounter t
       set t.plan      = pi_vPlan,
           t.treatment_plan  = v_clobTxPlan,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id    = pi_vEncounterID;
    commit;
    
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtPlan(): ' || sqlErrm;
  end;

  procedure updtTreatmentPlan(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_vEncounterID     in varchar2,
                              pi_nTreatmentID     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2) is
                              
  v_clobTxPlan    clob := '';
  
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    update encounter t
       set t.treatment_plan  = v_clobTxPlan,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id = pi_vEncounterID
       and t.patient_id = pi_vPatientID
       and t.treatment_id = pi_nTreatmentID;
    commit;
    
    pck_encounter.UpdateEncounterDiagnosis(pi_vSessionID => pi_vSessionID,
                                          pi_vSessionClientIP => pi_vSessionClientIP,
                                          pi_nUserID => pi_nUserID,
                                          pi_vPatientID => pi_vPatientID,
                                          pi_vEncounterID => pi_vEncounterID,
                                          pi_nTreatmentID => pi_nTreatmentID, 
                                          po_nStatusCode => po_nStatusCode, 
                                          po_vStatusComment => po_vStatusComment);
    
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtTreatmentPlan(): ' ||
                           sqlErrm;
  end;

  procedure updtPrevention(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_vPatientID       in varchar2,
                           pi_vEncounterID     in varchar2,
                           pi_nTreatmentID     in number,
                           pi_vPrevention      in clob,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    update encounter t
       set t.plan_prevention = pi_vPrevention,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id = pi_vEncounterID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtPrevention(): ' || sqlErrm;
  end;

  procedure updtAddendum(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         pi_vPatientID       in varchar2,
                         pi_vEncounterID     in varchar2,
                         pi_nTreatmentID     in number,
                         pi_vAddendum        in clob,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2) is
                         
  v_vAddendum  varchar2(32767) := '';
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_vAddendum := replace(pi_vAddendum, '~%d~', to_char(sysdate, 'MM/DD/YYYY HH:MI:SS AM'));
    
    update encounter t
       set t.addendum        = v_vAddendum,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id = pi_vEncounterID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtAddendum(): ' || sqlErrm;
  end;

  procedure updtAddendumSave(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             pi_vEncounterID     in varchar2,
                             pi_nTreatmentID     in number,
                             pi_vAddendumSave    in clob,
                             po_nStatusCode      out number,
                             po_vStatusComment   out varchar2) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    update encounter t
       set t.addendum_save   = pi_vAddendumSave,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id = pi_vEncounterID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtAddendumSave(): ' ||
                           sqlErrm;
  end;

  procedure updtSessionTime(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vPatientID       in varchar2,
                            pi_vEncounterID     in varchar2,
                            pi_nTreatmentID     in number,
                            pi_vMaintained      in varchar2,
                            pi_vSessionTime     in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    update encounter t
       set t.records_maintained_at = pi_vMaintained,
           t.session_time          = pi_vSessionTime,
           t.last_updated          = sysdate,
           t.last_updated_by       = pi_nUserID
     where t.encounter_id = pi_vEncounterID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtSessionTime(): ' ||
                           sqlErrm;
  end;

  procedure updtRecordsMaintainedAt(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vPatientID       in varchar2,
                                    pi_vEncounterID     in varchar2,
                                    pi_nTreatmentID     in number,
                                    pi_vMaintained      in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    update encounter t
       set t.records_maintained_at = pi_vMaintained,
           t.last_updated          = sysdate,
           t.last_updated_by       = pi_nUserID
     where t.encounter_id = pi_vEncounterID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.updtRecordsMaintainedAt(): ' ||
                           sqlErrm;
  end;

  procedure refreshTreatmentPlanText(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     pi_vPatientID       in varchar2,
                                     pi_vEncounterID     in varchar2,
                                     pi_nTreatmentID     in number,
                                     po_nStatusCode      out number,
                                     po_vStatusComment   out varchar2) is
                                     
  v_clobTxPlan    clob := '';
                                     
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    update encounter t
       set t.treatment_plan = v_clobTxPlan
     where t.encounter_id = pi_vEncounterID
       and t.patient_id = pi_vPatientID
       and t.treatment_id = pi_nTreatmentID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.refreshTreatmentPlanText(): ' ||
                           sqlErrm;
  end;

  procedure UpdtSOAP(pi_vSessionID       in varchar2,
                     pi_vSessionClientIP in varchar2,
                     pi_nUserID          in number,
                     pi_vPatientID       in varchar2,
                     pi_vEncounterID     in varchar2,
                     pi_nTreatmentID     in number,
                     pi_vSubjective   in varchar2,
                     pi_vObjective    in varchar2,
                     pi_vAssessment   in varchar2,
                     pi_vPlan         in varchar2,
                     po_nStatusCode      out number,
                     po_vStatusComment   out varchar2) is
  begin
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    update encounter t
       set t.subjective      = pi_vSubjective,
           t.objective       = pi_vObjective,
           t.assessment      = pi_vAssessment,
           t.plan            = pi_vPlan,
           t.last_updated    = sysdate,
           t.last_updated_by = pi_nUserID
     where t.encounter_id = pi_vEncounterID
       and t.treatment_id = pi_nTreatmentID;
    commit;
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SOAPP_REPORT.UpdtSOAP(): ' || sqlErrm;
  end;

end PCK_SOAPP_REPORT;
/

prompt
prompt Creating package body PCK_SYSTEM_SETTINGS
prompt =========================================
prompt
create or replace package body PCK_SYSTEM_SETTINGS is
  
  procedure GetSystemSettingsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor)
  is
    
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := null;
  
    open rs for
    
    select t.mail_smtp_host, t.mail_smtp_sender, t.mail_smtp_port, t.site_url, t.notify_email,
           t.has_military_detail, t.has_patient_supervisor_input, t.has_patient_insurance,
           t.branch_of_service, t.texting_host, t.texting_port,
           sys.ic_utl_sec.decryptdata (t.texting_user, sys.ic_utl_sec.c_rKey) as texting_user,
           sys.ic_utl_sec.decryptdata (t.texting_pswd, sys.ic_utl_sec.c_rKey) as texting_pswd,
           t.ora_win_dir
     from fx_settings t;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SYSTEM_SETTINGS.GetSystemSettingsRS(): ' ||
                           sqlErrm;
  end;

  procedure UpdateSystemSettings(pi_vSessionID                 in varchar2,
                                 pi_vSessionClientIP           in varchar2,
                                 pi_nUserID                    in number,
                                 pi_vMailSMTPHost              in varchar2,
                                 pi_vSenderEmailAddress        in varchar2,
                                 pi_nMailSMTPPort              in number,
                                 pi_vSiteURL                   in varchar2,
                                 pi_vNotifyEmailAddress        in varchar2,
                                 pi_vTextingHost               in varchar2,
                                 pi_nTextingPort               in number,
                                 pi_vTextingUser               in varchar2,
                                 pi_vTextingPswd               in varchar2,
                                 pi_vOraWinDir                 in varchar2,            
                                 po_nStatusCode                out number,
                                 po_vStatusComment             out varchar2) 
   is
                                 
       v_vUserName                        varchar2(128);
       v_vPassword                        varchar2(128);
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := null;
    
    v_vUserName := sys.ic_utl_sec.encryptdata (pi_vTextingUser, sys.ic_utl_sec.c_rKey);
    v_vPassword := sys.ic_utl_sec.encryptdata (pi_vTextingPswd, sys.ic_utl_sec.c_rKey);
  
    update fx_settings t
       set t.mail_smtp_host               = pi_vMailSMTPHost,
           t.mail_smtp_sender             = pi_vSenderEmailAddress,
           t.mail_smtp_port               = pi_nMailSMTPPort,
           t.site_url                     = pi_vSiteURL,
           t.notify_email                 = pi_vNotifyEmailAddress,
           t.texting_host                 = pi_vTextingHost,
           t.texting_port                 = pi_nTextingPort,
           t.texting_user                 = v_vUserName,
           t.texting_pswd                 = v_vPassword,
           t.ora_win_dir                  = pi_vOraWinDir;
            
    Commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SYSTEM_SETTINGS.UpdateSystemSettings(): ' ||
                           sqlErrm;
  end;

  procedure GetSiteRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0;
    po_vStatusComment := null;
  
    open rs for
      select t.* from Site t;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_SYSTEM_SETTINGS.GetSiteRS(): ' ||
                           sqlErrm;
  end;

end PCK_SYSTEM_SETTINGS;
/

prompt
prompt Creating package body PCK_TEMPLATE
prompt ==================================
prompt
create or replace package body PCK_TEMPLATE is

  procedure GetParsedTemplate2RS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 pi_vPatientID       in varchar2,
                                 pi_vEncounterID     in varchar2,
                                 pi_nTemplateID      in number,
                                 pi_vKey             in varchar2,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
    v_vTemplateText clob;
  
    rsTags     refCursor;
    v_recTags  template_item%ROWTYPE;
    v_nPos     number;
    v_vItemSQL long;
  
    rsTagValue  refCursor;
    v_vTagValue varchar2(4000);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    v_vTemplateText   := '';
    v_nPos            := 0;
    v_vItemSQL        := '';
    v_vTagValue       := '';
  
    --get the tagged template text
    select template
      into v_vTemplateText
      from template
     where template_id = pi_nTemplateID;
  
    --open the recordset of all the possible tags
    open rsTags for 'select * from template_item';
  
    --loop over items in the template_item table
    --and find and replace tags with values from the db
    LOOP
      v_recTags := null;
      FETCH rsTags
        INTO v_recTags;
      EXIT WHEN NOT rsTags%found;
      if v_recTags.description is not null then
        v_nPos := instr(v_vTemplateText,
                        '[' || v_recTags.description || ']');
        if v_nPos != 0 then
        
          --format the sql to run for this tag
          v_vItemSQL := v_recTags.Item_Sql;
          v_vItemSQL := replace(v_vItemSQL,
                                '~%s~',
                                '''' || pi_vPatientID || '''');
        
          v_vItemSQL := replace(v_vItemSQL,
                                '~%e~',
                                '''' || pi_vEncounterID || '''');
                                
          v_vItemSQL := replace(v_vItemSQL, 
                                '~%k~', 
                                '''' || pi_vKey || '''');
        
          --run the sql and get the value
          v_vTagValue := '';
          begin
          
            open rsTagValue for v_vItemSQL;
          
            FETCH rsTagValue
              INTO v_vTagValue;
            close rsTagValue;
          
          exception
            when others then
              --error but keep processing the other tags
              po_nStatusCode    := 1;
              po_vStatusComment := po_vStatusComment || '<br>' ||
                                   'PCK_TEMPLATE.GetParsedTemplate2RS(): ' ||
                                   sqlErrm;
            
          end;
        
          v_vTemplateText := replace(v_vTemplateText,
                                     '[' || v_recTags.description || ']',
                                     v_vTagValue);
        
        end if;
      end if;
    END LOOP;
    CLOSE rsTags;
  
    --open recordset
    open rs for
      select v_vTemplateText as template_text from dual;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetParsedTemplate2RS(): ' ||
                           sqlErrm;
  end;

  procedure GetTemplateDataTagRS(pi_vSessionID       in varchar2,
                                 pi_vSessionClientIP in varchar2,
                                 pi_nUserID          in number,
                                 po_nStatusCode      out number,
                                 po_vStatusComment   out varchar2,
                                 rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from template_item t
       where active = 1
       order by t.item_group_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetTemplateDataTagRS(): ' ||
                           sqlErrm;
  end;

  procedure GetTemplateDataTagGroupRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select *
        from template_item_group
       where active = 1
       order by group_id asc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetTemplateDataTagGroupRS(): ' ||
                           sqlErrm;
  end;

  procedure GetTemplateTypeRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select * from template_type where active = 1 order by type_id asc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetTemplateTypeRS(): ' || sqlErrm;
  end;

  procedure GetTemplateRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*, tt.description as template_type
        from template t, template_type tt
       where t.type_id in
             (select type_id from template_type where active = 1)
         and t.active = 1
         and t.type_id = tt.type_id
       order by t.type_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetTemplateRS(): ' || sqlErrm;
  end;

  procedure UpdateTemplate(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nTemplateID      in number,
                           pi_nGroupID         in number,
                           pi_vTemplateName    in varchar2,
                           pi_vTemplateText    in clob,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update template t
       set t.type_id     = pi_nGroupID,
           t.description = pi_vTemplateName,
           t.template    = pi_vTemplateText
     where t.template_id = pi_nTemplateID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.UpdateTemplate(): ' || sqlErrm;
  end;

  procedure InsertTemplate(pi_vSessionID       in varchar2,
                           pi_vSessionClientIP in varchar2,
                           pi_nUserID          in number,
                           pi_nSOAPsectID      in number,
                           pi_vTemplateName    in varchar2,
                           pi_vTemplateText    in clob,
                           pi_nTempGroupID     in number,
                           po_nTemplateID      out number,
                           po_nStatusCode      out number,
                           po_vStatusComment   out varchar2) is
  
  begin
  
    select seqTemplateID.Nextval into po_nTemplateID from dual;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into template
      (template_id,
       type_id,
       description,
       template,
       creator_id,
       created_date,
       active,
       template_group_id)
    values
      (po_nTemplateID,
       pi_nSOAPsectID,
       pi_vTemplateName,
       pi_vTemplateText,
       pi_nUserID,
       sysdate,
       1,
       pi_nTempGroupID);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.UpdateTemplate(): ' || sqlErrm;
  end;

  procedure DiscontinueTemplate(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                pi_nTemplateID      in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update template t
       set t.active = 0
     where t.template_id = pi_nTemplateID;
  
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.DiscontinueTemplate(): ' ||
                           sqlErrm;
  end;

  -- -----------------------------------------------------------------
  -- TEMPLATE GROUPS

  --Insert Template Group
  procedure InsertTemplateGroup(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                --
                                pi_vTemplateGrpName in varchar2,
                                pi_vComments        in varchar2,
                                --
                                po_nTemplateGrpID out number,
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2) is
  
    v_nTemplateGrpID number;
  
  begin
  
    select seqtemplategrpid.Nextval into v_nTemplateGrpID from dual;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into template_group
      (template_group_id,
       group_name,
       comments,
       active,
       created_by,
       last_updated,
       last_updated_by)
    values
      (v_nTemplateGrpID,
       pi_vTemplateGrpName,
       pi_vComments,
       1,
       pi_nUserID,
       sysdate,
       pi_nUserID);
  
    commit;
  
    po_nTemplateGrpID := v_nTemplateGrpID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.InsertTemplateGroup(): ' ||
                           sqlErrm;
      po_nTemplateGrpID := -1;
  end;

  -- Update Template Group
  procedure UpdateTemplateGroup(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                --
                                pi_nTemplateGrpID   in number,
                                pi_vTemplateGrpName in varchar2,
                                pi_vComments        in varchar2,
                                --
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update template_group t
       set group_name      = pi_vTemplateGrpName,
           comments        = pi_vComments,
           last_updated    = sysdate,
           last_updated_by = pi_nUserID
    
     where t.template_group_id = pi_nTemplateGrpID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.UpdateTemplateGroup(): ' ||
                           sqlErrm;
  end;

  --Discontinue Template Group
  procedure DiscontinueTemplateGroup(pi_vSessionID       in varchar2,
                                     pi_vSessionClientIP in varchar2,
                                     pi_nUserID          in number,
                                     --
                                     pi_nTemplateGrpID in number,
                                     --
                                     po_nStatusCode    out number,
                                     po_vStatusComment out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update template_group t
       set active = 0, last_updated = sysdate, last_updated_by = pi_nUserID
    
     where t.template_group_id = pi_nTemplateGrpID;
    commit;
  
    --also discontinue templates associated to the group
    update template t
       set active = 0
     where t.TEMPLATE_GROUP_ID = pi_nTemplateGrpID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.DiscontinueTemplateGroup(): ' ||
                           sqlErrm;
  end;

  --Get Template Groups
  procedure GetTemplateGroupsRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                po_nStatusCode      out number,
                                po_vStatusComment   out varchar2,
                                rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select * from template_group t where t.active = 1;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetTemplateGroupsRS(): ' ||
                           sqlErrm;
  end;

  -- Get Group Templates
  procedure GetGroupTemplatesRS(pi_vSessionID       in varchar2,
                                pi_vSessionClientIP in varchar2,
                                pi_nUserID          in number,
                                
                                pi_nGroupID in number,
                                
                                po_nStatusCode    out number,
                                po_vStatusComment out varchar2,
                                rs                out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*, tt.description as template_type
        from template t, template_type tt
       where t.type_id in
             (select type_id from template_type where active = 1)
         and t.active = 1
         and t.type_id = tt.type_id
         and t.template_group_id = pi_nGroupID
       order by t.type_id, t.template_group_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TEMPLATE.GetGroupTemplatesRS(): ' ||
                           sqlErrm;
  end;

  function fnGetParsedTemplateText(pi_vPatientID    in varchar2,
                                   pi_vKey          in varchar2,
                                   pi_vTemplateText in varchar2) return clob is
    v_vTemplateText clob;
  
    rsTags     refCursor;
    v_recTags  template_item%ROWTYPE;
    v_nPos     number;
    v_vItemSQL long;
  
    rsTagValue  refCursor;
    v_vTagValue varchar2(4000);
  
  begin
  
    v_vTemplateText := '';
    v_nPos          := 0;
    v_vItemSQL      := '';
    v_vTagValue     := '';
  
    --get the tagged template text
    v_vTemplateText := pi_vTemplateText;
  
    --open the recordset of all the possible tags
    open rsTags for 'select * from template_item';
  
    --loop over items in the template_item table
    --and find and replace tags with values from the db
    LOOP
      v_recTags := null;
      FETCH rsTags
        INTO v_recTags;
      EXIT WHEN NOT rsTags%found;
      if v_recTags.description is not null then
        v_nPos := instr(v_vTemplateText,
                        '[' || v_recTags.description || ']');
        if v_nPos != 0 then
        
          --format the sql to run for this tag
          v_vItemSQL := v_recTags.Item_Sql;
          v_vItemSQL := replace(v_vItemSQL,
                                '~%s~',
                                '''' || pi_vPatientID || '''');
        
          v_vItemSQL := replace(v_vItemSQL, '~%k~', '''' || pi_vKey || '''');
        
          --run the sql and get the value
          v_vTagValue := '';
          begin
          
            open rsTagValue for v_vItemSQL;
          
            FETCH rsTagValue
              INTO v_vTagValue;
            close rsTagValue;
          
          end;
        
          v_vTemplateText := replace(v_vTemplateText,
                                     '[' || v_recTags.description || ']',
                                     v_vTagValue);
        
        end if;
      end if;
    END LOOP;
    CLOSE rsTags;
  
    return v_vTemplateText;
  
  end fnGetParsedTemplateText;

end PCK_TEMPLATE;
/

prompt
prompt Creating package body PCK_TREATMENT
prompt ===================================
prompt
create or replace package body PCK_TREATMENT is

  --------------------------------------------------------------
  -- Returns the current active treatement for the patient_id
  --------------------------------------------------------------
  procedure GetCurrentTreatmentID(pi_vSessionID       in varchar2,
                                  pi_vSessionClientIP in varchar2,
                                  pi_nUserID          in number,
                                  pi_vPatientID       in varchar2,
                                  po_nTreatmentID     out number,
                                  po_nStatusCode      out number,
                                  po_vStatusComment   out varchar2) is
  
  begin
  
    select t.treatment_id
      into po_nTreatmentID
      from treatment t
     where patient_id = pi_vPatientID
       and case_closed = 0;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TREATMENT.GetCurrentTreatmentID(): ' ||
                           sqlErrm;
  end;

   --------------------------------------------------------------
  
  procedure GetTreatmentListRS(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vPatientID       in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2,
                               rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select t.*,
               '' as LEVEL_OF_CARE_DESC,
               '' as PRIMARY_RFR
        from treatment t
       where t.patient_id = pi_vPatientID
       order by t.case_closed asc, t.initial_visit_date desc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TREATMENT.GetTreatmentListRS(): ' ||
                           sqlErrm;
  end;

   --------------------------------------------------------------
  
  procedure GetTreatmentsList(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nSelectCases     in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor)
  
   is
  
    v_const_Search_All_Cases    number := 1;
    v_const_Search_Open_Cases   number := 2;
    v_const_Search_Closed_Cases number := 3;
  
    strSQL       varchar2(1000) := '';
    strSelectSQL varchar2(300) := '';
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    if pi_nSelectCases = v_const_Search_All_Cases then
      strSelectSQL := '';
    elsif pi_nSelectCases = v_const_Search_Open_Cases then
      strSelectSQL := ' and t.case_closed = 0';
    elsif pi_nSelectCases = v_const_Search_Closed_Cases then
      strSelectSQL := ' and t.case_closed <> 0';
    end if;
  
    strSQL := strSQL || 'select *';
    strSQL := strSQL || ' from treatment t';
    strSQL := strSQL || ' where t.patient_id = ''' || pi_vPatientID || '''';
    strSQL := strSQL || strSelectSQL;
    strSQL := strSQL || ' order by t.initial_visit_date desc';
  
    --open recordset
    open rs for strSQL;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TREATMENT.GetTreatmentsList(): ' || sqlErrm;
  end;
 
  procedure GetStatModalityByModalityIDRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nModalityID      in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
    v_vSQL constant varchar2(32767) := 'select t.*
                                        from stat_modality t
                                        where t.STAT_MODALITY_ID = :ModalityID';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
      using pi_nModalityID;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_TREATMENT.GetStatModalityByModalityIDRS(): ' || sqlErrm;
  end;

   --------------------------------------------------------------
  procedure GetAllStatModalityTypesRS(pi_vSessionID       in varchar2,
                                      pi_vSessionClientIP in varchar2,
                                      pi_nUserID          in number,
                                      po_nStatusCode      out number,
                                      po_vStatusComment   out varchar2,
                                      rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
        
    --open recordset
    open rs for
      select * from stat_modality t where is_active = 1
      order by stat_modality_id;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TREATMENT.GetAllStatModalityTypesRS(): ' ||
                           sqlErrm;
  end;

  --------------------------------------------------------------
  procedure GetDiagnosticIDRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_vPatientID       in varchar2,
                              pi_nTreatmentID     in number,
                              pi_vEncounterID     in varchar2,
                              pi_nProblemID       in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
    v_vSQL constant varchar2(32767) := 'select t.*
                                           from treatment_problem_list t
                                           where patient_id = :PatientID
                                           and treatment_id = :TreatmentID
                                           and encounter_id = :EncounterID
                                           and problem_id = :ProblemID';
  
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
      using pi_vPatientID, pi_nTreatmentID, pi_vEncounterID, pi_nProblemID;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_TREATMENT.GetDiagnosticIDRS():' || sqlErrm;
  end;

  --------------------------------------------------------------
  procedure GetDiagnosisSymptomsRS(pi_vSessionID       in varchar2,
                                   pi_vSessionClientIP in varchar2,
                                   pi_nUserID          in number,
                                   pi_nDiagnosisID     in number,
                                   po_nStatusCode      out number,
                                   po_vStatusComment   out varchar2,
                                   rs                  out RetRefCursor) is
    v_vSQL constant varchar2(32767) := 'select t.*
                                           from stat_diagnosis_symptoms t
                                           where diagnosis_id = :DiagnosisID
                                           and active = 1';
  begin
    po_nStatusCode    := PCK_COMMON.c_nResultStatus_Success;
    po_vStatusComment := '';
  
    open rs for v_vSQL
      using pi_nDiagnosisID;
  
  exception
    when others then
      po_nStatusCode    := PCK_COMMON.c_nResultStatus_Error;
      po_vStatusComment := 'PCK_TREATMENT.GetDiagnosisSymptomsRS():' ||
                           sqlErrm;
  end;

end PCK_TREATMENT;
/

prompt
prompt Creating package body PCK_TREATMENT_PLAN
prompt ========================================
prompt
create or replace package body PCK_TREATMENT_PLAN is

   -- GetProblemListRS --
  procedure GetProblemListRS(pi_vSessionID       in varchar2,
                             pi_vSessionClientIP in varchar2,
                             pi_nUserID          in number,
                             pi_vPatientID       in varchar2,
                             pi_nTreatmentID     in number,
                             po_nStatusCode    out number,
                             po_vStatusComment out varchar2,
                             rs                out RetRefCursor) is
  begin
  
    open rs for
      select *
        from treatment_problem_list t
       where t.patient_id = pi_vPatientID
         and t.treatment_id = pi_nTreatmentID
         and t.inactive != 1
       order by t.diagnostic_axis_type, t.sort_order, t.diag_code;
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_TREATMENT_PLAN.GetProblemListRS(): ' ||
                           sqlErrm;
  end;

end PCK_TREATMENT_PLAN;
/

prompt
prompt Creating package body PCK_USER
prompt ==============================
prompt
create or replace package body PCK_USER is

 --get a record set
  procedure GetLoginUserRS (
      pi_vSessionID              in varchar2,
      pi_vSessionClientIP        in varchar2,
      pi_nUserID                 in number,
      pi_vKey in varchar2,
      pi_nFXUserID               in number,
      po_nStatusCode             out number,
      po_vStatusComment          out varchar2,
      rs                         out RetRefCursor)
   is
     v_nTemp         number;
     v_nCount        number;
     v_nPatUserType  number := 32768;
     v_nRovUserTypes  number := 59;

   begin

      v_nTemp := 0;
      po_nStatusCode := 0;--0 = success
      po_vStatusComment := '';
      v_nCount := 0;

      select count(*) into v_nCount
      from fx_user t1,
           fx_user_rights t2
      where t2.fx_user_id = t1.fx_user_id
        and bitand(t2.user_type, v_nRovUserTypes) > 0
        and t1.fx_user_id = pi_nFXUserID;

      --open recordset
      if v_nCount > 0 then

        --check for user account
        open rs for
          select t1.fx_user_id,
                 t1.date_last_login,
                 t1.last_login_ip,
                 t1.last_flogin_date,
                 t1.last_flogin_ip,
                 t1.flogin_attempts,
                 t3.User_Type,
                 t3.user_rights,
                 t3.read_only,
                 t2.dims_id,
                 t2.provider_id,
                 --less than or equal to zero means we are expired!
                 floor(60 - (trunc(sysdate) - t1.date_password_changed)) as days_till_expiration,
                 t2.name
           from fx_user t1,
               suat_user t2,
               fx_user_rights t3
          where t2.fx_user_id = t1.fx_user_id
            and t3.fx_user_id = t1.fx_user_id
            and t1.fx_user_id = pi_nFXUserID;

       else

          --is a patient account
          open rs for
          select t1.fx_user_id,
                 t1.date_last_login,
                 t1.last_login_ip,
                 t1.last_flogin_date,
                 t1.last_flogin_ip,
                 t1.flogin_attempts,
                 v_nPatUserType as User_Type,
                 0 as user_rights,
                 0 as read_only,
                 0 as dims_id,
                 '' as provider_id,
                 --less than or equal to zero means we are expired!
                 floor(60 - (trunc(sysdate) - t1.date_password_changed)) as days_till_expiration,
                 (fnc_utl_decstr(t2.FIRST_NAME, pi_vKey, t2.PATIENT_ID) || ' ' || fnc_utl_decstr(t2.LAST_NAME, pi_vKey, t2.PATIENT_ID)) as name
           from fx_user t1,
               patient_demographics t2
          where t2.fx_user_id = t1.fx_user_id
            and t1.fx_user_id = pi_nFXUserID;

       end if;

   exception
      when others
      then
         po_nStatusCode := 1;
         po_vStatusComment := '421 - An error occurred while retrieving user infromation, Please contact your system administrator.';
   end;

end PCK_USER;
/

prompt
prompt Creating package body PCK_USER_ADMIN
prompt ====================================
prompt
create or replace package body PCK_USER_ADMIN is

  --get a record set of users back that match criteria
  procedure GetUserLookupRS(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_vDMISID          in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2,
                            rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';  
  
    --open recordset
    open rs for
      SELECT distinct *
        FROM SUAT_USER s
       WHERE s.DIMS_ID = pi_vDMISID
       ORDER BY upper(NAME) asc, ENTRY_DATE desc;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.getUserLookupRS(): ' || sqlErrm;
  end;

  --get a record set of users back that match criteria
  procedure GetUserLookupBySearchRS(pi_vSessionID       in varchar2,
                                    pi_vSessionClientIP in varchar2,
                                    pi_nUserID          in number,
                                    pi_vSearchValue     in varchar2,
                                    po_nStatusCode      out number,
                                    po_vStatusComment   out varchar2,
                                    rs                  out RetRefCursor) is
  
    strSQL       varchar2(300);
    strSelectSQL varchar2(300);
  
    v_bHQRights     boolean;
    v_bMAJCOMRights boolean;
    v_vDMISID       varchar(50);
    v_nMAJCOMID     number;
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    select nvl(dims_id, '')
      into v_vDMISID
      from suat_user t
     where t.fx_user_id = pi_nUserID;
  
    select nvl(majcom_id, '')
      into v_nMAJCOMID
      from stat_dims_base t
     where t.dims_id = v_vDMISID;
  
    --open recordset
    strSQL := strSQL || 'select * from suat_user s';
    strSQL := strSQL || ' where UPPER(s.name) like UPPER(''%' ||
              pi_vSearchValue || '%'')';
    strSQL := strSQL ||
              ' order by s.dims_id,upper(s.name) asc, s.entry_date desc';
    strSQL := strSQL || strSelectSQL;
  
    open rs for strSQL;
    return;
      
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.getUserLookupBySearchRS(): ' ||
                           sqlErrm;
  end;

  procedure GetSuatUserRS(pi_vSessionID       in varchar2,
                          pi_vSessionClientIP in varchar2,
                          pi_nUserID          in number,
                          pi_vProviderID      in varchar2,
                          po_nStatusCode      out number,
                          po_vStatusComment   out varchar2,
                          rs                  out RetRefCursor) is
  
    v_vDMISID varchar(50);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    select nvl(dims_id, '')
      into v_vDMISID
      from suat_user t
     where t.provider_id = pi_vProviderID;
  
    --open recordset
    open rs for
      select user_type,
             name,
             rank,
             military_service_id,
             title,
             unit,
             corps,
             squadron,
             phone,
             email,
             dims_id,
             r.user_rights,
             locked
        from suat_user t, fx_user_rights r
       where provider_id = pi_vProviderID
         and r.fx_user_id = t.fx_user_id
         and dims_id = v_vDMISID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.GetSuatUserRS(): ' || sqlErrm;
  end;

  --
  procedure GetSuatUserNameRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              pi_nFXUserID        in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
    v_vDMISID varchar(50);
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
    
    --open recordset
    open rs for
      select user_type,
             name,
             rank,
             military_service_id,
             title,
             unit,
             corps,
             squadron,
             phone,
             email,
             dims_id,
             r.user_rights,
             locked,
             t.graph_pref
        from suat_user t, fx_user_rights r
       where t.fx_user_id = pi_nFXUserID
         and r.fx_user_id = t.fx_user_id;
      
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.GetSuatUserNameRS(): ' ||
                           sqlErrm;
  end;

  procedure GetFacilityInfoRS(pi_vSessionID       in varchar2,
                              pi_vSessionClientIP in varchar2,
                              pi_nUserID          in number,
                              po_nStatusCode      out number,
                              po_vStatusComment   out varchar2,
                              rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    --open recordset
    open rs for
      select * from site t;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.GetFacilityInfoRS(): ' ||
                           sqlErrm;
  end;

  procedure InsertFacilityInfo(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vSiteID          in varchar2,
                               pi_vSiteName        in varchar2,
                               pi_vSiteAddress1    in varchar2,
                               pi_vSiteCity        in varchar2,
                               pi_vSiteState       in varchar2,
                               pi_vSitePostalCode  in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    insert into site
      (site_id,
       site_name,
       site_address_1,
       site_city,
       site_state,
       site_postal_code)
    values
      (pi_vSiteID,
       pi_vSiteName,
       pi_vSiteAddress1,
       pi_vSiteCity,
       pi_vSiteState,
       pi_vSitePostalCode);
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_User_Admin.InserFacilityInfo(): ' ||
                           sqlErrm;
  end;

  procedure UpdateFacilityInfo(pi_vSessionID       in varchar2,
                               pi_vSessionClientIP in varchar2,
                               pi_nUserID          in number,
                               pi_vSiteID          in varchar2,
                               pi_vSiteName        in varchar2,
                               pi_vSiteAddress1    in varchar2,
                               pi_vSiteCity        in varchar2,
                               pi_vSiteState       in varchar2,
                               pi_vSitePostalCode  in varchar2,
                               po_nStatusCode      out number,
                               po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update site
       set site_id          = pi_vSiteID,
           site_name        = pi_vSiteName,
           site_address_1   = pi_vSiteAddress1,
           site_city        = pi_vSiteCity,
           site_state       = pi_vSiteState,
           site_postal_code = pi_vSitePostalCode;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.UpdateFacilityInfo(): ' ||
                           sqlErrm;
  end;

  procedure UpdateGraphPref(pi_vSessionID       in varchar2,
                            pi_vSessionClientIP in varchar2,
                            pi_nUserID          in number,
                            pi_nGraphOpt        in varchar2,
                            po_nStatusCode      out number,
                            po_vStatusComment   out varchar2) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    update suat_user t
       set t.graph_pref = pi_nGraphOpt
     where t.fx_user_id = pi_nUserID;
    commit;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.UpdateGraphPref(): ' ||
                           sqlErrm;
  end;

  procedure GetGraphPref(pi_vSessionID       in varchar2,
                         pi_vSessionClientIP in varchar2,
                         pi_nUserID          in number,
                         po_nStatusCode      out number,
                         po_vStatusComment   out varchar2,
                         rs                  out RetRefCursor) is
  
  begin
  
    po_nStatusCode    := 0; --0 = success
    po_vStatusComment := '';
  
    open rs for
      select * from suat_user t where t.fx_user_id = pi_nUserID;
  
  exception
    when others then
      po_nStatusCode    := 1;
      po_vStatusComment := 'PCK_USER_ADMIN.GetGraphPref(): ' ||
                           sqlErrm;
  end;

end;
/

prompt
prompt Creating package body PCK_UTL_COMMON
prompt ====================================
prompt
create or replace package body PCK_UTL_COMMON is
 
end;
/


spool off
